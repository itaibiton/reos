---
phase: 40-ai-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - convex/convex.config.ts
  - convex/schema.ts
  - convex/ai/agent.ts
autonomous: true

must_haves:
  truths:
    - "@convex-dev/agent, ai, @ai-sdk/anthropic packages installed"
    - "Convex agent component registered in config"
    - "AI thread and message tables exist in schema"
    - "Agent definition with Claude model exists"
  artifacts:
    - path: "package.json"
      provides: "AI dependencies"
      contains: "@convex-dev/agent"
    - path: "convex/convex.config.ts"
      provides: "Convex component registration"
      contains: "agent"
    - path: "convex/schema.ts"
      provides: "AI memory tables"
      contains: "aiThreads"
    - path: "convex/ai/agent.ts"
      provides: "Agent definition"
      exports: ["investorAssistant"]
  key_links:
    - from: "convex/ai/agent.ts"
      to: "convex/convex.config.ts"
      via: "components import"
      pattern: "components\\.agent"
---

<objective>
Set up the foundational AI infrastructure: install packages, register the Convex Agent component, extend schema with AI memory tables, and create the base agent definition.

Purpose: Establish the technical foundation that all AI features (streaming, memory, context) will build upon.
Output: Working Convex Agent component with schema support for thread-based memory.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-ai-infrastructure-foundation/40-RESEARCH.md
@convex/schema.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install AI dependencies</name>
  <files>package.json</files>
  <action>
Install the three required packages for AI infrastructure:

```bash
npm install @convex-dev/agent ai @ai-sdk/anthropic
```

These provide:
- `@convex-dev/agent`: Thread-based memory persistence with streaming support
- `ai`: Vercel AI SDK core (streamText, generateText)
- `@ai-sdk/anthropic`: Claude model provider

Note: The existing `@anthropic-ai/sdk` can remain - it's used by the search module. The new packages use a different integration path.
  </action>
  <verify>
```bash
npm list @convex-dev/agent ai @ai-sdk/anthropic
```
All three packages should appear in the dependency tree.
  </verify>
  <done>package.json includes @convex-dev/agent, ai, and @ai-sdk/anthropic as dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Register agent component and extend schema</name>
  <files>convex/convex.config.ts, convex/schema.ts</files>
  <action>
**Create convex/convex.config.ts:**

```typescript
import { defineApp } from "convex/server";
import agent from "@convex-dev/agent/convex.config";

const app = defineApp();
app.use(agent);

export default app;
```

**Update convex/schema.ts** to add AI memory tables. Add these new table definitions after the existing tables (before the closing of defineSchema):

```typescript
// ============================================================================
// AI ASSISTANT TABLES (Phase 40)
// ============================================================================

// AI conversation threads - one per user for persistent memory
aiThreads: defineTable({
  // Reference to user
  userId: v.id("users"),
  // Thread ID from @convex-dev/agent (for linking)
  agentThreadId: v.optional(v.string()),
  // Summary of older messages (for context window management)
  summary: v.optional(v.string()),
  // Number of messages summarized (for tracking)
  summarizedMessageCount: v.optional(v.number()),
  // Last activity timestamp
  lastActivityAt: v.number(),
  // Timestamps
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_last_activity", ["lastActivityAt"]),
```

Note: The @convex-dev/agent component manages its own internal tables for messages and streaming. The aiThreads table is our application-level wrapper for user-to-thread mapping and custom summarization tracking.
  </action>
  <verify>
```bash
npx convex dev --once
```
Should complete without errors, confirming schema is valid and component is registered.
  </verify>
  <done>convex.config.ts exists with agent component registered; schema.ts includes aiThreads table with by_user index</done>
</task>

<task type="auto">
  <name>Task 3: Create base agent definition</name>
  <files>convex/ai/agent.ts</files>
  <action>
Create the directory and agent definition file:

```bash
mkdir -p convex/ai
```

**Create convex/ai/agent.ts:**

```typescript
import { Agent } from "@convex-dev/agent";
import { anthropic } from "@ai-sdk/anthropic";
import { components } from "../_generated/api";

/**
 * Investor Assistant Agent
 *
 * This is the core AI agent for the investor experience.
 * It has access to investor profiles and can answer questions about:
 * - Investment preferences and goals
 * - Property recommendations (Phase 42)
 * - Provider suggestions (Phase 43)
 *
 * Memory persists across sessions via Convex.
 */
export const investorAssistant = new Agent(components.agent, {
  name: "Investor Assistant",
  chat: anthropic.chat("claude-sonnet-4-20250514"),
  instructions: `You are a helpful real estate investment assistant for REOS, a platform connecting US investors with Israeli properties.

Your role:
- Help investors understand their investment options
- Answer questions about the investor's profile and preferences
- Provide guidance on the real estate investment process in Israel
- Be accurate and helpful - never make up information about properties or providers

Guidelines:
- Be conversational but professional
- Reference the investor's profile when relevant, but don't repeat it unnecessarily
- If asked about something not in your context, acknowledge the limitation
- For property-specific questions, note that property search and recommendations will be enhanced in future updates

Current capabilities:
- Understanding investor profiles (from questionnaire data)
- Answering general investment questions
- Providing guidance on the US-Israel investment process`,
  tools: {}, // Tools will be added in Phase 42 (properties) and Phase 43 (providers)
  maxSteps: 5,
});
```

The agent uses Claude Sonnet 4 (claude-sonnet-4-20250514) for the best balance of quality and speed. Tools will be added in later phases.
  </action>
  <verify>
```bash
npx convex dev --once
```
Should complete without type errors. The agent is defined but not yet exposed via actions.
  </verify>
  <done>convex/ai/agent.ts exists with investorAssistant agent using Claude Sonnet, proper instructions, and empty tools placeholder</done>
</task>

</tasks>

<verification>
1. `npm list @convex-dev/agent ai @ai-sdk/anthropic` shows all packages installed
2. `convex/convex.config.ts` exists with agent component registration
3. `convex/schema.ts` includes aiThreads table
4. `convex/ai/agent.ts` exports investorAssistant agent
5. `npx convex dev --once` completes without errors
</verification>

<success_criteria>
- All three AI packages installed and in package.json
- Convex agent component registered in convex.config.ts
- Schema includes aiThreads table with proper indexes
- Agent definition exists with Claude Sonnet model and investor-focused instructions
- Convex dev runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/40-ai-infrastructure-foundation/40-01-SUMMARY.md`
</output>
