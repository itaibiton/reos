---
phase: 17-client-management
plan: 01
type: execute
---

<objective>
Create backend queries for client management - list unique clients and get client details with deal history.

Purpose: Service providers need to see their clients (investors they've worked with) and view deal history per client.
Output: Convex queries for getClients and getClientDetails in a new clients.ts file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/16-provider-dashboard-enhancement/16-01-SUMMARY.md

**Relevant source files:**
@convex/deals.ts
@convex/dashboard.ts
@convex/serviceRequests.ts
@convex/schema.ts

**Established patterns:**
- Role-based queries using effectiveRole (viewingAsRole ?? role)
- Index-based deal queries (by_broker, by_mortgage_advisor, by_lawyer)
- Enrichment pattern: fetch related data (property, investor) and return combined
- getProviderActiveDeals in dashboard.ts shows the pattern for provider-specific data

**Constraining decisions:**
- Phase 6: Role-based list queries - each role sees only their relevant deals
- Phase 16: getProviderActiveDeals pattern with property/investor enrichment
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create getClients query for unique clients</name>
  <files>convex/clients.ts</files>
  <action>
Create new convex/clients.ts file with getClients query:

1. Get current user and determine effectiveRole
2. Only for service providers (broker, mortgage_advisor, lawyer) - return empty for others
3. Get all deals where this provider is assigned (use appropriate index based on role)
4. Extract unique investor IDs from deals
5. Fetch investor details for each unique investor
6. For each client, calculate:
   - Total deals count
   - Active deals count (not completed/cancelled)
   - Latest deal date
   - Total deal value (sum of property prices)
7. Return array sorted by latest activity (most recent first)

Return type per client:
```typescript
{
  _id: Id<"users">;
  name: string | undefined;
  email: string | undefined;
  imageUrl: string | undefined;
  totalDeals: number;
  activeDeals: number;
  totalValue: number;
  lastActivityAt: number;
}
```

Use the same effectiveRole pattern from dashboard.ts.
  </action>
  <verify>npx convex dev --once passes without errors</verify>
  <done>getClients query returns unique clients with deal statistics for the current provider</done>
</task>

<task type="auto">
  <name>Task 2: Create getClientDetails query with deal history</name>
  <files>convex/clients.ts</files>
  <action>
Add getClientDetails query to convex/clients.ts:

Args: { clientId: v.id("users") }

1. Get current user and determine effectiveRole
2. Only for service providers - return null for others
3. Verify the clientId is an investor the provider has worked with:
   - Get deals where provider is assigned AND investorId matches clientId
   - If no deals found, return null (unauthorized)
4. Fetch client (investor) user details
5. Fetch investor questionnaire if exists (for profile info)
6. Get all deals between this provider and client, enriched with:
   - Property info (title, city, priceUsd, images)
   - Current stage
   - Created date
   - Other assigned providers (broker/mortgage_advisor/lawyer names)
7. Sort deals by createdAt descending

Return type:
```typescript
{
  client: {
    _id: Id<"users">;
    name: string | undefined;
    email: string | undefined;
    imageUrl: string | undefined;
  };
  questionnaire: { ... } | null;  // investorQuestionnaire data if exists
  deals: Array<{
    _id: Id<"deals">;
    stage: string;
    createdAt: number;
    property: { _id, title, city, priceUsd, images } | null;
    providers: {
      broker: { name, imageUrl } | null;
      mortgageAdvisor: { name, imageUrl } | null;
      lawyer: { name, imageUrl } | null;
    };
  }>;
  stats: {
    totalDeals: number;
    activeDeals: number;
    completedDeals: number;
    totalValue: number;
  };
}
```
  </action>
  <verify>npx convex dev --once passes, npm run build passes</verify>
  <done>getClientDetails query returns full client profile with deal history and statistics</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` passes without errors
- [ ] `npm run build` passes without TypeScript errors
- [ ] Both queries are exported from convex/clients.ts
- [ ] Queries handle all 3 provider roles correctly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Queries ready for frontend consumption
</success_criteria>

<output>
After completion, create `.planning/phases/17-client-management/17-01-SUMMARY.md`
</output>
