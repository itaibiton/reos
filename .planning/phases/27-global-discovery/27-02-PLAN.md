---
phase: 27-global-discovery
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/trending.ts
  - convex/recommendations.ts
autonomous: true

must_haves:
  truths:
    - "Trending posts query returns posts sorted by engagement velocity"
    - "Trending supports 'today' and 'week' time windows"
    - "People to follow suggestions exclude already-followed users"
    - "Recommendations consider user role for relevance"
  artifacts:
    - path: "convex/trending.ts"
      provides: "Trending posts with time-decay scoring"
      exports: ["getTrendingPosts", "getTrendingProperties"]
    - path: "convex/recommendations.ts"
      provides: "Personalized recommendations"
      exports: ["suggestedUsers", "suggestedPosts"]
  key_links:
    - from: "convex/trending.ts"
      to: "convex/schema.ts"
      via: "posts query with visibility index"
      pattern: "by_visibility_and_time"
    - from: "convex/recommendations.ts"
      to: "convex/userFollows"
      via: "follows query for exclusion"
      pattern: "by_follower"
---

<objective>
Create trending content queries using Hacker News time-decay algorithm. Implement personalized recommendations for people to follow and suggested posts based on user role and engagement.

Purpose: Surface interesting content and users for discovery beyond chronological feeds.
Output: trending.ts with time-decay scored queries, recommendations.ts with role-based suggestions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-global-discovery/27-CONTEXT.md
@.planning/phases/27-global-discovery/27-RESEARCH.md
@convex/posts.ts
@convex/userFollows.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trending content queries</name>
  <files>convex/trending.ts</files>
  <action>
Create new file `convex/trending.ts` with:

1. Helper function for time-decay score (Hacker News formula):
```typescript
function calculateTrendingScore(
  engagementCount: number,
  createdAt: number,
  gravity: number = 1.8
): number {
  const hoursSinceCreation = (Date.now() - createdAt) / (1000 * 60 * 60);
  // HN formula: (P-1) / (T+2)^G
  // Using max(0, ...) to prevent negative scores from 0-engagement posts
  return Math.max(0, engagementCount - 1) / Math.pow(hoursSinceCreation + 2, gravity);
}
```

2. `getTrendingPosts` query:
- Args: `{ timeWindow: v.union(v.literal("today"), v.literal("week")), limit: v.optional(v.number()) }`
- Default limit: 10
- Calculate cutoff time based on window (24h or 7 days)
- Query public posts within time window using `by_visibility_and_time` index
- Over-fetch (take 100) to have enough for scoring
- Calculate trending score for each post: `likeCount + commentCount + saveCount`
- Sort by score descending
- Return top N posts enriched with author info (reuse enrichPost pattern from posts.ts)

3. `getTrendingProperties` query:
- Args: `{ timeWindow: v.union(v.literal("today"), v.literal("week")), limit: v.optional(v.number()) }`
- Default limit: 10
- Query available properties created within time window
- Score based on: number of favorites + deal count (if any)
- To get favorites count: query favorites table with `by_property` index, count results
- Sort by score and return

4. Both queries require authentication (return empty array for unauthenticated).

Note: Real-time computation is fine for MVP per research. Cache if performance becomes issue later.
  </action>
  <verify>
Test in Convex dashboard:
- `api.trending.getTrendingPosts({ timeWindow: "today" })` returns up to 10 posts
- Posts with more recent engagement rank higher
- `api.trending.getTrendingPosts({ timeWindow: "week" })` includes older posts
  </verify>
  <done>
trending.ts has getTrendingPosts and getTrendingProperties queries using time-decay scoring. Both filter by time window and return enriched results.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create personalized recommendations queries</name>
  <files>convex/recommendations.ts</files>
  <action>
Create new file `convex/recommendations.ts` with:

1. `suggestedUsers` query (People to follow):
- Args: `{ limit: v.optional(v.number()) }`
- Default limit: 5
- Get current user and their follows
- Build candidate set from:
  a) Users with same role (using by_role index)
  b) Users followed by people current user follows (friends-of-friends)
- Score candidates: +2 for friends-of-friends, +1 for same role
- Filter out: self, already following, users without onboardingComplete
- Sort by score, return top N with user info (name, imageUrl, role)

2. `suggestedPosts` query (Posts you might like):
- Args: `{ limit: v.optional(v.number()) }`
- Default limit: 5
- Strategy: Recent popular posts from same-role users OR posts with high engagement
- Query recent public posts (last 7 days)
- Filter to posts by users with same role as current user
- Sort by engagement (likeCount + commentCount)
- Return enriched posts (reuse enrichPost pattern)

3. Helper to get current user (extract from existing patterns):
```typescript
async function getCurrentUser(ctx: QueryCtx) {
  const identity = await ctx.auth.getUserIdentity();
  if (!identity) return null;
  return ctx.db
    .query("users")
    .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
    .unique();
}
```

4. All queries require authentication.
  </action>
  <verify>
Test in Convex dashboard:
- `api.recommendations.suggestedUsers({})` returns users not already followed
- Results include users with same role
- `api.recommendations.suggestedPosts({})` returns relevant posts
  </verify>
  <done>
recommendations.ts has suggestedUsers (people to follow) and suggestedPosts queries. Both use role-based filtering and exclude already-engaged content.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev` runs without errors
2. getTrendingPosts returns posts sorted by trending score
3. Time windows correctly filter content
4. suggestedUsers excludes self and already-followed
5. suggestedPosts returns role-relevant content
</verification>

<success_criteria>
- Trending posts ranked by engagement velocity with time decay
- Both "today" and "week" windows return appropriate content
- Suggested users filtered to exclude followed users and self
- Recommendations personalized by user role
</success_criteria>

<output>
After completion, create `.planning/phases/27-global-discovery/27-02-SUMMARY.md`
</output>
