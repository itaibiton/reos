---
phase: 27-global-discovery
plan: 03
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/components/search/GlobalSearchBar.tsx
  - src/components/search/SearchAutocomplete.tsx
  - src/components/search/index.ts
  - src/components/layout/AppShell.tsx
autonomous: true

must_haves:
  truths:
    - "Search bar visible in app header for all authenticated users"
    - "Typing in search bar shows autocomplete dropdown"
    - "Autocomplete shows matching users, posts, properties"
    - "Clicking result navigates to appropriate page"
    - "Pressing Enter navigates to full search results page"
    - "Search is debounced (300ms delay)"
  artifacts:
    - path: "src/components/search/GlobalSearchBar.tsx"
      provides: "Header search input with debounced query"
      min_lines: 50
    - path: "src/components/search/SearchAutocomplete.tsx"
      provides: "Dropdown showing search results and recent searches"
      min_lines: 100
    - path: "src/components/search/index.ts"
      provides: "Barrel export"
      exports: ["GlobalSearchBar", "SearchAutocomplete"]
    - path: "src/components/layout/AppShell.tsx"
      provides: "Header with GlobalSearchBar integrated"
      contains: "GlobalSearchBar"
  key_links:
    - from: "src/components/search/GlobalSearchBar.tsx"
      to: "convex/globalSearch.ts"
      via: "useQuery with skip pattern"
      pattern: "api.globalSearch.search"
    - from: "src/components/search/SearchAutocomplete.tsx"
      to: "convex/searchHistory.ts"
      via: "useQuery and useMutation"
      pattern: "api.searchHistory"
---

<objective>
Create always-visible search bar in the app header with debounced autocomplete. Shows matching users, posts, and properties as user types. Includes recent search history in suggestions.

Purpose: Enable quick discovery without leaving current page - the primary search entry point.
Output: GlobalSearchBar component in header, SearchAutocomplete dropdown with grouped results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-global-discovery/27-CONTEXT.md
@.planning/phases/27-global-discovery/27-RESEARCH.md
@src/components/layout/AppShell.tsx
@convex/globalSearch.ts (from Plan 01)
@convex/searchHistory.ts (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GlobalSearchBar component</name>
  <files>src/components/search/GlobalSearchBar.tsx</files>
  <action>
Create `src/components/search/GlobalSearchBar.tsx`:

1. Imports:
```typescript
"use client";

import { useState, useCallback, useMemo, useRef, useEffect } from "react";
import { useRouter } from "next/navigation";
import debounce from "lodash.debounce";
import { useQuery, useMutation } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Input } from "@/components/ui/input";
import { Search } from "lucide-react";
import { SearchAutocomplete } from "./SearchAutocomplete";
```

2. Component structure:
- `inputValue` state for controlled input
- `searchQuery` state for debounced query (what actually triggers search)
- `isOpen` state for autocomplete dropdown visibility
- useRef for input element (focus management)

3. Debounce implementation (per RESEARCH.md):
```typescript
const debouncedSearch = useMemo(
  () => debounce((value: string) => setSearchQuery(value), 300),
  []
);
```

4. Query with skip pattern (per CONTEXT.md - 1 char minimum):
```typescript
const results = useQuery(
  api.globalSearch.search,
  searchQuery.length >= 1 ? { query: searchQuery } : "skip"
);
```

5. Recent searches query (for empty state):
```typescript
const recentSearches = useQuery(api.searchHistory.getRecentSearches, {});
```

6. Event handlers:
- `handleChange`: Update inputValue, call debouncedSearch if >= 1 char
- `handleSubmit`: Navigate to `/search?q=${inputValue}` on Enter
- `handleFocus`: Open dropdown
- `handleBlur`: Close dropdown (with delay for click handling)
- `handleResultClick`: Navigate and close dropdown

7. UI structure:
- Relative container for dropdown positioning
- Search icon (lucide Search) on left
- Input with placeholder "Search users, posts, properties..."
- SearchAutocomplete as absolute-positioned dropdown below
- Keyboard support: Enter to submit, Escape to close

8. Styling:
- Width: w-64 md:w-80 (responsive)
- Height: h-9 (matches other header elements)
- Border and rounded styling consistent with design system
  </action>
  <verify>
Component compiles without errors. Debounce logic prevents excessive queries.
  </verify>
  <done>
GlobalSearchBar has debounced input, skip pattern query, Enter to submit, dropdown toggle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SearchAutocomplete dropdown component</name>
  <files>src/components/search/SearchAutocomplete.tsx</files>
  <action>
Create `src/components/search/SearchAutocomplete.tsx`:

1. Props interface:
```typescript
interface SearchAutocompleteProps {
  results: {
    posts: Array<{ _id: string; content: string; postType: string }>;
    users: Array<{ _id: string; name: string; imageUrl?: string; role?: string }>;
    properties: Array<{ _id: string; title: string; city: string; priceUsd: number; featuredImage?: string }>;
  } | undefined;
  recentSearches: Array<{ _id: string; query: string }> | undefined;
  searchQuery: string;
  onResultClick: (type: "post" | "user" | "property" | "search", id: string, query?: string) => void;
  onClearRecent: (id: string) => void;
  isLoading: boolean;
}
```

2. Sections to display:
- If searchQuery is empty: Show "Recent Searches" section
- If searchQuery has results: Show grouped sections (Users, Posts, Properties)
- If no results: Show "No results found" with suggestions link

3. Result item components (inline or small helpers):
- UserResult: Avatar (32px), name, role badge
- PostResult: Post type icon, content preview (truncated), timestamp
- PropertyResult: Thumbnail (40x40), title, city, price

4. Recent search items:
- Clock icon, query text
- X button to delete (calls onClearRecent)
- Clicking navigates to /search?q=query

5. Section headers:
- "Recent Searches", "Users", "Posts", "Properties"
- Use text-xs text-muted-foreground uppercase tracking-wide

6. Styling:
- Absolute positioned: absolute top-full left-0 right-0 mt-1
- Card-like: bg-popover border rounded-md shadow-lg
- Max height with scroll: max-h-[400px] overflow-y-auto
- Dividers between sections
- Hover states on items: bg-accent

7. Loading state:
- Show skeleton items while results loading

8. Navigation targets per CONTEXT.md:
- Users: `/profile/${userId}`
- Posts: `/feed/post/${postId}` (post detail page)
- Properties: `/properties/${propertyId}`
- Recent search: `/search?q=${query}`
  </action>
  <verify>
Component renders sections correctly. Click handlers fire with correct parameters.
  </verify>
  <done>
SearchAutocomplete shows grouped results, recent searches, handles navigation clicks. Loading and empty states implemented.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create barrel export and integrate into AppShell header</name>
  <files>src/components/search/index.ts, src/components/layout/AppShell.tsx</files>
  <action>
1. Create `src/components/search/index.ts`:
```typescript
export { GlobalSearchBar } from "./GlobalSearchBar";
export { SearchAutocomplete } from "./SearchAutocomplete";
```

2. Update `src/components/layout/AppShell.tsx`:

a) Add import at top:
```typescript
import { GlobalSearchBar } from "@/components/search";
```

b) In the header section (between SidebarTrigger/Breadcrumbs and auth section), add GlobalSearchBar:
- Position it in the center of the header (flex-1 with justify-center)
- Only show for authenticated users (wrap in Authenticated component)

c) Update header layout structure:
```tsx
<header className="flex h-16 shrink-0 items-center justify-between border-b px-4">
  {/* Left: Sidebar trigger + breadcrumbs */}
  <div className="flex items-center gap-2">
    <SidebarTrigger className="-ml-1" />
    <Separator orientation="vertical" className="mr-2 h-4" />
    {/* Breadcrumbs... */}
  </div>

  {/* Center: Global search (authenticated only) */}
  <Authenticated>
    <div className="flex-1 flex justify-center px-4">
      <GlobalSearchBar />
    </div>
  </Authenticated>

  {/* Right: Auth section */}
  <div className="flex items-center">
    {/* Existing auth content... */}
  </div>
</header>
```

d) Note: Keep the existing InvestorSearchBar for /properties page - it has property-specific filters. The GlobalSearchBar is for global discovery across all content types.

3. Add breadcrumb config for search page:
```typescript
"/search": { label: "Search" },
```
  </action>
  <verify>
Run `npm run dev`. Navigate to any authenticated page. Search bar appears in header. Typing shows autocomplete. Enter navigates to /search?q=query.
  </verify>
  <done>
GlobalSearchBar visible in header for authenticated users. Autocomplete works. Enter submits to search page. Barrel export complete.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` - no compilation errors
2. Search bar visible in header on all authenticated pages
3. Typing triggers debounced search (check network - 300ms delay)
4. Results show in grouped dropdown
5. Clicking user goes to /profile/[id]
6. Clicking property goes to /properties/[id]
7. Pressing Enter goes to /search?q=query
8. Recent searches shown when input empty
</verification>

<success_criteria>
- Search bar always visible in authenticated header
- Debounced search (300ms) with 1-char minimum
- Autocomplete shows users, posts, properties grouped
- Recent searches shown when empty
- Navigation works for all result types
- Enter key submits to full search page
</success_criteria>

<output>
After completion, create `.planning/phases/27-global-discovery/27-03-SUMMARY.md`
</output>
