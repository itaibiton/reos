---
phase: 27-global-discovery
plan: 04
type: execute
wave: 2
depends_on: ["27-01", "27-02"]
files_modified:
  - src/app/(app)/search/page.tsx
  - src/components/search/SearchResults.tsx
  - src/components/search/SearchResultCard.tsx
  - src/components/search/index.ts
autonomous: true

must_haves:
  truths:
    - "Search page shows full results for query from URL"
    - "Results grouped by type with tabs to filter"
    - "Pagination via infinite scroll"
    - "Empty results show suggestions (trending content)"
    - "Filters available for date range and user role"
  artifacts:
    - path: "src/app/(app)/search/page.tsx"
      provides: "Full search results page"
      min_lines: 100
    - path: "src/components/search/SearchResults.tsx"
      provides: "Results display with tabs and filters"
      min_lines: 80
    - path: "src/components/search/SearchResultCard.tsx"
      provides: "Individual result rendering by type"
      min_lines: 60
  key_links:
    - from: "src/app/(app)/search/page.tsx"
      to: "convex/globalSearch.ts"
      via: "useQuery for searchFull"
      pattern: "api.globalSearch.searchFull"
    - from: "src/app/(app)/search/page.tsx"
      to: "convex/trending.ts"
      via: "useQuery for empty state"
      pattern: "api.trending"
---

<objective>
Create full search results page at /search with query from URL params. Display results in tabbed interface (All/Users/Posts/Properties), with filters and infinite scroll pagination. Show trending content when no results.

Purpose: Comprehensive search experience after user submits from autocomplete or enters URL directly.
Output: /search page with SearchResults component, tabbed filtering, pagination.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-global-discovery/27-CONTEXT.md
@.planning/phases/27-global-discovery/27-RESEARCH.md
@src/app/(app)/feed/page.tsx
@convex/globalSearch.ts (from Plan 01)
@convex/trending.ts (from Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SearchResultCard component for individual results</name>
  <files>src/components/search/SearchResultCard.tsx</files>
  <action>
Create `src/components/search/SearchResultCard.tsx`:

1. Union type for results:
```typescript
type SearchResult =
  | { resultType: "user"; _id: string; name: string; imageUrl?: string; role?: string }
  | { resultType: "post"; _id: string; content: string; postType: string; authorName: string; authorImageUrl?: string; createdAt: number }
  | { resultType: "property"; _id: string; title: string; city: string; priceUsd: number; featuredImage?: string };
```

2. Props: `{ result: SearchResult }`

3. Render based on resultType using switch:

**User card:**
- Avatar (48px), name (font-semibold), role badge
- Link to /profile/[id]
- Hover: bg-accent transition

**Post card:**
- Author avatar (32px) + name + relative time
- Post type badge (property_listing/service_request/discussion)
- Content preview (2 lines truncate)
- Link to /feed/post/[id]
- Engagement stats: likes, comments (inline icons)

**Property card:**
- Image thumbnail (80x60) with fallback
- Title (font-semibold), city
- Price (formatted $X,XXX,XXX or $XXXK)
- Link to /properties/[id]
- Status badge if available

4. Use Card component from shadcn for consistent styling
5. All cards clickable with proper Link wrapper
  </action>
  <verify>
Component renders correctly for each result type. Links navigate to correct routes.
  </verify>
  <done>
SearchResultCard renders user, post, and property results with appropriate layouts and links.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SearchResults component with tabs and filters</name>
  <files>src/components/search/SearchResults.tsx</files>
  <action>
Create `src/components/search/SearchResults.tsx`:

1. Props interface:
```typescript
interface SearchResultsProps {
  query: string;
  initialType?: "all" | "user" | "post" | "property";
}
```

2. State management:
- `activeTab` for type filter (synced to URL params)
- Router for updating URL params on tab change

3. Query using searchFull from Plan 01:
```typescript
const results = useQuery(
  api.globalSearch.searchFull,
  query ? { query, type: activeTab === "all" ? undefined : activeTab } : "skip"
);
```

4. Tab structure (per CONTEXT.md):
```tsx
<Tabs value={activeTab} onValueChange={handleTabChange}>
  <TabsList className="grid w-full grid-cols-4">
    <TabsTrigger value="all">All</TabsTrigger>
    <TabsTrigger value="user">Users</TabsTrigger>
    <TabsTrigger value="post">Posts</TabsTrigger>
    <TabsTrigger value="property">Properties</TabsTrigger>
  </TabsList>
</Tabs>
```

5. Results display:
- For "all" tab: Show sections with headers (Users, Posts, Properties)
- For specific tab: Show flat list of that type
- Use SearchResultCard for each item
- Loading state: 3 skeleton cards

6. Empty state (per CONTEXT.md):
- "No results found for '{query}'"
- Suggest checking spelling
- Show trending content below as "Discover what's trending"

7. Result counts in tab badges:
- Show count next to each tab name if results exist
- Format: "Users (5)"
  </action>
  <verify>
Tabs switch correctly. Results filter by type. Empty state shows suggestions.
  </verify>
  <done>
SearchResults has tabbed filtering, displays results by type, shows empty state with suggestions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create search page and update barrel export</name>
  <files>src/app/(app)/search/page.tsx, src/components/search/index.ts</files>
  <action>
1. Create `src/app/(app)/search/page.tsx`:

```typescript
"use client";

import { useSearchParams } from "next/navigation";
import { useQuery, useMutation } from "convex/react";
import { useEffect } from "react";
import { api } from "@/convex/_generated/api";
import { SearchResults } from "@/components/search";

export default function SearchPage() {
  const searchParams = useSearchParams();
  const query = searchParams.get("q") || "";
  const type = searchParams.get("type") as "all" | "user" | "post" | "property" | null;

  // Save search to history when query changes
  const saveSearch = useMutation(api.searchHistory.saveSearch);

  useEffect(() => {
    if (query.length >= 1) {
      // Save with resultCount 0 initially, could update after results load
      saveSearch({ query, resultCount: 0 });
    }
  }, [query, saveSearch]);

  return (
    <div className="max-w-4xl mx-auto p-6 space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-2xl font-bold">Search Results</h1>
        {query && (
          <p className="text-muted-foreground mt-1">
            Showing results for "{query}"
          </p>
        )}
      </div>

      {/* Results or empty state */}
      {query ? (
        <SearchResults query={query} initialType={type ?? "all"} />
      ) : (
        <div className="text-center py-12">
          <p className="text-muted-foreground">
            Enter a search term to find users, posts, and properties.
          </p>
        </div>
      )}
    </div>
  );
}
```

2. Update `src/components/search/index.ts`:
```typescript
export { GlobalSearchBar } from "./GlobalSearchBar";
export { SearchAutocomplete } from "./SearchAutocomplete";
export { SearchResults } from "./SearchResults";
export { SearchResultCard } from "./SearchResultCard";
```

3. The breadcrumb config was already added in Plan 03. Verify it exists:
```typescript
"/search": { label: "Search" },
```
  </action>
  <verify>
Navigate to /search?q=test. Page loads with results. Tabs work. Search is saved to history.
  </verify>
  <done>
Search page at /search displays results for query. Search saved to history. Barrel export updated.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` - no compilation errors
2. /search?q=test shows results
3. Tabs filter results by type
4. Tab badges show result counts
5. Empty results show trending suggestions
6. Clicking result navigates to correct page
7. Search query saved to history
</verification>

<success_criteria>
- /search page loads and parses query from URL
- Tabbed interface filters results (All/Users/Posts/Properties)
- Results displayed with appropriate cards per type
- Empty state shows trending content suggestions
- Search queries saved to history on page load
</success_criteria>

<output>
After completion, create `.planning/phases/27-global-discovery/27-04-SUMMARY.md`
</output>
