---
phase: 27-global-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/globalSearch.ts
  - convex/searchHistory.ts
autonomous: true

must_haves:
  truths:
    - "Search index on posts.content returns matching posts"
    - "Search index on users.name returns matching users"
    - "Search index on properties.title returns matching properties"
    - "Unified search query returns results from all three tables"
    - "User search history is saved server-side"
    - "Recent searches appear in autocomplete suggestions"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Search indexes on posts, users, properties + searchHistory table"
      contains: "searchIndex"
    - path: "convex/globalSearch.ts"
      provides: "Unified search query across tables"
      exports: ["search", "searchFull"]
    - path: "convex/searchHistory.ts"
      provides: "Search history mutations and queries"
      exports: ["saveSearch", "getRecentSearches", "deleteSearch"]
  key_links:
    - from: "convex/globalSearch.ts"
      to: "convex/schema.ts"
      via: "withSearchIndex calls"
      pattern: "withSearchIndex.*search_"
---

<objective>
Add search indexes to enable full-text search across posts, users, and properties. Create unified search query that returns combined results. Implement server-side search history for autocomplete suggestions.

Purpose: Foundation for global discovery - without search indexes, no text search is possible in Convex.
Output: Schema with search indexes, globalSearch.ts with unified search query, searchHistory.ts for user history.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-global-discovery/27-CONTEXT.md
@.planning/phases/27-global-discovery/27-RESEARCH.md
@convex/schema.ts
@convex/posts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search indexes and searchHistory table to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add search indexes to existing tables:

1. Add search index to `posts` table:
```typescript
.searchIndex("search_content", {
  searchField: "content",
  filterFields: ["postType", "visibility"],
})
```

2. Add search index to `users` table:
```typescript
.searchIndex("search_name", {
  searchField: "name",
  filterFields: ["role", "onboardingComplete"],
})
```

3. Add search index to `properties` table:
```typescript
.searchIndex("search_title", {
  searchField: "title",
  filterFields: ["status", "city"],
})
```

4. Add new `searchHistory` table AFTER the postComments table:
```typescript
// Search history - user search queries for autocomplete
searchHistory: defineTable({
  userId: v.id("users"),
  query: v.string(),
  resultCount: v.number(),
  createdAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_user_and_time", ["userId", "createdAt"]),
```

Note: Convex search indexes support exactly 1 search field per index. Stick with title search for properties - it's the primary identifier users search for.
  </action>
  <verify>
Run `npx convex dev` - should see schema update with new indexes being created. No errors about search index configuration.
  </verify>
  <done>
Schema has search indexes on posts.content, users.name, properties.title. searchHistory table exists with by_user and by_user_and_time indexes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unified global search queries</name>
  <files>convex/globalSearch.ts</files>
  <action>
Create new file `convex/globalSearch.ts` with:

1. Import required modules:
```typescript
import { query } from "./_generated/server";
import { v } from "convex/values";
```

2. Create `search` query for autocomplete (limited results):
- Args: `{ query: v.string(), limit: v.optional(v.number()) }`
- Default limit: 5 per category
- Search all three tables in parallel using Promise.all
- For posts: use `withSearchIndex("search_content", ...)` with `.eq("visibility", "public")`
- For users: use `withSearchIndex("search_name", ...)` with `.eq("onboardingComplete", true)`
- For properties: use `withSearchIndex("search_title", ...)` with `.eq("status", "available")`
- Use `.take(limit)` on each query
- Return grouped results:
```typescript
return {
  posts: posts.map(p => ({
    _id: p._id,
    content: p.content.slice(0, 100), // Preview
    postType: p.postType,
    resultType: "post" as const,
  })),
  users: users.map(u => ({
    _id: u._id,
    name: u.name,
    imageUrl: u.imageUrl,
    role: u.role,
    resultType: "user" as const,
  })),
  properties: properties.map(p => ({
    _id: p._id,
    title: p.title,
    city: p.city,
    priceUsd: p.priceUsd,
    featuredImage: p.featuredImage,
    resultType: "property" as const,
  })),
};
```

3. Create `searchFull` query for full results page (paginated):
- Args: `{ query: v.string(), type: v.optional(v.union(...)), limit: v.optional(v.number()) }`
- Type can be "post", "user", "property", or undefined for all
- Larger default limit (20) with pagination support
- Enrich posts with author info (like globalFeed does)
- Enrich properties with full details needed for cards

4. Authentication pattern: Query should work for authenticated users only (follow existing posts.ts pattern).
  </action>
  <verify>
After `npx convex dev`, test in Convex dashboard:
- `api.globalSearch.search({ query: "test" })` returns grouped results
- Results are limited to 5 per category
- Only public posts and available properties returned
  </verify>
  <done>
globalSearch.ts has search (autocomplete) and searchFull (results page) queries. Both use withSearchIndex for efficient text search.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create search history mutations and queries</name>
  <files>convex/searchHistory.ts</files>
  <action>
Create new file `convex/searchHistory.ts` with:

1. `saveSearch` mutation:
- Args: `{ query: v.string(), resultCount: v.number() }`
- Get current user (follow existing auth pattern)
- Deduplicate: check if same query exists for user, update timestamp if so (upsert pattern)
- If new, insert record
- Limit history to 20 entries per user (delete oldest if over limit)

2. `getRecentSearches` query:
- Args: `{ limit: v.optional(v.number()) }`
- Default limit: 5
- Return user's recent searches, newest first
- Use by_user_and_time index with desc order

3. `deleteSearch` mutation:
- Args: `{ searchId: v.id("searchHistory") }`
- Verify ownership (user can only delete own searches)
- Delete the record

4. `clearSearchHistory` mutation:
- No args
- Delete all search history for current user

All mutations/queries require authentication. Follow existing auth pattern from posts.ts (getUserIdentity + query users by clerk_id).
  </action>
  <verify>
Test in Convex dashboard:
- `api.searchHistory.saveSearch({ query: "tel aviv", resultCount: 5 })` succeeds
- `api.searchHistory.getRecentSearches({})` returns the saved search
- Saving same query again updates timestamp (no duplicate)
  </verify>
  <done>
searchHistory.ts has saveSearch, getRecentSearches, deleteSearch, clearSearchHistory. Deduplication works. History limited to 20 per user.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev` runs without errors
2. Schema shows search indexes on posts, users, properties
3. searchHistory table created with indexes
4. globalSearch.search returns results grouped by type
5. searchHistory saves and retrieves searches correctly
</verification>

<success_criteria>
- Search indexes active on posts.content, users.name, properties.title
- globalSearch.search returns {posts, users, properties} from single query
- Search history saves with deduplication and 20-item limit
- All queries authenticated (return empty for unauthenticated)
</success_criteria>

<output>
After completion, create `.planning/phases/27-global-discovery/27-01-SUMMARY.md`
</output>
