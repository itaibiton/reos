---
phase: 27-global-discovery
plan: 05
type: execute
wave: 3
depends_on: ["27-02", "27-04"]
files_modified:
  - src/components/discovery/TrendingSection.tsx
  - src/components/discovery/PeopleToFollow.tsx
  - src/components/discovery/index.ts
  - src/app/(app)/feed/page.tsx
autonomous: true

must_haves:
  truths:
    - "Trending section shows posts ranked by engagement velocity"
    - "People to follow shows relevant user suggestions"
    - "Trending toggles between Today and This Week"
    - "Follow button works directly from suggestions"
    - "Feed page has discovery widgets in sidebar"
  artifacts:
    - path: "src/components/discovery/TrendingSection.tsx"
      provides: "Trending posts widget"
      min_lines: 60
    - path: "src/components/discovery/PeopleToFollow.tsx"
      provides: "User suggestions widget"
      min_lines: 50
    - path: "src/components/discovery/index.ts"
      provides: "Barrel export"
      exports: ["TrendingSection", "PeopleToFollow"]
    - path: "src/app/(app)/feed/page.tsx"
      provides: "Feed page with discovery sidebar"
      contains: "TrendingSection"
  key_links:
    - from: "src/components/discovery/TrendingSection.tsx"
      to: "convex/trending.ts"
      via: "useQuery"
      pattern: "api.trending.getTrendingPosts"
    - from: "src/components/discovery/PeopleToFollow.tsx"
      to: "convex/recommendations.ts"
      via: "useQuery"
      pattern: "api.recommendations.suggestedUsers"
---

<objective>
Create discovery widgets for trending content and user recommendations. Integrate into feed page as sidebar widgets for broader screen sizes.

Purpose: Passive discovery - users see trending/recommended content without actively searching.
Output: TrendingSection and PeopleToFollow widgets, integrated into feed page layout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-global-discovery/27-CONTEXT.md
@.planning/phases/27-global-discovery/27-RESEARCH.md
@src/app/(app)/feed/page.tsx
@convex/trending.ts (from Plan 02)
@convex/recommendations.ts (from Plan 02)
@src/components/feed/FollowButton.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TrendingSection widget</name>
  <files>src/components/discovery/TrendingSection.tsx</files>
  <action>
Create `src/components/discovery/TrendingSection.tsx`:

1. Imports:
```typescript
"use client";

import { useState } from "react";
import Link from "next/link";
import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Skeleton } from "@/components/ui/skeleton";
import { TrendingUp } from "lucide-react";
```

2. Component:
```typescript
export function TrendingSection() {
  const [timeWindow, setTimeWindow] = useState<"today" | "week">("today");

  const trendingPosts = useQuery(api.trending.getTrendingPosts, {
    timeWindow,
    limit: 5,
  });

  // ... render
}
```

3. UI structure:
- Card wrapper with "Trending" header and TrendingUp icon
- Small tabs toggle: Today / This Week
- List of trending posts (5 items):
  - Rank number (#1, #2, etc.)
  - Post preview: author avatar (24px), author name, truncated content (1 line)
  - Engagement indicator (small flame icon + count)
  - Link to /feed/post/[id]
- Loading state: 5 skeleton items

4. Compact styling for sidebar widget:
- Card with p-4
- Items with py-2 border-b last:border-0
- text-sm for content
- Hover state on items

5. Empty state:
- "No trending posts yet"
- Subtle text, no action needed
  </action>
  <verify>
Component shows trending posts. Tab switches between time windows. Links work.
  </verify>
  <done>
TrendingSection displays top 5 trending posts with time window toggle and rank indicators.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PeopleToFollow widget</name>
  <files>src/components/discovery/PeopleToFollow.tsx</files>
  <action>
Create `src/components/discovery/PeopleToFollow.tsx`:

1. Imports:
```typescript
"use client";

import Link from "next/link";
import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { UserPlus } from "lucide-react";
import { FollowButton } from "@/components/feed";
```

2. Component:
```typescript
export function PeopleToFollow() {
  const suggestedUsers = useQuery(api.recommendations.suggestedUsers, {
    limit: 3,
  });

  // ... render
}
```

3. UI structure:
- Card wrapper with "Suggested for you" header and UserPlus icon
- List of suggested users (3 items):
  - Avatar (40px)
  - Name (font-medium) + role badge (text-xs)
  - FollowButton (compact variant, small size)
  - Link wrapper around avatar/name to /profile/[id]
- Loading state: 3 skeleton items

4. Each user item layout:
```tsx
<div className="flex items-center justify-between py-2">
  <Link href={`/profile/${user._id}`} className="flex items-center gap-3">
    <Avatar className="h-10 w-10">
      <AvatarImage src={user.imageUrl} />
      <AvatarFallback>{user.name?.[0] || "?"}</AvatarFallback>
    </Avatar>
    <div>
      <p className="font-medium text-sm">{user.name}</p>
      <Badge variant="secondary" className="text-xs">{formatRole(user.role)}</Badge>
    </div>
  </Link>
  <FollowButton userId={user._id} size="sm" />
</div>
```

5. Helper for role formatting:
```typescript
function formatRole(role?: string) {
  const labels: Record<string, string> = {
    investor: "Investor",
    broker: "Broker",
    mortgage_advisor: "Mortgage Advisor",
    lawyer: "Lawyer",
  };
  return labels[role || ""] || "User";
}
```

6. Empty state:
- "No suggestions right now"
- Check back later message
  </action>
  <verify>
Component shows 3 suggested users. FollowButton works. Profile links work.
  </verify>
  <done>
PeopleToFollow displays 3 user suggestions with follow buttons and profile links.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create barrel export and integrate into feed page</name>
  <files>src/components/discovery/index.ts, src/app/(app)/feed/page.tsx</files>
  <action>
1. Create `src/components/discovery/index.ts`:
```typescript
export { TrendingSection } from "./TrendingSection";
export { PeopleToFollow } from "./PeopleToFollow";
```

2. Update `src/app/(app)/feed/page.tsx` to include discovery sidebar:

a) Add imports:
```typescript
import { TrendingSection, PeopleToFollow } from "@/components/discovery";
```

b) Change layout from single column to two columns on large screens:
- Main feed: left column (flex-1 or lg:w-2/3)
- Discovery sidebar: right column (lg:w-1/3, sticky)
- On small screens: single column, no sidebar (hidden lg:block)

c) Updated structure:
```tsx
<div className="max-w-5xl mx-auto p-6">
  <div className="lg:flex lg:gap-6">
    {/* Main feed column */}
    <div className="flex-1 space-y-6">
      {/* Existing header, tabs, posts list */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Feed</h1>
        <Button onClick={() => setDialogOpen(true)} className="gap-2">
          <HugeiconsIcon icon={Add01Icon} size={16} />
          Create Post
        </Button>
      </div>

      {/* Feed Source Tabs */}
      {/* Post Type Filter Tabs */}
      {/* Posts list / empty state / loading */}
      {/* Load more button */}
    </div>

    {/* Discovery sidebar - hidden on mobile */}
    <aside className="hidden lg:block w-80 space-y-6 sticky top-6 self-start">
      <PeopleToFollow />
      <TrendingSection />
    </aside>
  </div>
</div>
```

d) Adjust max-width to accommodate sidebar: change from max-w-2xl to max-w-5xl

e) Keep mobile experience unchanged (widgets hidden)
  </action>
  <verify>
Run `npm run dev`. Feed page shows sidebar on large screens. Widgets display trending posts and user suggestions. Mobile view hides sidebar.
  </verify>
  <done>
Discovery widgets integrated into feed page sidebar. Two-column layout on large screens. Mobile unchanged.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` - no compilation errors
2. Feed page shows two-column layout on lg+ screens
3. TrendingSection shows top 5 posts with time toggle
4. PeopleToFollow shows 3 suggestions with follow buttons
5. Following a user from widget works
6. Mobile view: sidebar hidden, single column feed
7. Clicking trending post navigates to /feed/post/[id]
</verification>

<success_criteria>
- TrendingSection shows posts ranked by engagement with time toggle
- PeopleToFollow shows personalized user suggestions with inline follow
- Feed page has sidebar layout on large screens
- Widgets are responsive (hidden on mobile)
- All navigation links work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/27-global-discovery/27-05-SUMMARY.md`
</output>
