---
phase: 62-context-awareness-help-guidance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/ai/context.ts
  - convex/ai/chat.ts
autonomous: true

must_haves:
  truths:
    - "When a message is sent from a property detail page, the AI system prompt includes that property's title, city, price, type, and status"
    - "When a message is sent from a deal detail page, the AI system prompt includes the deal stage, property name, and provider assignments"
    - "When a message is sent from a list page (dashboard, deals list, property browse), the AI system prompt includes page-level guidance"
    - "Entity resolution fails gracefully -- invalid or unauthorized entity IDs result in null context, not errors"
    - "Help guidance text is injected per pageType so the AI can explain features and guide workflows"
  artifacts:
    - path: "convex/ai/context.ts"
      provides: "buildPageContext internalQuery + entity resolvers + help guidance map"
      exports: ["buildPageContext"]
    - path: "convex/ai/chat.ts"
      provides: "Extended sendMessage args with pageContext, wired to buildPageContext"
  key_links:
    - from: "convex/ai/chat.ts"
      to: "convex/ai/context.ts"
      via: "ctx.runQuery(internal.ai.context.buildPageContext, ...)"
      pattern: "internal\\.ai\\.context\\.buildPageContext"
    - from: "convex/ai/chat.ts"
      to: "systemContext string"
      via: "pageContextString appended after profileContext"
      pattern: "pageContextString"
---

<objective>
Add server-side page context resolution to the AI assistant backend.

Purpose: Enable the AI to know what page and entity the user is viewing, so it can provide contextual responses, help guidance, and page-aware greetings. All entity data is resolved server-side with access control -- the frontend only sends lightweight identifiers.

Output: Extended `sendMessage` action accepting `pageContext` arg, new `buildPageContext` internalQuery resolving entity data from entityType/entityId, and help guidance strings injected per pageType.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-context-awareness-help-guidance/62-RESEARCH.md
@convex/ai/context.ts
@convex/ai/chat.ts
@convex/ai/agent.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add buildPageContext internalQuery to convex/ai/context.ts</name>
  <files>convex/ai/context.ts</files>
  <action>
Add a new exported `buildPageContext` internalQuery below the existing `buildProfileContext`. This function resolves entity data server-side and returns a markdown string for the system prompt.

**Args:**
```typescript
{
  userId: v.id("users"),
  pageType: v.string(),
  entityType: v.optional(v.string()),
  entityId: v.optional(v.string()),
}
```

**Handler logic:**

1. If no `entityType` or no `entityId`, call `buildListPageContext(pageType)` and return the result (a static string or null).

2. If `entityType` and `entityId` are present, switch on `entityType`:
   - `"property"` -> `buildPropertyContext(ctx, entityId)`
   - `"deal"` -> `buildDealContext(ctx, userId, entityId)`
   - `"provider"` -> `buildProviderContext(ctx, entityId)`
   - `"client"` -> `buildClientContext(ctx, userId, entityId)`
   - default -> return `null`

3. After getting the entity context string, append help guidance from `getHelpGuidance(pageType)`.

4. Return the combined string: `entityContext + "\n\n" + helpGuidance` (or just one if the other is null).

**Entity resolver functions (all private, not exported):**

`buildPropertyContext(ctx, entityId)`:
- Validate entityId looks like a Convex ID (has underscore). If not, return null.
- `ctx.db.get(entityId as Id<"properties">)`. If null, return null.
- Return markdown lines: title, location (city + address), price ($X,XXX format), propertyType, status, bedrooms (if present), bathrooms (if present), squareMeters (if present), expectedRoi (if present), capRate (if present), monthlyRent (if present).
- Format: `## Current Page Context\n\nThe user is viewing a property listing:\n- Title: "..."\n- Location: ...\n...`
- End with: `Tailor responses to this property. Offer investment analysis, comparisons, or next steps when relevant.`
- Wrap everything in try/catch, return null on any error.

`buildDealContext(ctx, userId, entityId)`:
- Validate entityId. `ctx.db.get(entityId as Id<"deals">)`. If null, return null.
- **Access check:** Verify `userId` is one of: `deal.investorId`, `deal.brokerId`, `deal.mortgageAdvisorId`, `deal.lawyerId`. If not, return null.
- Get property via `ctx.db.get(deal.propertyId)` for title.
- Return: property title, deal stage, createdAt date, provider assignment status (assigned/not assigned for broker, mortgage advisor, lawyer).
- End with: `Help with deal progression, explain next steps, or answer questions about the ${deal.stage} stage.`
- Wrap in try/catch.

`buildProviderContext(ctx, entityId)`:
- Validate entityId. Query `serviceProviderProfiles` by userId index: `ctx.db.query("serviceProviderProfiles").withIndex("by_user", q => q.eq("userId", entityId as Id<"users">)).unique()`. If null, try `ctx.db.get(entityId as Id<"serviceProviderProfiles">)` as fallback.
- Get user record for name: `ctx.db.get(profile.userId)`.
- Return: provider name, providerType, serviceAreas (joined), yearsExperience, companyName (if present), bio snippet (first 100 chars if present).
- End with: `Help the user evaluate this provider or connect with them.`
- Wrap in try/catch.

`buildClientContext(ctx, userId, entityId)`:
- Validate entityId. Get client user: `ctx.db.get(entityId as Id<"users">)`. If null, return null.
- **Access check:** Query deals where `investorId === entityId` and current user is one of the provider roles. If no deals found where userId is assigned, return null.
- Count deals, list their stages.
- Return: client name, deal count, stages.
- End with: `Help manage this client's deals, review progress, or plan next steps.`
- Wrap in try/catch.

`buildListPageContext(pageType)`:
- Static map returning contextual strings for non-entity pages:
  - `property_browse`: "The user is browsing the property marketplace. Help them search, filter, or understand available properties."
  - `property_saved`: "The user is viewing their saved properties. Help compare or suggest next steps."
  - `property_listings`: "The user is viewing their property listings. Help with listing management."
  - `property_create`: "The user is creating a new property listing. Help with listing best practices, pricing, and required information."
  - `deals_list`: "The user is viewing their deals list. Help with deal status, next steps, or comparisons between deals."
  - `dashboard`: "The user is on the main dashboard. Give portfolio overviews, highlight important updates, or suggest actions."
  - `providers_browse`: "The user is browsing service providers. Help them find the right broker, mortgage advisor, or lawyer."
  - `settings`: "The user is on the settings page. Help with account settings, preferences, or platform features."
  - `onboarding`: "The user is going through onboarding. Help them understand the platform and get started."
  - `onboarding_questionnaire`: "The user is filling out their investor questionnaire. Help them understand each question and why it matters."
  - `onboarding_vendor`: "The user is setting up their vendor profile. Help with profile optimization and best practices."
  - `social_feed`: "The user is viewing the social feed. Help them engage with content or find relevant posts."
  - `messaging`: "The user is in direct messaging. Help with communication tips or platform questions."
  - `analytics`: "The user is viewing analytics. Help interpret data and suggest improvements."
- Return null for unknown pageTypes. All strings start with `## Current Page Context\n\n`.

`getHelpGuidance(pageType)`:
- Static map returning help guidance for the AI:
  - `property_detail`: "If the user asks for help:\n- Explain how to save properties, start deals, and compare listings\n- Mention the mortgage calculator and neighborhood data\n- Offer investment analysis for this specific property"
  - `property_edit`: "If the user asks for help:\n- Guide them through each listing field\n- Suggest pricing strategies and compelling descriptions\n- Explain which fields matter most for buyer visibility"
  - `deal_detail`: "If the user asks for help:\n- Explain the deal stages: interest -> broker_matched -> mortgage -> legal -> closing -> completed\n- Explain what each provider role does (broker, mortgage advisor, lawyer)\n- Guide them on requesting providers and uploading documents"
  - `deals_list`: "If the user asks for help:\n- Explain how deals work on REOS\n- Help prioritize which deal needs attention\n- Explain deal stages and typical timelines"
  - `property_browse`: "If the user asks for help:\n- Explain search filters and how to find matching properties\n- Describe property types and what to look for\n- Suggest starting a deal when they find something interesting"
  - `providers_browse`: "If the user asks for help:\n- Explain the different provider roles and when you need each\n- Help evaluate provider profiles\n- Guide them on requesting a provider for their deal"
  - `dashboard`: "If the user asks for help:\n- Give a tour of the dashboard features\n- Explain key metrics and what they mean\n- Suggest the most important next action based on their status"
  - `onboarding_questionnaire`: "If the user asks for help:\n- Explain why each question matters for property recommendations\n- Help them think through budget, location, and investment goals\n- Reassure them that preferences can be updated later"
- Return null for unknown pageTypes. All strings start with `## Help Guidance\n\n`.
  </action>
  <verify>
Run `npx convex dev --typecheck --once` (or `npx tsc --noEmit` on the convex directory) to confirm no TypeScript errors. Verify the file exports `buildPageContext` as an internalQuery.
  </verify>
  <done>
`buildPageContext` internalQuery exists in `convex/ai/context.ts`, accepts userId/pageType/entityType/entityId, resolves entity data with access control, returns markdown context string with help guidance, and returns null gracefully on errors or unauthorized access.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend sendMessage to accept and use pageContext</name>
  <files>convex/ai/chat.ts</files>
  <action>
Modify the `sendMessage` action in `convex/ai/chat.ts` to accept an optional `pageContext` argument and use it to build page-aware system prompts.

**Step 1: Extend args**

Add to the existing args object:
```typescript
pageContext: v.optional(v.object({
  pageType: v.string(),
  entityType: v.optional(v.string()),
  entityId: v.optional(v.string()),
})),
```

Update the handler destructuring to include `pageContext`.

**Step 2: Add import**

Add `internal` import if not already present (it is already imported via `import { internal, api } from "../_generated/api";`).

**Step 3: Call buildPageContext after buildProfileContext**

After the existing `profileContext` query (around line 63), add:

```typescript
// Load page context (if provided)
let pageContextString: string | null = null;
if (pageContext) {
  try {
    pageContextString = await ctx.runQuery(
      internal.ai.context.buildPageContext,
      {
        userId: user._id,
        pageType: pageContext.pageType,
        entityType: pageContext.entityType,
        entityId: pageContext.entityId,
      }
    );
  } catch {
    // Graceful degradation: assistant works without page context
    pageContextString = null;
  }
}
```

**Step 4: Inject into system prompt**

After the existing `if (profileContext)` block (around line 92), add:

```typescript
if (pageContextString) {
  systemContext += pageContextString + "\n\n";
}
```

This goes BEFORE the summary injection, so the prompt order is: rolePrompt -> profileContext -> pageContext -> summary -> autoGreeting.

**Step 5: Enhance auto-greeting with page awareness**

In the auto-greeting section (around line 136), modify the auto-greeting instructions to mention page context when available. After the existing auto-greeting instructions, add:

```typescript
if (pageContextString && isAutoGreeting) {
  systemContext += `\nIMPORTANT: Your greeting should reference the page context above. If the user is viewing a specific property or deal, mention it in your greeting instead of jumping straight to generic recommendations.\n`;
}
```

Do NOT change the auto-greeting flow otherwise -- just add this hint so the AI naturally incorporates page context into its greeting when relevant.
  </action>
  <verify>
Run `npx convex dev --typecheck --once` to confirm no TypeScript errors. Manually verify that the `sendMessage` function signature now includes `pageContext` as an optional arg. Verify the system prompt construction order: rolePrompt -> profileContext -> pageContext -> summary -> autoGreeting.
  </verify>
  <done>
`sendMessage` action accepts optional `pageContext` object with `pageType`, `entityType`, and `entityId`. It calls `buildPageContext` to resolve entity data server-side. The resolved context string is injected into the system prompt between profile context and conversation summary. Auto-greeting instructions reference page context when available. Any failure in context resolution is caught and gracefully ignored.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx convex dev --typecheck --once`
2. The `sendMessage` action still works without `pageContext` (backward compatible)
3. The `buildPageContext` function returns null for unknown entity types
4. The `buildPageContext` function returns null when entityId is invalid
5. Deal context checks that the requesting user is a participant
</verification>

<success_criteria>
- `buildPageContext` internalQuery exists and resolves property, deal, provider, and client context
- `sendMessage` accepts optional `pageContext` and injects resolved context into system prompt
- Access control enforced: unauthorized entity access returns null, not data
- Graceful degradation: invalid IDs, missing entities, and resolution errors all return null
- Help guidance strings injected per pageType
- Backward compatible: existing calls without pageContext still work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/62-context-awareness-help-guidance/62-01-SUMMARY.md`
</output>
