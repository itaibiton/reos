---
phase: 09-onboarding-gate
plan: 01
type: execute
---

<objective>
Set up onboarding gate infrastructure and progress tracking for investor questionnaire flow.

Purpose: Create the foundation for multi-step investor onboarding while keeping service providers on the simple role-selection path.
Output: Updated schema with progress tracking, backend mutations for progress updates, and role-aware gate logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@questionare.md

**Current onboarding:**
@src/app/(app)/layout.tsx
@src/app/(app)/onboarding/page.tsx
@convex/users.ts
@convex/schema.ts

**Key patterns established:**
- Convex for backend (reactive queries/mutations)
- Clerk for auth (clerkId on users table)
- Role-based routing (investor vs service providers)
- onboardingComplete boolean currently gates all protected routes

**What needs to change:**
The current `onboardingComplete` boolean is insufficient. We need:
1. Service providers: Complete after role selection (current behavior)
2. Investors: Complete after finishing the questionnaire (Phases 10-14)

The gate must differentiate between these paths.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema - Add onboarding progress and questionnaire draft table</name>
  <files>convex/schema.ts</files>
  <action>
1. Add `onboardingStep` field to users table (optional number, 0 = not started, 1 = role selected, 2+ = questionnaire progress)
2. Create `investorQuestionnaires` table for storing draft/completed questionnaire data:
   - userId (reference to users)
   - status: "draft" | "complete"
   - currentStep: number (which questionnaire step they're on)
   - Draft answers storage (start minimal, expand in Phases 11-14):
     - citizenship: optional string
     - residencyStatus: optional string
     - experienceLevel: optional string
     - ownsPropertyInIsrael: optional boolean
     - investmentType: optional string
   - Timestamps (createdAt, updatedAt)
   - Index by userId

Keep the table lean - only add fields we need for Phase 9 gate logic. More fields added in Phases 11-14.
  </action>
  <verify>npx convex dev --once (schema validates and deploys)</verify>
  <done>Schema updated with onboardingStep on users and investorQuestionnaires table</done>
</task>

<task type="auto">
  <name>Task 2: Backend - Create onboarding progress mutations and update setUserRole</name>
  <files>convex/users.ts, convex/investorQuestionnaires.ts</files>
  <action>
1. Create `convex/investorQuestionnaires.ts` with:
   - `getByUser` query: Returns questionnaire for current user (or null)
   - `initializeDraft` mutation: Creates draft questionnaire for investor
   - `updateStep` mutation: Updates currentStep field

2. Modify `setUserRole` in `convex/users.ts`:
   - For service providers (broker, mortgage_advisor, lawyer): Set onboardingComplete = true (current behavior)
   - For investors: Set onboardingComplete = false, onboardingStep = 1 (role selected but questionnaire pending)
   - Call initializeDraft for investors to create their questionnaire record

3. Add `completeOnboarding` mutation in users.ts:
   - Sets onboardingComplete = true
   - Used when investor finishes questionnaire (called by Phase 14)

4. Add `getOnboardingStatus` query:
   - Returns { role, onboardingComplete, onboardingStep, questionnaireStatus }
   - Used by gate logic
  </action>
  <verify>
npx convex dev --once
Test setUserRole with investor role creates questionnaire draft
  </verify>
  <done>Mutations created: initializeDraft, updateStep, completeOnboarding, getOnboardingStatus</done>
</task>

<task type="auto">
  <name>Task 3: Gate - Update layout with role-aware onboarding enforcement</name>
  <files>src/app/(app)/layout.tsx, src/app/(app)/onboarding/questionnaire/page.tsx, src/hooks/useCurrentUser.ts</files>
  <action>
1. Update `src/app/(app)/layout.tsx`:
   - Keep existing auth check (redirect to /sign-in if not authenticated)
   - Modify onboarding check logic:
     - If no role selected → redirect to /onboarding (role selection)
     - If role is investor AND onboardingComplete is false → redirect to /onboarding/questionnaire
     - If service provider AND no role → redirect to /onboarding
     - Otherwise → allow access to app
   - Allow /onboarding and /onboarding/* paths without redirect loops

2. Create `src/app/(app)/onboarding/questionnaire/page.tsx`:
   - Placeholder component showing "Investor Questionnaire Coming Soon"
   - Include a "Skip for now" button that calls completeOnboarding (temporary for development)
   - This will be fully implemented in Phase 10

3. Update `src/hooks/useCurrentUser.ts` if needed:
   - Ensure it returns onboardingStep for gate logic
  </action>
  <verify>
npm run dev
- Create new user → lands on /onboarding (role selection)
- Select investor → redirects to /onboarding/questionnaire
- Select broker → goes to /dashboard (onboarding complete)
- "Skip for now" on questionnaire → goes to /dashboard
  </verify>
  <done>Gate enforces role-aware onboarding paths, questionnaire placeholder exists</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx convex dev --once` succeeds without errors
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] New user selecting "investor" is redirected to /onboarding/questionnaire
- [ ] New user selecting "broker" goes directly to /dashboard
- [ ] Existing users with onboardingComplete=true are unaffected
- [ ] "Skip for now" button allows investors to bypass questionnaire (dev convenience)
</verification>

<success_criteria>
- Schema has onboardingStep field on users table
- investorQuestionnaires table exists with draft storage
- setUserRole correctly differentiates investor vs service provider onboarding
- Gate logic in layout.tsx routes investors to /onboarding/questionnaire
- Service providers complete onboarding after role selection
- Placeholder questionnaire page exists for Phase 10 implementation
</success_criteria>

<output>
After completion, create `.planning/phases/09-onboarding-gate/09-01-SUMMARY.md`
</output>
