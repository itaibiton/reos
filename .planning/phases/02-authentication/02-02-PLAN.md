---
phase: 02-authentication
plan: 02
type: execute
---

<objective>
Create user schema in Convex with role support and implement user sync from Clerk.

Purpose: Store user data in Convex database with roles (investor, broker, mortgage_advisor, lawyer) enabling role-based features.
Output: Users table in Convex, automatic user creation on first sign-in, role assignment working.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-01-SUMMARY.md (will exist after Plan 1)

**Prior plan provides:**
- Clerk installed and configured
- ConvexProviderWithClerk working
- auth.config.ts synced to Convex

**User types from PROJECT.md:**
- Investors — find properties, connect with service providers, track deals
- Brokers — receive leads, manage client relationships
- Mortgage/Finance Advisors — receive warm leads, manage financing
- Lawyers — manage legal process for closing

**Key files:**
@convex/schema.ts
@src/app/ConvexClientProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create users table schema with roles</name>
  <files>convex/schema.ts</files>
  <action>
Update `convex/schema.ts` to add users table:

```typescript
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

// User roles in the system
// - investor: finds and invests in properties
// - broker: real estate agent connecting investors with properties
// - mortgage_advisor: handles financing for deals
// - lawyer: handles legal process for closing
const userRoles = v.union(
  v.literal("investor"),
  v.literal("broker"),
  v.literal("mortgage_advisor"),
  v.literal("lawyer")
);

export default defineSchema({
  users: defineTable({
    // Clerk user ID (from JWT subject claim)
    clerkId: v.string(),
    // User email from Clerk
    email: v.string(),
    // Display name
    name: v.optional(v.string()),
    // Profile image URL
    imageUrl: v.optional(v.string()),
    // User's role in the system
    role: v.optional(userRoles),
    // Onboarding completed flag
    onboardingComplete: v.boolean(),
    // Timestamps
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_clerk_id", ["clerkId"])
    .index("by_email", ["email"])
    .index("by_role", ["role"]),
});
```

Run `npx convex dev` to sync schema to Convex.
  </action>
  <verify>npx convex dev succeeds and shows users table created</verify>
  <done>Users table schema deployed to Convex with role enum and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create user sync functions</name>
  <files>convex/users.ts</files>
  <action>
Create `convex/users.ts` with functions to:
1. Get or create user on sign-in (using Clerk identity)
2. Get current user
3. Update user role

```typescript
import { v } from "convex/values";
import { mutation, query } from "./_generated/server";

// Get or create user from Clerk identity
// Called automatically when user accesses authenticated content
export const getOrCreateUser = mutation({
  args: {},
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("Not authenticated");
    }

    // Check if user already exists
    const existingUser = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (existingUser) {
      // Update last seen / any changed fields
      await ctx.db.patch(existingUser._id, {
        email: identity.email ?? existingUser.email,
        name: identity.name ?? existingUser.name,
        imageUrl: identity.pictureUrl ?? existingUser.imageUrl,
        updatedAt: Date.now(),
      });
      return existingUser._id;
    }

    // Create new user
    const userId = await ctx.db.insert("users", {
      clerkId: identity.subject,
      email: identity.email ?? "",
      name: identity.name,
      imageUrl: identity.pictureUrl,
      role: undefined, // Role selected during onboarding
      onboardingComplete: false,
      createdAt: Date.now(),
      updatedAt: Date.now(),
    });

    return userId;
  },
});

// Get current authenticated user
export const getCurrentUser = query({
  args: {},
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      return null;
    }

    return await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .unique();
  },
});

// Update user's role (used during onboarding)
export const setUserRole = mutation({
  args: {
    role: v.union(
      v.literal("investor"),
      v.literal("broker"),
      v.literal("mortgage_advisor"),
      v.literal("lawyer")
    ),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("Not authenticated");
    }

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) {
      throw new Error("User not found");
    }

    await ctx.db.patch(user._id, {
      role: args.role,
      onboardingComplete: true,
      updatedAt: Date.now(),
    });
  },
});
```

Run `npx convex dev` to sync functions.
  </action>
  <verify>
- npx convex dev succeeds
- Functions appear in Convex dashboard
- No TypeScript errors
  </verify>
  <done>User sync functions deployed: getOrCreateUser, getCurrentUser, setUserRole</done>
</task>

<task type="auto">
  <name>Task 3: Create useCurrentUser hook</name>
  <files>src/hooks/useCurrentUser.ts</files>
  <action>
Create `src/hooks/useCurrentUser.ts`:

```typescript
"use client";

import { useQuery, useMutation } from "convex/react";
import { useConvexAuth } from "convex/react";
import { api } from "../../convex/_generated/api";
import { useEffect } from "react";

export function useCurrentUser() {
  const { isAuthenticated, isLoading: isAuthLoading } = useConvexAuth();
  const user = useQuery(
    api.users.getCurrentUser,
    isAuthenticated ? {} : "skip"
  );
  const getOrCreateUser = useMutation(api.users.getOrCreateUser);

  // Ensure user exists in Convex when authenticated
  useEffect(() => {
    if (isAuthenticated && user === null) {
      getOrCreateUser();
    }
  }, [isAuthenticated, user, getOrCreateUser]);

  return {
    user,
    isLoading: isAuthLoading || (isAuthenticated && user === undefined),
    isAuthenticated,
  };
}
```

This hook:
- Uses useConvexAuth for auth state (not Clerk's useAuth)
- Fetches current user from Convex
- Auto-creates user in Convex on first sign-in
- Returns loading state while auth/user resolves
  </action>
  <verify>
- TypeScript compiles without errors
- npm run build succeeds
  </verify>
  <done>useCurrentUser hook created with auto-sync behavior</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] convex/schema.ts has users table with roles
- [ ] convex/users.ts has getOrCreateUser, getCurrentUser, setUserRole
- [ ] src/hooks/useCurrentUser.ts exists
- [ ] `npx convex dev` shows all functions synced
- [ ] `npm run build` succeeds
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- User schema deployed to Convex
- User sync functions working
- Ready for Plan 02-03: Protected routes and auth UI
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-02-SUMMARY.md`:

# Phase 2 Plan 2: User Schema + Sync Summary

**[One-liner summarizing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 02-03-PLAN.md: Protected routes and auth UI
</output>
