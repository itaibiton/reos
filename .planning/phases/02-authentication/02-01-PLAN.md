---
phase: 02-authentication
plan: 01
type: execute
---

<objective>
Install Clerk and integrate with Convex authentication system.

Purpose: Establish the authentication foundation that all protected features depend on.
Output: Clerk installed, JWT configured, ConvexProviderWithClerk working, users can sign in.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

**Tech stack available:**
- Next.js 16.1.1 with App Router
- Convex backend (project: "reos")
- Tailwind v4 + Shadcn/ui (53 components)
- ConvexClientProvider at src/app/ConvexClientProvider.tsx

**Key files to modify:**
@src/app/ConvexClientProvider.tsx
@src/app/layout.tsx

**Clerk-Convex Integration Pattern (from docs.convex.dev/auth/clerk):**
1. Install @clerk/nextjs
2. Create JWT template named "convex" in Clerk Dashboard
3. Configure convex/auth.config.ts with Clerk issuer domain
4. Replace ConvexProvider with ConvexProviderWithClerk
5. Wrap layout with ClerkProvider
6. Use useConvexAuth() hook (not Clerk's useAuth) for auth state
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Clerk and configure environment</name>
  <files>package.json, .env.local, middleware.ts</files>
  <action>
1. Install Clerk:
   ```bash
   npm install @clerk/nextjs
   ```

2. Create `.env.local` with Clerk keys (will need auth gate for user to provide keys):
   ```
   NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
   CLERK_SECRET_KEY=sk_test_...
   CLERK_JWT_ISSUER_DOMAIN=https://xxx.clerk.accounts.dev
   ```
   Note: User must create Clerk account and JWT template named "convex" in dashboard

3. Create `middleware.ts` at project root:
   ```typescript
   import { clerkMiddleware } from '@clerk/nextjs/server'
   export default clerkMiddleware()
   export const config = {
     matcher: [
       '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
       '/(api|trpc)(.*)',
     ],
   }
   ```
  </action>
  <verify>npm run build succeeds (even without env vars, Clerk fails gracefully)</verify>
  <done>Clerk installed, middleware.ts created</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure Clerk Dashboard and provide environment variables</action>
  <instructions>
I've installed Clerk and created the middleware. Now you need to:

1. Go to https://dashboard.clerk.com and sign in (or create account)
2. Create a new application (or use existing)
3. Go to **Configure > JWT Templates**
4. Click **New template** and select **Convex**
5. **IMPORTANT:** Do NOT rename it - must stay as "convex"
6. Copy the **Issuer domain** (looks like: https://verb-noun-00.clerk.accounts.dev)

7. Go to **Configure > API Keys** and copy:
   - Publishable key (starts with pk_test_ or pk_live_)
   - Secret key (starts with sk_test_ or sk_live_)

8. Create/update `.env.local` in project root with these values:
   ```
   NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_YOUR_KEY
   CLERK_SECRET_KEY=sk_test_YOUR_KEY
   CLERK_JWT_ISSUER_DOMAIN=https://YOUR_ISSUER.clerk.accounts.dev
   ```
  </instructions>
  <verification>I'll verify by checking the env vars are loaded and Clerk initializes</verification>
  <resume-signal>Type "done" when you've added the environment variables to .env.local</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Integrate Clerk with Convex providers</name>
  <files>src/app/ConvexClientProvider.tsx, src/app/layout.tsx, convex/auth.config.ts</files>
  <action>
1. Create `convex/auth.config.ts`:
   ```typescript
   import { AuthConfig } from "convex/server";

   export default {
     providers: [
       {
         domain: process.env.CLERK_JWT_ISSUER_DOMAIN!,
         applicationID: "convex",
       },
     ],
   } satisfies AuthConfig;
   ```

2. Update `src/app/ConvexClientProvider.tsx` to use ConvexProviderWithClerk:
   ```typescript
   "use client";

   import { ConvexReactClient } from "convex/react";
   import { ConvexProviderWithClerk } from "convex/react-clerk";
   import { useAuth } from "@clerk/nextjs";
   import { ReactNode } from "react";

   const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

   export function ConvexClientProvider({ children }: { children: ReactNode }) {
     return (
       <ConvexProviderWithClerk client={convex} useAuth={useAuth}>
         {children}
       </ConvexProviderWithClerk>
     );
   }
   ```

3. Update `src/app/layout.tsx` to wrap with ClerkProvider:
   ```typescript
   import { ClerkProvider } from "@clerk/nextjs";
   // ... existing imports

   export default function RootLayout({ children }: { children: React.ReactNode }) {
     return (
       <html lang="en">
         <body className={...}>
           <ClerkProvider>
             <ConvexClientProvider>
               <AppShell>{children}</AppShell>
             </ConvexClientProvider>
           </ClerkProvider>
         </body>
       </html>
     );
   }
   ```

4. Run `npx convex dev` to sync auth.config.ts to Convex backend
  </action>
  <verify>
- npm run build succeeds
- npx convex dev shows auth config synced
- Dev server starts without errors
  </verify>
  <done>ConvexProviderWithClerk wrapping app, auth.config.ts synced to Convex</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] @clerk/nextjs installed in package.json
- [ ] middleware.ts exists at project root
- [ ] convex/auth.config.ts exists and synced
- [ ] ConvexProviderWithClerk used instead of ConvexProvider
- [ ] ClerkProvider wraps ConvexClientProvider
- [ ] `npm run build` succeeds
- [ ] `npx convex dev` shows no auth config errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Clerk + Convex integration working at provider level
- Ready for Plan 02-02: User schema and sync
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Clerk + Convex Integration Summary

**[One-liner summarizing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 02-02-PLAN.md: User schema and sync
</output>
