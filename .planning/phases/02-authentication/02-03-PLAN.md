---
phase: 02-authentication
plan: 03
type: execute
---

<objective>
Add authentication UI components and protect routes based on auth state.

Purpose: Enable users to sign in/up and see role-appropriate navigation.
Output: Sign-in/sign-up pages, auth-aware header/sidebar, protected dashboard route.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@.planning/phases/02-authentication/02-02-SUMMARY.md

**Prior plans provide:**
- Clerk + Convex integration working
- Users table with roles in Convex
- useCurrentUser hook for auth state
- getOrCreateUser auto-syncs Clerk users to Convex

**Key files:**
@src/components/layout/Header.tsx
@src/components/layout/Sidebar.tsx
@src/app/layout.tsx

**Auth UI patterns:**
- Use Clerk's pre-built components: SignIn, SignUp, UserButton
- Use Convex's Authenticated/Unauthenticated for conditional rendering
- useCurrentUser hook for user data + role
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sign-in and sign-up pages</name>
  <files>src/app/sign-in/[[...sign-in]]/page.tsx, src/app/sign-up/[[...sign-up]]/page.tsx</files>
  <action>
1. Create `src/app/sign-in/[[...sign-in]]/page.tsx`:
```typescript
import { SignIn } from "@clerk/nextjs";

export default function SignInPage() {
  return (
    <div className="flex min-h-screen items-center justify-center">
      <SignIn
        appearance={{
          elements: {
            rootBox: "mx-auto",
            card: "shadow-none",
          },
        }}
      />
    </div>
  );
}
```

2. Create `src/app/sign-up/[[...sign-up]]/page.tsx`:
```typescript
import { SignUp } from "@clerk/nextjs";

export default function SignUpPage() {
  return (
    <div className="flex min-h-screen items-center justify-center">
      <SignUp
        appearance={{
          elements: {
            rootBox: "mx-auto",
            card: "shadow-none",
          },
        }}
      />
    </div>
  );
}
```

3. These pages use Clerk's catch-all route pattern [[...]] for multi-step flows.

4. Sign-in/sign-up pages should NOT have the AppShell wrapper. Create a layout for auth pages:
`src/app/(auth)/layout.tsx`:
```typescript
export default function AuthLayout({ children }: { children: React.ReactNode }) {
  return <>{children}</>;
}
```

Then move sign-in and sign-up into (auth) route group:
- `src/app/(auth)/sign-in/[[...sign-in]]/page.tsx`
- `src/app/(auth)/sign-up/[[...sign-up]]/page.tsx`
  </action>
  <verify>
- Navigate to /sign-in shows Clerk sign-in form
- Navigate to /sign-up shows Clerk sign-up form
- Pages don't have sidebar/header
  </verify>
  <done>Sign-in and sign-up pages working with Clerk components</done>
</task>

<task type="auto">
  <name>Task 2: Update header with auth-aware user menu</name>
  <files>src/components/layout/Header.tsx</files>
  <action>
Update `src/components/layout/Header.tsx` to show:
- UserButton (Clerk) when authenticated
- Sign In button when not authenticated

```typescript
"use client";

import { UserButton } from "@clerk/nextjs";
import { Authenticated, Unauthenticated, AuthLoading } from "convex/react";
import Link from "next/link";
import { Menu } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";

interface HeaderProps {
  onMenuClick: () => void;
}

export function Header({ onMenuClick }: HeaderProps) {
  return (
    <header className="sticky top-0 z-50 flex h-14 items-center gap-4 border-b bg-background px-4 lg:px-6">
      {/* Mobile menu button */}
      <Button
        variant="ghost"
        size="icon"
        className="lg:hidden"
        onClick={onMenuClick}
      >
        <Menu className="h-5 w-5" />
        <span className="sr-only">Toggle menu</span>
      </Button>

      {/* Logo */}
      <Link href="/" className="flex items-center gap-2 font-semibold">
        <span className="text-lg">REOS</span>
      </Link>

      {/* Spacer */}
      <div className="flex-1" />

      {/* Auth section */}
      <AuthLoading>
        <Skeleton className="h-8 w-8 rounded-full" />
      </AuthLoading>

      <Authenticated>
        <UserButton
          afterSignOutUrl="/"
          appearance={{
            elements: {
              avatarBox: "h-8 w-8",
            },
          }}
        />
      </Authenticated>

      <Unauthenticated>
        <Button asChild size="sm">
          <Link href="/sign-in">Sign In</Link>
        </Button>
      </Unauthenticated>
    </header>
  );
}
```

Key patterns:
- Use Convex's Authenticated/Unauthenticated (not Clerk's SignedIn/SignedOut)
- AuthLoading shows skeleton while auth state resolves
- UserButton provides dropdown with sign-out
  </action>
  <verify>
- Header shows "Sign In" when logged out
- Header shows UserButton when logged in
- No flash of wrong content on page load
  </verify>
  <done>Header shows auth-appropriate UI with UserButton or Sign In</done>
</task>

<task type="auto">
  <name>Task 3: Create protected dashboard route</name>
  <files>src/app/(app)/dashboard/page.tsx, src/app/(app)/layout.tsx</files>
  <action>
1. Create route group for app pages that require auth:
`src/app/(app)/layout.tsx`:
```typescript
"use client";

import { useConvexAuth } from "convex/react";
import { redirect } from "next/navigation";
import { useEffect } from "react";
import { Spinner } from "@/components/ui/spinner";

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { isAuthenticated, isLoading } = useConvexAuth();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      redirect("/sign-in");
    }
  }, [isAuthenticated, isLoading]);

  if (isLoading) {
    return (
      <div className="flex min-h-[50vh] items-center justify-center">
        <Spinner className="h-8 w-8" />
      </div>
    );
  }

  if (!isAuthenticated) {
    return null; // Will redirect
  }

  return <>{children}</>;
}
```

2. Create dashboard page:
`src/app/(app)/dashboard/page.tsx`:
```typescript
"use client";

import { useCurrentUser } from "@/hooks/useCurrentUser";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";

export default function DashboardPage() {
  const { user, isLoading } = useCurrentUser();

  if (isLoading) {
    return (
      <div className="space-y-4">
        <Skeleton className="h-8 w-48" />
        <Skeleton className="h-32 w-full max-w-md" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Dashboard</h1>
        <p className="text-muted-foreground">
          Welcome back{user?.name ? `, ${user.name}` : ""}!
        </p>
      </div>

      <Card className="max-w-md">
        <CardHeader>
          <CardTitle>Your Profile</CardTitle>
          <CardDescription>Account information synced from Clerk</CardDescription>
        </CardHeader>
        <CardContent className="space-y-2">
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">Email</span>
            <span className="text-sm">{user?.email}</span>
          </div>
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">Role</span>
            {user?.role ? (
              <Badge variant="secondary">{user.role.replace("_", " ")}</Badge>
            ) : (
              <Badge variant="outline">Not set</Badge>
            )}
          </div>
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">Onboarding</span>
            <Badge variant={user?.onboardingComplete ? "default" : "destructive"}>
              {user?.onboardingComplete ? "Complete" : "Incomplete"}
            </Badge>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

3. Update sidebar to link to dashboard:
Update navigation items in `src/components/layout/Sidebar.tsx` to include /dashboard.
  </action>
  <verify>
- /dashboard redirects to /sign-in when not authenticated
- /dashboard shows user info when authenticated
- User data synced from Clerk appears correctly
  </verify>
  <done>Protected dashboard route working with user data display</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication flow with Clerk + Convex</what-built>
  <how-to-verify>
    1. Run: `npm run dev` (and `npx convex dev` in another terminal)
    2. Visit: http://localhost:3000
    3. Verify: Header shows "Sign In" button
    4. Click: "Sign In" button
    5. Test: Create account or sign in with existing
    6. Verify: After sign-in, redirected to home, UserButton appears in header
    7. Visit: http://localhost:3000/dashboard
    8. Verify: Dashboard shows your email and role status
    9. Click: UserButton â†’ Sign Out
    10. Verify: Redirected, Sign In button reappears
    11. Visit: http://localhost:3000/dashboard while signed out
    12. Verify: Redirected to /sign-in
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Sign-in and sign-up pages render Clerk components
- [ ] Header shows UserButton when authenticated
- [ ] Header shows Sign In when unauthenticated
- [ ] /dashboard requires authentication
- [ ] User data from Convex displays correctly
- [ ] Sign out works and clears auth state
- [ ] `npm run build` succeeds
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Complete auth flow working end-to-end
- Phase 2: Authentication complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-03-SUMMARY.md`:

# Phase 2 Plan 3: Protected Routes + Auth UI Summary

**[One-liner summarizing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 2 complete, ready for Phase 3: Profiles
</output>
