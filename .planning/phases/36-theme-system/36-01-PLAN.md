---
phase: 36-theme-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/theme/ThemeSwitcher.tsx
  - src/app/[locale]/Providers.tsx
  - src/app/globals.css
  - messages/en.json
  - messages/he.json
  - src/app/[locale]/(app)/test-theme/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can select Light, Dark, or System theme"
    - "Theme persists across page refresh (localStorage)"
    - "No flash of wrong theme on page load"
    - "System option respects OS dark mode"
    - "Theme transitions animate smoothly"
  artifacts:
    - path: "src/components/theme/ThemeSwitcher.tsx"
      provides: "Theme toggle component with Light/Dark/System options"
      exports: ["ThemeSwitcher"]
    - path: "src/app/[locale]/(app)/test-theme/page.tsx"
      provides: "Test page to verify theme switching"
      min_lines: 30
  key_links:
    - from: "src/components/theme/ThemeSwitcher.tsx"
      to: "next-themes useTheme"
      via: "useTheme hook"
      pattern: "useTheme\\(\\)"
    - from: "src/app/[locale]/Providers.tsx"
      to: "ThemeProvider"
      via: "Provider configuration"
      pattern: "ThemeProvider.*attribute.*class"
---

<objective>
Create a ThemeSwitcher component and enable smooth theme transitions.

Purpose: Satisfy THM-01 through THM-05 requirements by creating the theme UI component and enabling CSS transitions. The component will be placed in the Header dropdown in Phase 38, but this phase creates and tests it in isolation.

Output:
- ThemeSwitcher component at src/components/theme/ThemeSwitcher.tsx
- Test page at /[locale]/(app)/test-theme to verify functionality
- Smooth theme transitions enabled via CSS
- Translations for Light/Dark/System in both English and Hebrew
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.5-ROADMAP.md
@.planning/phases/36-theme-system/36-RESEARCH.md
@src/app/[locale]/Providers.tsx
@src/app/globals.css
@src/components/ui/toggle-group.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThemeSwitcher component and add translations</name>
  <files>
    - src/components/theme/ThemeSwitcher.tsx
    - messages/en.json
    - messages/he.json
  </files>
  <action>
Create the ThemeSwitcher component at `src/components/theme/ThemeSwitcher.tsx`:

1. Use the `useTheme` hook from `next-themes` for theme state
2. Use `useState` + `useEffect` for mounted state to avoid hydration mismatch
3. Return a Skeleton placeholder until mounted
4. Use ToggleGroup from `@/components/ui/toggle-group` with `type="single"`
5. Three ToggleGroupItem options: light, dark, system
6. Use lucide-react icons: Sun, Moon, Monitor
7. Include sr-only spans for accessibility
8. Use useTranslations("common.theme") for translated labels

Component structure:
```typescript
"use client";

import { useEffect, useState } from "react";
import { useTheme } from "next-themes";
import { useTranslations } from "next-intl";
import { Sun, Moon, Monitor } from "lucide-react";
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import { Skeleton } from "@/components/ui/skeleton";

export function ThemeSwitcher() {
  const t = useTranslations("common.theme");
  const [mounted, setMounted] = useState(false);
  const { theme, setTheme } = useTheme();

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) {
    return <Skeleton className="h-9 w-[108px] rounded-md" />;
  }

  return (
    <ToggleGroup
      type="single"
      value={theme}
      onValueChange={(value) => value && setTheme(value)}
      className="bg-muted p-1 rounded-lg"
    >
      <ToggleGroupItem value="light" aria-label={t("light")} className="px-3">
        <Sun className="size-4" />
        <span className="sr-only">{t("light")}</span>
      </ToggleGroupItem>
      <ToggleGroupItem value="dark" aria-label={t("dark")} className="px-3">
        <Moon className="size-4" />
        <span className="sr-only">{t("dark")}</span>
      </ToggleGroupItem>
      <ToggleGroupItem value="system" aria-label={t("system")} className="px-3">
        <Monitor className="size-4" />
        <span className="sr-only">{t("system")}</span>
      </ToggleGroupItem>
    </ToggleGroup>
  );
}
```

Add translations to `messages/en.json` in the `common` section (after `language`):
```json
"theme": {
  "title": "Theme",
  "light": "Light",
  "dark": "Dark",
  "system": "System"
}
```

Add translations to `messages/he.json` in the `common` section (after `language`):
```json
"theme": {
  "title": "ערכת נושא",
  "light": "בהיר",
  "dark": "כהה",
  "system": "מערכת"
}
```

IMPORTANT: The `theme` key should be added after the `language` key in the `common` section of both JSON files.
  </action>
  <verify>
- File exists: `ls src/components/theme/ThemeSwitcher.tsx`
- No TypeScript errors: `npx tsc --noEmit`
- Translations exist: `grep -A4 '"theme":' messages/en.json messages/he.json`
  </verify>
  <done>
ThemeSwitcher component created with useTheme hook, mounted state handling, ToggleGroup UI, and translations in both languages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable smooth theme transitions</name>
  <files>
    - src/app/[locale]/Providers.tsx
    - src/app/globals.css
  </files>
  <action>
1. **Modify `src/app/[locale]/Providers.tsx`:**
   - Remove the `disableTransitionOnChange` prop from ThemeProvider
   - This enables CSS transitions during theme changes (was deliberately disabled before)

Before:
```typescript
<ThemeProvider
  attribute="class"
  defaultTheme="system"
  enableSystem
  disableTransitionOnChange
>
```

After:
```typescript
<ThemeProvider
  attribute="class"
  defaultTheme="system"
  enableSystem
>
```

2. **Modify `src/app/globals.css`:**
   - Add transition property to the `body` rule in `@layer base`
   - Use `transition: background-color 300ms ease-in-out, color 300ms ease-in-out;`

Find the existing body rule:
```css
body {
  @apply bg-background text-foreground;
}
```

Change to:
```css
body {
  @apply bg-background text-foreground;
  transition: background-color 300ms ease-in-out, color 300ms ease-in-out;
}
```

NOTE: Using raw CSS `transition` property instead of Tailwind's `transition-colors` because Tailwind v4 @apply may have issues with transition utilities in @layer base. The raw CSS approach is more reliable.
  </action>
  <verify>
- disableTransitionOnChange removed: `grep -c "disableTransitionOnChange" src/app/[locale]/Providers.tsx` should return 0
- Transition added: `grep "transition:" src/app/globals.css`
  </verify>
  <done>
ThemeProvider allows transitions (disableTransitionOnChange removed), body element has 300ms color transitions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create test page to verify theme switching</name>
  <files>
    - src/app/[locale]/(app)/test-theme/page.tsx
  </files>
  <action>
Create a test page at `src/app/[locale]/(app)/test-theme/page.tsx` to verify the ThemeSwitcher component works correctly before Phase 38 places it in the header.

The test page should:
1. Display the ThemeSwitcher component prominently
2. Show current theme state (using useTheme)
3. Include sample UI elements to verify transitions work (cards, text, etc.)
4. Be a client component (needs useTheme)

```typescript
"use client";

import { useTheme } from "next-themes";
import { useEffect, useState } from "react";
import { ThemeSwitcher } from "@/components/theme/ThemeSwitcher";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";

export default function TestThemePage() {
  const { theme, resolvedTheme } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  return (
    <div className="p-6 space-y-8">
      <div>
        <h1 className="text-2xl font-bold mb-2">Theme System Test</h1>
        <p className="text-muted-foreground">
          Test page to verify theme switching works correctly. This page will be removed after Phase 38.
        </p>
      </div>

      {/* Theme Switcher */}
      <Card>
        <CardHeader>
          <CardTitle>Theme Switcher Component</CardTitle>
          <CardDescription>
            Select a theme to test. Changes should persist across page refreshes.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <ThemeSwitcher />

          {mounted && (
            <div className="flex gap-2 items-center text-sm">
              <span className="text-muted-foreground">Current:</span>
              <Badge variant="secondary">{theme}</Badge>
              <span className="text-muted-foreground">Resolved:</span>
              <Badge variant="outline">{resolvedTheme}</Badge>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Sample UI Elements */}
      <Card>
        <CardHeader>
          <CardTitle>Sample UI Elements</CardTitle>
          <CardDescription>
            These elements should transition smoothly when theme changes.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex gap-2 flex-wrap">
            <Button>Primary</Button>
            <Button variant="secondary">Secondary</Button>
            <Button variant="outline">Outline</Button>
            <Button variant="ghost">Ghost</Button>
            <Button variant="destructive">Destructive</Button>
          </div>

          <div className="flex gap-2 flex-wrap">
            <Badge>Default</Badge>
            <Badge variant="secondary">Secondary</Badge>
            <Badge variant="outline">Outline</Badge>
            <Badge variant="destructive">Destructive</Badge>
          </div>

          <div className="grid gap-4 md:grid-cols-2">
            <Card className="bg-muted">
              <CardContent className="p-4">
                <p className="font-medium">Muted Card</p>
                <p className="text-sm text-muted-foreground">
                  Background should transition smoothly.
                </p>
              </CardContent>
            </Card>
            <Card className="bg-accent">
              <CardContent className="p-4">
                <p className="font-medium">Accent Card</p>
                <p className="text-sm text-accent-foreground">
                  Colors should animate on theme switch.
                </p>
              </CardContent>
            </Card>
          </div>
        </CardContent>
      </Card>

      {/* Verification Checklist */}
      <Card>
        <CardHeader>
          <CardTitle>Verification Checklist</CardTitle>
          <CardDescription>
            Manual verification steps for theme system requirements.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <ul className="space-y-2 text-sm">
            <li>THM-01: Toggle switches between Light/Dark/System</li>
            <li>THM-02: Refresh page - theme should persist (check localStorage key: "theme")</li>
            <li>THM-03: No flash of wrong theme on page load</li>
            <li>THM-04: Select "System", change OS dark mode - app should follow</li>
            <li>THM-05: Theme transitions animate smoothly (300ms)</li>
          </ul>
        </CardContent>
      </Card>
    </div>
  );
}
```

NOTE: This test page is temporary. It will be removed or repurposed after Phase 38 places the ThemeSwitcher in the header dropdown.
  </action>
  <verify>
- Page exists: `ls src/app/[locale]/(app)/test-theme/page.tsx`
- Dev server builds: `npm run dev` (check for errors)
- Visit http://localhost:3000/en/test-theme to manually verify theme switching
  </verify>
  <done>
Test page created at /[locale]/(app)/test-theme showing ThemeSwitcher component and sample UI elements for visual verification.
  </done>
</task>

</tasks>

<verification>
1. **ThemeSwitcher works:**
   - Visit http://localhost:3000/en/test-theme
   - Click Light/Dark/System buttons
   - Theme should change immediately

2. **Persistence (THM-02):**
   - Select "dark" theme
   - Refresh page
   - Theme should still be "dark"
   - Check: `localStorage.getItem("theme")` in browser console

3. **No flash (THM-03):**
   - Set to "dark" theme
   - Hard refresh (Cmd+Shift+R)
   - Should NOT see brief flash of light theme

4. **System preference (THM-04):**
   - Select "system" theme
   - Change OS dark mode setting
   - App should follow OS preference

5. **Smooth transitions (THM-05):**
   - Switch themes
   - Background and text colors should animate over 300ms (not instant snap)

6. **RTL/Hebrew:**
   - Visit http://localhost:3000/he/test-theme
   - Component should work correctly in RTL mode
   - Labels should be in Hebrew (sr-only)
</verification>

<success_criteria>
- [ ] ThemeSwitcher component exists with ToggleGroup UI
- [ ] Translations exist in both en.json and he.json
- [ ] disableTransitionOnChange removed from ThemeProvider
- [ ] Body has transition CSS for smooth theme changes
- [ ] Test page shows theme switcher and displays current theme
- [ ] Theme persists across page refresh
- [ ] No hydration mismatch errors in console
- [ ] Transitions animate smoothly (not instant)
</success_criteria>

<output>
After completion, create `.planning/phases/36-theme-system/36-01-SUMMARY.md`
</output>
