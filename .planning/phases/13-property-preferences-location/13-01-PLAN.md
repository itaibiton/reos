---
phase: 13-property-preferences-location
plan: 01
type: execute
---

<objective>
Add property preferences and location selection steps to the investor questionnaire.

Purpose: Capture investor preferences for property type, size, locations, and amenities to enable personalized property matching and service provider visibility.
Output: 4 new questionnaire steps with Convex persistence, extending the 10-step wizard to 14 steps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/12-questionnaire-content-2/12-01-SUMMARY.md
@.planning/phases/11-questionnaire-content-1/11-01-SUMMARY.md

**Key files:**
@src/app/(app)/onboarding/questionnaire/page.tsx
@src/components/questionnaire/steps/GoalsStep.tsx
@src/components/questionnaire/steps/BudgetStep.tsx
@src/lib/constants.ts
@convex/schema.ts
@convex/investorQuestionnaires.ts

**Established patterns:**
- Step components use value/onChange props with QuestionBubble + AnswerArea structure
- Local useState for immediate UI, Convex sync on step change
- Checkbox multi-select pattern from GoalsStep (array state with toggle handler)
- Multi-input step pattern from BudgetStep (separate min/max props)
- Barrel exports via @/components/questionnaire/steps

**Constraining decisions:**
- Phase 10: QuestionBubble + AnswerArea conversational UI pattern
- Phase 11: Step component pattern with value/onChange props
- Phase 12: Checkbox multi-select pattern established in GoalsStep

**Constants available:**
- PROPERTY_TYPES: residential, commercial, mixed_use, land
- ISRAELI_LOCATIONS: 15 cities (Tel Aviv, Jerusalem, Haifa, etc.)
- PROPERTY_AMENITIES: 15 amenities (airConditioning, elevator, parking, etc.)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schema fields and create 4 step components</name>
  <files>convex/schema.ts, convex/investorQuestionnaires.ts, src/components/questionnaire/steps/PropertyTypeStep.tsx, src/components/questionnaire/steps/PropertySizeStep.tsx, src/components/questionnaire/steps/LocationStep.tsx, src/components/questionnaire/steps/AmenitiesStep.tsx, src/components/questionnaire/steps/index.ts</files>
  <action>
1. Add 8 new fields to investorQuestionnaires table in schema.ts:
   - preferredPropertyTypes: v.optional(v.array(v.string())) - from PROPERTY_TYPES
   - preferredLocations: v.optional(v.array(v.string())) - from ISRAELI_LOCATIONS
   - minBedrooms: v.optional(v.number())
   - maxBedrooms: v.optional(v.number())
   - minArea: v.optional(v.number()) - in sqm
   - maxArea: v.optional(v.number()) - in sqm
   - preferredAmenities: v.optional(v.array(v.string())) - from PROPERTY_AMENITIES
   - locationFlexibility: v.optional(v.string()) - "flexible" | "specific" | "nearby_cities"

2. Update saveAnswers mutation in investorQuestionnaires.ts to accept and persist all 8 new fields.

3. Create PropertyTypeStep.tsx:
   - Props: value: string[] | undefined, onChange: (value: string[]) => void
   - Question: "What types of properties interest you?"
   - Checkbox multi-select using PROPERTY_TYPES from constants
   - Follow GoalsStep checkbox pattern exactly

4. Create PropertySizeStep.tsx:
   - Props: minBedrooms, maxBedrooms, minArea, maxArea with individual onChange handlers
   - Question: "What size property are you looking for?"
   - Two sections: Bedrooms (min/max number inputs) and Area (min/max sqm inputs)
   - Follow BudgetStep multi-input pattern

5. Create LocationStep.tsx:
   - Props: value: string[] | undefined, onChange: (value: string[]) => void
   - Question: "Which cities or areas interest you?"
   - Checkbox multi-select using ISRAELI_LOCATIONS from constants
   - Show cities in a 2-column grid for better display

6. Create AmenitiesStep.tsx:
   - Props: value: string[] | undefined, onChange: (value: string[]) => void
   - Question: "What amenities are important to you?"
   - Checkbox multi-select using PROPERTY_AMENITIES from constants
   - Use 3-column grid for more compact display

7. Export all 4 components from steps/index.ts barrel file.
  </action>
  <verify>npx convex dev --once succeeds, all components export without TypeScript errors</verify>
  <done>8 new schema fields added, 4 step components created following established patterns, barrel exports updated</done>
</task>

<task type="auto">
  <name>Task 2: Wire up questionnaire page with new steps</name>
  <files>src/app/(app)/onboarding/questionnaire/page.tsx</files>
  <action>
1. Import the 4 new step components from @/components/questionnaire/steps

2. Add 8 new state variables:
   - preferredPropertyTypes (string[]) initialized to []
   - preferredLocations (string[]) initialized to []
   - minBedrooms (number | undefined)
   - maxBedrooms (number | undefined)
   - minArea (number | undefined)
   - maxArea (number | undefined)
   - preferredAmenities (string[]) initialized to []
   - locationFlexibility (string | undefined)

3. Update useEffect draft restoration to include all 8 new fields from questionnaire

4. Add 4 new steps to the steps array after the existing 10 steps:
   - id: "property-type", title: "Property Type", component: PropertyTypeStep
   - id: "property-size", title: "Property Size", component: PropertySizeStep
   - id: "location", title: "Location", component: LocationStep
   - id: "amenities", title: "Amenities", component: AmenitiesStep

5. Update saveProgress function to include all 8 new fields in saveAnswers call

6. Add new state variables to useMemo dependency array
  </action>
  <verify>npm run dev starts without errors, navigate to /onboarding/questionnaire and see 14 steps, new steps display correctly</verify>
  <done>Questionnaire extended from 10 to 14 steps, all new fields persist to Convex on step change</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx convex dev --once` succeeds with new schema fields
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] Questionnaire shows 14 steps (10 existing + 4 new)
- [ ] PropertyTypeStep shows all 4 property types as checkboxes
- [ ] PropertySizeStep shows min/max inputs for bedrooms and area
- [ ] LocationStep shows all 15 cities as checkboxes
- [ ] AmenitiesStep shows all 15 amenities as checkboxes
- [ ] Answers persist when navigating between steps
- [ ] Draft answers restore on page reload
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- 4 new step components following established patterns
- Questionnaire extended to 14 steps with full persistence
- Phase 13 complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-property-preferences-location/13-01-SUMMARY.md`
</output>
