---
phase: 38-header-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/header/AvatarDropdown.tsx
  - src/components/header/NotificationsTab.tsx
  - src/components/header/SettingsTab.tsx
  - src/components/header/index.ts
  - messages/en.json
  - messages/he.json
autonomous: true

must_haves:
  truths:
    - "User sees avatar button with unread badge when notifications exist"
    - "User can open dropdown and see Notifications and Settings tabs"
    - "User can switch between Light/Dark/System themes in Settings tab"
    - "User can switch between English/Hebrew in Settings tab"
    - "User can sign out via button at dropdown bottom"
    - "Notifications are grouped by type (messages, deals, files, requests)"
  artifacts:
    - path: "src/components/header/AvatarDropdown.tsx"
      provides: "Main avatar dropdown with tabs"
      exports: ["AvatarDropdown"]
    - path: "src/components/header/NotificationsTab.tsx"
      provides: "Notification list with grouping"
      exports: ["NotificationsTab"]
    - path: "src/components/header/SettingsTab.tsx"
      provides: "Theme and language switches"
      exports: ["SettingsTab"]
  key_links:
    - from: "src/components/header/AvatarDropdown.tsx"
      to: "api.notifications.getUnreadCount"
      via: "useQuery for badge count"
      pattern: "useQuery\\(api\\.notifications\\.getUnreadCount"
    - from: "src/components/header/NotificationsTab.tsx"
      to: "api.notifications.list"
      via: "useQuery for notification list"
      pattern: "useQuery\\(api\\.notifications\\.list"
    - from: "src/components/header/AvatarDropdown.tsx"
      to: "@clerk/nextjs"
      via: "useClerk().signOut()"
      pattern: "signOut\\("
---

<objective>
Create the AvatarDropdown component with tabbed interface for notifications and settings, plus sign out functionality.

Purpose: Consolidate notifications, theme/language settings, and sign out into a single avatar-triggered dropdown per HDR-02 through HDR-06, HDR-09, HDR-10.

Output: Four new files in src/components/header/ providing the complete avatar dropdown experience.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.5-ROADMAP.md
@.planning/phases/38-header-redesign/38-RESEARCH.md
@src/components/notifications/NotificationCenter.tsx
@src/components/theme/ThemeSwitcher.tsx
@src/components/LocaleSwitcher.tsx
@src/components/ui/popover.tsx
@src/components/ui/tabs.tsx
@src/components/ui/avatar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotificationsTab with grouped notifications</name>
  <files>
    src/components/header/NotificationsTab.tsx
  </files>
  <action>
Create NotificationsTab component that:

1. Reuses notification fetching and display logic from NotificationCenter:
   - useQuery(api.notifications.list, { limit: 20 })
   - markAsRead and markAllAsRead mutations
   - NotificationItem internal component with icon, title, message, relative time

2. Groups notifications by type using useMemo:
   - Group into: messages (new_message), deals (deal_stage_change), files (file_uploaded), requests (request_*)
   - Use translation keys for group headers: "header.notifications.groups.messages", etc.

3. UI structure:
   - Header with title and "Mark all read" button (only if unread > 0)
   - ScrollArea with h-72 (slightly smaller than current h-80 to fit tabs)
   - Grouped sections with type headers (collapsible optional, simple headers fine for MVP)
   - Empty state matching current NotificationCenter

4. Export as named export

5. Use translations namespace "header.notifications" for all labels

Import patterns:
- useQuery, useMutation from "convex/react"
- useFormatter, useNow, useTranslations from "next-intl"
- useRouter from "@/i18n/navigation"
- HugeiconsIcon from "@hugeicons/react"
- Icons from "@hugeicons/core-free-icons"
- UI components from @/components/ui/*
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
NotificationsTab component exists, renders grouped notifications, handles mark as read
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SettingsTab with theme and language switches</name>
  <files>
    src/components/header/SettingsTab.tsx
    messages/en.json
    messages/he.json
  </files>
  <action>
Create SettingsTab component that:

1. Theme section:
   - Label "Theme" with ThemeSwitcher component embedded inline
   - Reuse existing ThemeSwitcher from @/components/theme/ThemeSwitcher

2. Language section:
   - Label "Language" with inline toggle/buttons for English/Hebrew
   - Simplified from LocaleSwitcher dropdown - use ToggleGroup or button pair
   - Use routing.locales for dynamic locale list
   - Use router.replace(pathname, { locale }) for switching

3. Layout:
   - Vertical stack with clear section labels
   - p-4 padding, space-y-4 between sections
   - Each section: label (text-sm text-muted-foreground) + control

4. Translations:
   - Add to "header.settings" namespace: title, theme, language

Update messages/en.json:
```json
"header": {
  "notifications": {
    "title": "Notifications",
    "markAllRead": "Mark all read",
    "empty": "No notifications",
    "caughtUp": "You're all caught up!",
    "groups": {
      "messages": "Messages",
      "deals": "Deals",
      "files": "Files",
      "requests": "Requests"
    }
  },
  "settings": {
    "title": "Settings",
    "theme": "Theme",
    "language": "Language"
  },
  "signOut": "Sign Out"
}
```

Update messages/he.json with Hebrew equivalents.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
SettingsTab component exists with theme toggle and language switcher inline
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AvatarDropdown with tabs and sign out</name>
  <files>
    src/components/header/AvatarDropdown.tsx
    src/components/header/index.ts
  </files>
  <action>
Create AvatarDropdown component that:

1. Trigger button:
   - Button variant="ghost" size="icon" with Avatar inside
   - Avatar uses user?.imageUrl from useQuery(api.users.getCurrentUser)
   - Fallback shows initials from user?.name
   - Badge for unread count positioned absolute -top-1 -end-1 (use existing pattern from NotificationCenter)
   - Badge only shows if unreadCount > 0

2. Popover structure:
   - PopoverContent align="end" className="w-80 p-0"
   - Tabs with TabsList (grid-cols-2), TabsTrigger for "notifications" and "settings"
   - TabsContent for each tab, mt-0 to remove gap
   - Separator between tabs content and sign out button

3. Sign out button:
   - Full-width Button variant="ghost" at bottom
   - Uses useClerk() from "@clerk/nextjs" to get signOut function
   - onClick: signOut({ redirectUrl: "/" })
   - Uses Logout01Icon or similar

4. Tab default value: "notifications"

5. Create barrel export in index.ts:
```typescript
export { AvatarDropdown } from "./AvatarDropdown";
export { NotificationsTab } from "./NotificationsTab";
export { SettingsTab } from "./SettingsTab";
```

Imports:
- useClerk from "@clerk/nextjs"
- Popover, PopoverContent, PopoverTrigger from "@/components/ui/popover"
- Tabs, TabsContent, TabsList, TabsTrigger from "@/components/ui/tabs"
- Avatar, AvatarImage, AvatarFallback from "@/components/ui/avatar"
- Button, Badge, Separator from @/components/ui/*
- useQuery from "convex/react"
- api from convex/_generated/api
- useTranslations from "next-intl"
- NotificationsTab, SettingsTab from local imports
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Component renders in isolation (can test by temporarily importing in a page)
  </verify>
  <done>
AvatarDropdown component exists with avatar trigger, badge, tabbed popover, and sign out button
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes
2. All three components export correctly via barrel
3. Badge shows correct unread count
4. Tabs switch between Notifications and Settings
5. Theme toggle works (light/dark/system)
6. Language toggle works (switches locale)
7. Sign out redirects to home page
</verification>

<success_criteria>
- AvatarDropdown renders avatar with optional unread badge (HDR-02, HDR-06)
- Clicking avatar opens popover with two tabs (HDR-03, HDR-04)
- Notifications tab shows grouped notifications (HDR-09)
- Settings tab has theme and language toggles (HDR-04)
- Sign Out button at bottom works (HDR-05)
- No Clerk UserButton used (HDR-10)
</success_criteria>

<output>
After completion, create `.planning/phases/38-header-redesign/38-01-SUMMARY.md`
</output>
