---
phase: 38-header-redesign
plan: 03
type: execute
wave: 2
depends_on: ["38-01", "38-02"]
files_modified:
  - src/components/layout/AppShell.tsx
  - src/components/layout/Header.tsx
autonomous: true

must_haves:
  truths:
    - "User sees single avatar dropdown instead of separate UserButton and NotificationCenter"
    - "User on mobile sees search icon instead of hidden search bar"
    - "User on mobile does not see breadcrumbs"
    - "User on desktop sees breadcrumbs as before"
    - "Admin user still sees role switcher dropdown"
  artifacts:
    - path: "src/components/layout/AppShell.tsx"
      provides: "Updated header with AvatarDropdown and MobileSearchExpander"
      min_lines: 350
    - path: "src/components/layout/Header.tsx"
      provides: "Updated header component (if still used)"
      min_lines: 100
  key_links:
    - from: "src/components/layout/AppShell.tsx"
      to: "src/components/header/AvatarDropdown.tsx"
      via: "import and render"
      pattern: "import.*AvatarDropdown"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/components/header/MobileSearchExpander.tsx"
      via: "import and render"
      pattern: "import.*MobileSearchExpander"
---

<objective>
Integrate AvatarDropdown and MobileSearchExpander into the application header, removing Clerk UserButton and adding mobile-responsive behavior.

Purpose: Complete the header redesign by wiring new components into AppShell and Header, hiding breadcrumbs on mobile per HDR-07.

Output: Updated AppShell.tsx and Header.tsx with new header components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.5-ROADMAP.md
@.planning/phases/38-header-redesign/38-01-SUMMARY.md
@.planning/phases/38-header-redesign/38-02-SUMMARY.md
@src/components/layout/AppShell.tsx
@src/components/layout/Header.tsx
@src/components/header/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AppShell.tsx header section</name>
  <files>
    src/components/layout/AppShell.tsx
  </files>
  <action>
Modify AppShell.tsx to use new header components:

1. Remove imports:
   - Remove: UserButton from "@clerk/nextjs"
   - Remove: NotificationCenter from "@/components/notifications/NotificationCenter"
   - Keep: LocaleSwitcher (only for admin role switcher area, not header)

2. Add imports:
   - Add: AvatarDropdown, MobileSearchExpander from "@/components/header"
   - Keep: GlobalSearchBar (still used, triggered by MobileSearchExpander)

3. Update ProviderHeaderContent component:
   - Remove LocaleSwitcher (moved to AvatarDropdown settings)
   - Remove NotificationCenter (moved to AvatarDropdown)
   - Remove UserButton completely
   - Add AvatarDropdown as the last item
   - Keep admin role-switching dropdown (it stays separate)

New ProviderHeaderContent structure:
```typescript
function ProviderHeaderContent() {
  // ... existing role switching logic ...

  return (
    <div className="flex items-center gap-3">
      {/* Role-switching dropdown - admin only */}
      {isAdmin && (
        <DropdownMenu>
          {/* ... existing role switcher ... */}
        </DropdownMenu>
      )}

      {/* Avatar dropdown (replaces UserButton + NotificationCenter + LocaleSwitcher) */}
      <AvatarDropdown />
    </div>
  );
}
```

4. Update header section - add MobileSearchExpander:
   - Add useState for search dialog open state
   - Add MobileSearchExpander before GlobalSearchBar
   - Pass onOpenSearch callback to MobileSearchExpander

```typescript
// In AppShell component
const [searchOpen, setSearchOpen] = useState(false);

// In header JSX
<Authenticated>
  <div className="flex items-center gap-2 flex-1 justify-end px-4">
    {/* Mobile search trigger */}
    <MobileSearchExpander onOpenSearch={() => setSearchOpen(true)} />
    {/* Desktop search bar */}
    <div className="hidden md:block">
      <GlobalSearchBar open={searchOpen} onOpenChange={setSearchOpen} />
    </div>
  </div>
</Authenticated>
```

Wait - GlobalSearchBar manages its own open state. Need to check if it accepts props.

Actually, GlobalSearchBar uses internal useState for open. Two options:
a) Lift state up to AppShell and pass as props
b) Keep MobileSearchExpander simple - just a button that triggers keyboard shortcut

Option (b) is simpler: MobileSearchExpander simulates Cmd+K keypress to open search.

Actually simplest: MobileSearchExpander just opens the dialog. But GlobalSearchBar doesn't expose setOpen.

Let's modify GlobalSearchBar to accept optional open/onOpenChange props (controlled mode).

Actually, for minimal changes, let's keep it simpler:
- MobileSearchExpander triggers the same keyboard shortcut (Cmd+K)
- Or, we can just have MobileSearchExpander render its own trigger that opens the dialog

Cleanest approach:
- Export setOpen from GlobalSearchBar context OR
- Have MobileSearchExpander dispatch keyboard event OR
- Just have MobileSearchExpander be a visible md:hidden button that, when clicked, opens GlobalSearchBar

Looking at GlobalSearchBar.tsx, it has a Button trigger that opens the dialog. The simplest change is:
1. Add state lifting: GlobalSearchBar accepts open/onOpenChange as optional props
2. If provided, use those; otherwise use internal state

For this plan, let's do minimal integration:
- MobileSearchExpander is a simple icon button visible only on mobile
- Clicking it simulates the keyboard shortcut OR directly opens the dialog

Simplest: just programmatically trigger keydown event for Cmd+K:

```typescript
const handleClick = () => {
  const event = new KeyboardEvent('keydown', {
    key: 'k',
    metaKey: true,
    bubbles: true,
  });
  document.dispatchEvent(event);
};
```

This leverages existing GlobalSearchBar keyboard listener without any changes to GlobalSearchBar.

5. Hide breadcrumbs on mobile:
   - Add "hidden md:flex" to Breadcrumb wrapper
   - Breadcrumbs only visible on md: and above

Current breadcrumb code:
```typescript
<Breadcrumb>
  <BreadcrumbList>
    {breadcrumbs.map(...)}
  </BreadcrumbList>
</Breadcrumb>
```

Updated:
```typescript
<Breadcrumb className="hidden md:block">
  <BreadcrumbList>
    {breadcrumbs.map(...)}
  </BreadcrumbList>
</Breadcrumb>
```
  </action>
  <verify>
`npx tsc --noEmit` passes
Mobile view shows search icon and avatar dropdown
Desktop view shows search bar, breadcrumbs, and avatar dropdown
Sign out works via dropdown
  </verify>
  <done>
AppShell uses new header components, breadcrumbs hidden on mobile, UserButton removed
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Header.tsx for consistency</name>
  <files>
    src/components/layout/Header.tsx
  </files>
  <action>
Update Header.tsx to match AppShell changes (Header is used in some layouts):

1. Remove imports:
   - Remove: UserButton from "@clerk/nextjs"
   - Remove: NotificationCenter (if imported)

2. Add imports:
   - Add: AvatarDropdown, MobileSearchExpander from "@/components/header"

3. Update AuthenticatedContent component:
   - Remove NotificationCenter
   - Remove UserButton
   - Add AvatarDropdown
   - Keep admin role switcher

4. Add MobileSearchExpander before GlobalSearchBar in auth section:
```typescript
<div className="flex items-center gap-3 flex-shrink-0">
  {/* Mobile search trigger */}
  <MobileSearchExpander onOpenSearch={() => {
    // Dispatch keyboard event to open GlobalSearchBar
    document.dispatchEvent(new KeyboardEvent('keydown', { key: 'k', metaKey: true, bubbles: true }));
  }} />

  {/* Desktop search */}
  <div className="hidden md:block flex-shrink-0">
    <GlobalSearchBar />
  </div>

  {/* Auth states */}
  ...
</div>
```

5. Note: Header.tsx might not be actively used if AppShell is the main layout. Still update for consistency in case it's used elsewhere (landing pages, etc.).
  </action>
  <verify>
`npx tsc --noEmit` passes
If Header.tsx is used anywhere, it shows updated components
  </verify>
  <done>
Header.tsx updated with same changes as AppShell for consistency
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes
2. Mobile (<768px):
   - Search icon visible, tapping opens search dialog
   - Avatar dropdown shows with badge if unread notifications
   - No breadcrumbs visible
   - Bottom tab bar still works (from Phase 37)
3. Desktop (>=768px):
   - Full search bar visible
   - Breadcrumbs visible
   - Avatar dropdown works
   - Admin role switcher still works
4. Sign out:
   - Click avatar -> dropdown opens
   - Click "Sign Out" -> redirects to home page
5. No UserButton visible anywhere
</verification>

<success_criteria>
- Mobile shows search icon instead of hidden search bar (HDR-01)
- Single avatar dropdown replaces UserButton + NotificationCenter (HDR-02)
- Breadcrumbs hidden on mobile, shown on desktop (HDR-07)
- Admin role switcher unchanged (functional, separate from dropdown)
- No Clerk UserButton component visible (HDR-10)
</success_criteria>

<output>
After completion, create `.planning/phases/38-header-redesign/38-03-SUMMARY.md`
</output>
