---
phase: 63-multi-role-agent-auth-enforcement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/ai/roles/instructions.ts
  - convex/ai/roles/toolSets.ts
  - convex/ai/roles/auth.ts
  - convex/ai/tools/propertySearch.ts
  - convex/ai/tools/providerSearch.ts
autonomous: true

must_haves:
  truths:
    - "Each of the 5 roles (investor, broker, mortgage_advisor, lawyer, admin) has a distinct system prompt with role-specific guidance and tool descriptions"
    - "A getRoleTools function returns a different tool set per role, with admin getting the effective role's tools when viewingAsRole is set"
    - "Every tool handler authenticates via ctx.auth.getUserIdentity(), gets the user, calculates effectiveRole, and enforces role-based access before executing"
    - "An unauthenticated or unauthorized tool call throws a user-friendly error message"
  artifacts:
    - path: "convex/ai/roles/instructions.ts"
      provides: "getRoleInstructions(role) function returning role-specific system prompt strings"
      exports: ["getRoleInstructions"]
    - path: "convex/ai/roles/toolSets.ts"
      provides: "getRoleTools(role) function returning role-scoped tool objects"
      exports: ["getRoleTools"]
    - path: "convex/ai/roles/auth.ts"
      provides: "authenticateToolUser(ctx) helper returning { user, effectiveRole } or throwing"
      exports: ["authenticateToolUser"]
    - path: "convex/ai/tools/propertySearch.ts"
      provides: "searchPropertiesTool with auth enforcement in handler"
      contains: "ctx.auth.getUserIdentity"
    - path: "convex/ai/tools/providerSearch.ts"
      provides: "searchProvidersTool with auth enforcement in handler"
      contains: "ctx.auth.getUserIdentity"
  key_links:
    - from: "convex/ai/roles/toolSets.ts"
      to: "convex/ai/tools/propertySearch.ts"
      via: "import searchPropertiesTool"
      pattern: "import.*searchPropertiesTool"
    - from: "convex/ai/roles/toolSets.ts"
      to: "convex/ai/tools/providerSearch.ts"
      via: "import searchProvidersTool"
      pattern: "import.*searchProvidersTool"
    - from: "convex/ai/tools/propertySearch.ts"
      to: "convex/ai/roles/auth.ts"
      via: "import authenticateToolUser"
      pattern: "authenticateToolUser"
    - from: "convex/ai/roles/auth.ts"
      to: "convex/users API"
      via: "ctx.runQuery(api.users.getByClerkId)"
      pattern: "api\\.users\\.getByClerkId"
---

<objective>
Create the role system backend: role-specific instructions for all 5 platform roles, role-scoped tool sets, and a shared auth helper for tool handlers. Retrofit auth enforcement into the two existing tools (propertySearch, providerSearch).

Purpose: This is the security and role foundation that Phase 63's chat integration (Plan 02) depends on. Without distinct instructions per role, all users get the same experience. Without auth in tool handlers, any user could invoke any tool via prompt injection.

Output: Three new files in `convex/ai/roles/` and two updated tool files with auth enforcement.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-multi-role-agent-auth-enforcement/63-RESEARCH.md

Key source files to reference:
@convex/ai/agent.ts
@convex/ai/chat.ts (lines 94-111 for current role prompt pattern)
@convex/ai/tools/propertySearch.ts
@convex/ai/tools/providerSearch.ts
@convex/ai/context.ts (for buildProfileContext -- investors only)
@src/hooks/useCurrentUser.ts (effectiveRole pattern on frontend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create convex/ai/roles/ module (instructions, toolSets, auth helper)</name>
  <files>
    convex/ai/roles/instructions.ts
    convex/ai/roles/toolSets.ts
    convex/ai/roles/auth.ts
  </files>
  <action>
Create three files in `convex/ai/roles/`:

**1. `convex/ai/roles/auth.ts`** -- Shared auth helper for tool handlers.

Export a single function `authenticateToolUser(ctx)` that:
- Calls `ctx.auth.getUserIdentity()` -- throws `"Not authenticated"` if null
- Calls `ctx.runQuery(api.users.getByClerkId, { clerkId: identity.subject })` -- throws `"User not found"` if null
- Calculates `effectiveRole`: if `user.role === "admin" && user.viewingAsRole`, use `user.viewingAsRole`, else use `user.role`
- Returns `{ user, effectiveRole, identity }` -- the user doc, the calculated role, and the identity

The `ctx` parameter type: use the same pattern as existing tool handlers. Import `api` from `"../../_generated/api"`. Do NOT import ActionCtx directly -- use a generic type for ctx that has `auth` and `runQuery` properties (the createTool handler ctx type). Use this pattern:
```typescript
type ToolCtx = {
  auth: { getUserIdentity: () => Promise<any> };
  runQuery: (query: any, args: any) => Promise<any>;
};
```

**2. `convex/ai/roles/instructions.ts`** -- Role-specific system prompts.

Export `getRoleInstructions(role: string): string` that returns a markdown system prompt section.

For each role, the prompt should:
- State the role clearly (## Your Role header)
- Describe what the assistant focuses on for this role
- List the tools available to this role and when to use them
- Include role-specific behavioral guidelines

Role prompts (keep each 10-20 lines for token efficiency):

- **investor**: Focus on property discovery, investment analysis, provider recommendations, deal guidance. Tools: searchProperties, searchProviders. Never invent data. Reference their profile when relevant. Suggest next steps after tool results.

- **broker**: Focus on client management, deal progression, market insights. Currently has: searchProperties (to help clients find properties), searchProviders (to find complementary team members). Help them prioritize pipeline tasks and communicate effectively with clients.

- **mortgage_advisor**: Focus on client financing, mortgage guidance, deal support. Currently has: searchProperties (to understand deal properties), searchProviders (to coordinate with team members). Help with mortgage-related questions and client communication.

- **lawyer**: Focus on legal processes, contract guidance, closing procedures, deal compliance. Currently has: searchProperties (to review deal properties), searchProviders (to coordinate with team). Help with legal stage questions and document requirements.

- **admin**: Focus on platform operations, user oversight, data verification. Has access to all tools. When viewing as another role (via viewingAsRole), adapt behavior to match that role's perspective. Can help debug platform issues and verify data integrity.

Default/fallback returns the investor prompt.

**3. `convex/ai/roles/toolSets.ts`** -- Role-to-tool mapping.

Import `searchPropertiesTool` from `"../tools/propertySearch"` and `searchProvidersTool` from `"../tools/providerSearch"`.

Export `getRoleTools(role: string): Record<string, any>` that returns a tools object per role:

- **investor**: `{ searchProperties: searchPropertiesTool, searchProviders: searchProvidersTool }` -- both tools
- **broker**: `{ searchProperties: searchPropertiesTool, searchProviders: searchProvidersTool }` -- can search to help clients
- **mortgage_advisor**: `{ searchProperties: searchPropertiesTool, searchProviders: searchProvidersTool }` -- can search for context
- **lawyer**: `{ searchProperties: searchPropertiesTool, searchProviders: searchProvidersTool }` -- can search for context
- **admin**: `{ searchProperties: searchPropertiesTool, searchProviders: searchProvidersTool }` -- all tools (same as above for now; Phase 64 adds more tools per role)

Default/fallback returns empty object `{}`.

NOTE: Currently all roles get the same two tools because those are the only tools that exist. The value of this mapping is (a) the structure is ready for Phase 64 when role-specific tools are added, and (b) the admin tool selection respects viewingAsRole. The role-specific tool sets will diverge in Phase 64 (ACT-01, ACT-02).

Add a JSDoc comment explaining this: "Phase 63 establishes the tool set mapping pattern. Phase 64 adds role-specific read/write tools that will differentiate the tool sets."
  </action>
  <verify>
    Run `npx convex typecheck` from the project root. All three new files should compile without errors. Verify imports resolve correctly.
  </verify>
  <done>
    Three files exist in convex/ai/roles/ with exported functions: getRoleInstructions, getRoleTools, authenticateToolUser. All type-check successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add auth enforcement to existing tool handlers</name>
  <files>
    convex/ai/tools/propertySearch.ts
    convex/ai/tools/providerSearch.ts
  </files>
  <action>
Retrofit server-side auth enforcement into both existing tool handlers. This is the critical security requirement (ACT-03).

**For both `propertySearch.ts` and `providerSearch.ts`:**

1. Import `authenticateToolUser` from `"../roles/auth"` at the top of each file.

2. At the START of each handler (before any query execution), add auth enforcement:
```typescript
// Server-side auth enforcement (ACT-03)
const { effectiveRole } = await authenticateToolUser(ctx);
```

3. For `propertySearch.ts`, add a role check after auth:
```typescript
// Property search is available to all authenticated roles
// (investors search for properties, providers search for deal context)
// This check ensures only authenticated users can search
// Role-specific restrictions will be added in Phase 64 if needed
```
No role restriction needed -- all roles can search properties. The auth check itself (ensuring the user is authenticated and valid) is the security requirement.

4. For `providerSearch.ts`, add the same pattern:
```typescript
// Provider search is available to all authenticated roles
// Investors find team members, providers find collaborators
```
No role restriction needed -- all roles can search providers.

5. The key security gain: Previously, these tools had ZERO auth checks. Now they:
   - Verify the user is authenticated (not an anonymous/expired session)
   - Verify the user exists in the database
   - Calculate effectiveRole (for future Phase 64 role restrictions)
   - Throw clear errors on auth failure

Do NOT change the tool description, args schema, or return types. Only add the auth check at the start of each handler.

Error messages should be user-friendly:
- "Not authenticated" (if identity is null)
- "User not found" (if user record doesn't exist)
These are defined in `auth.ts` and will be surfaced by the LLM to the user naturally.
  </action>
  <verify>
    Run `npx convex typecheck`. Both tool files should compile. Check that `authenticateToolUser` is called as the first line in each handler.
  </verify>
  <done>
    Both propertySearch.ts and providerSearch.ts handlers start with `authenticateToolUser(ctx)` call. Auth is enforced server-side before any query execution.
  </done>
</task>

</tasks>

<verification>
1. `npx convex typecheck` passes with no errors
2. `convex/ai/roles/instructions.ts` exports `getRoleInstructions` with distinct prompts for all 5 roles
3. `convex/ai/roles/toolSets.ts` exports `getRoleTools` with tool mappings for all 5 roles
4. `convex/ai/roles/auth.ts` exports `authenticateToolUser` that authenticates, gets user, calculates effectiveRole
5. Both existing tools (propertySearch, providerSearch) call `authenticateToolUser` at the start of their handlers
6. No changes to tool descriptions, args, or return types
</verification>

<success_criteria>
- All 5 roles have distinct system prompts in getRoleInstructions
- getRoleTools returns appropriate tool objects per role
- authenticateToolUser provides the effectiveRole pattern as a reusable helper
- Existing tools are secured with auth enforcement (ACT-03)
- All files type-check without errors
</success_criteria>

<output>
After completion, create `.planning/phases/63-multi-role-agent-auth-enforcement/63-01-SUMMARY.md`
</output>
