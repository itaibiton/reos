---
phase: 63-multi-role-agent-auth-enforcement
plan: 02
type: execute
wave: 2
depends_on: ["63-01"]
files_modified:
  - convex/ai/chat.ts
  - convex/ai/agent.ts
  - src/components/ai/hooks/useAIAssistantChat.ts
  - src/components/ai/AIAssistantPanel.tsx
  - src/components/ai/hooks/useSuggestedPrompts.ts
  - messages/en.json
  - messages/he.json
autonomous: true

must_haves:
  truths:
    - "sendMessage in chat.ts calculates effectiveRole from the user record (not from the frontend role parameter) and uses it for getRoleInstructions and getRoleTools"
    - "Admin with viewingAsRole gets the effective role's system prompt and tool set, not the admin tools"
    - "The frontend passes effectiveRole to sendMessage so the backend can log it, but the backend independently re-derives it from ctx.auth for security"
    - "Suggested prompts adapt based on the user's effective role -- service providers see provider-relevant prompts, not investor prompts"
    - "agent.ts tools field is empty (tools are injected dynamically per role in chat.ts)"
  artifacts:
    - path: "convex/ai/chat.ts"
      provides: "sendMessage using getRoleInstructions + getRoleTools with effectiveRole derived from ctx.auth"
      contains: "getRoleInstructions"
    - path: "convex/ai/agent.ts"
      provides: "platformAssistant with empty tools (dynamic injection)"
      contains: "tools: {}"
    - path: "src/components/ai/hooks/useAIAssistantChat.ts"
      provides: "Hook that passes effectiveRole to sendMessage"
      contains: "effectiveRole"
    - path: "src/components/ai/hooks/useSuggestedPrompts.ts"
      provides: "Role-aware suggested prompts with provider-specific page type keys"
      contains: "role"
    - path: "messages/en.json"
      provides: "Provider-role suggested prompt translations"
      contains: "clientManagement"
    - path: "messages/he.json"
      provides: "Hebrew provider-role suggested prompt translations"
  key_links:
    - from: "convex/ai/chat.ts"
      to: "convex/ai/roles/instructions.ts"
      via: "import getRoleInstructions"
      pattern: "getRoleInstructions\\(effectiveRole\\)"
    - from: "convex/ai/chat.ts"
      to: "convex/ai/roles/toolSets.ts"
      via: "import getRoleTools"
      pattern: "getRoleTools\\(effectiveRole\\)"
    - from: "src/components/ai/hooks/useAIAssistantChat.ts"
      to: "src/hooks/useCurrentUser.ts"
      via: "useCurrentUser hook for effectiveRole"
      pattern: "useCurrentUser"
    - from: "src/components/ai/AIAssistantPanel.tsx"
      to: "src/components/ai/hooks/useSuggestedPrompts.ts"
      via: "useSuggestedPrompts(pageType, effectiveRole)"
      pattern: "useSuggestedPrompts"
---

<objective>
Wire the role system (from Plan 01) into the chat action and frontend. The sendMessage action uses effectiveRole (derived server-side from ctx.auth) to select role-specific instructions and tools. The frontend passes effectiveRole for logging purposes and adapts suggested prompts per role.

Purpose: This connects the role definitions and auth enforcement (Plan 01) to the actual user experience, completing all 4 Phase 63 requirements (ROLE-01, ROLE-02, ROLE-03, ACT-03).

Output: Updated chat.ts and agent.ts on the backend, updated hooks and panel on the frontend, and role-specific i18n keys for suggested prompts.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-multi-role-agent-auth-enforcement/63-RESEARCH.md
@.planning/phases/63-multi-role-agent-auth-enforcement/63-01-SUMMARY.md

Key source files:
@convex/ai/chat.ts
@convex/ai/agent.ts
@src/components/ai/hooks/useAIAssistantChat.ts
@src/components/ai/AIAssistantPanel.tsx
@src/components/ai/hooks/useSuggestedPrompts.ts
@src/hooks/useCurrentUser.ts
@messages/en.json (aiAssistant.suggestions section, around line 2735)
@messages/he.json (matching section)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire role system into chat.ts and agent.ts</name>
  <files>
    convex/ai/chat.ts
    convex/ai/agent.ts
  </files>
  <action>
**1. Update `convex/ai/agent.ts`:**

Remove the hardcoded tools from the platformAssistant definition. The tools are now injected dynamically per role in chat.ts.

Change:
```typescript
tools: {
  searchProperties: searchPropertiesTool,
  searchProviders: searchProvidersTool,
},
```
To:
```typescript
tools: {},
```

Remove the imports for `searchPropertiesTool` and `searchProvidersTool` since they're no longer used in this file.

Update the JSDoc comment to note: "Tools are injected dynamically per role via getRoleTools() in chat.ts"

Keep the `instructions` field as-is (it's the base/fallback prompt). The role-specific prompt is prepended in chat.ts via `system` parameter.

**2. Update `convex/ai/chat.ts`:**

Add imports at the top:
```typescript
import { getRoleInstructions } from "./roles/instructions";
import { getRoleTools } from "./roles/toolSets";
```

In the `sendMessage` handler, AFTER getting the user record (around line 53), add effectiveRole calculation:
```typescript
// Calculate effective role server-side (never trust frontend for auth)
const effectiveRole = user.role === "admin" && user.viewingAsRole
  ? user.viewingAsRole
  : (user.role ?? "investor");
```

Replace the existing role prompt block (lines 94-111) which is:
```typescript
const userRole = role ?? "investor";
let rolePrompt = "";
if (userRole === "investor") {
  rolePrompt = `## Your Role...`;
} else {
  rolePrompt = `## Your Role...`;
}
```

With:
```typescript
// Get role-specific instructions and tools (ROLE-01, ROLE-02)
const rolePrompt = getRoleInstructions(effectiveRole);
const roleTools = getRoleTools(effectiveRole);
```

Update the `agentThread.streamText()` call to pass the role-specific tools. Currently (around line 198-212) the call doesn't pass tools:
```typescript
const result = await agentThread.streamText(
  {
    prompt: message || "Begin our conversation",
    system: systemContext || undefined,
    abortSignal: abortController.signal,
    toolChoice: shouldForceToolUse ? "required" : "auto",
  },
  {
    saveStreamDeltas: true,
    contextOptions: {
      recentMessages: 10,
    },
  }
);
```

Add `tools: roleTools` to the second argument (the options object):
```typescript
const result = await agentThread.streamText(
  {
    prompt: message || "Begin our conversation",
    system: systemContext || undefined,
    abortSignal: abortController.signal,
    toolChoice: shouldForceToolUse ? "required" : "auto",
  },
  {
    saveStreamDeltas: true,
    contextOptions: {
      recentMessages: 10,
    },
    tools: roleTools, // Role-scoped tools (ROLE-03)
  }
);
```

Update the `updateThreadRole` call at the end to use the server-derived effectiveRole instead of the frontend-passed `role`:
```typescript
void ctx.runMutation(internal.ai.threads.updateThreadRole, {
  threadId,
  role: effectiveRole,  // Use server-derived role, not frontend parameter
});
```

For the auto-greeting block (around line 162-174), make it role-aware. The current auto-greeting is investor-specific ("Welcome! Based on your profile..."). Wrap it in a role check:

```typescript
if (isAutoGreeting) {
  if (effectiveRole === "investor") {
    systemContext += `\n\n## Auto-Greeting Instructions
...existing investor auto-greeting content...`;
  } else {
    systemContext += `\n\n## Auto-Greeting Instructions

You're starting a conversation with a ${effectiveRole} user.
Give a brief, warm greeting acknowledging their role on the REOS platform.
Ask how you can help them today. Keep it to 2-3 sentences.
Do NOT call any tools automatically for non-investor roles.`;
  }
}
```

Keep the `role` parameter in the args schema (it's still accepted from frontend for backward compatibility) but use `effectiveRole` for all logic.

The `toolChoice: shouldForceToolUse ? "required" : "auto"` logic should also be role-aware. The `shouldForceToolUse` currently triggers on auto-greeting OR property/provider keywords. For non-investor roles during auto-greeting, don't force tool use:

Update the `shouldForceToolUse` calculation:
```typescript
// Force tool usage for investor auto-greeting or explicit property/provider requests
const shouldForceToolUse = (isAutoGreeting && effectiveRole === "investor") || wantsProperties || wantsProviders;
```
  </action>
  <verify>
    Run `npx convex typecheck`. Both files should compile. Verify that:
    1. agent.ts has `tools: {}` (empty tools)
    2. chat.ts imports getRoleInstructions and getRoleTools
    3. chat.ts calculates effectiveRole from user record (not from `role` parameter)
    4. streamText receives `tools: roleTools` in options
    5. Auto-greeting is role-aware
  </verify>
  <done>
    chat.ts derives effectiveRole server-side, uses getRoleInstructions and getRoleTools, passes role-scoped tools to streamText, and has role-aware auto-greeting. agent.ts has empty tools (dynamic injection). Both type-check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update frontend hooks + suggested prompts with role awareness and i18n</name>
  <files>
    src/components/ai/hooks/useAIAssistantChat.ts
    src/components/ai/AIAssistantPanel.tsx
    src/components/ai/hooks/useSuggestedPrompts.ts
    messages/en.json
    messages/he.json
  </files>
  <action>
**1. Update `src/components/ai/hooks/useAIAssistantChat.ts`:**

Add effectiveRole parameter to the hook signature. The hook already accepts `pageContext` -- add an optional `effectiveRole` parameter:

```typescript
export function useAIAssistantChat(pageContext?: PageContext, effectiveRole?: string) {
```

Add a ref for effectiveRole (same pattern as pageContextRef):
```typescript
const effectiveRoleRef = useRef(effectiveRole);
useEffect(() => {
  effectiveRoleRef.current = effectiveRole;
}, [effectiveRole]);
```

In the sendMessage callback, pass the role to the backend. The backend will independently verify it, but passing it helps with logging and backward compatibility:
```typescript
await sendMessageAction({
  message: text,
  role: effectiveRoleRef.current,
  ...(ctx && {
    pageContext: {
      pageType: ctx.pageType,
      ...(ctx.entityType && { entityType: ctx.entityType }),
      ...(ctx.entityId && { entityId: ctx.entityId }),
    },
  }),
});
```

**2. Update `src/components/ai/AIAssistantPanel.tsx`:**

Import `useCurrentUser` from `@/hooks/useCurrentUser`:
```typescript
import { useCurrentUser } from "@/hooks/useCurrentUser";
```

In `AssistantChatContent`, get the effective role:
```typescript
const { effectiveRole } = useCurrentUser();
```

Pass it to the hooks:
```typescript
const suggestedPrompts = useSuggestedPrompts(pageContext.pageType, effectiveRole);
```

And:
```typescript
const { messages, isStreaming, ... } = useAIAssistantChat(pageContext, effectiveRole);
```

**3. Update `src/components/ai/hooks/useSuggestedPrompts.ts`:**

Add role awareness. The hook should return different prompts for service provider roles vs investors.

Update the function signature:
```typescript
export function useSuggestedPrompts(pageType: string, effectiveRole?: string): string[] {
```

Add provider-specific prompt keys. Create a new constant for provider roles (broker, mortgage_advisor, lawyer):

```typescript
const PROVIDER_PROMPT_KEYS_BY_PAGE_TYPE: Record<string, string[]> = {
  dashboard: [
    "provider.dashboard.clients",
    "provider.dashboard.pipeline",
    "provider.dashboard.help",
  ],
  deals_list: [
    "provider.dealsList.activeDeals",
    "provider.dealsList.nextAction",
    "provider.dealsList.clientUpdate",
  ],
  deal_detail: [
    "provider.dealDetail.progress",
    "provider.dealDetail.clientInfo",
    "provider.dealDetail.nextStep",
  ],
  property_detail: [
    "provider.propertyDetail.dealContext",
    "provider.propertyDetail.marketInfo",
    "provider.propertyDetail.clientMatch",
  ],
  providers_browse: [
    "provider.providersBrowse.findColleague",
    "provider.providersBrowse.teamBuilding",
    "provider.providersBrowse.specializations",
  ],
};
```

Add admin-specific prompt keys:

```typescript
const ADMIN_PROMPT_KEYS_BY_PAGE_TYPE: Record<string, string[]> = {
  dashboard: [
    "admin.dashboard.overview",
    "admin.dashboard.pendingActions",
    "admin.dashboard.platformHealth",
  ],
};
```

Update the hook logic to select the right prompt keys based on role:
```typescript
return useMemo(() => {
  const isProvider = effectiveRole === "broker" || effectiveRole === "mortgage_advisor" || effectiveRole === "lawyer";
  const isAdmin = effectiveRole === "admin";

  let keys: string[];
  if (isProvider) {
    keys = PROVIDER_PROMPT_KEYS_BY_PAGE_TYPE[pageType]
      ?? PROVIDER_PROMPT_KEYS_BY_PAGE_TYPE["dashboard"]
      ?? [];
  } else if (isAdmin) {
    keys = ADMIN_PROMPT_KEYS_BY_PAGE_TYPE[pageType]
      ?? ADMIN_PROMPT_KEYS_BY_PAGE_TYPE["dashboard"]
      ?? [];
  } else {
    // Investor (default)
    keys = PROMPT_KEYS_BY_PAGE_TYPE[pageType]
      ?? PROMPT_KEYS_BY_PAGE_TYPE["dashboard"]
      ?? [];
  }

  return keys.map((key) => t(key));
}, [pageType, effectiveRole, t]);
```

**4. Update `messages/en.json`:**

Add provider and admin suggested prompt translations under `aiAssistant.suggestions`. Add these AFTER the existing `settings` section (around line 2784):

```json
"provider": {
  "dashboard": {
    "clients": "Show me a summary of my clients",
    "pipeline": "Which deals need my attention?",
    "help": "Help me understand my dashboard"
  },
  "dealsList": {
    "activeDeals": "Summarize my active deals",
    "nextAction": "What should I focus on next?",
    "clientUpdate": "Help me prepare a client update"
  },
  "dealDetail": {
    "progress": "What's the progress on this deal?",
    "clientInfo": "Tell me about this client",
    "nextStep": "What's the next step for this deal?"
  },
  "propertyDetail": {
    "dealContext": "How does this property relate to my deals?",
    "marketInfo": "What's the market outlook for this area?",
    "clientMatch": "Which of my clients might be interested?"
  },
  "providersBrowse": {
    "findColleague": "Help me find colleagues in my area",
    "teamBuilding": "Who can complement my services?",
    "specializations": "What specializations are available?"
  }
},
"admin": {
  "dashboard": {
    "overview": "Give me a platform overview",
    "pendingActions": "What actions need my attention?",
    "platformHealth": "How is the platform performing?"
  }
}
```

**5. Update `messages/he.json`:**

Add the matching Hebrew translations under the same path `aiAssistant.suggestions`:

```json
"provider": {
  "dashboard": {
    "clients": "\u05D4\u05E6\u05D2 \u05DC\u05D9 \u05E1\u05D9\u05DB\u05D5\u05DD \u05E9\u05DC \u05D4\u05DC\u05E7\u05D5\u05D7\u05D5\u05EA \u05E9\u05DC\u05D9",
    "pipeline": "\u05D0\u05D9\u05D6\u05D4 \u05E2\u05E1\u05E7\u05D0\u05D5\u05EA \u05D3\u05D5\u05E8\u05E9\u05D5\u05EA \u05EA\u05E9\u05D5\u05DE\u05EA \u05DC\u05D1\u05D9?",
    "help": "\u05E2\u05D6\u05D5\u05E8 \u05DC\u05D9 \u05DC\u05D4\u05D1\u05D9\u05DF \u05D0\u05EA \u05DC\u05D5\u05D7 \u05D4\u05D1\u05E7\u05E8\u05D4"
  },
  "dealsList": {
    "activeDeals": "\u05E1\u05DB\u05DD \u05D0\u05EA \u05D4\u05E2\u05E1\u05E7\u05D0\u05D5\u05EA \u05D4\u05E4\u05E2\u05D9\u05DC\u05D5\u05EA \u05E9\u05DC\u05D9",
    "nextAction": "\u05E2\u05DC \u05DE\u05D4 \u05DC\u05D4\u05EA\u05DE\u05E7\u05D3 \u05E2\u05DB\u05E9\u05D9\u05D5?",
    "clientUpdate": "\u05E2\u05D6\u05D5\u05E8 \u05DC\u05D9 \u05DC\u05D4\u05DB\u05D9\u05DF \u05E2\u05D3\u05DB\u05D5\u05DF \u05DC\u05DC\u05E7\u05D5\u05D7"
  },
  "dealDetail": {
    "progress": "\u05DE\u05D4 \u05D4\u05D4\u05EA\u05E7\u05D3\u05DE\u05D5\u05EA \u05D1\u05E2\u05E1\u05E7\u05D4 \u05D4\u05D6\u05D5?",
    "clientInfo": "\u05E1\u05E4\u05E8 \u05DC\u05D9 \u05E2\u05DC \u05D4\u05DC\u05E7\u05D5\u05D7 \u05D4\u05D6\u05D4",
    "nextStep": "\u05DE\u05D4 \u05D4\u05E9\u05DC\u05D1 \u05D4\u05D1\u05D0 \u05D1\u05E2\u05E1\u05E7\u05D4?"
  },
  "propertyDetail": {
    "dealContext": "\u05D0\u05D9\u05DA \u05D4\u05E0\u05DB\u05E1 \u05D4\u05D6\u05D4 \u05E7\u05E9\u05D5\u05E8 \u05DC\u05E2\u05E1\u05E7\u05D0\u05D5\u05EA \u05E9\u05DC\u05D9?",
    "marketInfo": "\u05DE\u05D4 \u05D4\u05EA\u05D7\u05D6\u05D9\u05EA \u05DC\u05D0\u05D6\u05D5\u05E8 \u05D4\u05D6\u05D4?",
    "clientMatch": "\u05DE\u05D9 \u05DE\u05D4\u05DC\u05E7\u05D5\u05D7\u05D5\u05EA \u05E9\u05DC\u05D9 \u05E2\u05E9\u05D5\u05D9 \u05DC\u05D4\u05EA\u05E2\u05E0\u05D9\u05D9\u05DF?"
  },
  "providersBrowse": {
    "findColleague": "\u05E2\u05D6\u05D5\u05E8 \u05DC\u05D9 \u05DC\u05DE\u05E6\u05D5\u05D0 \u05E2\u05DE\u05D9\u05EA\u05D9\u05DD \u05D1\u05D0\u05D6\u05D5\u05E8 \u05E9\u05DC\u05D9",
    "teamBuilding": "\u05DE\u05D9 \u05D9\u05DB\u05D5\u05DC \u05DC\u05D4\u05E9\u05DC\u05D9\u05DD \u05D0\u05EA \u05D4\u05E9\u05D9\u05E8\u05D5\u05EA\u05D9\u05DD \u05E9\u05DC\u05D9?",
    "specializations": "\u05D0\u05D9\u05DC\u05D5 \u05D4\u05EA\u05DE\u05D7\u05D5\u05D9\u05D5\u05EA \u05D6\u05DE\u05D9\u05E0\u05D5\u05EA?"
  }
},
"admin": {
  "dashboard": {
    "overview": "\u05EA\u05DF \u05DC\u05D9 \u05E1\u05E7\u05D9\u05E8\u05D4 \u05E9\u05DC \u05D4\u05E4\u05DC\u05D8\u05E4\u05D5\u05E8\u05DE\u05D4",
    "pendingActions": "\u05D0\u05D9\u05DC\u05D5 \u05E4\u05E2\u05D5\u05DC\u05D5\u05EA \u05D3\u05D5\u05E8\u05E9\u05D5\u05EA \u05EA\u05E9\u05D5\u05DE\u05EA \u05DC\u05D1\u05D9?",
    "platformHealth": "\u05DE\u05D4 \u05DE\u05E6\u05D1 \u05D4\u05E4\u05DC\u05D8\u05E4\u05D5\u05E8\u05DE\u05D4?"
  }
}
```

NOTE for the executor: Use the actual Hebrew text, not Unicode escapes. The above are escaped for plan readability. The actual values should be readable Hebrew:
- "Show me a summary of my clients" = "הצג לי סיכום של הלקוחות שלי"
- "Which deals need my attention?" = "איזה עסקאות דורשות תשומת לבי?"
- "Help me understand my dashboard" = "עזור לי להבין את לוח הבקרה"
- "Summarize my active deals" = "סכם את העסקאות הפעילות שלי"
- "What should I focus on next?" = "על מה להתמקד עכשיו?"
- "Help me prepare a client update" = "עזור לי להכין עדכון ללקוח"
- "What's the progress on this deal?" = "מה ההתקדמות בעסקה הזו?"
- "Tell me about this client" = "ספר לי על הלקוח הזה"
- "What's the next step for this deal?" = "מה השלב הבא בעסקה?"
- "How does this property relate to my deals?" = "איך הנכס הזה קשור לעסקאות שלי?"
- "What's the market outlook for this area?" = "מה התחזית לאזור הזה?"
- "Which of my clients might be interested?" = "מי מהלקוחות שלי עשוי להתעניין?"
- "Help me find colleagues in my area" = "עזור לי למצוא עמיתים באזור שלי"
- "Who can complement my services?" = "מי יכול להשלים את השירותים שלי?"
- "What specializations are available?" = "אילו התמחויות זמינות?"
- "Give me a platform overview" = "תן לי סקירה של הפלטפורמה"
- "What actions need my attention?" = "אילו פעולות דורשות תשומת לבי?"
- "How is the platform performing?" = "מה מצב הפלטפורמה?"

Be careful to place the new keys inside the existing `aiAssistant.suggestions` object, after the `settings` key and before the closing brace of `suggestions`.
  </action>
  <verify>
    1. Run `npx convex typecheck` for backend changes
    2. Run `npx next build` (or at minimum verify no TS errors in frontend) to check frontend compiles
    3. Verify en.json and he.json are valid JSON (use `node -e "JSON.parse(require('fs').readFileSync('messages/en.json'))"`)
    4. Verify useAIAssistantChat accepts effectiveRole parameter
    5. Verify useSuggestedPrompts selects provider prompts for broker/mortgage_advisor/lawyer roles
    6. Verify AIAssistantPanel passes effectiveRole from useCurrentUser to both hooks
  </verify>
  <done>
    - chat.ts derives effectiveRole server-side and uses getRoleInstructions/getRoleTools
    - agent.ts has empty tools (dynamic injection per role)
    - Frontend passes effectiveRole through hooks
    - Suggested prompts are role-aware with provider and admin variants
    - i18n keys exist in both en.json and he.json for all role-specific prompts
    - All files compile without errors
  </done>
</task>

</tasks>

<verification>
1. `npx convex typecheck` passes with no errors
2. Frontend compiles without TypeScript errors
3. en.json and he.json are valid JSON with provider and admin suggestion keys
4. chat.ts uses `effectiveRole` (from user record) for all role logic, not the `role` parameter
5. chat.ts passes `tools: roleTools` to `agentThread.streamText()`
6. agent.ts has `tools: {}` (no hardcoded tools)
7. useSuggestedPrompts returns different prompts for investors vs providers vs admins
8. Auto-greeting is role-aware (investor gets full tool-call greeting, others get simple greeting)
</verification>

<success_criteria>
- An investor sees investor prompts and tools; a broker sees provider prompts
- Admin with viewingAsRole=broker sees broker prompts and tools
- effectiveRole is derived server-side from ctx.auth (ROLE-02, ACT-03)
- Tools are injected dynamically per role (ROLE-03)
- i18n complete for both EN and HE with provider and admin prompts
</success_criteria>

<output>
After completion, create `.planning/phases/63-multi-role-agent-auth-enforcement/63-02-SUMMARY.md`
</output>
