---
phase: 14-ai-preferences-service-selection
plan: 01
type: execute
domain: questionnaire
---

<objective>
Add 3 new questionnaire steps: purchase timeline, free-text AI preferences, and service provider selection.

Purpose: Complete investor questionnaire with timeline, open-ended preferences for AI matching, and service needs.
Output: 17-step questionnaire with all investor preferences captured, ready for Phase 15 profile display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-property-preferences-location/13-01-SUMMARY.md

**Current questionnaire:**
- 14 steps (citizenship through amenities)
- Step components follow value/onChange props pattern
- QuestionBubble + AnswerArea UI pattern with showAnswer state
- Draft restoration via useEffect on questionnaire load

**Key files:**
@convex/schema.ts - investorQuestionnaires table (lines 493-531)
@convex/investorQuestionnaires.ts - saveAnswers mutation
@src/app/(app)/onboarding/questionnaire/page.tsx - wizard integration
@src/components/questionnaire/steps/index.ts - barrel exports
@src/components/questionnaire/steps/GoalsStep.tsx - checkbox multi-select pattern
@src/components/questionnaire/steps/HorizonStep.tsx - radio option pattern

**Established patterns from prior phases:**
- Checkbox multi-select: GoalsStep, PropertyTypeStep, LocationStep, AmenitiesStep
- Radio single-select: CitizenshipStep, ResidencyStep, ExperienceStep, OwnershipStep, HorizonStep
- Each step uses QuestionBubble (question, description, onTypingComplete) + AnswerArea
- Local useState for showAnswer, triggered by onTypingComplete callback
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schema fields and create 3 step components</name>
  <files>
    convex/schema.ts,
    convex/investorQuestionnaires.ts,
    src/components/questionnaire/steps/TimelineStep.tsx,
    src/components/questionnaire/steps/AdditionalPreferencesStep.tsx,
    src/components/questionnaire/steps/ServicesStep.tsx,
    src/components/questionnaire/steps/index.ts
  </files>
  <action>
1. **Schema fields** (add after Phase 13 fields in investorQuestionnaires):
   - `purchaseTimeline: v.optional(v.string())` - "3_months" | "6_months" | "1_year" | "exploring"
   - `additionalPreferences: v.optional(v.string())` - free-text up to 2000 chars
   - `servicesNeeded: v.optional(v.array(v.string()))` - ["broker", "mortgage_advisor", "lawyer"]

2. **saveAnswers mutation** - Add the 3 new fields to args and update logic

3. **TimelineStep.tsx** - Radio single-select with 4 options:
   - "Within 3 months" (3_months)
   - "Within 6 months" (6_months)
   - "Within 1 year" (1_year)
   - "Just exploring" (exploring)
   Question: "When are you looking to purchase?"
   Description: "This helps us prioritize your matches."

4. **AdditionalPreferencesStep.tsx** - Textarea for free-text:
   - Use Shadcn Textarea component
   - Placeholder: "e.g., I prefer properties near good schools, looking for a quiet neighborhood..."
   - Max length 2000 chars with character count display
   Question: "Anything else we should know?"
   Description: "Share any preferences not covered above. Our AI uses this to find better matches."

5. **ServicesStep.tsx** - Checkbox multi-select with 3 options:
   - Broker: "Help finding and negotiating properties"
   - Mortgage advisor: "Help with financing options"
   - Lawyer: "Legal assistance for purchase"
   Question: "Which services would you like?"
   Description: "Select all that apply. We'll connect you with our partners."

6. **Barrel exports** - Add 3 new exports to steps/index.ts
  </action>
  <verify>
    - `npx convex dev --typecheck=enable` passes (schema valid)
    - All 3 step components exist and export correctly
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    - 3 new schema fields added to investorQuestionnaires
    - saveAnswers mutation accepts new fields
    - 3 step components created following established patterns
    - Barrel exports updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire up questionnaire page with new steps</name>
  <files>
    src/app/(app)/onboarding/questionnaire/page.tsx
  </files>
  <action>
1. **Add state variables** (after Phase 13 state):
   - `purchaseTimeline: string | undefined`
   - `additionalPreferences: string | undefined`
   - `servicesNeeded: string[]`

2. **Draft restoration** - Add to useEffect that loads questionnaire:
   - `setPurchaseTimeline(questionnaire.purchaseTimeline)`
   - `setAdditionalPreferences(questionnaire.additionalPreferences)`
   - `setServicesNeeded(questionnaire.servicesNeeded ?? [])`

3. **Import step components** - Add TimelineStep, AdditionalPreferencesStep, ServicesStep

4. **Add to steps array** - After amenities step (position 15-17):
   - timeline (id: "timeline", title: "Timeline")
   - additional-preferences (id: "additional-preferences", title: "Preferences")
   - services (id: "services", title: "Services")

5. **Update saveProgress** - Include new fields in saveAnswers call

6. **Update useMemo dependencies** - Add 3 new state variables
  </action>
  <verify>
    - `npm run dev` starts without errors
    - Navigate to /onboarding/questionnaire
    - All 17 steps render with forward/back navigation
    - New steps persist to Convex (check console/Convex dashboard)
  </verify>
  <done>
    - Questionnaire extended from 14 to 17 steps
    - New steps integrated with wizard
    - Draft persistence works for all Phase 14 fields
    - Step navigation works correctly
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx convex dev --typecheck=enable` passes
- [ ] `npm run build` succeeds without errors
- [ ] All 17 questionnaire steps work (forward/back)
- [ ] Phase 14 fields persist to Convex on step change
- [ ] Draft restoration loads Phase 14 fields correctly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Questionnaire has 17 steps total
- Timeline, additional preferences, and services captured
</success_criteria>

<output>
After completion, create `.planning/phases/14-ai-preferences-service-selection/14-01-SUMMARY.md` with frontmatter:
- subsystem: questionnaire
- tags: [forms, textarea, checkbox, convex, questionnaire]
- provides: 3 new questionnaire steps, 17-step investor questionnaire complete
- affects: [15-profile-display]
</output>
