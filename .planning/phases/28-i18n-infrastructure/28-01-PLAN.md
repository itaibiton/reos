---
phase: 28-i18n-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/i18n/routing.ts
  - src/i18n/navigation.ts
  - src/i18n/request.ts
  - next.config.ts
  - middleware.ts
autonomous: true

must_haves:
  truths:
    - "next-intl and @radix-ui/react-direction packages are installed"
    - "i18n routing configuration defines 'en' and 'he' locales"
    - "Middleware composes Clerk auth with next-intl locale handling"
    - "Navigation APIs export locale-aware Link, redirect, useRouter"
  artifacts:
    - path: "src/i18n/routing.ts"
      provides: "Locale routing configuration"
      exports: ["routing"]
    - path: "src/i18n/navigation.ts"
      provides: "Locale-aware navigation APIs"
      exports: ["Link", "redirect", "usePathname", "useRouter", "getPathname"]
    - path: "src/i18n/request.ts"
      provides: "Server-side request locale config"
      exports: ["default"]
    - path: "middleware.ts"
      provides: "Composed Clerk + next-intl middleware"
      contains: "clerkMiddleware"
  key_links:
    - from: "middleware.ts"
      to: "src/i18n/routing.ts"
      via: "import routing config"
      pattern: "from.*i18n/routing"
    - from: "src/i18n/navigation.ts"
      to: "src/i18n/routing.ts"
      via: "createNavigation(routing)"
      pattern: "createNavigation.*routing"
---

<objective>
Set up core next-intl infrastructure: install packages, create i18n configuration files, and compose Clerk middleware with next-intl for locale-aware routing.

Purpose: Establish the foundation for URL-based locale routing (`/en/`, `/he/` prefixes) before restructuring the app directory. The middleware must correctly chain Clerk authentication with next-intl locale handling.

Output: Working i18n configuration files and composed middleware. Route structure migration happens in Plan 02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-i18n-infrastructure/28-RESEARCH.md

# Current files to understand existing patterns
@middleware.ts
@next.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install i18n dependencies</name>
  <files>package.json</files>
  <action>
Install the required packages for internationalization:

```bash
npm install next-intl @radix-ui/react-direction
```

next-intl provides:
- `defineRouting` for locale configuration
- `createMiddleware` for middleware composition
- `createNavigation` for locale-aware navigation APIs
- `NextIntlClientProvider` for client context

@radix-ui/react-direction provides:
- `DirectionProvider` for RTL context (Radix/Shadcn components use this)
  </action>
  <verify>
Run `npm list next-intl @radix-ui/react-direction` and confirm both packages are listed with versions.
  </verify>
  <done>
Both packages appear in package.json dependencies with appropriate versions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create i18n configuration files</name>
  <files>
    src/i18n/routing.ts
    src/i18n/navigation.ts
    src/i18n/request.ts
  </files>
  <action>
Create the `src/i18n/` directory and three configuration files:

**src/i18n/routing.ts** - Central routing configuration:
```typescript
import { defineRouting } from 'next-intl/routing'

export const routing = defineRouting({
  locales: ['en', 'he'],
  defaultLocale: 'en',
  localePrefix: 'always', // URLs always include /en/ or /he/
})
```

**src/i18n/navigation.ts** - Locale-aware navigation APIs:
```typescript
import { createNavigation } from 'next-intl/navigation'
import { routing } from './routing'

export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing)
```

**src/i18n/request.ts** - Server-side request config:
```typescript
import { getRequestConfig } from 'next-intl/server'
import { hasLocale } from 'next-intl'
import { routing } from './routing'

export default getRequestConfig(async ({ requestLocale }) => {
  const requested = await requestLocale
  const locale = hasLocale(routing.locales, requested)
    ? requested
    : routing.defaultLocale

  return {
    locale,
    // Messages will be added in Phase 31 (Translation Infrastructure)
  }
})
```

Key decisions:
- `localePrefix: 'always'` ensures URLs always have `/en/` or `/he/` prefix (cleaner, avoids edge cases)
- Default locale is 'en' (English)
- Messages loading deferred to Phase 31
  </action>
  <verify>
Run `ls -la src/i18n/` and confirm all three files exist.
Run `npx tsc --noEmit` to verify TypeScript compilation.
  </verify>
  <done>
Three i18n config files exist with correct exports: routing.ts exports `routing`, navigation.ts exports `Link, redirect, usePathname, useRouter, getPathname`, request.ts has default export.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update next.config.ts and compose middleware</name>
  <files>
    next.config.ts
    middleware.ts
  </files>
  <action>
**Update next.config.ts** to use createNextIntlPlugin:
```typescript
import type { NextConfig } from "next";
import createNextIntlPlugin from 'next-intl/plugin';

const withNextIntl = createNextIntlPlugin('./src/i18n/request.ts');

const nextConfig: NextConfig = {
  /* config options here */
};

export default withNextIntl(nextConfig);
```

**Update middleware.ts** to compose Clerk with next-intl:
```typescript
import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";
import createMiddleware from "next-intl/middleware";
import { routing } from "./src/i18n/routing";

const intlMiddleware = createMiddleware(routing);

// Protected routes - all routes under (app) route group
// Include locale prefix in patterns
const isProtectedRoute = createRouteMatcher([
  "/:locale/dashboard(.*)",
  "/:locale/properties(.*)",
  "/:locale/profile(.*)",
  "/:locale/onboarding(.*)",
  "/:locale/deals(.*)",
  "/:locale/chat(.*)",
  "/:locale/clients(.*)",
  "/:locale/settings(.*)",
  "/:locale/analytics(.*)",
  "/:locale/feed(.*)",
  "/:locale/search(.*)",
  "/:locale/providers(.*)",
  "/:locale/accounting(.*)",
  "/:locale/appraisal(.*)",
  "/:locale/legal(.*)",
  "/:locale/mortgage(.*)",
  "/:locale/notary(.*)",
  "/:locale/leads(.*)",
  "/:locale/tax(.*)",
]);

export default clerkMiddleware(async (auth, req) => {
  if (isProtectedRoute(req)) {
    await auth.protect();
  }
  return intlMiddleware(req);
});

export const config = {
  matcher: [
    "/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)",
    "/(api|trpc)(.*)",
  ],
};
```

Key changes:
- Clerk middleware wraps outer, returns intlMiddleware
- Protected routes include `:locale` prefix in patterns
- All routes from (app) group are protected
- Auth pages (sign-in, sign-up) and main page are public
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation with no errors.
  </verify>
  <done>
next.config.ts uses createNextIntlPlugin and middleware.ts composes Clerk with next-intl, protecting all (app) routes with locale-aware patterns.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Dependencies installed: `npm list next-intl @radix-ui/react-direction`
3. i18n files exist: `ls -la src/i18n/`
4. Middleware imports routing config correctly

Note: The app won't run correctly yet - Plan 02 restructures the app directory to use [locale] segment.
</verification>

<success_criteria>
- next-intl ^4.x and @radix-ui/react-direction ^1.x installed
- src/i18n/routing.ts defines locales: ['en', 'he'] with defaultLocale: 'en'
- src/i18n/navigation.ts exports locale-aware navigation APIs
- src/i18n/request.ts provides server-side locale config
- middleware.ts composes Clerk auth with next-intl locale handling
- next.config.ts uses createNextIntlPlugin
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/28-i18n-infrastructure/28-01-SUMMARY.md`
</output>
