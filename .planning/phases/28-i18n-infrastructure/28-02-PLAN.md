---
phase: 28-i18n-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - src/app/[locale]/layout.tsx
  - src/app/[locale]/(app)/layout.tsx
  - src/app/[locale]/(auth)/layout.tsx
  - src/app/[locale]/(main)/layout.tsx
  - src/app/[locale]/(main)/page.tsx
  - src/app/[locale]/ConvexClientProvider.tsx
  - src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "User can navigate to /en/dashboard and /he/dashboard"
    - "User visiting /he/ sees <html dir='rtl' lang='he'>"
    - "User visiting /en/ sees <html dir='ltr' lang='en'>"
    - "Protected routes still require authentication"
    - "Existing routes redirect to locale-prefixed versions"
  artifacts:
    - path: "src/app/[locale]/layout.tsx"
      provides: "Root locale layout with providers"
      contains: "DirectionProvider"
    - path: "src/app/[locale]/(app)/layout.tsx"
      provides: "Protected app routes layout"
      contains: "AppShell"
    - path: "src/app/[locale]/(auth)/layout.tsx"
      provides: "Auth routes layout"
    - path: "src/app/[locale]/(main)/layout.tsx"
      provides: "Public main routes layout"
  key_links:
    - from: "src/app/[locale]/layout.tsx"
      to: "@radix-ui/react-direction"
      via: "DirectionProvider wrapping"
      pattern: "DirectionProvider.*dir="
    - from: "src/app/[locale]/layout.tsx"
      to: "src/i18n/routing.ts"
      via: "locale validation"
      pattern: "hasLocale.*routing"
    - from: "src/app/[locale]/(app)/layout.tsx"
      to: "src/i18n/navigation.ts"
      via: "locale-aware navigation"
      pattern: "from.*@/i18n/navigation"
---

<objective>
Migrate the app structure to use [locale] dynamic segment: move existing route groups under [locale], create locale-aware root layout with DirectionProvider, add Heebo font for Hebrew support, and update all provider URLs to include locale.

Purpose: Complete the i18n infrastructure so URLs like `/en/dashboard` and `/he/dashboard` work correctly with proper RTL support when locale is Hebrew. This satisfies INFRA-01 (URL routing), INFRA-03 (DirectionProvider), INFRA-04 (route groups preserved), and RTL-01 (HTML dir attribute).

Output: Fully functional locale-aware app structure where existing functionality works with locale prefixes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-i18n-infrastructure/28-RESEARCH.md
@.planning/phases/28-i18n-infrastructure/28-01-SUMMARY.md

# Current layout files to understand structure
@src/app/layout.tsx
@src/app/(app)/layout.tsx
@src/app/(auth)/layout.tsx
@src/app/(main)/layout.tsx
@src/app/(main)/page.tsx
@src/app/ConvexClientProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create [locale] directory structure and move route groups</name>
  <files>
    src/app/[locale]/(app)/
    src/app/[locale]/(auth)/
    src/app/[locale]/(main)/
  </files>
  <action>
Create the [locale] segment and move existing route groups under it:

```bash
# Create the [locale] directory
mkdir -p src/app/[locale]

# Move all route groups under [locale]
mv src/app/(app) src/app/[locale]/
mv src/app/(auth) src/app/[locale]/
mv src/app/(main) src/app/[locale]/
```

After moving, the structure should be:
```
src/app/
├── [locale]/
│   ├── (app)/
│   │   ├── layout.tsx
│   │   ├── dashboard/
│   │   ├── properties/
│   │   └── ... (all protected routes)
│   ├── (auth)/
│   │   ├── layout.tsx
│   │   ├── sign-in/
│   │   └── sign-up/
│   ├── (main)/
│   │   ├── layout.tsx
│   │   └── page.tsx
│   └── layout.tsx (will create in Task 2)
├── globals.css (keep here)
├── favicon.ico (keep here)
└── layout.tsx (will be removed/replaced)
```

Important: Keep globals.css and favicon.ico in src/app/ (not inside [locale]).
  </action>
  <verify>
Run `ls -la src/app/[locale]/` and confirm (app), (auth), (main) folders exist.
Run `ls src/app/` and confirm globals.css and favicon.ico remain.
  </verify>
  <done>
Route groups (app), (auth), (main) moved under src/app/[locale]/ while globals.css and favicon.ico remain in src/app/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create locale-aware root layout with DirectionProvider</name>
  <files>
    src/app/[locale]/layout.tsx
    src/app/[locale]/ConvexClientProvider.tsx
    src/app/layout.tsx
    src/app/globals.css
  </files>
  <action>
**Move ConvexClientProvider to [locale] directory:**
```bash
mv src/app/ConvexClientProvider.tsx src/app/[locale]/
```

**Update ConvexClientProvider.tsx** - no changes needed, just moved.

**Create src/app/[locale]/layout.tsx** - the new locale-aware root layout:
```typescript
import type { Metadata } from "next";
import { Inter, JetBrains_Mono, Heebo } from "next/font/google";
import { ClerkProvider } from "@clerk/nextjs";
import { DirectionProvider } from "@radix-ui/react-direction";
import { NextIntlClientProvider, hasLocale } from "next-intl";
import { notFound } from "next/navigation";
import { routing } from "@/i18n/routing";
import { ConvexClientProvider } from "./ConvexClientProvider";
import { Toaster } from "@/components/ui/sonner";
import "../globals.css";

const inter = Inter({
  variable: "--font-inter",
  subsets: ["latin"],
});

const jetbrainsMono = JetBrains_Mono({
  variable: "--font-mono",
  subsets: ["latin"],
});

const heebo = Heebo({
  subsets: ["latin", "hebrew"],
  variable: "--font-heebo",
  display: "swap",
});

export const metadata: Metadata = {
  title: "REOS - Real Estate Investment Platform",
  description: "Connect US investors with Israeli properties",
};

// Generate static params for all supported locales
export function generateStaticParams() {
  return routing.locales.map((locale) => ({ locale }));
}

type Props = {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
};

export default async function LocaleLayout({ children, params }: Props) {
  const { locale } = await params;

  // Validate locale
  if (!hasLocale(routing.locales, locale)) {
    notFound();
  }

  const direction = locale === "he" ? "rtl" : "ltr";

  return (
    <html
      lang={locale}
      dir={direction}
      className={`${inter.variable} ${jetbrainsMono.variable} ${heebo.variable}`}
    >
      <body className="font-sans antialiased">
        <ClerkProvider
          signInUrl={`/${locale}/sign-in`}
          signUpUrl={`/${locale}/sign-up`}
          signInFallbackRedirectUrl={`/${locale}/dashboard`}
          signUpFallbackRedirectUrl={`/${locale}/dashboard`}
        >
          <ConvexClientProvider>
            <DirectionProvider dir={direction}>
              <NextIntlClientProvider>
                {children}
              </NextIntlClientProvider>
            </DirectionProvider>
          </ConvexClientProvider>
          <Toaster position="bottom-right" />
        </ClerkProvider>
      </body>
    </html>
  );
}
```

**Delete old src/app/layout.tsx** - no longer needed (locale layout is the new root).

**Update src/app/globals.css** - add Heebo to font stack:
Find the `--font-sans` variable (or body font-family) and update to include Heebo:
```css
/* In the @theme or :root section, find font-sans and update: */
--font-sans: var(--font-inter), var(--font-heebo), system-ui, sans-serif;
```

If using Tailwind v4 with @theme, update the font-family configuration to include Heebo as a fallback for Hebrew text support.

Key decisions:
- ClerkProvider URLs now include locale: `/${locale}/sign-in`
- DirectionProvider wraps children, sets dir based on locale
- NextIntlClientProvider for client-side locale context
- Heebo font added for Hebrew-Latin support
- generateStaticParams pre-renders all locale paths
  </action>
  <verify>
Run `ls src/app/[locale]/` and confirm layout.tsx and ConvexClientProvider.tsx exist.
Run `ls src/app/` and confirm old layout.tsx is deleted.
Run `npx tsc --noEmit` for TypeScript verification.
  </verify>
  <done>
Locale-aware root layout exists at src/app/[locale]/layout.tsx with DirectionProvider, Heebo font, and locale-aware ClerkProvider URLs. Old root layout is removed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update (app) layout for locale-aware navigation</name>
  <files>
    src/app/[locale]/(app)/layout.tsx
  </files>
  <action>
Update the (app) route group layout to use locale-aware navigation:

**Update src/app/[locale]/(app)/layout.tsx:**
```typescript
"use client";

import { useConvexAuth, useQuery } from "convex/react";
import { useEffect } from "react";
import { Spinner } from "@/components/ui/spinner";
import { AppShell } from "@/components/layout/AppShell";
import { useCurrentUser } from "@/hooks/useCurrentUser";
import { api } from "../../../../convex/_generated/api";
import { useRouter, usePathname } from "@/i18n/navigation";

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { isAuthenticated, isLoading: isAuthLoading } = useConvexAuth();
  const { user, isLoading: isUserLoading } = useCurrentUser();
  const router = useRouter();
  const pathname = usePathname();

  // Query questionnaire for investors to check if they've started it
  const questionnaire = useQuery(
    api.investorQuestionnaires.getByUser,
    user?.role === "investor" ? undefined : "skip"
  );

  const isLoading = isAuthLoading || isUserLoading;
  const isQuestionnaireLoading = user?.role === "investor" && questionnaire === undefined;

  // Check if current path is an onboarding path (role selection or questionnaire)
  const isOnboardingPath = pathname.startsWith("/onboarding");

  useEffect(() => {
    if (!isAuthLoading && !isAuthenticated) {
      router.push("/sign-in");
    }
  }, [isAuthenticated, isAuthLoading, router]);

  // Role-aware onboarding gate logic
  useEffect(() => {
    if (isLoading || isQuestionnaireLoading || !isAuthenticated || !user || isOnboardingPath) {
      return;
    }

    // No role selected - redirect to role selection
    if (!user.role) {
      router.push("/onboarding");
      return;
    }

    // Investor who hasn't started questionnaire yet - redirect to questionnaire
    // Once they've started (questionnaire exists), they can skip and access the app
    if (user.role === "investor" && !questionnaire) {
      router.push("/onboarding/questionnaire");
      return;
    }

    // Service providers and admins complete onboarding after role selection
    // (handled in setUserRole mutation)
  }, [isLoading, isQuestionnaireLoading, isAuthenticated, user, questionnaire, pathname, router, isOnboardingPath]);

  // Show minimal loading screen until auth and user data are confirmed
  if (isLoading || !isAuthenticated) {
    return (
      <div className="flex min-h-screen items-center justify-center">
        <Spinner className="h-8 w-8" />
      </div>
    );
  }

  // Still loading user data
  if (!user) {
    return (
      <div className="flex min-h-screen items-center justify-center">
        <Spinner className="h-8 w-8" />
      </div>
    );
  }

  return <AppShell>{children}</AppShell>;
}
```

Key changes:
- Import `useRouter, usePathname` from `@/i18n/navigation` instead of `next/navigation`
- The locale-aware router automatically handles locale prefixing
- `router.push("/sign-in")` becomes `/en/sign-in` or `/he/sign-in` based on current locale
- `pathname` returns the path WITHOUT locale prefix (e.g., `/dashboard` not `/en/dashboard`)

No changes needed to the redirect paths - the locale-aware router handles prefixing automatically.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation.
Check that the layout uses imports from `@/i18n/navigation`.
  </verify>
  <done>
(app) layout updated to use locale-aware useRouter and usePathname from @/i18n/navigation. Redirects will automatically include the current locale prefix.
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify the full i18n infrastructure works:

1. Start dev server: `npm run dev`

2. Test locale routing:
   - Navigate to http://localhost:3000 - should redirect to /en (default locale)
   - Navigate to http://localhost:3000/en/dashboard - should work (or redirect to sign-in if not authenticated)
   - Navigate to http://localhost:3000/he/dashboard - should work with RTL

3. Test HTML attributes:
   - View page source on /en/ - verify `<html lang="en" dir="ltr">`
   - View page source on /he/ - verify `<html lang="he" dir="rtl">`

4. Test auth protection:
   - Navigate to /en/dashboard without auth - should redirect to /en/sign-in
   - Navigate to /he/dashboard without auth - should redirect to /he/sign-in

5. TypeScript compilation: `npx tsc --noEmit`
</verification>

<success_criteria>
- Route groups (app), (auth), (main) exist under src/app/[locale]/
- src/app/[locale]/layout.tsx exists with DirectionProvider wrapping
- HTML element has lang={locale} and dir={direction} attributes
- ClerkProvider URLs include locale: /${locale}/sign-in, /${locale}/sign-up
- Heebo font loaded for Hebrew support
- (app) layout uses locale-aware navigation from @/i18n/navigation
- Visiting /en/ shows dir="ltr", visiting /he/ shows dir="rtl"
- Protected routes still require authentication
- App compiles and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-i18n-infrastructure/28-02-SUMMARY.md`
</output>
