---
phase: 57-vendor-onboarding-approval
plan: 03
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - src/app/[locale]/(app)/admin/vendors/pending/page.tsx
  - src/components/admin/PendingVendorsTable.tsx
  - src/components/admin/VendorApprovalModal.tsx
  - src/components/vendor/VendorApprovalBanner.tsx
  - src/app/[locale]/(app)/dashboard/page.tsx
  - src/app/[locale]/(app)/providers/page.tsx
  - messages/en.json
  - messages/he.json
autonomous: false

must_haves:
  truths:
    - "Admin can navigate to /admin/vendors/pending and see a table of pending vendor applications"
    - "Admin can click a vendor to see their full profile details in a modal"
    - "Admin can approve a vendor -- vendor becomes visible in the provider directory"
    - "Admin can reject a vendor with a reason -- vendor sees the rejection reason"
    - "Pending vendors see an approval status banner on the dashboard"
    - "Rejected vendors see the rejection reason and a link to revise and resubmit"
    - "Unapproved vendors do NOT appear in the provider directory or search results"
  artifacts:
    - path: "src/app/[locale]/(app)/admin/vendors/pending/page.tsx"
      provides: "Admin vendor approval queue page"
      min_lines: 20
    - path: "src/components/admin/PendingVendorsTable.tsx"
      provides: "Table of pending vendors with review action"
      min_lines: 60
    - path: "src/components/admin/VendorApprovalModal.tsx"
      provides: "Modal showing full vendor profile with approve/reject buttons"
      min_lines: 80
    - path: "src/components/vendor/VendorApprovalBanner.tsx"
      provides: "Banner showing pending/rejected/approved status on vendor dashboard"
      min_lines: 30
  key_links:
    - from: "src/components/admin/PendingVendorsTable.tsx"
      to: "convex/serviceProviderProfiles.ts:listPendingVendors"
      via: "useQuery for pending vendors list"
      pattern: "useQuery.*listPendingVendors"
    - from: "src/components/admin/VendorApprovalModal.tsx"
      to: "convex/serviceProviderProfiles.ts:approveVendor"
      via: "useMutation for approval"
      pattern: "useMutation.*approveVendor"
    - from: "src/components/admin/VendorApprovalModal.tsx"
      to: "convex/serviceProviderProfiles.ts:rejectVendor"
      via: "useMutation for rejection"
      pattern: "useMutation.*rejectVendor"
    - from: "src/components/vendor/VendorApprovalBanner.tsx"
      to: "convex/serviceProviderProfiles.ts:getMyApprovalStatus"
      via: "useQuery for vendor's own status"
      pattern: "useQuery.*getMyApprovalStatus"
---

<objective>
Build the admin vendor approval interface and the vendor-facing approval status banner. Admins can review, approve, or reject pending vendors. Vendors see their approval status on the dashboard. The provider directory is confirmed to show only approved vendors.

Purpose: Without the admin approval UI, no vendor can transition from pending to approved. Without the status banner, vendors have no visibility into their application status. This plan completes the full approval lifecycle.

Output: Admin approval queue at /admin/vendors/pending with review modal, vendor dashboard approval banner, and provider directory confirmed filtering by approval status.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/VENDOR_ARCHITECTURE.md

@.planning/phases/57-vendor-onboarding-approval/57-01-SUMMARY.md

@convex/schema.ts
@convex/serviceProviderProfiles.ts
@convex/users.ts
@convex/notifications.ts
@src/app/[locale]/(app)/dashboard/page.tsx
@src/app/[locale]/(app)/providers/page.tsx
@messages/en.json
@messages/he.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin approval page, table, and modal</name>
  <files>
    src/app/[locale]/(app)/admin/vendors/pending/page.tsx
    src/components/admin/PendingVendorsTable.tsx
    src/components/admin/VendorApprovalModal.tsx
    messages/en.json
    messages/he.json
  </files>
  <action>
**admin/vendors/pending/page.tsx -- Admin approval queue page:**

Create the route at `src/app/[locale]/(app)/admin/vendors/pending/page.tsx`:
- "use client" component
- Gate: check current user role === "admin" (use `useQuery(api.users.getCurrentUser)`), redirect to /dashboard if not admin
- Layout: page header with title "Pending Vendor Approvals" and a badge showing count of pending vendors
- Render `PendingVendorsTable` component
- If no pending vendors, show empty state: "No pending applications" with an icon
- Use `useTranslations("adminVendors")` for all text

**PendingVendorsTable.tsx -- Table of pending vendors:**

Create at `src/components/admin/PendingVendorsTable.tsx`:
- "use client" component
- Uses `useQuery(api.serviceProviderProfiles.listPendingVendors)` to fetch pending vendors
- Display as a Shadcn Table with columns:
  - Photo (avatar or placeholder)
  - Name
  - Provider Type (badge: Broker / Mortgage Advisor / Lawyer)
  - Company Name
  - Submitted Date (formatted with relative time: "2 hours ago", "3 days ago")
  - Actions: "Review" button
- Clicking "Review" opens VendorApprovalModal for that vendor
- Loading state: show Skeleton rows while data loads
- Real-time: Convex subscription automatically updates the table when vendors are approved/rejected
- Mobile responsive: on small screens, show as cards instead of table (use the existing responsive pattern from the project)

**VendorApprovalModal.tsx -- Review and approve/reject modal:**

Create at `src/components/admin/VendorApprovalModal.tsx`:
- "use client" component
- Uses the project's ResponsiveDialog pattern (dialog on desktop, bottom sheet on mobile)
- Props: `vendor` data object, `open: boolean`, `onOpenChange: (open: boolean) => void`
- Displays full vendor profile in scrollable content:
  - **Header:** Photo, name, provider type badge, email, phone
  - **Professional Details section:** Company, license number, years experience, specializations (as badges)
  - **Service Area section:** Service areas (as badges), languages (as badges)
  - **Bio section:** Full bio text
  - **Additional section:** Website URL (as link), external recommendations
  - **Submitted:** Timestamp of submission
- **Action buttons at bottom (sticky footer):**
  - "Approve" button (green/primary variant): calls `useMutation(api.serviceProviderProfiles.approveVendor)` with profileId
  - "Reject" button (red/destructive variant): opens a rejection reason textarea input
- **Rejection flow:**
  - When "Reject" is clicked, show a textarea for rejection reason (optional but encouraged)
  - Show a secondary "Confirm Rejection" button
  - Calls `useMutation(api.serviceProviderProfiles.rejectVendor)` with profileId and reason
- **After action:** Show success toast ("Vendor approved" or "Vendor rejected"), close modal
- Loading states on both action buttons (disable while mutation is in progress)
- Use `useTranslations("adminVendors")` for all text

**i18n translations -- Add "adminVendors" section to both en.json and he.json:**

English keys:
- `title`: "Pending Vendor Approvals"
- `empty`: "No pending applications"
- `emptyDescription`: "All vendor applications have been reviewed"
- `columns.photo`: "Photo"
- `columns.name`: "Name"
- `columns.type`: "Type"
- `columns.company`: "Company"
- `columns.submitted`: "Submitted"
- `columns.actions`: "Actions"
- `review`: "Review"
- `approve`: "Approve"
- `reject`: "Reject"
- `confirmReject`: "Confirm Rejection"
- `rejectionReason`: "Rejection Reason"
- `rejectionReasonPlaceholder`: "Why is this application being rejected? (optional)"
- `approveSuccess`: "Vendor approved successfully"
- `rejectSuccess`: "Vendor rejected"
- `profileDetails`: "Profile Details"
- `professionalDetails`: "Professional Details"
- `serviceArea`: "Service Area"
- `bio`: "Bio"
- `additional`: "Additional Information"
- `submittedAt`: "Submitted"
- `pendingCount`: "{count} pending"
- Provider type labels: broker, mortgage_advisor, lawyer

Hebrew translations for all of the above.

**Important patterns:**
- Use Shadcn Table component (import from @/components/ui/table)
- Use Shadcn Badge for provider types and specializations
- Use Shadcn Dialog or the project's ResponsiveDialog for the modal
- Use `formatDistanceToNow` from date-fns for relative timestamps
- Follow the existing admin page pattern if any admin pages exist (check src/app/[locale]/(app)/admin/)
- Since no admin route exists yet, create the full path: `src/app/[locale]/(app)/admin/vendors/pending/page.tsx`
  </action>
  <verify>
1. Navigate to `/admin/vendors/pending` as an admin user -- table should render
2. Navigate to `/admin/vendors/pending` as a non-admin user -- should redirect to dashboard
3. If there are pending vendors (from testing Plan 02), they should appear in the table
4. Click "Review" -- modal opens with full vendor profile
5. Click "Approve" -- vendor status changes, vendor disappears from table, success toast shows
6. Click "Reject" with a reason -- vendor status changes, success toast shows
  </verify>
  <done>
Admin can view pending vendor applications at /admin/vendors/pending, review full profile details in a modal, and approve or reject with optional reason. Table updates in real-time. Non-admins are redirected away.
  </done>
</task>

<task type="auto">
  <name>Task 2: Vendor approval banner on dashboard and provider directory verification</name>
  <files>
    src/components/vendor/VendorApprovalBanner.tsx
    src/app/[locale]/(app)/dashboard/page.tsx
    src/app/[locale]/(app)/providers/page.tsx
    messages/en.json
    messages/he.json
  </files>
  <action>
**VendorApprovalBanner.tsx -- Status banner component:**

Create at `src/components/vendor/VendorApprovalBanner.tsx`:
- "use client" component
- Uses `useQuery(api.serviceProviderProfiles.getMyApprovalStatus)` to get current vendor's status
- Renders different banners based on status:

  **Draft status (approvalStatus === "draft" or null):**
  - Yellow/warning banner: "Complete your profile to start accepting clients"
  - "Complete Profile" button linking to `/onboarding/vendor-profile`

  **Pending status (approvalStatus === "pending"):**
  - Blue/info banner: "Your profile is under review. We'll notify you within 48 hours."
  - Show submitted date: "Submitted on {date}"
  - No action button

  **Rejected status (approvalStatus === "rejected"):**
  - Red/destructive banner: "Your profile was not approved."
  - Show rejection reason if available: "Reason: {reason}"
  - "Revise & Resubmit" button linking to `/onboarding/vendor-profile` (the wizard should allow editing and resubmitting)
  - Show reviewed date

  **Approved status (approvalStatus === "approved") or undefined (grandfathered):**
  - Do NOT render anything (no banner)

- Use Shadcn Alert component with appropriate variants (warning, default, destructive)
- Use Hugeicons for the alert icons (match existing project icon usage)
- Use `useTranslations("vendorStatus")` for all text
- Should only render for service provider roles (check user.role)

**dashboard/page.tsx -- Add VendorApprovalBanner:**

Modify the existing dashboard page:
- Import VendorApprovalBanner
- Add it at the TOP of the dashboard content (above existing dashboard widgets)
- Only render for service provider roles (broker, mortgage_advisor, lawyer)
- The banner handles its own visibility logic (doesn't render for approved vendors)
- Keep all existing dashboard functionality intact -- this is an additive change only

**providers/page.tsx -- Verify approval filtering:**

Review the providers page to confirm it uses the `listByType` query (which was modified in Plan 01 to filter by approvalStatus). The filtering happens at the query level, so the providers page should already be correct. However:
- Verify the page calls `listByType` (or `getProvidersByType`)
- If it does NOT use those queries (e.g., it fetches all profiles directly), add the approval filter client-side as a safety net: `providers.filter(p => p.approvalStatus === "approved" || !p.approvalStatus)`
- This is a verification + safety net task, not a major code change

**i18n translations -- Add "vendorStatus" section to both en.json and he.json:**

English keys:
- `draft.title`: "Complete Your Profile"
- `draft.description`: "Complete your vendor profile to start accepting clients on the platform."
- `draft.action`: "Complete Profile"
- `pending.title`: "Profile Under Review"
- `pending.description`: "Your profile is being reviewed by our team. We'll notify you within 48 hours."
- `pending.submittedAt`: "Submitted on {date}"
- `rejected.title`: "Profile Not Approved"
- `rejected.description`: "Your profile was not approved. Please review the feedback and resubmit."
- `rejected.reason`: "Reason: {reason}"
- `rejected.action`: "Revise & Resubmit"
- `rejected.reviewedAt`: "Reviewed on {date}"

Hebrew translations for all of the above.

**Important patterns:**
- The VendorApprovalBanner must NOT break the existing dashboard for investors or admins -- it should only render for service provider roles
- Use conditional rendering, not route-level gating
- The banner should be the FIRST thing a pending/rejected vendor sees on their dashboard
- For the "Revise & Resubmit" flow, the vendor wizard (Plan 02) should detect an existing profile and pre-populate the form (this is handled by the upsertProfile mutation + localStorage draft)
  </action>
  <verify>
1. Login as a vendor with "pending" status -- dashboard shows blue "Under Review" banner at the top
2. Login as a vendor with "rejected" status -- dashboard shows red banner with rejection reason and "Revise & Resubmit" button
3. Login as a vendor with "draft" status -- dashboard shows yellow "Complete Your Profile" banner
4. Login as an approved vendor or investor -- NO banner shown
5. Visit /providers page -- only approved vendors appear (verify no unapproved vendors leak through)
6. Switch locale to Hebrew -- all banner text is in Hebrew
  </verify>
  <done>
Vendor dashboard shows appropriate approval status banner (pending, rejected, or draft). Approved vendors see no banner. Provider directory confirmed to show only approved vendors. Full EN/HE translations for all status messages.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify full vendor registration and approval flow</name>
  <what-built>
Complete vendor onboarding and admin approval flow:
- Multi-step vendor registration wizard with photo upload
- Admin approval queue with review modal
- Vendor status banners on dashboard
- Provider directory filtering by approval status
  </what-built>
  <how-to-verify>
1. **Register as new vendor:**
   - Create a new account or use an existing test account
   - Select "Broker" role during onboarding
   - Verify you are redirected to /onboarding/vendor-profile
   - Complete all 4 steps of the wizard (upload a photo, fill all fields)
   - Submit for approval
   - Verify redirect to dashboard with "Profile Under Review" banner

2. **Admin approval flow:**
   - Login as admin
   - Navigate to /admin/vendors/pending
   - Verify the newly submitted vendor appears in the table
   - Click "Review" -- verify full profile displays in modal
   - Click "Approve" -- verify vendor disappears from table
   - Verify the vendor receives a notification

3. **Post-approval verification:**
   - Login as the approved vendor
   - Verify the approval banner is GONE from dashboard
   - Visit /providers -- verify the approved vendor appears in the directory

4. **Rejection flow (test with another vendor):**
   - Submit another vendor for approval
   - As admin, reject with reason "Missing license verification"
   - Login as rejected vendor
   - Verify red banner shows with rejection reason
   - Click "Revise & Resubmit" -- verify wizard opens with pre-filled data

5. **Visual check:**
   - Verify mobile responsiveness of admin table (should show as cards)
   - Verify Hebrew translations work for all components
   - Verify profile photo displays correctly throughout the flow
  </how-to-verify>
  <resume-signal>Type "approved" if flow works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Admin approval page renders at /admin/vendors/pending with table of pending vendors
2. Admin can review full profile in modal and approve/reject
3. Approved vendors appear in provider directory, rejected vendors do not
4. Vendor dashboard shows correct status banner (pending/rejected/draft/none)
5. Rejected vendors can revise and resubmit
6. All text is translated in EN and HE
7. No regressions to existing dashboard or provider directory for grandfathered providers
</verification>

<success_criteria>
- /admin/vendors/pending route exists with working approval queue
- Admin can approve vendor -- vendor becomes visible in /providers directory
- Admin can reject vendor with reason -- vendor sees reason on dashboard
- Pending vendors see "Under Review" banner on dashboard
- Rejected vendors can revise and resubmit via "Revise & Resubmit" button
- Provider directory shows ONLY approved vendors (and grandfathered ones)
- Full i18n support for all admin and vendor status text
- Human verification of the complete end-to-end flow passes
</success_criteria>

<output>
After completion, create `.planning/phases/57-vendor-onboarding-approval/57-03-SUMMARY.md`
</output>
