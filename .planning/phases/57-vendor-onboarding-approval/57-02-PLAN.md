---
phase: 57-vendor-onboarding-approval
plan: 02
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - src/app/[locale]/(app)/onboarding/vendor-profile/page.tsx
  - src/components/vendor/VendorOnboardingWizard.tsx
  - src/components/vendor/steps/BasicInfoStep.tsx
  - src/components/vendor/steps/ProfessionalDetailsStep.tsx
  - src/components/vendor/steps/ServiceAreaStep.tsx
  - src/components/vendor/steps/ReviewSubmitStep.tsx
  - src/components/shared/ProfilePhotoUpload.tsx
  - src/lib/validations/vendor-onboarding.ts
  - messages/en.json
  - messages/he.json
  - src/app/[locale]/(app)/onboarding/page.tsx
autonomous: true

must_haves:
  truths:
    - "A vendor selecting broker/mortgage_advisor/lawyer role is redirected to /onboarding/vendor-profile"
    - "The multi-step wizard has 4 steps: Basic Info, Professional Details, Service Area & Bio, Review & Submit"
    - "All 12+ registration fields are present across the wizard steps"
    - "A vendor can upload a profile photo via drag-and-drop or click-to-select during onboarding"
    - "Form state persists across steps and survives page refresh (localStorage)"
    - "Submitting for approval calls submitForApproval mutation and redirects to dashboard"
    - "All form fields and labels are translated in EN and HE"
    - "A rejected vendor returning to the wizard sees their existing Convex profile data pre-loaded"
  artifacts:
    - path: "src/app/[locale]/(app)/onboarding/vendor-profile/page.tsx"
      provides: "Vendor onboarding route page"
      min_lines: 15
    - path: "src/components/vendor/VendorOnboardingWizard.tsx"
      provides: "Multi-step wizard with 4 steps, step indicator, navigation, form state management"
      min_lines: 100
    - path: "src/components/shared/ProfilePhotoUpload.tsx"
      provides: "Drag-and-drop photo upload component using Convex storage"
      min_lines: 50
    - path: "src/lib/validations/vendor-onboarding.ts"
      provides: "Zod schemas for each step and the combined form"
      min_lines: 40
    - path: "messages/en.json"
      provides: "English translations for vendor onboarding"
      contains: "vendorOnboarding"
    - path: "messages/he.json"
      provides: "Hebrew translations for vendor onboarding"
      contains: "vendorOnboarding"
  key_links:
    - from: "src/components/vendor/VendorOnboardingWizard.tsx"
      to: "convex/serviceProviderProfiles.ts:upsertProfile"
      via: "useMutation for draft saving"
      pattern: "useMutation.*upsertProfile"
    - from: "src/components/vendor/VendorOnboardingWizard.tsx"
      to: "convex/serviceProviderProfiles.ts:submitForApproval"
      via: "useMutation for final submission"
      pattern: "useMutation.*submitForApproval"
    - from: "src/components/vendor/VendorOnboardingWizard.tsx"
      to: "convex/serviceProviderProfiles.ts:getMyProfile"
      via: "useQuery to pre-load existing profile for resubmission"
      pattern: "useQuery.*getMyProfile"
    - from: "src/components/shared/ProfilePhotoUpload.tsx"
      to: "convex/users.ts:generateProfilePhotoUploadUrl"
      via: "useMutation for upload URL generation"
      pattern: "useMutation.*generateProfilePhotoUploadUrl"
    - from: "src/app/[locale]/(app)/onboarding/page.tsx"
      to: "/onboarding/vendor-profile"
      via: "redirect after service provider role selection"
      pattern: "vendor-profile"
---

<objective>
Build the vendor onboarding multi-step wizard UI with profile photo upload, form validation, draft persistence, and i18n support. After completing the questionnaire, vendors submit for admin approval.

Purpose: This is the vendor-facing entry point -- without it, no new vendors can register. The multi-step form collects all 12+ registration fields and submits them through the backend mutations created in Plan 01.

Output: A 4-step onboarding wizard at /onboarding/vendor-profile with profile photo upload, Zod validation, localStorage draft persistence, and full EN/HE translations.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/VENDOR_ARCHITECTURE.md
@.planning/research/STACK-VENDOR-REGISTRATION.md
@.planning/research/PITFALLS-VENDOR-REGISTRATION.md

@.planning/phases/57-vendor-onboarding-approval/57-01-SUMMARY.md

@convex/schema.ts
@convex/serviceProviderProfiles.ts
@convex/users.ts
@src/app/[locale]/(app)/onboarding/page.tsx
@src/app/[locale]/(app)/onboarding/questionnaire/page.tsx
@messages/en.json
@messages/he.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validation schemas, photo upload component, and onboarding redirect</name>
  <files>
    src/lib/validations/vendor-onboarding.ts
    src/components/shared/ProfilePhotoUpload.tsx
    src/app/[locale]/(app)/onboarding/page.tsx
  </files>
  <action>
**vendor-onboarding.ts -- Zod validation schemas:**

Create validation schemas for each wizard step using the project's existing Zod + i18n error key pattern (same as contact form -- error messages are keys, not strings). Follow the pattern from the contact page where Zod errors use translation keys.

Step 1 (Basic Info) schema:
- `fullName`: string, min 2 chars, error key "nameMin"
- `email`: string, email format, error key "emailInvalid"
- `phoneNumber`: string, min 7 chars, error key "phoneMin"
- `providerType`: enum ("broker" | "mortgage_advisor" | "lawyer"), error key "providerTypeRequired"

Step 2 (Professional Details) schema:
- `companyName`: optional string
- `licenseNumber`: string, min 1, error key "licenseRequired"
- `yearsExperience`: number, min 0, max 50, error key "experienceRange"
- `specializations`: array of strings, min 1 item, error key "specializationRequired"

Step 3 (Service Area & Bio) schema:
- `serviceAreas`: array of strings, min 1 item, error key "serviceAreaRequired"
- `languages`: array of ("english" | "hebrew" | "russian" | "french" | "spanish"), min 1 item, error key "languageRequired"
- `bio`: string, min 20 chars, max 500 chars, error keys "bioMin" / "bioMax"
- `websiteUrl`: optional string, url format when provided, error key "websiteInvalid"
- `externalRecommendations`: optional string, max 2000 chars

Combined schema (for final validation before submit): merge all step schemas.

Export: `step1Schema`, `step2Schema`, `step3Schema`, `combinedVendorSchema`, and the inferred TypeScript types.

**ProfilePhotoUpload.tsx -- Reusable photo upload component:**

Create a "use client" component at `src/components/shared/ProfilePhotoUpload.tsx`:
- Uses native file input (not react-dropzone -- it is NOT installed yet and is not needed for Phase 57)
- Accept: image/jpeg, image/png, image/webp
- Max size: 5MB (validate client-side, show error toast via sonner)
- On file select:
  1. Call `useMutation(api.users.generateProfilePhotoUploadUrl)` to get upload URL
  2. POST the file to the upload URL
  3. Extract storageId from response JSON
  4. Call `useMutation(api.users.saveProfilePhoto)` with storageId
  5. Display the returned URL as a preview
- Show loading state during upload (spinner overlay on the photo area)
- Display current photo (or placeholder avatar) in a circular container
- Accept `onPhotoSaved?: (url: string, storageId: string) => void` callback prop
- Style: rounded-full with border, hover overlay "Change photo" text, Tailwind classes
- Use `useTranslations("vendorOnboarding")` for all text labels
- Show upload progress feedback via toast (sonner)
- Handle errors: show error toast if upload fails, file too large, or wrong format

**onboarding/page.tsx -- Modify redirect logic:**

Currently, `setUserRole` for service providers sets `onboardingComplete: true` and redirects to `/dashboard`. After Plan 01 changes, service providers get `onboardingComplete: false`.

Modify the onboarding page so that:
- After a user selects a service provider role (broker, mortgage_advisor, lawyer), redirect to `/onboarding/vendor-profile` instead of `/dashboard`
- Keep investor flow unchanged (redirects to `/onboarding/questionnaire`)
- Keep admin flow unchanged

Look at how the current onboarding page handles role selection and routing. The key change is: when `role` is broker/mortgage_advisor/lawyer, the post-role-selection redirect should go to `/onboarding/vendor-profile`.
  </action>
  <verify>
1. `npx next build` should not produce type errors related to the new files
2. Check that `src/lib/validations/vendor-onboarding.ts` exports step1Schema, step2Schema, step3Schema, combinedVendorSchema
3. Check that `src/components/shared/ProfilePhotoUpload.tsx` exists and imports from convex/react
4. Check that the onboarding page redirects service providers to /onboarding/vendor-profile
  </verify>
  <done>
Zod validation schemas exist for all 4 steps with i18n error keys. ProfilePhotoUpload component uses Convex storage upload pattern (generateUploadUrl -> POST -> saveProfilePhoto). Onboarding page redirects service providers to /onboarding/vendor-profile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Multi-step wizard and route page</name>
  <files>
    src/app/[locale]/(app)/onboarding/vendor-profile/page.tsx
    src/components/vendor/VendorOnboardingWizard.tsx
  </files>
  <action>
**vendor-profile/page.tsx -- Route page:**

Create the route page at `src/app/[locale]/(app)/onboarding/vendor-profile/page.tsx`:
- "use client" component
- Import and render `VendorOnboardingWizard`
- Gate: redirect to `/dashboard` if user's `onboardingComplete === true` (use `useQuery(api.users.getOnboardingStatus)`)
- Gate: redirect to `/onboarding` if user has no role set
- Minimal wrapper: centered layout with max-w-2xl, padding, page title from translations

**VendorOnboardingWizard.tsx -- Main wizard component:**

Create at `src/components/vendor/VendorOnboardingWizard.tsx`:
- "use client" component
- 4 steps: BasicInfoStep, ProfessionalDetailsStep, ServiceAreaStep, ReviewSubmitStep
- Use `react-hook-form` with `zodResolver` for per-step validation
- Single form instance with all fields, validate current step fields before advancing
- Step indicator bar at top showing: step number, name, completed/current/upcoming state (use Tailwind classes, simple circles connected by lines)
- Framer Motion AnimatePresence for step transitions (opacity + x-slide, same pattern as existing investor questionnaire)
- Navigation: "Back" and "Next" buttons (disable Back on step 1, show "Submit for Approval" on final step)
- **Draft persistence via localStorage:**
  - On every field change (debounced 500ms), save form data to localStorage key `vendor-onboarding-draft`
  - On mount, check localStorage for saved draft and populate form via `reset()`
  - Clear localStorage after successful submission
  - Store `{ formData: {...}, currentStep: number, savedAt: timestamp }`
  - If draft is older than 7 days, discard it
- **Pre-load existing Convex profile for resubmission:**
  - Use `useQuery(api.serviceProviderProfiles.getMyProfile)` to fetch existing profile
  - On mount, if NO localStorage draft exists (or draft is expired), check if `getMyProfile` returns data
  - If it does (rejected vendor returning to revise), populate the form with the Convex profile data via `reset()`:
    - Map profile fields: bio, serviceAreas, languages, phoneNumber, companyName, licenseNumber, yearsExperience, specializations, websiteUrl, externalRecommendations, providerType
    - Map user fields: userName -> fullName, userEmail -> email
  - Priority: localStorage draft takes precedence over Convex data (more recent edits)
  - This ensures rejected vendors returning via "Revise & Resubmit" see their existing profile data
- **Draft saving to Convex:**
  - On step advance (Next button), call `upsertProfile` mutation with current form data to save draft to database
  - Map form fields to upsertProfile args: companyName, licenseNumber, yearsExperience, specializations, serviceAreas, languages, bio, phoneNumber, preferredContact
  - Also save websiteUrl and externalRecommendations via a separate patch if upsertProfile doesn't support them (check Plan 01 implementation)
- **Final submission:**
  - On "Submit for Approval" click, validate all steps
  - Call `upsertProfile` one final time with all data
  - Then call `submitForApproval` mutation
  - Show success toast: "Profile submitted for approval!"
  - Clear localStorage draft
  - Redirect to `/dashboard` using `useRouter()`
- Use `useTranslations("vendorOnboarding")` for all labels
- Display user's uploaded profile photo in the wizard header area (use ProfilePhotoUpload component in Step 1)

**Key pitfalls to avoid:**
- Do NOT install react-dropzone (not in package.json). Use native file input for photo upload.
- Do NOT store form state only in React state -- persist to localStorage for crash recovery.
- Validate per-step (not all fields at once) to allow partial progress.
- Pre-fill email from the current user (Clerk identity) and make it read-only.
- Map providerType from the user's already-set role (they chose role in the first onboarding step).
  </action>
  <verify>
1. Navigate to `/onboarding/vendor-profile` -- the wizard skeleton renders with step indicator
2. Verify the wizard component imports and references all 4 step components (BasicInfoStep, ProfessionalDetailsStep, ServiceAreaStep, ReviewSubmitStep)
3. Verify localStorage persistence logic is present (search for "vendor-onboarding-draft")
4. Verify `useQuery(api.serviceProviderProfiles.getMyProfile)` is called for Convex profile pre-loading
5. Verify submit flow calls upsertProfile then submitForApproval
  </verify>
  <done>
Route page at /onboarding/vendor-profile renders the VendorOnboardingWizard. Wizard has 4-step navigation with step indicator, localStorage draft persistence, Convex profile pre-loading for resubmission (via getMyProfile), draft saving on step advance, and final submission calling submitForApproval. Form is managed by react-hook-form with zodResolver.
  </done>
</task>

<task type="auto">
  <name>Task 3: Step components and i18n translations</name>
  <files>
    src/components/vendor/steps/BasicInfoStep.tsx
    src/components/vendor/steps/ProfessionalDetailsStep.tsx
    src/components/vendor/steps/ServiceAreaStep.tsx
    src/components/vendor/steps/ReviewSubmitStep.tsx
    messages/en.json
    messages/he.json
  </files>
  <action>
**Step components:**

Each step is a presentational component receiving the form instance via props.

**BasicInfoStep.tsx:**
- Fields: fullName (Input), email (Input, pre-filled from Clerk, read-only), phoneNumber (Input), providerType (Select with broker/mortgage_advisor/lawyer options -- if user's role is already set, show as read-only badge)
- Include `ProfilePhotoUpload` component here
- Use Shadcn Form components (FormField, FormItem, FormLabel, FormControl, FormMessage)

**ProfessionalDetailsStep.tsx:**
- Fields: companyName (Input, optional), licenseNumber (Input), yearsExperience (Input type="number"), specializations (multi-select or tag input -- use a simple Combobox or multi-select pattern with predefined options per provider type)
- Specialization options vary by providerType:
  - Broker: "Residential", "Commercial", "Luxury", "New Construction", "Investment Properties", "Land"
  - Mortgage Advisor: "First-time Buyers", "Investment Loans", "Refinancing", "Commercial Mortgages", "International Buyers"
  - Lawyer: "Real Estate Transactions", "Property Law", "Commercial Real Estate", "Landlord-Tenant", "Zoning & Land Use"
- Use Shadcn Form components

**ServiceAreaStep.tsx:**
- Fields: serviceAreas (multi-select from Israeli cities: "Tel Aviv", "Jerusalem", "Haifa", "Beer Sheva", "Netanya", "Herzliya", "Ra'anana", "Ashdod", "Rishon LeZion", "Petah Tikva", "Bat Yam", "Holon", "Ramat Gan", "Rehovot", "Nationwide Israel"), languages (multi-select checkboxes: English, Hebrew, Russian, French, Spanish), bio (Textarea, min 20 / max 500 chars with character counter), websiteUrl (Input, optional), externalRecommendations (Textarea, optional, max 2000 chars)
- Use Shadcn Form components

**ReviewSubmitStep.tsx:**
- Read-only summary of ALL fields across all steps
- Display profile photo preview
- Grouped sections: "Basic Info", "Professional Details", "Service Area & Bio"
- Each section shows field label + value pairs
- "Edit" button per section that navigates back to that step
- Submit button with loading state (shows spinner during submission)
- Below submit: small text "Your profile will be reviewed by our team within 48 hours"

**i18n translations (messages/en.json and messages/he.json):**

Add a `"vendorOnboarding"` key to both files with translations for:
- Step names: "Basic Information", "Professional Details", "Service Area & Bio", "Review & Submit"
- All field labels (fullName, email, phoneNumber, providerType, companyName, licenseNumber, yearsExperience, specializations, serviceAreas, languages, bio, websiteUrl, externalRecommendations)
- Provider type labels: "Real Estate Broker", "Mortgage Advisor", "Lawyer"
- All validation error messages (nameMin, emailInvalid, phoneMin, etc.)
- Button labels: "Next", "Back", "Submit for Approval"
- Success message, review section headers, photo upload labels
- Hebrew translations must be accurate (the project already has full Hebrew support)
- Specialization labels for each provider type
- City names (though these may already exist in existing translations)

**Important patterns to follow:**
- Use `useTranslations("vendorOnboarding")` hook (from next-intl) -- same as existing components
- Use Shadcn Form components (FormField, FormItem, FormLabel, FormControl, FormMessage) -- same as contact form
- Use `zodResolver` from @hookform/resolvers -- already installed
- Framer Motion for step transitions -- already installed
- Sonner for toasts -- already installed
- Router for navigation -- use `useRouter` from next/navigation with `useLocale` for locale-prefixed paths
  </action>
  <verify>
1. Navigate to `/onboarding/vendor-profile` (as a newly registered service provider) -- the 4-step wizard should render with all fields
2. Fill out Step 1 fields, click Next -- validates and advances
3. Refresh the page -- form data should be restored from localStorage
4. Complete all 4 steps and submit -- should see success toast and redirect to dashboard
5. Check the Convex dashboard -- a serviceProviderProfile with approvalStatus "pending" should exist
6. Check that i18n works -- switch to Hebrew locale, all labels should be in Hebrew with RTL layout
  </verify>
  <done>
All 4 step components render their respective fields using Shadcn Form components. BasicInfoStep includes ProfilePhotoUpload. ReviewSubmitStep shows a read-only summary with edit navigation. Full EN/HE translations exist under the "vendorOnboarding" key for all labels, errors, buttons, specializations, and cities.
  </done>
</task>

</tasks>

<verification>
1. Full vendor registration flow works: sign up -> select broker role -> wizard renders at /onboarding/vendor-profile
2. All 4 steps validate correctly: missing required fields show translated error messages
3. Profile photo uploads to Convex storage and displays in the wizard
4. Form data persists across page refresh (localStorage)
5. Rejected vendor returning to wizard sees existing profile data pre-loaded from Convex (via getMyProfile)
6. Submission creates a serviceProviderProfile with approvalStatus: "pending" and submittedAt timestamp
7. All text is translated in both EN and HE
8. Step transitions are animated with Framer Motion
9. No console errors or TypeScript compilation errors
</verification>

<success_criteria>
- /onboarding/vendor-profile route renders the 4-step wizard
- All 12+ registration fields are present and validated with Zod
- Profile photo upload works end-to-end (select -> upload to Convex -> display preview)
- Draft persistence works (refresh page, data restored)
- Rejected vendor resubmission works (existing Convex profile pre-loaded when no localStorage draft)
- Submit for approval calls mutation and redirects to dashboard
- Full EN/HE translations for all labels, errors, and buttons
- Service providers are redirected to vendor wizard after role selection
</success_criteria>

<output>
After completion, create `.planning/phases/57-vendor-onboarding-approval/57-02-SUMMARY.md`
</output>
