---
phase: 57-vendor-onboarding-approval
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/serviceProviderProfiles.ts
  - convex/users.ts
  - convex/notifications.ts
autonomous: true

must_haves:
  truths:
    - "serviceProviderProfiles table has approvalStatus field with draft/pending/approved/rejected values"
    - "users table has customImageStorageId field for profile photos"
    - "Existing service providers are grandfathered as approved"
    - "Service provider role selection sets onboardingComplete to false (not true)"
    - "Admin can approve or reject a vendor via mutation with audit fields"
    - "Provider directory queries filter out non-approved vendors"
    - "Vendor can check their own approval status"
    - "Notifications are created for vendor approval events"
    - "Vendor can retrieve their full profile for resubmission editing"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Extended serviceProviderProfiles with approval fields, users with customImageStorageId"
      contains: "approvalStatus"
    - path: "convex/serviceProviderProfiles.ts"
      provides: "submitForApproval, approveVendor, rejectVendor mutations; listPendingVendors, getMyApprovalStatus, getMyProfile queries"
      exports: ["submitForApproval", "approveVendor", "rejectVendor", "listPendingVendors", "getMyApprovalStatus", "getMyProfile"]
    - path: "convex/users.ts"
      provides: "generateProfilePhotoUploadUrl, saveProfilePhoto mutations; getProfilePhotoUrl query"
      exports: ["generateProfilePhotoUploadUrl", "saveProfilePhoto", "getProfilePhotoUrl"]
    - path: "convex/notifications.ts"
      provides: "Extended notification types for vendor approval events"
      contains: "vendor_approved"
  key_links:
    - from: "convex/serviceProviderProfiles.ts:listByType"
      to: "schema.ts:approvalStatus"
      via: "filter on approvalStatus === approved"
      pattern: "approvalStatus.*approved"
    - from: "convex/serviceProviderProfiles.ts:getPublicProfile"
      to: "schema.ts:approvalStatus"
      via: "hide unapproved unless own profile or admin"
      pattern: "approvalStatus.*approved"
    - from: "convex/users.ts:setUserRole"
      to: "schema.ts:onboardingComplete"
      via: "service providers now get onboardingComplete: false"
      pattern: "onboardingComplete.*false"
    - from: "convex/serviceProviderProfiles.ts:approveVendor"
      to: "convex/notifications.ts:createNotification"
      via: "notification on approval"
      pattern: "createNotification"
    - from: "convex/serviceProviderProfiles.ts:getMyProfile"
      to: "schema.ts:serviceProviderProfiles"
      via: "returns full profile for current user to enable resubmission"
      pattern: "getMyProfile"
---

<objective>
Extend the Convex schema and backend to support vendor approval workflow and profile photo uploads. This is the backend foundation that all subsequent plans depend on.

Purpose: Without the approval state machine, queries, and mutations, the onboarding UI and admin interface cannot function. This plan establishes the data model and business logic for the entire vendor registration flow.

Output: Extended schema.ts with approval fields, new mutations/queries in serviceProviderProfiles.ts for approval workflow, profile photo upload mutations in users.ts, and extended notification types.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/VENDOR_ARCHITECTURE.md

@convex/schema.ts
@convex/serviceProviderProfiles.ts
@convex/users.ts
@convex/notifications.ts
@convex/dealFiles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema and notification types</name>
  <files>
    convex/schema.ts
    convex/notifications.ts
  </files>
  <action>
**schema.ts changes:**

1. Add approval status union type near the top of the file (after `questionnaireStatus`):
```typescript
const approvalStatus = v.union(
  v.literal("draft"),
  v.literal("pending"),
  v.literal("approved"),
  v.literal("rejected")
);
```

2. Add new fields to `serviceProviderProfiles` table:
   - `approvalStatus: v.optional(approvalStatus)` -- optional so existing records without it are treated as grandfathered (approved)
   - `submittedAt: v.optional(v.number())` -- timestamp when submitted for approval
   - `reviewedAt: v.optional(v.number())` -- timestamp when admin reviewed
   - `reviewedBy: v.optional(v.id("users"))` -- admin who reviewed
   - `rejectionReason: v.optional(v.string())` -- reason for rejection
   - `websiteUrl: v.optional(v.string())` -- vendor website link
   - `externalRecommendations: v.optional(v.string())` -- free-text external recommendations

3. Add a new index to serviceProviderProfiles: `.index("by_approval_status", ["approvalStatus"])`

4. Add new field to `users` table:
   - `customImageStorageId: v.optional(v.id("_storage"))` -- Convex-uploaded custom profile photo

5. Expand the `userRoles` union to include additional service provider subtypes that match the existing `providerType` (NO CHANGE needed -- broker, mortgage_advisor, lawyer already exist in userRoles).

**notifications.ts changes:**

6. Extend the `notificationType` union in schema.ts to add:
   - `v.literal("vendor_submitted")` -- vendor submitted for approval
   - `v.literal("vendor_approved")` -- vendor was approved
   - `v.literal("vendor_rejected")` -- vendor was rejected

7. In notifications.ts, update the `notificationTypeValidator` and `NotificationType` type to include the new types: `"vendor_submitted" | "vendor_approved" | "vendor_rejected"`.

**Important:** Make ALL `approvalStatus` fields `v.optional()` so existing service provider records without this field continue to work. The code will treat `undefined` approvalStatus as `"approved"` (grandfathered).
  </action>
  <verify>
Run `npx convex dev --once` from the project root. The schema push should succeed without errors. Check that the Convex dashboard shows the new fields on serviceProviderProfiles and users tables.
  </verify>
  <done>
Schema has approvalStatus field on serviceProviderProfiles, customImageStorageId on users, three new notification types, and by_approval_status index. Convex schema push succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Approval workflow mutations/queries, profile photo mutations, and getMyProfile query</name>
  <files>
    convex/serviceProviderProfiles.ts
    convex/users.ts
  </files>
  <action>
**serviceProviderProfiles.ts -- Add new mutations and queries, modify existing queries:**

1. **`submitForApproval` mutation** (vendor-facing):
   - No args needed (operates on current user's profile)
   - Get authenticated user via `ctx.auth.getUserIdentity()` + lookup by clerkId
   - Get profile via `by_user` index
   - Validate required fields are present: bio, serviceAreas (length > 0), languages (length > 0), phoneNumber
   - Patch profile: `{ approvalStatus: "pending", submittedAt: Date.now(), rejectionReason: undefined, updatedAt: Date.now() }`
   - Notify all admin users: query users table for `role === "admin"`, create "vendor_submitted" notification for each with link `/admin/vendors/pending`
   - Return `{ success: true }`

2. **`approveVendor` mutation** (admin-only):
   - Args: `{ profileId: v.id("serviceProviderProfiles") }`
   - Auth check: verify current user `role === "admin"`
   - Get the profile, verify `approvalStatus === "pending"` (state machine guard -- cannot approve non-pending profiles)
   - Patch profile: `{ approvalStatus: "approved", reviewedAt: Date.now(), reviewedBy: adminUser._id, updatedAt: Date.now() }`
   - Also patch the vendor's user record: `{ onboardingComplete: true }`
   - Create "vendor_approved" notification for the vendor user with link `/dashboard`
   - Return `{ success: true }`

3. **`rejectVendor` mutation** (admin-only):
   - Args: `{ profileId: v.id("serviceProviderProfiles"), reason: v.optional(v.string()) }`
   - Auth check: verify current user `role === "admin"`
   - Get the profile, verify `approvalStatus === "pending"`
   - Patch profile: `{ approvalStatus: "rejected", reviewedAt: Date.now(), reviewedBy: adminUser._id, rejectionReason: args.reason, updatedAt: Date.now() }`
   - Create "vendor_rejected" notification for vendor with the rejection reason in the message
   - Return `{ success: true }`

4. **`listPendingVendors` query** (admin-only):
   - No args
   - Auth check: verify current user `role === "admin"`, return [] if not
   - Query serviceProviderProfiles with `.withIndex("by_approval_status", q => q.eq("approvalStatus", "pending"))`
   - Enrich each profile with user data (name, email, imageUrl) from the users table
   - Sort by `submittedAt` descending (most recent first)
   - Return enriched profiles

5. **`getMyApprovalStatus` query** (vendor-facing):
   - No args
   - Get authenticated user
   - Get their serviceProviderProfile via `by_user` index
   - Return `{ status: profile?.approvalStatus ?? null, submittedAt, reviewedAt, rejectionReason }` or null if no profile

6. **`getMyProfile` query** (vendor-facing, for resubmission/wizard pre-population):
   - No args
   - Get authenticated user via `ctx.auth.getUserIdentity()` + lookup by clerkId
   - Get their serviceProviderProfile via `by_user` index
   - If no profile, return null
   - Return the FULL profile object including all fields: bio, serviceAreas, languages, phoneNumber, companyName, licenseNumber, yearsExperience, specializations, websiteUrl, externalRecommendations, approvalStatus, rejectionReason, providerType
   - Also include the user's name and email (from the users table) so the wizard can pre-fill those fields
   - Return type: `{ profile: ServiceProviderProfile, userName: string, userEmail: string } | null`

7. **Modify `listByType` query**: After the existing `.withIndex("by_provider_type", ...)` and `.collect()`, add a filter:
   ```typescript
   providers = providers.filter(p =>
     p.approvalStatus === "approved" || p.approvalStatus === undefined
   );
   ```
   This ensures only approved vendors (and grandfathered ones without approvalStatus) appear in the directory.

8. **Modify `getPublicProfile` query**: After getting the profile, before returning data, add a visibility check:
   - Get the current user (may be null for unauthenticated visitors)
   - If `profile.approvalStatus !== "approved" && profile.approvalStatus !== undefined`:
     - If current user is NOT the profile owner AND NOT an admin, return null
   This allows vendors to see their own unapproved profile and admins to see any profile.

9. **Modify `getProvidersByType` query**: Same filter as listByType -- add `p.approvalStatus === "approved" || p.approvalStatus === undefined`.

10. **Modify `upsertProfile` mutation**: When creating a NEW profile (not updating), set `approvalStatus: "draft"` in the insert. When updating an existing profile, do NOT change approvalStatus (it stays as-is).

**users.ts -- Add profile photo mutations:**

11. **`generateProfilePhotoUploadUrl` mutation**:
    - No args
    - Auth check: verify authenticated
    - Return `await ctx.storage.generateUploadUrl()`
    - Follow exact same pattern as `dealFiles.generateUploadUrl`

12. **`saveProfilePhoto` mutation**:
    - Args: `{ storageId: v.id("_storage") }`
    - Auth check: verify authenticated, get user
    - If `user.customImageStorageId` exists, delete old photo: `await ctx.storage.delete(user.customImageStorageId)`
    - Patch user: `{ customImageStorageId: args.storageId, updatedAt: Date.now() }`
    - Get public URL: `const url = await ctx.storage.getUrl(args.storageId)`
    - Return `{ url, storageId: args.storageId }`

13. **`getProfilePhotoUrl` query**:
    - Args: `{ userId: v.id("users") }`
    - Get user by ID
    - If `user.customImageStorageId`, return `await ctx.storage.getUrl(user.customImageStorageId)`
    - Else return `user.imageUrl` (Clerk fallback)

14. **Modify `setUserRole` mutation**: Change the logic so that service providers (broker, mortgage_advisor, lawyer) now get `onboardingComplete: false` instead of `true`. This forces them through the vendor onboarding wizard before they can use the platform. Keep admin and investor logic unchanged.
    Change: `onboardingComplete: isServiceProvider || args.role === "admin"` to `onboardingComplete: args.role === "admin"` (investors already get false via isInvestor check, service providers now also get false).
    Also set `onboardingStep: 1` for service providers (same as investors).

**Pitfall awareness:**
- All approval state changes are SERVER-SIDE ONLY (Convex mutations). Never trust client-side approval status.
- State machine guards: Only pending profiles can be approved/rejected. Draft profiles cannot be approved directly.
- Grandfathering: `undefined` approvalStatus is treated as "approved" in ALL queries (backward compatible).
- Profile photo: delete old photo storage before saving new one to prevent orphaned files.
  </action>
  <verify>
Run `npx convex dev --once` from the project root to verify all mutations and queries compile without errors. Verify the following in Convex dashboard or by reviewing the generated code:
1. `submitForApproval` exists as a mutation
2. `approveVendor` and `rejectVendor` exist as admin-only mutations
3. `listPendingVendors` exists as a query
4. `getMyApprovalStatus` exists as a query
5. `getMyProfile` exists as a query returning full profile + user name/email
6. `listByType` now filters by approvalStatus
7. `generateProfilePhotoUploadUrl` and `saveProfilePhoto` exist as mutations
8. `setUserRole` sets onboardingComplete: false for service providers
  </verify>
  <done>
All approval workflow mutations (submit, approve, reject) and queries (listPending, getMyApprovalStatus, getMyProfile) are implemented. getMyProfile returns the full profile with user name/email for wizard pre-population and resubmission. Existing directory queries (listByType, getProvidersByType, getPublicProfile) filter out unapproved vendors while grandfathering existing providers. Profile photo upload/save mutations are implemented. Service provider role selection now sets onboardingComplete: false to force onboarding wizard completion. Convex pushes without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` succeeds -- schema and all functions compile
2. serviceProviderProfiles table schema includes approvalStatus, submittedAt, reviewedAt, reviewedBy, rejectionReason, websiteUrl, externalRecommendations
3. users table schema includes customImageStorageId
4. Notification type union includes vendor_submitted, vendor_approved, vendor_rejected
5. listByType and getProvidersByType filter by approvalStatus === "approved" || undefined
6. getPublicProfile hides unapproved profiles from non-owners and non-admins
7. setUserRole sets onboardingComplete: false for broker/mortgage_advisor/lawyer roles
8. getMyProfile returns full profile object with user name and email for wizard pre-population
</verification>

<success_criteria>
- Convex schema push succeeds with new fields and indexes
- All 5 new mutations compile: submitForApproval, approveVendor, rejectVendor, generateProfilePhotoUploadUrl, saveProfilePhoto
- All 4 new queries compile: listPendingVendors, getMyApprovalStatus, getProfilePhotoUrl, getMyProfile
- Existing queries (listByType, getProvidersByType, getPublicProfile) updated with approval filtering
- setUserRole sends service providers through onboarding (onboardingComplete: false)
- No breaking changes to existing provider functionality (grandfathering works)
- getMyProfile enables the wizard to pre-load existing profile data for rejected vendor resubmission
</success_criteria>

<output>
After completion, create `.planning/phases/57-vendor-onboarding-approval/57-01-SUMMARY.md`
</output>
