---
phase: 46-ai-auto-flow
plan: 04
type: execute
wave: 3
depends_on: ["46-01", "46-02", "46-03"]
files_modified:
  - convex/ai/messages.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Tool results extracted from both result and output.value fields"
    - "Messages with tool calls but no text content are preserved (not filtered)"
    - "PropertyCardRenderer receives toolCalls with results"
    - "ProviderCardRenderer receives toolCalls with results"
    - "Cards render as React components, not markdown text"
  artifacts:
    - path: "convex/ai/messages.ts"
      provides: "Fixed tool result extraction"
      contains: "output.*value"
  key_links:
    - from: "extractToolCalls"
      to: "tool-result"
      via: "extracts result or output.value"
      pattern: "result.*||.*output"
---

<objective>
Fix tool result extraction in messages.ts so that property and provider cards render correctly.

Purpose: Close AUTO-02, AUTO-03, AUTO-04 gaps - tool results must flow to card renderers
Output: Cards display instead of text, SaveAllButton visible, providers grouped by role
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-ai-auto-flow/46-VERIFICATION.md

@convex/ai/messages.ts
@convex/_generated/api.d.ts (lines 370-420 for tool-result type)
@src/components/ai/PropertyCardRenderer.tsx
@src/components/ai/ProviderCardRenderer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add debug logging to understand message structure</name>
  <files>convex/ai/messages.ts</files>
  <action>
First, add temporary logging to understand the actual message structure from the agent.

In the `listMessages` action handler, after fetching messages, add:
```typescript
// DEBUG: Log first few messages to understand structure
if (messagesResult.page.length > 0) {
  console.log("Message structure sample:", JSON.stringify(messagesResult.page.slice(0, 2), null, 2));
}
```

This will help us understand:
1. What the actual content array looks like
2. Whether tool-call and tool-result are in same message or separate
3. What field names are used (result vs output)

**Note**: Remove this logging after debugging is complete (Task 4).
  </action>
  <verify>
Deploy and trigger auto-greeting, check Convex logs for message structure.
  </verify>
  <done>
Debug logging added to understand actual message structure from agent
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix tool result extraction to handle output field</name>
  <files>convex/ai/messages.ts</files>
  <action>
Update the `extractToolCalls` function to handle both `result` and `output` fields.

Based on the API types in `convex/_generated/api.d.ts`, tool-result has:
- `result?: any` - direct result value
- `output?: { type: "text" | "json" | "content" | "error-text" | "error-json"; value: any }` - typed result

Update the function:

```typescript
/**
 * Helper: Extract tool calls from message content and pair with results
 *
 * Assistant messages with tools have content arrays containing:
 * - { type: "tool-call", toolCallId, toolName, args } - tool invocations
 * - { type: "tool-result", toolCallId, result?, output? } - tool results
 *
 * Tool results can be in either `result` field or `output.value` field.
 */
function extractToolCalls(content: unknown): ToolCall[] {
  if (!Array.isArray(content)) {
    return [];
  }

  // Extract tool-call parts
  const toolCallParts = content.filter(
    (part): part is { type: "tool-call"; toolCallId: string; toolName: string; args: any } =>
      part &&
      typeof part === "object" &&
      part.type === "tool-call" &&
      typeof part.toolCallId === "string" &&
      typeof part.toolName === "string"
  );

  // Extract tool-result parts (may have result OR output field)
  const toolResultParts = content.filter(
    (part): part is {
      type: "tool-result";
      toolCallId: string;
      result?: any;
      output?: { type: string; value: any };
    } =>
      part &&
      typeof part === "object" &&
      part.type === "tool-result" &&
      typeof part.toolCallId === "string"
  );

  // Build a map of results by toolCallId
  // Check both result and output.value fields
  const resultMap = new Map<string, any>();
  for (const r of toolResultParts) {
    // Prefer result field if present, otherwise use output.value
    const resultValue = r.result ?? (r.output?.value);
    if (resultValue !== undefined) {
      resultMap.set(r.toolCallId, resultValue);
    }
  }

  // Pair tool calls with their results
  return toolCallParts.map((call) => ({
    toolCallId: call.toolCallId,
    toolName: call.toolName,
    args: call.args,
    result: resultMap.get(call.toolCallId),
  }));
}
```

Key changes:
1. Type guard now includes optional `output` field
2. Result extraction checks `r.result ?? r.output?.value`
3. Uses nullish coalescing for clean fallback
  </action>
  <verify>
TypeScript compiles: `cd /Users/Kohelet/Code/REOS && npx tsc --noEmit`
Convex deploys: `npx convex dev --once`
  </verify>
  <done>
extractToolCalls now handles both result and output.value fields
Tool results correctly paired with tool calls regardless of which field is used
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix message filter to preserve tool-only messages</name>
  <files>convex/ai/messages.ts</files>
  <action>
Update the filter that removes empty-content messages to also preserve messages with tool calls.

Current code at line ~64:
```typescript
.filter(msg => msg.content.length > 0)
```

Change to:
```typescript
.filter(msg => msg.content.length > 0 || (msg.toolCalls && msg.toolCalls.length > 0))
```

This ensures that assistant messages with tool calls (but no text) are still returned to the frontend.

**Context**: The AI might send a message that is purely tool calls with no accompanying text. These should still be displayed so the card renderers can show the property/provider cards.
  </action>
  <verify>
Build passes: `cd /Users/Kohelet/Code/REOS && npm run build`
  </verify>
  <done>
Messages with tool calls but empty text content are now preserved
Card renderers will receive these messages and display tool results
  </done>
</task>

<task type="auto">
  <name>Task 4: Clean up debug logging and verify deployment</name>
  <files>convex/ai/messages.ts</files>
  <action>
If the logging from Task 1 was helpful and fixes are working, remove the debug logging.

If issues persist, keep logging temporarily and note in summary.

Final file should be clean without debug console.log statements.

Verify the complete deployment:
```bash
cd /Users/Kohelet/Code/REOS && npx convex dev --once
```
  </action>
  <verify>
Convex functions deploy successfully
No debug logging in production code
  </verify>
  <done>
Debug logging removed (or documented if needed for further investigation)
Clean deployment to Convex
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Fixed tool result extraction in convex/ai/messages.ts:
1. extractToolCalls now handles both `result` and `output.value` fields
2. Message filter preserves messages with tool calls (even if no text content)
3. Tool results should now flow correctly to PropertyCardRenderer and ProviderCardRenderer
  </what-built>
  <how-to-verify>
Test the complete flow:

1. **Clear existing thread (fresh start):**
   - Go to investor summary page
   - Click "Clear Memory" if button exists, or sign out/in with fresh account

2. **Complete questionnaire:**
   - Navigate to questionnaire
   - Complete all steps
   - Click "Complete"

3. **Verify auto-greeting with cards (CRITICAL):**
   - Should redirect to summary page
   - AI should automatically send greeting
   - **AUTO-02 CHECK:** Properties should display as CARDS with:
     - Property image
     - Price
     - Location
     - Match reason badges
     - Individual "Save" button on each card
   - If you still see text like "1. Property at 123 Main St..." instead of cards, this is a FAILURE

4. **Verify SaveAllButton (AUTO-03):**
   - If 2+ properties shown, look for "Save All" button below the property cards

5. **Verify provider cards (AUTO-04):**
   - After properties, providers should show as cards grouped by role
   - Accordion sections: "Brokers", "Mortgage Advisors", "Lawyers"
   - Each provider card has "Add to Team" button

**SUCCESS CHECKLIST:**
- [ ] Property cards render with images, prices, match badges (not text)
- [ ] SaveAllButton visible when 2+ properties shown
- [ ] Provider cards grouped by role in accordion
- [ ] Each provider has "Add to Team" button

**If still showing text instead of cards:**
Report what you see in the AI response and check browser console for errors.
  </how-to-verify>
  <resume-signal>Type "approved" if cards render correctly, or describe what you see</resume-signal>
</task>

</tasks>

<verification>
1. extractToolCalls handles both result and output.value
2. Message filter preserves tool-only messages
3. TypeScript compiles without errors
4. Convex deploys successfully
5. Property cards render as React components (AUTO-02)
6. SaveAllButton visible for 2+ properties (AUTO-03)
7. Provider cards grouped by role with Add to Team buttons (AUTO-04)
</verification>

<success_criteria>
- Tool results correctly extracted from agent messages
- Messages with tool calls preserved in frontend data
- PropertyCardRenderer receives toolCalls with results
- ProviderCardRenderer receives toolCalls with results
- Cards display as interactive React components, not markdown text
- SaveAllButton renders for batch property saving
- Providers grouped by role with Add to Team functionality
</success_criteria>

<output>
After completion, create `.planning/phases/46-ai-auto-flow/46-04-SUMMARY.md`
</output>
