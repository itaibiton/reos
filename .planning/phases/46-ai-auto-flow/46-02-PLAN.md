---
phase: 46-ai-auto-flow
plan: 02
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - src/components/ai/hooks/useAutoGreeting.ts
  - src/components/ai/hooks/index.ts
  - src/app/[locale]/(app)/profile/investor/summary/page.tsx
  - src/components/profile/MobileInvestorSummary.tsx
  - src/app/[locale]/(app)/onboarding/questionnaire/page.tsx
autonomous: true

must_haves:
  truths:
    - "After questionnaire completion and redirect, AI sends greeting automatically"
    - "Auto-greeting only fires once (not on every page reload)"
    - "Questionnaire completion awaits markComplete before redirect"
  artifacts:
    - path: "src/components/ai/hooks/useAutoGreeting.ts"
      provides: "Auto-greeting trigger logic"
      contains: "useAutoGreeting"
    - path: "src/components/ai/hooks/index.ts"
      provides: "Barrel export for hooks"
      contains: "useAutoGreeting"
    - path: "src/app/[locale]/(app)/profile/investor/summary/page.tsx"
      provides: "Auto-greeting trigger for desktop"
      contains: "useAutoGreeting"
    - path: "src/components/profile/MobileInvestorSummary.tsx"
      provides: "Auto-greeting trigger for mobile"
      contains: "useAutoGreeting"
  key_links:
    - from: "summary/page.tsx"
      to: "useAIChat"
      via: "sendMessage with allowEmpty"
      pattern: "sendMessage.*allowEmpty.*true"
    - from: "questionnaire/page.tsx"
      to: "summary/page.tsx"
      via: "await markComplete then redirect"
      pattern: "await markComplete.*router\\.push"
    - from: "summary/page.tsx useAIChat"
      to: "AIChatPanel display"
      via: "shared Convex thread state"
      pattern: "useAIChat.*sendMessage"
---

<objective>
Wire auto-greeting trigger on summary page - detect first visit after questionnaire and trigger AI greeting.

Purpose: AI initiates conversation automatically when investor arrives at summary page
Output: Summary page triggers auto-greeting on first visit, questionnaire properly awaits completion before redirect
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-ai-auto-flow/46-RESEARCH.md

@src/app/[locale]/(app)/profile/investor/summary/page.tsx
@src/components/profile/MobileInvestorSummary.tsx
@src/app/[locale]/(app)/onboarding/questionnaire/page.tsx
@src/components/ai/hooks/useAIChat.ts
@src/components/ai/hooks/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAutoGreeting hook for shared logic</name>
  <files>
    src/components/ai/hooks/useAutoGreeting.ts
    src/components/ai/hooks/index.ts
  </files>
  <action>
Create a new hook that encapsulates auto-greeting trigger logic:

**File: src/components/ai/hooks/useAutoGreeting.ts**
```typescript
"use client";

import { useEffect, useRef } from "react";
import { useQuery } from "convex/react";
import { api } from "../../../../convex/_generated/api";

interface UseAutoGreetingOptions {
  sendMessage: (text: string, options?: { allowEmpty?: boolean }) => Promise<void>;
  messages: Array<{ _id: string }>;
  isLoading: boolean;
}

/**
 * Hook to trigger AI auto-greeting on first visit after questionnaire completion.
 *
 * Fires when:
 * 1. Questionnaire status is "complete"
 * 2. No messages exist in the thread (first visit)
 * 3. Messages have finished loading
 *
 * Prevents re-triggering via ref tracking.
 */
export function useAutoGreeting({
  sendMessage,
  messages,
  isLoading,
}: UseAutoGreetingOptions) {
  const questionnaire = useQuery(api.investorQuestionnaires.getByUser);
  const hasTriggeredRef = useRef(false);

  useEffect(() => {
    // Guard: Don't trigger if already triggered this session
    if (hasTriggeredRef.current) return;

    // Guard: Wait for data to load
    if (isLoading) return;
    if (questionnaire === undefined) return;

    // Guard: Only trigger for complete questionnaire
    if (questionnaire?.status !== "complete") return;

    // Guard: Only trigger if thread is empty (first visit)
    if (messages.length > 0) return;

    // Trigger auto-greeting
    hasTriggeredRef.current = true;
    sendMessage("", { allowEmpty: true });
  }, [questionnaire?.status, messages.length, isLoading, sendMessage]);
}
```

**File: src/components/ai/hooks/index.ts**
Add export for the new hook:
```typescript
export { useAutoGreeting } from "./useAutoGreeting";
```

Ensure index.ts exists and exports all AI hooks including the new useAutoGreeting.
  </action>
  <verify>
TypeScript compiles: `cd /Users/Kohelet/Code/REOS && npx tsc --noEmit`
Verify export exists: `grep -n "useAutoGreeting" src/components/ai/hooks/index.ts`
  </verify>
  <done>
useAutoGreeting hook exists at src/components/ai/hooks/useAutoGreeting.ts
Hook is exported from src/components/ai/hooks/index.ts barrel file
Hook triggers sendMessage("", { allowEmpty: true }) on first visit after questionnaire completion
Ref prevents re-triggering on subsequent renders
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate auto-greeting in summary page and mobile component</name>
  <files>
    src/app/[locale]/(app)/profile/investor/summary/page.tsx
    src/components/profile/MobileInvestorSummary.tsx
  </files>
  <action>
**Desktop summary page (src/app/[locale]/(app)/profile/investor/summary/page.tsx):**

1. Import useAutoGreeting and useAIChat at the component level (not inside AIChatPanel):
   ```typescript
   import { useAutoGreeting } from "@/components/ai/hooks/useAutoGreeting";
   import { useAIChat } from "@/components/ai/hooks/useAIChat";
   ```

2. Add useAIChat and useAutoGreeting calls in the component:
   ```typescript
   // AI chat state for auto-greeting
   const { messages, sendMessage, isLoading: isChatLoading } = useAIChat();

   // Auto-greeting trigger
   useAutoGreeting({
     sendMessage,
     messages,
     isLoading: isChatLoading,
   });
   ```

3. The page's useAIChat and AIChatPanel's internal useAIChat share the same Convex thread state:
   - Page triggers sendMessage("", { allowEmpty: true }) -> writes to Convex thread
   - AIChatPanel's useAIChat reactively sees new messages via Convex subscription
   - No double-sending: hasTriggeredRef prevents re-trigger, and both instances read same thread

**Mobile component (src/components/profile/MobileInvestorSummary.tsx):**

1. Same pattern - import and use hooks:
   ```typescript
   import { useAutoGreeting } from "@/components/ai/hooks/useAutoGreeting";
   import { useAIChat } from "@/components/ai/hooks/useAIChat";
   ```

2. Add the hooks in the component:
   ```typescript
   const { messages, sendMessage, isLoading: isChatLoading } = useAIChat();

   useAutoGreeting({
     sendMessage,
     messages,
     isLoading: isChatLoading,
   });
   ```

**Verification of indirect wiring pattern:**
- Page useAIChat.sendMessage("", { allowEmpty: true }) -> Convex action -> stores assistant message
- AIChatPanel's useAIChat subscribes to same thread -> sees new message -> renders it
- No double-sending because: (1) hasTriggeredRef guards in useAutoGreeting, (2) both read same messages array from Convex
  </action>
  <verify>
Build passes: `cd /Users/Kohelet/Code/REOS && npm run build`
No TypeScript errors
Verify wiring:
1. grep "useAutoGreeting" in both page.tsx and MobileInvestorSummary.tsx
2. grep "sendMessage.*allowEmpty" to confirm trigger pattern
3. Manual test: auto-greeting triggers from page, AIChatPanel displays it, no double messages
  </verify>
  <done>
Desktop summary page triggers auto-greeting on first visit via useAutoGreeting hook
Mobile summary triggers auto-greeting on first visit via useAutoGreeting hook
Both use shared useAutoGreeting hook for consistent behavior
Verified: auto-greeting from page.tsx sendMessage appears in AIChatPanel (shared Convex state)
Verified: no double-sending occurs (hasTriggeredRef + shared messages array)
  </done>
</task>

<task type="auto">
  <name>Task 3: Ensure questionnaire completion properly awaits before redirect</name>
  <files>src/app/[locale]/(app)/onboarding/questionnaire/page.tsx</files>
  <action>
Review and fix the handleComplete function to ensure async operations complete before redirect:

Current code already awaits properly:
```typescript
const handleComplete = async () => {
  setIsSubmitting(true);
  try {
    await saveProgress();
    await markComplete();
    await completeOnboarding();
    router.push("/profile/investor/summary");
  } catch (error) {
    // ...
  }
};
```

This is correct. The race condition pitfall mentioned in research doesn't apply here.

However, verify that router.push happens AFTER all mutations complete. The current code is correct.

**No changes needed** - just verify the flow is correct by reading the existing code.

If any issues are found during verification, update accordingly.
  </action>
  <verify>
Read the file and confirm the await chain is correct
Build passes: `cd /Users/Kohelet/Code/REOS && npm run build`
  </verify>
  <done>
handleComplete properly awaits markComplete before router.push
No race condition between completion and redirect
Auto-greeting will trigger correctly on arrival at summary page
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. TypeScript compiles without errors
3. Auto-greeting triggers only on first visit (check via ref)
4. Desktop and mobile both have auto-greeting wired
5. useAutoGreeting exported from hooks/index.ts barrel file
6. Verify indirect wiring: page sendMessage -> AIChatPanel displays (no double-send)
</verification>

<success_criteria>
- useAutoGreeting hook exists and is properly exported from index.ts barrel
- Desktop summary page uses useAutoGreeting to trigger AI greeting
- Mobile summary component uses useAutoGreeting to trigger AI greeting
- Questionnaire completion properly awaits before redirect
- Auto-greeting fires exactly once per session (ref prevents re-trigger)
- Page's sendMessage triggers, AIChatPanel sees and displays message (shared Convex state)
- No double-sending between page useAIChat and AIChatPanel useAIChat
</success_criteria>

<output>
After completion, create `.planning/phases/46-ai-auto-flow/46-02-SUMMARY.md`
</output>
