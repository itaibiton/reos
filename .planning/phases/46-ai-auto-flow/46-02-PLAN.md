---
phase: 46-ai-auto-flow
plan: 02
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - src/components/ai/hooks/useAutoGreeting.ts
  - src/components/ai/hooks/index.ts
  - src/components/ai/AIChatPanel.tsx
  - src/app/[locale]/(app)/profile/investor/summary/page.tsx
autonomous: true

must_haves:
  truths:
    - "After questionnaire completion and redirect, AI sends greeting automatically"
    - "Auto-greeting only fires once (not on every page reload)"
    - "Single useAIChat instance handles both auto-greeting and user input"
  artifacts:
    - path: "src/components/ai/hooks/useAutoGreeting.ts"
      provides: "Auto-greeting trigger logic"
      contains: "useAutoGreeting"
    - path: "src/components/ai/hooks/index.ts"
      provides: "Barrel export for hooks"
      contains: "useAutoGreeting"
    - path: "src/components/ai/AIChatPanel.tsx"
      provides: "Chat panel with optional auto-greeting"
      contains: "autoGreet"
  key_links:
    - from: "AIChatPanel"
      to: "useAutoGreeting"
      via: "conditional hook call based on autoGreet prop"
      pattern: "autoGreet.*useAutoGreeting"
    - from: "useAutoGreeting"
      to: "sendMessage"
      via: "calls sendMessage with allowEmpty"
      pattern: "sendMessage.*allowEmpty.*true"
    - from: "summary/page.tsx"
      to: "AIChatPanel"
      via: "passes autoGreet={true} prop"
      pattern: "AIChatPanel.*autoGreet"
---

<objective>
Wire auto-greeting trigger into AIChatPanel component with autoGreet prop - single useAIChat instance handles both auto-greeting and user messages.

Purpose: AI initiates conversation automatically when investor arrives at summary page, without race conditions from dual hook instances
Output: AIChatPanel accepts autoGreet prop, summary page enables it, greeting fires on first visit
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-ai-auto-flow/46-RESEARCH.md

@src/components/ai/AIChatPanel.tsx
@src/app/[locale]/(app)/profile/investor/summary/page.tsx
@src/components/ai/hooks/useAIChat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAutoGreeting hook and barrel export</name>
  <files>
    src/components/ai/hooks/useAutoGreeting.ts
    src/components/ai/hooks/index.ts
  </files>
  <action>
Create the useAutoGreeting hook and its barrel export file.

**File: src/components/ai/hooks/useAutoGreeting.ts**
```typescript
"use client";

import { useEffect, useRef } from "react";
import { useQuery } from "convex/react";
import { api } from "../../../../convex/_generated/api";

interface UseAutoGreetingOptions {
  sendMessage: (text: string, options?: { allowEmpty?: boolean }) => Promise<void>;
  messages: Array<{ _id: string }>;
  isLoading: boolean;
}

/**
 * Hook to trigger AI auto-greeting on first visit after questionnaire completion.
 *
 * Fires when:
 * 1. Questionnaire status is "complete"
 * 2. No messages exist in the thread (first visit)
 * 3. Messages have finished loading
 *
 * Prevents re-triggering via ref tracking.
 */
export function useAutoGreeting({
  sendMessage,
  messages,
  isLoading,
}: UseAutoGreetingOptions) {
  const questionnaire = useQuery(api.investorQuestionnaires.getByUser);
  const hasTriggeredRef = useRef(false);

  useEffect(() => {
    // Guard: Don't trigger if already triggered this session
    if (hasTriggeredRef.current) return;

    // Guard: Wait for data to load
    if (isLoading) return;
    if (questionnaire === undefined) return;

    // Guard: Only trigger for complete questionnaire
    if (questionnaire?.status !== "complete") return;

    // Guard: Only trigger if thread is empty (first visit)
    if (messages.length > 0) return;

    // Trigger auto-greeting
    hasTriggeredRef.current = true;
    sendMessage("", { allowEmpty: true });
  }, [questionnaire?.status, messages.length, isLoading, sendMessage]);
}
```

**File: src/components/ai/hooks/index.ts (CREATE NEW FILE)**
This file does NOT exist in the codebase. Create it with exports for all hooks in the folder:
```typescript
export { useAIChat } from "./useAIChat";
export { useAutoGreeting } from "./useAutoGreeting";
export { usePropertySave } from "./usePropertySave";
export { useProviderAdd } from "./useProviderAdd";
export { useSmartScroll } from "./useSmartScroll";
```

Note: The index.ts barrel file must be CREATED, not modified - it doesn't exist yet.
  </action>
  <verify>
TypeScript compiles: `cd /Users/Kohelet/Code/REOS && npx tsc --noEmit`
Verify files exist:
- `ls -la src/components/ai/hooks/useAutoGreeting.ts`
- `ls -la src/components/ai/hooks/index.ts`
Verify export exists: `grep -n "useAutoGreeting" src/components/ai/hooks/index.ts`
  </verify>
  <done>
useAutoGreeting hook exists at src/components/ai/hooks/useAutoGreeting.ts
Barrel file created at src/components/ai/hooks/index.ts (new file)
All hooks in folder exported from index.ts
Hook triggers sendMessage("", { allowEmpty: true }) on first visit after questionnaire completion
Ref prevents re-triggering on subsequent renders
  </done>
</task>

<task type="auto">
  <name>Task 2: Add autoGreet prop to AIChatPanel and wire in summary page</name>
  <files>
    src/components/ai/AIChatPanel.tsx
    src/app/[locale]/(app)/profile/investor/summary/page.tsx
  </files>
  <action>
**CRITICAL: Single useAIChat instance pattern**

The auto-greeting MUST use the same useAIChat instance that AIChatPanel uses for displaying messages and handling user input. Do NOT create a second useAIChat instance in the parent page - this causes race conditions.

**File: src/components/ai/AIChatPanel.tsx**

1. Add `autoGreet?: boolean` to the props interface:
   ```typescript
   interface AIChatPanelProps {
     className?: string;
     renderQuickReplies?: (sendMessage: (text: string) => void) => ReactNode;
     autoGreet?: boolean;  // NEW: triggers auto-greeting on first visit
   }
   ```

2. Import and conditionally use the useAutoGreeting hook inside AIChatPanel:
   ```typescript
   import { useAutoGreeting } from "./hooks/useAutoGreeting";
   ```

3. After the existing useAIChat call, add conditional auto-greeting:
   ```typescript
   const {
     messages,
     isStreaming,
     isLoading,
     error,
     sendMessage,
     stopGeneration,
     clearMemory,
   } = useAIChat();

   // Auto-greeting trigger (uses same useAIChat instance - no race condition)
   useAutoGreeting(autoGreet ? {
     sendMessage,
     messages,
     isLoading,
   } : {
     sendMessage: async () => {},  // no-op when disabled
     messages: [],
     isLoading: false,
   });
   ```

   Alternative cleaner pattern - only call hook when enabled:
   ```typescript
   // Place this BEFORE any conditional returns
   const autoGreetingState = autoGreet ? { sendMessage, messages, isLoading } : null;

   // After all hooks, conditionally trigger
   useAutoGreeting(autoGreetingState ?? {
     sendMessage: async () => {},
     messages: [],
     isLoading: false,
   });
   ```

4. Update the component signature to accept the prop:
   ```typescript
   export function AIChatPanel({ className, renderQuickReplies, autoGreet }: AIChatPanelProps) {
   ```

**File: src/app/[locale]/(app)/profile/investor/summary/page.tsx**

1. Find where AIChatPanel is rendered (likely in the desktop layout section)
2. Add the `autoGreet` prop:
   ```typescript
   <AIChatPanel autoGreet={true} />
   ```

3. Do NOT add useAIChat in the page component - all chat state stays inside AIChatPanel

**Why this pattern is safe:**
- Single useAIChat instance in AIChatPanel
- useAutoGreeting receives sendMessage from that same instance
- No race between two instances trying to send simultaneously
- hasTriggeredRef in useAutoGreeting prevents double-sends even on re-renders
  </action>
  <verify>
Build passes: `cd /Users/Kohelet/Code/REOS && npm run build`
No TypeScript errors
Verify wiring:
1. `grep "autoGreet" src/components/ai/AIChatPanel.tsx` - shows prop and hook usage
2. `grep "autoGreet" src/app/[locale]/(app)/profile/investor/summary/page.tsx` - shows prop passed
3. Confirm NO useAIChat import in summary/page.tsx (all state in AIChatPanel)
  </verify>
  <done>
AIChatPanel accepts autoGreet prop
AIChatPanel internally calls useAutoGreeting when autoGreet={true}
Single useAIChat instance handles both auto-greeting and user messages
Summary page passes autoGreet={true} to AIChatPanel
No dual useAIChat instances - no race condition possible
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. TypeScript compiles without errors
3. Auto-greeting triggers only on first visit (check via ref)
4. useAutoGreeting exported from hooks/index.ts barrel file (new file)
5. Single useAIChat instance pattern - AIChatPanel owns all chat state
6. No useAIChat import in summary page (verification against race condition)
</verification>

<success_criteria>
- useAutoGreeting hook exists and is exported from NEW index.ts barrel file
- AIChatPanel accepts autoGreet prop and conditionally triggers auto-greeting
- Summary page passes autoGreet={true} to AIChatPanel
- Single useAIChat instance (inside AIChatPanel) handles everything
- Auto-greeting fires exactly once per session (ref prevents re-trigger)
- No race condition possible - no dual useAIChat instances
</success_criteria>

<output>
After completion, create `.planning/phases/46-ai-auto-flow/46-02-SUMMARY.md`
</output>
