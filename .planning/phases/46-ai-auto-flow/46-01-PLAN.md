---
phase: 46-ai-auto-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ai/hooks/useAIChat.ts
  - convex/ai/chat.ts
autonomous: true

must_haves:
  truths:
    - "Empty message can be sent via useAIChat.sendMessage('')"
    - "Server-side chat action detects auto-greeting scenario"
    - "System prompt instructs AI to greet and call tools automatically"
  artifacts:
    - path: "src/components/ai/hooks/useAIChat.ts"
      provides: "Empty message support for auto-greeting"
      contains: "allowEmpty"
    - path: "convex/ai/chat.ts"
      provides: "Auto-greeting system prompt enhancement"
      contains: "Auto-Greeting Instructions"
  key_links:
    - from: "useAIChat.sendMessage"
      to: "convex/ai/chat.sendMessage"
      via: "allowEmpty parameter"
      pattern: "allowEmpty.*true"
    - from: "convex/ai/chat.ts"
      to: "system prompt"
      via: "isAutoGreeting detection"
      pattern: "isAutoGreeting.*message.*===.*\"\""
---

<objective>
Enable AI auto-greeting infrastructure - modify useAIChat to allow empty messages and enhance chat action with auto-greeting system prompt.

Purpose: Foundation for AI-initiated conversations after questionnaire completion
Output: Modified hooks and Convex action that support auto-greeting flow
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-ai-auto-flow/46-RESEARCH.md

@src/components/ai/hooks/useAIChat.ts
@convex/ai/chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify useAIChat to support empty messages</name>
  <files>src/components/ai/hooks/useAIChat.ts</files>
  <action>
Update the sendMessage function to accept an optional options object with `allowEmpty` flag:

1. Change function signature from `sendMessage(text: string)` to `sendMessage(text: string, options?: { allowEmpty?: boolean })`

2. Modify the early return guard:
   - Current: `if (!text.trim()) return;`
   - New: `if (!text.trim() && !options?.allowEmpty) return;`

3. For optimistic user message, skip adding it when allowEmpty is true and text is empty (we don't want to show an empty user message in the UI):
   - Only add optimisticUserMessage if `text.trim()` is truthy

This allows `sendMessage("", { allowEmpty: true })` for auto-greeting without breaking existing usage.
  </action>
  <verify>
Build passes: `cd /Users/Kohelet/Code/REOS && npx tsc --noEmit`
No regressions in existing sendMessage calls (they don't pass options)
  </verify>
  <done>
useAIChat.sendMessage accepts optional `{ allowEmpty: true }` to send empty messages for auto-greeting
Empty messages skip optimistic UI update (no empty user bubble shown)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add auto-greeting detection and system prompt enhancement</name>
  <files>convex/ai/chat.ts</files>
  <action>
Enhance the sendMessage action to detect auto-greeting scenarios and inject appropriate system prompt:

1. After loading profile context and thread, detect auto-greeting:
   ```typescript
   // Get message count from agent thread
   const messagesResult = await investorAssistant.listMessages(ctx, {
     threadId: currentThreadId,
     paginationOpts: { numItems: 1, cursor: null },
     excludeToolMessages: true,
     statuses: ["success"],
   });
   const messageCount = messagesResult.page.length;

   // Detect auto-greeting scenario: empty message + empty/new thread
   const isAutoGreeting = message.trim() === "" && (isNew || messageCount === 0);
   ```

2. If isAutoGreeting, append auto-greeting instructions to systemContext:
   ```typescript
   if (isAutoGreeting) {
     systemContext += `\n\n## First Interaction - Auto-Greeting Mode

You're meeting this investor for the first time after they completed their investment profile questionnaire.

Your sequence:
1. Send a warm, personalized greeting (2-3 sentences) referencing their budget range and target cities from their profile
2. Immediately call the searchProperties tool with criteria matching their profile (3 properties)
3. After showing properties, immediately call the searchProviders tool (2-3 providers per role: broker, mortgage_advisor, lawyer)
4. After showing providers, mention the quick reply buttons for follow-up questions

CRITICAL: Execute BOTH tool calls automatically in this response. Do NOT wait for user prompts.
Start with "Welcome! Based on your profile..." then show properties, then providers.`;
   }
   ```

3. For the prompt, use a fallback when empty:
   ```typescript
   prompt: message || "Begin our conversation",
   ```

This ensures AI receives explicit instructions to auto-invoke tools without waiting for user input.
  </action>
  <verify>
Build passes: `cd /Users/Kohelet/Code/REOS && npx convex dev --once`
TypeScript compiles without errors
  </verify>
  <done>
sendMessage action detects isAutoGreeting when message is empty and thread is new/empty
System prompt includes explicit instructions to greet and call both searchProperties and searchProviders tools
AI receives clear directive to execute tools automatically without waiting
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Convex functions deploy: `npx convex dev --once`
3. No breaking changes to existing chat functionality (normal messages still work)
</verification>

<success_criteria>
- useAIChat.sendMessage("", { allowEmpty: true }) is valid and sends to server
- Server detects empty message + empty thread as auto-greeting scenario
- System prompt for auto-greeting includes explicit tool invocation instructions
- Existing chat functionality unchanged (text.trim() guard still works for normal usage)
</success_criteria>

<output>
After completion, create `.planning/phases/46-ai-auto-flow/46-01-SUMMARY.md`
</output>
