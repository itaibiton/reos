---
phase: 46-ai-auto-flow
plan: 03
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - src/components/profile/MobileInvestorSummary.tsx
  - src/components/IncompleteProfileReminder.tsx
  - messages/en.json
  - messages/he.json
autonomous: false

must_haves:
  truths:
    - "Mobile summary triggers auto-greeting on first visit (same as desktop)"
    - "Questionnaire popup shows on every visit until completed"
    - "Skip closes popup for current session only (not permanently)"
    - "Completing questionnaire dismisses popup permanently"
  artifacts:
    - path: "src/components/profile/MobileInvestorSummary.tsx"
      provides: "Mobile auto-greeting trigger"
      contains: "autoGreet"
    - path: "src/components/IncompleteProfileReminder.tsx"
      provides: "Persistent questionnaire reminder"
      contains: "toast"
  key_links:
    - from: "MobileInvestorSummary"
      to: "AIChatPanel"
      via: "passes autoGreet={true} prop"
      pattern: "AIChatPanel.*autoGreet"
    - from: "IncompleteProfileReminder"
      to: "questionnaire.status"
      via: "useQuery check"
      pattern: "questionnaire.*status.*complete"
---

<objective>
Wire auto-greeting for mobile, verify questionnaire reminder persistence, and add translations.

Purpose: Ensure mobile has same auto-greeting behavior as desktop, and questionnaire reminder persists until completion
Output: Mobile summary triggers auto-greeting, verified persistence behavior, added i18n
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-ai-auto-flow/46-RESEARCH.md

@src/components/profile/MobileInvestorSummary.tsx
@src/components/IncompleteProfileReminder.tsx
@messages/en.json
@messages/he.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire auto-greeting in MobileInvestorSummary</name>
  <files>src/components/profile/MobileInvestorSummary.tsx</files>
  <action>
Add autoGreet prop to AIChatPanel in the mobile summary component.

1. Find where AIChatPanel is rendered in MobileInvestorSummary.tsx
2. Add `autoGreet={true}` prop:
   ```typescript
   <AIChatPanel autoGreet={true} />
   ```

3. Do NOT add useAIChat or useAutoGreeting directly - all logic is inside AIChatPanel now

This ensures mobile has identical auto-greeting behavior to desktop, using the same single-instance pattern.
  </action>
  <verify>
Build passes: `cd /Users/Kohelet/Code/REOS && npm run build`
Verify wiring: `grep "autoGreet" src/components/profile/MobileInvestorSummary.tsx`
  </verify>
  <done>
MobileInvestorSummary passes autoGreet={true} to AIChatPanel
Mobile users get same auto-greeting experience as desktop
No duplicate useAIChat instances
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify questionnaire completion await chain</name>
  <files>src/app/[locale]/(app)/onboarding/questionnaire/page.tsx</files>
  <action>
Review and verify the handleComplete function ensures async operations complete before redirect:

Expected correct code pattern:
```typescript
const handleComplete = async () => {
  setIsSubmitting(true);
  try {
    await saveProgress();
    await markComplete();
    await completeOnboarding();
    router.push("/profile/investor/summary");
  } catch (error) {
    // ...
  }
};
```

**Verification checklist:**
1. All mutations are awaited (saveProgress, markComplete, completeOnboarding)
2. router.push happens AFTER all awaits complete
3. No race condition between completion and redirect

**If the implementation is correct as-is:** Document this verification in summary, no changes needed.

**If issues found:** Fix the await chain to ensure proper sequencing.
  </action>
  <verify>
Read the file and confirm the await chain is correct:
`grep -A 10 "handleComplete" src/app/[locale]/(app)/onboarding/questionnaire/page.tsx`
  </verify>
  <done>
handleComplete properly awaits markComplete before router.push
No race condition between completion and redirect
Auto-greeting will trigger correctly on arrival at summary page
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify IncompleteProfileReminder persistence behavior</name>
  <files>src/components/IncompleteProfileReminder.tsx</files>
  <action>
Review the current IncompleteProfileReminder implementation:

Current behavior (from code review):
1. Shows toast when questionnaire.status !== "complete" and effectiveRole === "investor"
2. Dismisses on navigation to onboarding/questionnaire pages
3. Re-shows on navigation to other pages (tracks lastPathRef)
4. Does NOT update database on dismiss - just closes toast

This is CORRECT for AUTO-05 requirement. The toast:
- Shows on every page navigation while status is "draft"
- Closing the toast only dismisses for current path (via lastPathRef tracking)
- On next navigation, toast shows again
- Only markComplete() in questionnaire page permanently updates status

**Verify no changes needed:**
- The toast pattern with lastPathRef already implements "skip is temporary"
- Database status remains "draft" until user completes questionnaire
- Toast will show again on next page navigation

If the implementation is correct as-is, no changes needed. Document this verification.

**Potential enhancement (if needed):**
If toast doesn't show on summary page, ensure pathname check allows it:
- Current check: `pathname.startsWith("/onboarding") || pathname.startsWith("/profile/investor/questionnaire")`
- Summary page `/profile/investor/summary` should NOT be excluded, so toast WILL show there

This means the toast already shows on summary page for incomplete profiles, which is correct.
  </action>
  <verify>
Read the file and confirm:
1. Toast shows when status !== "complete"
2. No database update on dismiss
3. lastPathRef causes re-show on navigation
  </verify>
  <done>
IncompleteProfileReminder correctly persists until questionnaire completion
Skip (closing toast) is temporary - shows again on next navigation
No code changes needed - existing implementation satisfies AUTO-05
  </done>
</task>

<task type="auto">
  <name>Task 4: Add translations for AI auto-greeting context</name>
  <files>
    messages/en.json
    messages/he.json
  </files>
  <action>
Add translations for AI assistant auto-greeting and related UI elements.

**English (messages/en.json):**
Add to the "ai" section (create if doesn't exist):
```json
{
  "ai": {
    "autoGreeting": {
      "welcome": "Welcome! Based on your profile, I've found some great investment opportunities for you.",
      "showingProperties": "Let me show you some properties that match your criteria.",
      "showingProviders": "I've also found some service providers who can help with your investment journey.",
      "quickRepliesHint": "Use the quick reply buttons below for follow-up questions."
    }
  }
}
```

Note: These translations are for reference - the AI generates dynamic content based on system prompt.
The actual greeting text comes from the AI, not hardcoded strings. But having these
as reference helps maintain consistency if we ever need them for UI elements.

**Hebrew (messages/he.json):**
Add matching translations:
```json
{
  "ai": {
    "autoGreeting": {
      "welcome": "ברוכים הבאים! על סמך הפרופיל שלך, מצאתי כמה הזדמנויות השקעה מעולות.",
      "showingProperties": "הנה כמה נכסים שתואמים את הקריטריונים שלך.",
      "showingProviders": "מצאתי גם כמה נותני שירות שיכולים לעזור במסע ההשקעה שלך.",
      "quickRepliesHint": "השתמש בכפתורי התגובה המהירה למטה לשאלות נוספות."
    }
  }
}
```
  </action>
  <verify>
JSON is valid: `cd /Users/Kohelet/Code/REOS && node -e "JSON.parse(require('fs').readFileSync('messages/en.json'))"`
Hebrew JSON is valid: `node -e "JSON.parse(require('fs').readFileSync('messages/he.json'))"`
  </verify>
  <done>
English translations added for AI auto-greeting reference strings
Hebrew translations added for AI auto-greeting reference strings
JSON files remain valid
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete AI Auto-Flow implementation:
1. useAIChat supports empty messages with allowEmpty flag (Plan 01)
2. Server-side chat action detects auto-greeting and injects tool-calling instructions (Plan 01)
3. AIChatPanel accepts autoGreet prop for auto-greeting trigger (Plan 02)
4. Desktop summary page passes autoGreet={true} to AIChatPanel (Plan 02)
5. Mobile summary passes autoGreet={true} to AIChatPanel (Plan 03)
6. Questionnaire reminder persists until completion (verified existing behavior)
  </what-built>
  <how-to-verify>
Test the complete flow:

1. **Fresh start (clear data if needed):**
   - Sign in as an investor with incomplete questionnaire
   - Verify the incomplete profile toast appears

2. **Complete questionnaire:**
   - Navigate to questionnaire page
   - Complete all steps
   - Click "Complete" button
   - Should redirect to `/profile/investor/summary`

3. **Verify auto-greeting:**
   - On summary page, AI should automatically send a greeting
   - AI should show property cards (not just text description)
   - **AUTO-03 verification:** Confirm "Save All" button renders below the property cards
   - After properties, AI should show provider cards grouped by role
   - **AUTO-04 verification:** Confirm providers are grouped by role (Broker, Mortgage Advisor, Lawyer sections)
   - **AUTO-04 verification:** Confirm each provider card has "Add to Team" button
   - **SUCCESS-07 verification:** Confirm quick reply buttons remain visible after auto-greeting completes

4. **Verify no re-trigger:**
   - Refresh the page
   - AI should NOT send another greeting (messages already exist)

5. **Verify persistence (skip test):**
   - Sign out and sign in again (or use different browser)
   - If questionnaire was incomplete and you skipped, toast should reappear
   - If questionnaire was completed, toast should NOT appear

6. **Mobile verification:**
   - Test on mobile viewport or device
   - Same auto-greeting behavior should work in mobile tabbed interface

**Checklist for visual verification:**
- [ ] Property cards render with match reasons and individual Save buttons
- [ ] SaveAllButton visible below property cards (AUTO-03)
- [ ] Provider cards grouped by role: Broker, Mortgage Advisor, Lawyer (AUTO-04)
- [ ] Each provider card has "Add to Team" button (AUTO-04)
- [ ] Quick reply buttons visible after auto-suggestions complete (SUCCESS-07)
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Mobile auto-greeting wired (autoGreet prop passed)
2. Questionnaire await chain verified correct
3. IncompleteProfileReminder correctly persists (code review)
4. Translations valid JSON
5. End-to-end flow works (human verification)
6. AUTO-03: SaveAllButton renders below property cards
7. AUTO-04: Providers grouped by role with Add to Team buttons
8. SUCCESS-07: Quick reply buttons visible after auto-suggestions
</verification>

<success_criteria>
- Mobile summary triggers auto-greeting via autoGreet={true} prop
- Questionnaire completion properly awaits before redirect
- Questionnaire popup shows on every visit until completed (existing behavior)
- Skip closes for session only, not permanently (existing behavior)
- AI auto-greeting fires on first visit to summary page (desktop and mobile)
- Property cards display with SaveAllButton below them (AUTO-03)
- Provider cards grouped by role: broker, mortgage_advisor, lawyer (AUTO-04)
- Provider cards have "Add to Team" buttons (AUTO-04)
- Quick reply buttons remain visible after auto-suggestions (SUCCESS-07)
- No re-triggering on page reload
</success_criteria>

<output>
After completion, create `.planning/phases/46-ai-auto-flow/46-03-SUMMARY.md`
</output>
