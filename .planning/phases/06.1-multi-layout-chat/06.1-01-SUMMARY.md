---
phase: 06.1-multi-layout-chat
plan: 01
subsystem: api
tags: [convex, messages, chat, real-time, queries, mutations]

# Dependency graph
requires:
  - phase: 06-deal-flow
    provides: deals, serviceRequests, user participants
provides:
  - messages table with status tracking
  - listForDeal query for all deal messages
  - listConversation query for 1:1 chats
  - getUnreadCount query for badge counts
  - getDealParticipants query for chat list
  - send mutation with validation
  - markAsRead mutation for read receipts
affects: [06.1-02-chat-ui, 06.1-03-multi-layout]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Real-time queries via Convex subscriptions
    - Participant access control on all queries/mutations

key-files:
  created:
    - convex/messages.ts
  modified:
    - convex/schema.ts

key-decisions:
  - "Message status: sent → delivered → read (3-state)"
  - "Indexes for by_deal_and_time, by_conversation for efficient queries"

patterns-established:
  - "Chat queries enrich messages with sender info"
  - "Participant validation before any query/mutation"

issues-created: []

# Metrics
duration: 3min
completed: 2026-01-15
---

# Phase 6.1 Plan 01: Messages Schema & Chat Backend Summary

**Real-time messaging backend with Convex subscriptions, participant access control, and read receipts**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-15T13:06:52Z
- **Completed:** 2026-01-15T13:09:26Z
- **Tasks:** 3
- **Files modified:** 2

## Accomplishments

- Messages table with dealId, senderId, recipientId, content, status
- 4 queries: listForDeal, listConversation, getUnreadCount, getDealParticipants
- 2 mutations: send (with validation), markAsRead (batch update)
- Participant access control on all operations

## Task Commits

Each task was committed atomically:

1. **Task 1: Add messages table to schema** - `0ab7e2d` (feat)
2. **Task 2: Create messages queries** - `07eda6b` (feat)
3. **Task 3: Create messages mutations** - included in `07eda6b` (same file)

## Files Created/Modified

- `convex/schema.ts` - Added messageStatus validator and messages table with 5 indexes
- `convex/messages.ts` - New file with 4 queries and 2 mutations

## Decisions Made

- Used 3-state message status (sent, delivered, read) for delivery tracking
- Created by_conversation index for efficient 1:1 chat filtering
- Enriched messages with sender name/imageUrl for UI display

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Next Phase Readiness

- Backend ready for chat UI implementation
- Real-time subscriptions work via Convex useQuery
- Ready for 06.1-02: Chat UI components + single layout

---
*Phase: 06.1-multi-layout-chat*
*Completed: 2026-01-15*
