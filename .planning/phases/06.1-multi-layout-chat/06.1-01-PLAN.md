# Phase 6.1 Plan 01: Messages Schema & Chat Backend

## Objective

Create the messaging backend infrastructure: messages table, real-time queries using Convex subscriptions, and mutations for sending/receiving messages between deal participants.

## Execution Context

@convex/schema.ts - Existing schema with deals, serviceRequests
@convex/deals.ts - Deal queries and mutations
@convex/serviceRequests.ts - Provider request patterns

## Context

**Prerequisites:**
- Phase 6 complete (deals, service requests, files)
- Convex backend with real-time subscriptions support

**Key decisions from Phase 6:**
- Deal participants: investor + up to 3 providers (broker, mortgage_advisor, lawyer)
- Service requests track investor-provider relationships
- Activity logging pattern established for audit trail

**Real-time pattern:**
- Convex queries automatically subscribe to updates
- useQuery hook provides real-time data
- No additional WebSocket setup needed

## Tasks

### Task 1: Add messages table to schema

**Files:** convex/schema.ts

**Changes:**
1. Add messageStatus validator:
```typescript
const messageStatus = v.union(
  v.literal("sent"),
  v.literal("delivered"),
  v.literal("read")
);
```

2. Add messages table:
```typescript
messages: defineTable({
  // Conversation context
  dealId: v.id("deals"),
  senderId: v.id("users"),
  recipientId: v.id("users"),

  // Message content
  content: v.string(),

  // Status tracking
  status: messageStatus,
  readAt: v.optional(v.number()),

  // Timestamps
  createdAt: v.number(),
})
  .index("by_deal", ["dealId"])
  .index("by_deal_and_time", ["dealId", "createdAt"])
  .index("by_sender", ["senderId"])
  .index("by_recipient", ["recipientId"])
  .index("by_conversation", ["dealId", "senderId", "recipientId"]),
```

**Verification:** `npx convex dev` runs without schema errors

### Task 2: Create messages queries

**Files:** convex/messages.ts (new)

**Functions to implement:**

1. `listForDeal` - Get all messages for a deal (participant access only)
```typescript
export const listForDeal = query({
  args: { dealId: v.id("deals") },
  handler: async (ctx, args) => {
    // Verify user is deal participant
    // Return messages sorted by createdAt ascending
    // Include sender info (name, imageUrl)
  }
});
```

2. `listConversation` - Get messages between current user and specific participant
```typescript
export const listConversation = query({
  args: {
    dealId: v.id("deals"),
    participantId: v.id("users"),
  },
  handler: async (ctx, args) => {
    // Get messages where (sender=me AND recipient=participant) OR (sender=participant AND recipient=me)
    // Sort by createdAt ascending
    // Include sender info
  }
});
```

3. `getUnreadCount` - Count unread messages for current user in a deal
```typescript
export const getUnreadCount = query({
  args: { dealId: v.id("deals") },
  handler: async (ctx, args) => {
    // Count messages where recipient=me AND status != "read"
  }
});
```

4. `getDealParticipants` - List all participants user can chat with
```typescript
export const getDealParticipants = query({
  args: { dealId: v.id("deals") },
  handler: async (ctx, args) => {
    // Return investor + all assigned providers with name, role, imageUrl
    // Exclude current user from list
  }
});
```

**Verification:** Queries appear in convex/_generated/api.d.ts

### Task 3: Create messages mutations

**Files:** convex/messages.ts

**Functions to implement:**

1. `send` - Send a message
```typescript
export const send = mutation({
  args: {
    dealId: v.id("deals"),
    recipientId: v.id("users"),
    content: v.string(),
  },
  handler: async (ctx, args) => {
    // Validate: user is deal participant
    // Validate: recipient is deal participant
    // Validate: content is not empty
    // Insert message with status "sent"
    // Return message ID
  }
});
```

2. `markAsRead` - Mark messages as read
```typescript
export const markAsRead = mutation({
  args: {
    dealId: v.id("deals"),
    senderId: v.id("users"),
  },
  handler: async (ctx, args) => {
    // Update all unread messages from sender to current user
    // Set status to "read" and readAt to now
  }
});
```

**Verification:** Mutations appear in convex/_generated/api.d.ts

## Verification

```bash
# Schema and functions compile
npx convex dev

# Check generated types
cat convex/_generated/api.d.ts | grep -A5 "messages"
```

## Success Criteria

- [ ] messages table added to schema with proper indexes
- [ ] listForDeal query returns messages with sender info
- [ ] listConversation query filters by participant pair
- [ ] getUnreadCount returns accurate count
- [ ] getDealParticipants returns all chat-able users
- [ ] send mutation creates message with validation
- [ ] markAsRead mutation updates message status
- [ ] All functions have participant access control

## Output

Backend ready for chat UI:
- Real-time message queries via Convex subscriptions
- Send/read mutations with proper validation
- Participant enumeration for chat list
