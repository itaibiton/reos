# Phase 6.1 Plan 02: Chat UI Components & Single Layout

## Objective

Create the chat page with single-layout chat experience: conversation list sidebar, message thread view, and message input. This establishes the core chat components that will be reused in multi-layout views.

## Execution Context

@convex/messages.ts - Messages queries and mutations (from 06.1-01)
@src/app/(app)/deals/[id]/page.tsx - Deal detail page patterns
@src/components/ui/* - Shadcn components

## Context

**Prerequisites:**
- 06.1-01 complete (messages schema and backend)
- Existing patterns: useCurrentUser hook, toast notifications, Avatar component

**UI patterns to follow:**
- Sidebar list similar to deals page filtering
- Message bubbles: own messages right-aligned, others left-aligned
- Real-time updates via useQuery subscriptions
- Input with send button (Enter to send, Shift+Enter for newline)

## Tasks

### Task 1: Create ChatMessage component

**Files:** src/components/chat/ChatMessage.tsx (new)

**Component:**
```typescript
interface ChatMessageProps {
  content: string;
  senderName: string;
  senderImage?: string;
  timestamp: number;
  isOwn: boolean;
  status?: "sent" | "delivered" | "read";
}

export function ChatMessage({ ... }: ChatMessageProps) {
  // Render message bubble
  // Own messages: right-aligned, primary background
  // Other messages: left-aligned, muted background
  // Show avatar for other's messages
  // Show timestamp below message
  // Show status indicator for own messages (optional)
}
```

**Styling:**
- Own: `ml-auto bg-primary text-primary-foreground rounded-2xl rounded-br-sm`
- Others: `mr-auto bg-muted rounded-2xl rounded-bl-sm`
- Max width 70% of container
- Avatar (24px) for others only

**Verification:** Component renders correctly with different props

### Task 2: Create ChatInput component

**Files:** src/components/chat/ChatInput.tsx (new)

**Component:**
```typescript
interface ChatInputProps {
  onSend: (content: string) => void;
  disabled?: boolean;
  placeholder?: string;
}

export function ChatInput({ onSend, disabled, placeholder }: ChatInputProps) {
  // Textarea with auto-resize
  // Enter sends, Shift+Enter adds newline
  // Send button (disabled when empty or sending)
  // Clear input after send
}
```

**Behavior:**
- Use `useState` for input value
- `onKeyDown` handler for Enter/Shift+Enter
- Textarea auto-grows up to 4 lines
- Disable during send operation

**Verification:** Enter sends message, Shift+Enter adds newline

### Task 3: Create ChatThread component

**Files:** src/components/chat/ChatThread.tsx (new)

**Component:**
```typescript
interface ChatThreadProps {
  dealId: Id<"deals">;
  participantId: Id<"users">;
  participantName: string;
  participantImage?: string;
  participantRole?: string;
  onBack?: () => void; // For mobile back navigation
}

export function ChatThread({ ... }: ChatThreadProps) {
  // Header with participant info and optional back button
  // Scrollable message list using ScrollArea
  // Auto-scroll to bottom on new messages
  // ChatInput at bottom
  // Mark messages as read when thread is open
}
```

**Data fetching:**
```typescript
const messages = useQuery(api.messages.listConversation, {
  dealId,
  participantId,
});
const sendMessage = useMutation(api.messages.send);
const markAsRead = useMutation(api.messages.markAsRead);

// Mark as read on mount and when new messages arrive
useEffect(() => {
  markAsRead({ dealId, senderId: participantId });
}, [messages?.length]);
```

**Layout:**
- Header: 56px fixed
- Messages: flex-1 overflow-y-auto
- Input: auto-height at bottom

**Verification:** Messages load, new messages appear in real-time, scroll behavior works

### Task 4: Create ChatParticipantList component

**Files:** src/components/chat/ChatParticipantList.tsx (new)

**Component:**
```typescript
interface ChatParticipantListProps {
  dealId: Id<"deals">;
  selectedParticipantId?: Id<"users">;
  onSelectParticipant: (participant: Participant) => void;
}

export function ChatParticipantList({ ... }: ChatParticipantListProps) {
  // List of deal participants user can chat with
  // Show avatar, name, role badge
  // Show unread count badge
  // Highlight selected participant
}
```

**Data:**
```typescript
const participants = useQuery(api.messages.getDealParticipants, { dealId });
// For each participant, could show last message preview (optional enhancement)
```

**List item:**
- Avatar (32px)
- Name + role badge
- Unread count badge (if > 0)
- Selected state: bg-accent

**Verification:** Participants load, selection works, unread badges show

### Task 5: Create chat page with single layout

**Files:** src/app/(app)/chat/page.tsx (new)

**Page structure:**
```typescript
export default function ChatPage() {
  const [selectedDealId, setSelectedDealId] = useState<Id<"deals"> | null>(null);
  const [selectedParticipant, setSelectedParticipant] = useState<Participant | null>(null);

  // Get user's active deals
  const deals = useQuery(api.deals.list);

  return (
    <div className="h-full flex">
      {/* Left sidebar: Deal selector + participant list */}
      <div className="w-80 border-r flex flex-col">
        {/* Deal selector dropdown */}
        {/* ChatParticipantList for selected deal */}
      </div>

      {/* Main area: Chat thread or empty state */}
      <div className="flex-1">
        {selectedParticipant ? (
          <ChatThread ... />
        ) : (
          <EmptyState message="Select a conversation" />
        )}
      </div>
    </div>
  );
}
```

**Features:**
- Deal selector (dropdown or list) at top of sidebar
- Participant list below
- Full chat thread when participant selected
- Empty state when no selection

**Verification:** Page loads, deal selection works, chat works end-to-end

### Task 6: Add chat to navigation

**Files:** src/components/layout/Sidebar.tsx

**Changes:**
- Add "Chat" nav item for all authenticated roles
- Icon: Message02Icon or similar from Hugeicons
- Route: /chat

**Verification:** Chat link appears in sidebar, navigates correctly

## Verification

```bash
# Build passes
npm run build

# Manual test:
# 1. Navigate to /chat
# 2. Select a deal with providers
# 3. Select a participant
# 4. Send a message
# 5. Verify real-time updates
```

## Success Criteria

- [ ] ChatMessage renders own/other messages correctly
- [ ] ChatInput handles Enter/Shift+Enter properly
- [ ] ChatThread shows messages with auto-scroll
- [ ] ChatParticipantList shows participants with unread counts
- [ ] Chat page works end-to-end with single layout
- [ ] Navigation includes chat link
- [ ] Messages update in real-time

## Output

Functional chat page with:
- Single full-width chat experience
- Deal and participant selection
- Real-time messaging
- Unread message indicators
