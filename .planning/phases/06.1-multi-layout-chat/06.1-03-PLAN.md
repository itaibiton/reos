# Phase 6.1 Plan 03: Multi-Layout System with Drag-and-Drop

## Objective

Extend the chat page with multiple layout options (single, split, quad) and drag-and-drop functionality for assigning participants to chat panes.

## Execution Context

@src/app/(app)/chat/page.tsx - Single layout chat (from 06.1-02)
@src/components/chat/* - Chat components (from 06.1-02)
npm: @dnd-kit/core, @dnd-kit/sortable - Drag-and-drop library

## Context

**Prerequisites:**
- 06.1-02 complete (single layout chat working)
- react-resizable-panels already installed

**Layout modes:**
1. **Single**: Full chat with one participant (current behavior)
2. **Split**: Two chat panes side-by-side
3. **Quad**: Four chat panes in 2x2 grid

**Drag-and-drop behavior:**
- Drag participant from sidebar list to empty pane
- Click button in empty pane to open participant selector
- Can swap pane contents by dragging between panes

## Tasks

### Task 1: Install dnd-kit

**Command:**
```bash
npm install @dnd-kit/core @dnd-kit/utilities
```

**Verification:** Package appears in package.json

### Task 2: Create layout mode selector

**Files:** src/components/chat/LayoutModeSelector.tsx (new)

**Component:**
```typescript
type LayoutMode = "single" | "split" | "quad";

interface LayoutModeSelectorProps {
  mode: LayoutMode;
  onModeChange: (mode: LayoutMode) => void;
}

export function LayoutModeSelector({ mode, onModeChange }: LayoutModeSelectorProps) {
  // Toggle group with 3 options
  // Icons representing each layout
  // Single: one rectangle
  // Split: two vertical rectangles
  // Quad: four squares
}
```

**Use Shadcn ToggleGroup:**
```typescript
<ToggleGroup type="single" value={mode} onValueChange={onModeChange}>
  <ToggleGroupItem value="single" aria-label="Single chat">
    <SingleLayoutIcon />
  </ToggleGroupItem>
  <ToggleGroupItem value="split" aria-label="Split view">
    <SplitLayoutIcon />
  </ToggleGroupItem>
  <ToggleGroupItem value="quad" aria-label="Quad view">
    <QuadLayoutIcon />
  </ToggleGroupItem>
</ToggleGroup>
```

**Verification:** Toggle switches layout mode

### Task 3: Create ChatPane component (droppable)

**Files:** src/components/chat/ChatPane.tsx (new)

**Component:**
```typescript
interface ChatPaneProps {
  paneId: string; // "pane-0", "pane-1", etc.
  participant: Participant | null;
  dealId: Id<"deals">;
  onClear: () => void;
  onSelectParticipant: () => void;
}

export function ChatPane({ paneId, participant, dealId, onClear, onSelectParticipant }: ChatPaneProps) {
  const { setNodeRef, isOver } = useDroppable({ id: paneId });

  if (!participant) {
    // Empty state: drop zone + select button
    return (
      <div ref={setNodeRef} className={cn(
        "h-full flex flex-col items-center justify-center border-2 border-dashed",
        isOver && "border-primary bg-primary/5"
      )}>
        <p className="text-muted-foreground mb-4">Drag a participant here</p>
        <Button variant="outline" onClick={onSelectParticipant}>
          Select Participant
        </Button>
      </div>
    );
  }

  // Filled state: chat thread with close button
  return (
    <div ref={setNodeRef} className="h-full flex flex-col">
      <div className="flex items-center justify-between p-2 border-b">
        <span className="font-medium">{participant.name}</span>
        <Button variant="ghost" size="icon" onClick={onClear}>
          <Cancel01Icon />
        </Button>
      </div>
      <div className="flex-1">
        <ChatThread
          dealId={dealId}
          participantId={participant._id}
          participantName={participant.name}
          participantImage={participant.imageUrl}
          participantRole={participant.role}
          compact // Smaller header for multi-pane
        />
      </div>
    </div>
  );
}
```

**Verification:** Empty pane shows drop zone, filled pane shows chat

### Task 4: Make participant list items draggable

**Files:** src/components/chat/ChatParticipantList.tsx

**Modifications:**
1. Wrap component with DndContext provider (if not at page level)
2. Make each list item draggable:

```typescript
function DraggableParticipant({ participant, ...props }) {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: participant._id,
    data: { participant },
  });

  const style = transform ? {
    transform: `translate3d(${transform.x}px, ${transform.y}px, 0)`,
  } : undefined;

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...listeners}
      {...attributes}
      className={cn(
        "cursor-grab",
        isDragging && "opacity-50"
      )}
    >
      {/* Existing participant list item content */}
    </div>
  );
}
```

3. Add drag overlay for visual feedback during drag

**Verification:** Participants can be dragged from list

### Task 5: Create multi-layout container

**Files:** src/components/chat/ChatLayoutContainer.tsx (new)

**Component:**
```typescript
interface ChatLayoutContainerProps {
  mode: LayoutMode;
  dealId: Id<"deals">;
  panes: (Participant | null)[];
  onPaneChange: (paneIndex: number, participant: Participant | null) => void;
}

export function ChatLayoutContainer({ mode, dealId, panes, onPaneChange }: ChatLayoutContainerProps) {
  const visiblePanes = mode === "single" ? 1 : mode === "split" ? 2 : 4;

  // Grid layout based on mode
  const gridClass = {
    single: "grid-cols-1",
    split: "grid-cols-2",
    quad: "grid-cols-2 grid-rows-2",
  }[mode];

  return (
    <div className={cn("grid h-full gap-1", gridClass)}>
      {Array.from({ length: visiblePanes }).map((_, index) => (
        <ChatPane
          key={index}
          paneId={`pane-${index}`}
          participant={panes[index] || null}
          dealId={dealId}
          onClear={() => onPaneChange(index, null)}
          onSelectParticipant={() => {/* Open selector dialog */}}
        />
      ))}
    </div>
  );
}
```

**Verification:** Layout changes with mode, panes render correctly

### Task 6: Integrate drag-and-drop in chat page

**Files:** src/app/(app)/chat/page.tsx

**Modifications:**
1. Add layout mode state
2. Add panes state (array of 4 participants, some null)
3. Wrap with DndContext
4. Handle drag end to assign participant to pane

```typescript
export default function ChatPage() {
  const [layoutMode, setLayoutMode] = useState<LayoutMode>("single");
  const [selectedDealId, setSelectedDealId] = useState<Id<"deals"> | null>(null);
  const [panes, setPanes] = useState<(Participant | null)[]>([null, null, null, null]);

  function handleDragEnd(event: DragEndEvent) {
    const { active, over } = event;
    if (!over) return;

    // Extract pane index from droppable id
    const paneIndex = parseInt(over.id.toString().replace("pane-", ""));
    if (isNaN(paneIndex)) return;

    // Get participant from drag data
    const participant = active.data.current?.participant;
    if (!participant) return;

    // Update pane
    setPanes(prev => {
      const next = [...prev];
      next[paneIndex] = participant;
      return next;
    });
  }

  return (
    <DndContext onDragEnd={handleDragEnd}>
      <div className="h-full flex flex-col">
        {/* Header with layout selector */}
        <div className="p-2 border-b flex items-center justify-between">
          <DealSelector ... />
          <LayoutModeSelector mode={layoutMode} onModeChange={setLayoutMode} />
        </div>

        <div className="flex-1 flex">
          {/* Sidebar */}
          <div className="w-64 border-r">
            <ChatParticipantList ... />
          </div>

          {/* Main area */}
          <div className="flex-1">
            <ChatLayoutContainer
              mode={layoutMode}
              dealId={selectedDealId}
              panes={panes}
              onPaneChange={(index, p) => {
                setPanes(prev => {
                  const next = [...prev];
                  next[index] = p;
                  return next;
                });
              }}
            />
          </div>
        </div>
      </div>

      {/* Drag overlay */}
      <DragOverlay>
        {/* Render dragged participant preview */}
      </DragOverlay>
    </DndContext>
  );
}
```

**Verification:** Full drag-and-drop workflow works

### Task 7: Add participant selector dialog

**Files:** src/components/chat/ParticipantSelectorDialog.tsx (new)

**Component:**
```typescript
interface ParticipantSelectorDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  dealId: Id<"deals">;
  excludeIds: Id<"users">[]; // Already assigned to panes
  onSelect: (participant: Participant) => void;
}

export function ParticipantSelectorDialog({ ... }: ParticipantSelectorDialogProps) {
  const participants = useQuery(api.messages.getDealParticipants, { dealId });

  const available = participants?.filter(p => !excludeIds.includes(p._id));

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Select Participant</DialogTitle>
        </DialogHeader>
        <div className="space-y-2">
          {available?.map(p => (
            <Button
              key={p._id}
              variant="ghost"
              className="w-full justify-start"
              onClick={() => {
                onSelect(p);
                onOpenChange(false);
              }}
            >
              <Avatar ... />
              {p.name}
              <Badge>{p.role}</Badge>
            </Button>
          ))}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

**Verification:** Dialog opens, selecting participant fills pane

## Verification

```bash
# Build passes
npm run build

# Manual test:
# 1. Navigate to /chat
# 2. Select a deal with multiple providers
# 3. Switch to split layout
# 4. Drag participant to left pane
# 5. Drag another to right pane
# 6. Verify both chats work independently
# 7. Switch to quad layout
# 8. Use select button to fill panes
# 9. Switch back to single layout
```

## Checkpoint: Human Verification

**Type:** verify
**Description:** Verify multi-layout chat functionality

**Test scenarios:**
1. Single layout works as before (regression)
2. Split layout shows two functional chat panes
3. Quad layout shows four panes (2x2 grid)
4. Drag-and-drop from sidebar to pane works
5. "Select Participant" button in empty pane works
6. Clear button removes participant from pane
7. Layout switching preserves pane assignments where possible
8. Real-time messages work in all panes simultaneously

## Success Criteria

- [ ] dnd-kit installed and configured
- [ ] Layout mode selector switches between single/split/quad
- [ ] ChatPane renders empty and filled states
- [ ] Participants draggable from sidebar list
- [ ] Drop zones highlight during drag
- [ ] Dropping assigns participant to pane
- [ ] ParticipantSelectorDialog works as alternative to drag
- [ ] Multiple simultaneous chats work in split/quad modes
- [ ] Layout switching works smoothly

## Output

Complete multi-layout chat system:
- Three layout modes (single, split, quad)
- Drag-and-drop participant assignment
- Button-based participant selection alternative
- Independent real-time chat in each pane
