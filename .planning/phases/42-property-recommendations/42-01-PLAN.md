---
phase: 42-property-recommendations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/ai/tools/propertySearch.ts
  - convex/ai/tools/propertyQueries.ts
  - convex/ai/agent.ts
autonomous: true

must_haves:
  truths:
    - "AI can search properties based on budget, location, and property type"
    - "Tool returns only existing properties (verified by database query)"
    - "AI uses investor profile context when searching"
  artifacts:
    - path: "convex/ai/tools/propertyQueries.ts"
      provides: "Multi-criteria property search query"
      exports: ["searchProperties"]
    - path: "convex/ai/tools/propertySearch.ts"
      provides: "AI tool definition with Zod schema"
      exports: ["searchPropertiesTool"]
    - path: "convex/ai/agent.ts"
      provides: "Agent with searchProperties tool registered"
      contains: "searchProperties"
  key_links:
    - from: "convex/ai/tools/propertySearch.ts"
      to: "convex/ai/tools/propertyQueries.ts"
      via: "ctx.runQuery in tool execute"
      pattern: "runQuery.*searchProperties"
    - from: "convex/ai/agent.ts"
      to: "convex/ai/tools/propertySearch.ts"
      via: "tools object registration"
      pattern: "tools:\\s*\\{[^}]*searchProperties"
---

<objective>
Create the property search tool that allows the AI to query real properties from the database based on investor criteria.

Purpose: Enable RAG-grounded property recommendations by giving the AI access to actual database properties via tool calling.
Output: Property search query + tool definition + agent registration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-property-recommendations/42-CONTEXT.md
@.planning/phases/42-property-recommendations/42-RESEARCH.md
@.planning/phases/40-ai-infrastructure-foundation/40-03-SUMMARY.md
@convex/ai/agent.ts
@convex/properties.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create property search query</name>
  <files>convex/ai/tools/propertyQueries.ts</files>
  <action>
Create a new file `convex/ai/tools/propertyQueries.ts` with a `searchProperties` query that:

1. Accepts optional filter arguments:
   - `budgetMin: v.optional(v.number())` - Minimum price in USD
   - `budgetMax: v.optional(v.number())` - Maximum price in USD
   - `cities: v.optional(v.array(v.string()))` - Array of Israeli cities to search
   - `propertyTypes: v.optional(v.array(v.string()))` - Array of property types (residential, commercial, mixed_use, land)
   - `minBedrooms: v.optional(v.number())` - Minimum bedrooms
   - `limit: v.number()` - Maximum results (default enforced by caller)

2. Query implementation:
   - Start with `ctx.db.query("properties").withIndex("by_status", q => q.eq("status", "available")).collect()`
   - Apply each filter conditionally in TypeScript (not all at once in index)
   - Handle undefined property fields gracefully (e.g., `p.bedrooms !== undefined && p.bedrooms >= minBedrooms`)
   - Return sliced results with essential fields only:
     - `_id`, `title`, `city`, `address`, `priceUsd`, `bedrooms`, `bathrooms`, `squareMeters`, `propertyType`, `featuredImage`, `expectedRoi`, `capRate`

Reference the existing `convex/properties.ts` list query for filtering patterns but keep this as a standalone query in the tools directory.

Note: This query does NOT require authentication check since it's called from the AI agent action context which has already authenticated.
  </action>
  <verify>
Run `npx convex dev` - no TypeScript errors for the new file.
Check that `convex/ai/tools/propertyQueries.ts` exports `searchProperties`.
  </verify>
  <done>
searchProperties query exists and compiles, accepts multi-criteria filters, returns essential property fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create property search tool definition</name>
  <files>convex/ai/tools/propertySearch.ts</files>
  <action>
Create a new file `convex/ai/tools/propertySearch.ts` with:

```typescript
import { tool } from "ai";
import { z } from "zod";
import { api } from "../../_generated/api";
import type { ActionCtx } from "../../_generated/server";

export const searchPropertiesTool = tool({
  description: `Search for properties matching investor criteria.
Use this tool when the investor asks for property recommendations, wants to see properties, or asks about available listings.
Always consider the investor's profile preferences (budget, locations, property types) from the conversation context.
Return results to the user with explanations of why each property matches their criteria.`,

  parameters: z.object({
    budgetMin: z.number().optional().describe("Minimum price in USD"),
    budgetMax: z.number().optional().describe("Maximum price in USD"),
    cities: z.array(z.string()).optional().describe("Israeli cities to search in (e.g., 'Tel Aviv', 'Jerusalem', 'Haifa')"),
    propertyTypes: z.array(z.enum(["residential", "commercial", "mixed_use", "land"]))
      .optional()
      .describe("Types of properties to include"),
    minBedrooms: z.number().optional().describe("Minimum number of bedrooms"),
    maxResults: z.number().default(3).describe("Maximum properties to return (default 3, max 5)"),
  }),

  execute: async (args, options) => {
    // The options.toolCallId gives us access to abort signal if needed
    // The ctx is passed via the agent's tool execution context
    const ctx = (options as any).ctx as ActionCtx;

    const results = await ctx.runQuery(api.ai.tools.propertyQueries.searchProperties, {
      budgetMin: args.budgetMin,
      budgetMax: args.budgetMax,
      cities: args.cities,
      propertyTypes: args.propertyTypes,
      minBedrooms: args.minBedrooms,
      limit: Math.min(args.maxResults ?? 3, 5), // Cap at 5 max
    });

    return {
      properties: results,
      count: results.length,
      searchCriteria: {
        budgetMin: args.budgetMin,
        budgetMax: args.budgetMax,
        cities: args.cities,
        propertyTypes: args.propertyTypes,
        minBedrooms: args.minBedrooms,
      },
      message: results.length > 0
        ? `Found ${results.length} matching properties`
        : "No properties found matching these criteria. Try broadening your search.",
    };
  },
});
```

Important notes:
- Use Vercel AI SDK's `tool()` helper (already installed)
- The tool's `execute` receives options that include ctx from agent
- Return searchCriteria so the UI can compute match badges
- Cap maxResults at 5 to avoid overwhelming the chat
- Detailed description helps Claude know when to use this tool
  </action>
  <verify>
Run `npx convex dev` - no TypeScript errors.
Check that `convex/ai/tools/propertySearch.ts` exports `searchPropertiesTool`.
  </verify>
  <done>
searchPropertiesTool exists with Zod schema, calls propertyQueries.searchProperties, returns properties with searchCriteria.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register tool with agent and update instructions with explicit examples</name>
  <files>convex/ai/agent.ts</files>
  <action>
Update `convex/ai/agent.ts` to:

1. Import the search tool:
   ```typescript
   import { searchPropertiesTool } from "./tools/propertySearch";
   ```

2. Add the tool to the agent's tools object:
   ```typescript
   tools: {
     searchProperties: searchPropertiesTool,
   },
   ```

3. Update the agent instructions to include property recommendation guidance with EXPLICIT EXAMPLES for match explanations.
   - Add after the existing "Your role:" section:
   ```
   When recommending properties:
   - Use the searchProperties tool to find real properties from the database
   - NEVER invent or hallucinate properties - only mention properties returned by the tool
   - Consider the investor's profile (budget range, target locations, property type preferences) when searching
   - Recommend 3 properties by default unless the user asks for more or fewer
   - For EACH property, explain 2-3 specific reasons why it matches the investor's criteria

   Example match explanations (use this style):
   "This property fits your criteria because:
   1. At $320,000, it's well within your $400,000 budget
   2. Located in Tel Aviv, one of your preferred cities
   3. The 3-bedroom layout matches your minimum requirement"

   "I recommend this property because:
   1. The price of $275,000 leaves room in your budget for renovations
   2. Haifa offers strong rental yields in this price range
   3. As a residential property, it aligns with your investment goals"

   - If no properties match, suggest broadening criteria and explain what's available
   ```

4. Update the "Current capabilities:" section to include:
   ```
   - Searching and recommending properties based on investor criteria
   - Explaining why properties match the investor's profile
   ```

Keep all existing instructions intact. Just add the property-specific guidance.
  </action>
  <verify>
Run `npx convex dev` - no TypeScript errors.
Verify the import path resolves correctly.
Check agent.ts includes `searchProperties` in tools object.
Check agent instructions include example match explanations.
  </verify>
  <done>
Agent has searchProperties tool registered, instructions include property recommendation guidance with explicit example explanations, never-hallucinate rule explicit.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx convex dev` runs without errors
2. `convex/ai/tools/` directory exists with propertyQueries.ts and propertySearch.ts
3. Agent tools object is no longer empty `{}`
4. Agent instructions mention searchProperties and anti-hallucination rule
5. Agent instructions include explicit example match explanations (2-3 reasons per property)
</verification>

<success_criteria>
- Property search query accepts budget, location, type, bedrooms filters
- Tool definition uses Zod schema with proper descriptions
- Tool returns properties with searchCriteria for UI matching
- Agent registered with tool and updated instructions
- Agent instructions include explicit examples for "2-3 reasons why it matches" (REC-02)
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/42-property-recommendations/42-01-SUMMARY.md`
</output>
