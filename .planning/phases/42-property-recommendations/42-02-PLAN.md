---
phase: 42-property-recommendations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/sonner.tsx
  - src/app/layout.tsx
  - src/components/ai/PropertyRecommendationCard.tsx
  - src/components/ai/PropertyDetailModal.tsx
  - src/components/ai/SaveAllButton.tsx
  - src/components/ai/hooks/usePropertySave.ts
autonomous: true

must_haves:
  truths:
    - "Property cards display photo, price, location, bedrooms, sqm compactly"
    - "Match badges show Budget, Location, Property Type criteria"
    - "Tapping card opens modal with full property details"
    - "Save All button saves multiple properties with toast feedback"
  artifacts:
    - path: "src/components/ui/sonner.tsx"
      provides: "Toast notification component"
      exports: ["Toaster"]
    - path: "src/components/ai/PropertyRecommendationCard.tsx"
      provides: "Compact property card for chat"
      exports: ["PropertyRecommendationCard"]
    - path: "src/components/ai/PropertyDetailModal.tsx"
      provides: "Full property detail overlay"
      exports: ["PropertyDetailModal"]
    - path: "src/components/ai/SaveAllButton.tsx"
      provides: "Batch save with toast"
      exports: ["SaveAllButton"]
    - path: "src/components/ai/hooks/usePropertySave.ts"
      provides: "Save favorite mutation hook"
      exports: ["usePropertySave"]
  key_links:
    - from: "src/components/ai/PropertyRecommendationCard.tsx"
      to: "src/components/ai/PropertyDetailModal.tsx"
      via: "onClick opens modal"
      pattern: "setModalOpen\\(true\\)"
    - from: "src/components/ai/SaveAllButton.tsx"
      to: "convex/favorites.ts"
      via: "useMutation toggle"
      pattern: "api\\.favorites\\.toggle"
    - from: "src/app/layout.tsx"
      to: "src/components/ui/sonner.tsx"
      via: "Toaster component"
      pattern: "<Toaster"
---

<objective>
Create the property recommendation UI components: compact property cards for chat, detail modal, and batch save functionality.

Purpose: Enable property recommendations to appear as rich, interactive cards within the AI chat interface.
Output: PropertyRecommendationCard, PropertyDetailModal, SaveAllButton, usePropertySave hook, Sonner toast setup
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-property-recommendations/42-CONTEXT.md
@.planning/phases/42-property-recommendations/42-RESEARCH.md
@.planning/phases/41-conversational-ai-core/41-03-SUMMARY.md
@src/components/ui/card.tsx
@src/components/ui/badge.tsx
@src/components/ui/button.tsx
@src/components/ui/dialog.tsx
@convex/favorites.ts
@convex/properties.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sonner and add to layout</name>
  <files>src/components/ui/sonner.tsx, src/app/layout.tsx</files>
  <action>
1. Install Sonner via shadcn:
   ```bash
   npx shadcn@latest add sonner
   ```
   This creates `src/components/ui/sonner.tsx`

2. Add the Toaster component to the root layout.

Open `src/app/layout.tsx` and:
- Import: `import { Toaster } from "@/components/ui/sonner";`
- Add `<Toaster />` as a sibling to children, before the closing body tag:
  ```tsx
  <body>
    <ConvexClerkProvider>
      {children}
    </ConvexClerkProvider>
    <Toaster />
  </body>
  ```

The Toaster should be outside ConvexClerkProvider so it's always available.
Position it after children so toasts appear on top of other content.
  </action>
  <verify>
Run the app with `npm run dev`.
Check that `src/components/ui/sonner.tsx` exists.
No console errors about missing Toaster.
  </verify>
  <done>
Sonner installed, Toaster component in root layout, ready for toast() calls throughout app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PropertyRecommendationCard component</name>
  <files>src/components/ai/PropertyRecommendationCard.tsx</files>
  <action>
Create `src/components/ai/PropertyRecommendationCard.tsx`:

```typescript
"use client";

import { useState } from "react";
import { Card } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";
import { PropertyDetailModal } from "./PropertyDetailModal";
import { usePropertySave } from "./hooks/usePropertySave";
import { Id } from "../../../convex/_generated/dataModel";

// Property data as returned by searchProperties tool
interface PropertyData {
  _id: string;
  title: string;
  city: string;
  address: string;
  priceUsd: number;
  bedrooms?: number;
  bathrooms?: number;
  squareMeters?: number;
  propertyType: string;
  featuredImage?: string;
  expectedRoi?: number;
  capRate?: number;
}

// Search criteria for computing match badges
interface SearchCriteria {
  budgetMin?: number;
  budgetMax?: number;
  cities?: string[];
  propertyTypes?: string[];
  minBedrooms?: number;
}

interface PropertyRecommendationCardProps {
  property: PropertyData;
  searchCriteria?: SearchCriteria;
}

export function PropertyRecommendationCard({
  property,
  searchCriteria,
}: PropertyRecommendationCardProps) {
  const [modalOpen, setModalOpen] = useState(false);
  const { isSaved, toggleSave, isLoading } = usePropertySave(
    property._id as Id<"properties">
  );

  // Compute match badges based on search criteria
  const badges: { label: string; variant: "default" | "secondary" | "outline" }[] = [];

  if (searchCriteria) {
    // Budget match
    if (searchCriteria.budgetMax && property.priceUsd <= searchCriteria.budgetMax) {
      badges.push({
        label: `Under $${(searchCriteria.budgetMax / 1000).toFixed(0)}K`,
        variant: "default",
      });
    }

    // Location match
    if (searchCriteria.cities?.includes(property.city)) {
      badges.push({ label: property.city, variant: "secondary" });
    }

    // Property type match
    if (searchCriteria.propertyTypes?.includes(property.propertyType)) {
      const typeLabel = property.propertyType
        .split("_")
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(" ");
      badges.push({ label: typeLabel, variant: "outline" });
    }
  }

  // Fallback badges if no criteria
  if (badges.length === 0) {
    badges.push({ label: property.city, variant: "secondary" });
    if (property.propertyType) {
      const typeLabel = property.propertyType
        .split("_")
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(" ");
      badges.push({ label: typeLabel, variant: "outline" });
    }
  }

  return (
    <>
      <Card
        className="overflow-hidden cursor-pointer hover:shadow-md transition-shadow"
        onClick={() => setModalOpen(true)}
      >
        <div className="flex gap-3 p-3">
          {/* Image thumbnail */}
          <div className="w-20 h-20 rounded bg-muted flex-shrink-0 overflow-hidden">
            {property.featuredImage ? (
              <img
                src={property.featuredImage}
                alt={property.title}
                className="w-full h-full object-cover"
              />
            ) : (
              <div className="w-full h-full flex items-center justify-center text-muted-foreground text-xs">
                No image
              </div>
            )}
          </div>

          {/* Property info */}
          <div className="flex-1 min-w-0">
            <h4 className="font-semibold text-sm truncate">{property.title}</h4>
            <p className="text-xs text-muted-foreground truncate">{property.address}</p>
            <p className="font-bold text-base mt-1">
              ${property.priceUsd.toLocaleString()}
            </p>
            <div className="flex gap-2 mt-1 text-xs text-muted-foreground">
              {property.bedrooms !== undefined && (
                <span>{property.bedrooms} bed</span>
              )}
              {property.bathrooms !== undefined && (
                <span>{property.bathrooms} bath</span>
              )}
              {property.squareMeters !== undefined && (
                <span>{property.squareMeters} sqm</span>
              )}
            </div>
          </div>

          {/* Save button */}
          <Button
            variant="ghost"
            size="icon"
            className={cn(
              "h-8 w-8 flex-shrink-0",
              isSaved && "text-red-500"
            )}
            disabled={isLoading}
            onClick={(e) => {
              e.stopPropagation();
              toggleSave();
            }}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill={isSaved ? "currentColor" : "none"}
              stroke="currentColor"
              strokeWidth={2}
              className="w-4 h-4"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"
              />
            </svg>
          </Button>
        </div>

        {/* Match badges */}
        {badges.length > 0 && (
          <div className="flex flex-wrap gap-1 px-3 pb-3">
            {badges.map((badge, i) => (
              <Badge key={i} variant={badge.variant} className="text-xs">
                {badge.label}
              </Badge>
            ))}
          </div>
        )}
      </Card>

      <PropertyDetailModal
        propertyId={property._id as Id<"properties">}
        open={modalOpen}
        onOpenChange={setModalOpen}
      />
    </>
  );
}
```

Key features:
- Compact layout optimized for chat context (20x20 thumbnail, essential info)
- Match badges computed from searchCriteria
- Heart icon for individual save (red when saved)
- Click opens PropertyDetailModal
- Graceful fallbacks for missing data
  </action>
  <verify>
Run `npx tsc --noEmit` - no TypeScript errors.
Check component exports properly.
  </verify>
  <done>
PropertyRecommendationCard renders compact property info with match badges, save button, and opens modal on click.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PropertyDetailModal, SaveAllButton, and usePropertySave hook</name>
  <files>src/components/ai/PropertyDetailModal.tsx, src/components/ai/SaveAllButton.tsx, src/components/ai/hooks/usePropertySave.ts</files>
  <action>
Create three files:

**1. `src/components/ai/hooks/usePropertySave.ts`:**
```typescript
"use client";

import { useQuery, useMutation } from "convex/react";
import { api } from "../../../../convex/_generated/api";
import { Id } from "../../../../convex/_generated/dataModel";
import { useState, useCallback } from "react";

export function usePropertySave(propertyId: Id<"properties">) {
  const [isLoading, setIsLoading] = useState(false);
  const isSavedQuery = useQuery(api.favorites.isSaved, { propertyId });
  const toggleMutation = useMutation(api.favorites.toggle);

  const toggleSave = useCallback(async () => {
    setIsLoading(true);
    try {
      await toggleMutation({ propertyId });
    } catch (error) {
      console.error("Failed to toggle save:", error);
    } finally {
      setIsLoading(false);
    }
  }, [toggleMutation, propertyId]);

  return {
    isSaved: isSavedQuery ?? false,
    isLoading: isSavedQuery === undefined || isLoading,
    toggleSave,
  };
}
```

**2. `src/components/ai/SaveAllButton.tsx`:**
```typescript
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { useMutation } from "convex/react";
import { api } from "../../../convex/_generated/api";
import { Id } from "../../../convex/_generated/dataModel";

interface SaveAllButtonProps {
  propertyIds: string[];
}

export function SaveAllButton({ propertyIds }: SaveAllButtonProps) {
  const [saved, setSaved] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const toggleFavorite = useMutation(api.favorites.toggle);

  const handleSaveAll = async () => {
    if (isSaving || saved) return;
    setIsSaving(true);

    try {
      // Save all properties (toggle handles duplicates gracefully)
      await Promise.all(
        propertyIds.map((id) =>
          toggleFavorite({ propertyId: id as Id<"properties"> }).catch(() => {
            // Silently ignore errors (might already be saved)
          })
        )
      );

      setSaved(true);
      toast.success(`${propertyIds.length} properties saved`, {
        description: "View your saved properties in Favorites",
      });
    } catch (error) {
      toast.error("Failed to save properties");
    } finally {
      setIsSaving(false);
    }
  };

  if (saved) {
    return (
      <Button variant="outline" disabled className="w-full">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          className="w-4 h-4 me-2 text-green-500"
        >
          <path
            fillRule="evenodd"
            d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z"
            clipRule="evenodd"
          />
        </svg>
        Saved
      </Button>
    );
  }

  return (
    <Button
      variant="default"
      onClick={handleSaveAll}
      disabled={isSaving}
      className="w-full"
    >
      {isSaving ? "Saving..." : `Save All ${propertyIds.length} Properties`}
    </Button>
  );
}
```

**3. `src/components/ai/PropertyDetailModal.tsx`:**
```typescript
"use client";

import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { useQuery } from "convex/react";
import { api } from "../../../convex/_generated/api";
import { Id } from "../../../convex/_generated/dataModel";
import { usePropertySave } from "./hooks/usePropertySave";
import Link from "next/link";

interface PropertyDetailModalProps {
  propertyId: Id<"properties">;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function PropertyDetailModal({
  propertyId,
  open,
  onOpenChange,
}: PropertyDetailModalProps) {
  const property = useQuery(
    api.properties.getById,
    open ? { id: propertyId } : "skip"
  );
  const { isSaved, toggleSave, isLoading } = usePropertySave(propertyId);

  if (!open) return null;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl max-h-[85vh] overflow-hidden flex flex-col">
        <DialogHeader>
          <DialogTitle className="pe-8">
            {property?.title || "Loading..."}
          </DialogTitle>
        </DialogHeader>

        {property ? (
          <div className="overflow-y-auto flex-1 space-y-4">
            {/* Featured image */}
            {property.featuredImage && (
              <div className="w-full aspect-video rounded-lg overflow-hidden bg-muted">
                <img
                  src={property.featuredImage}
                  alt={property.title}
                  className="w-full h-full object-cover"
                />
              </div>
            )}

            {/* Price and type */}
            <div className="flex items-center justify-between">
              <div>
                <p className="text-2xl font-bold">
                  ${property.priceUsd.toLocaleString()}
                </p>
                <p className="text-sm text-muted-foreground">
                  {property.address}, {property.city}
                </p>
              </div>
              <Badge variant="outline" className="text-sm">
                {property.propertyType
                  .split("_")
                  .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
                  .join(" ")}
              </Badge>
            </div>

            {/* Quick facts */}
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
              {property.bedrooms !== undefined && (
                <div className="text-center p-3 bg-muted rounded-lg">
                  <p className="text-lg font-semibold">{property.bedrooms}</p>
                  <p className="text-xs text-muted-foreground">Bedrooms</p>
                </div>
              )}
              {property.bathrooms !== undefined && (
                <div className="text-center p-3 bg-muted rounded-lg">
                  <p className="text-lg font-semibold">{property.bathrooms}</p>
                  <p className="text-xs text-muted-foreground">Bathrooms</p>
                </div>
              )}
              {property.squareMeters !== undefined && (
                <div className="text-center p-3 bg-muted rounded-lg">
                  <p className="text-lg font-semibold">{property.squareMeters}</p>
                  <p className="text-xs text-muted-foreground">sqm</p>
                </div>
              )}
              {property.yearBuilt !== undefined && (
                <div className="text-center p-3 bg-muted rounded-lg">
                  <p className="text-lg font-semibold">{property.yearBuilt}</p>
                  <p className="text-xs text-muted-foreground">Year Built</p>
                </div>
              )}
            </div>

            {/* Investment metrics */}
            {(property.expectedRoi || property.capRate || property.monthlyRent) && (
              <div>
                <h3 className="font-semibold mb-2">Investment Metrics</h3>
                <div className="grid grid-cols-3 gap-4">
                  {property.expectedRoi !== undefined && (
                    <div className="text-center p-3 bg-green-50 dark:bg-green-950 rounded-lg">
                      <p className="text-lg font-semibold text-green-600 dark:text-green-400">
                        {property.expectedRoi}%
                      </p>
                      <p className="text-xs text-muted-foreground">Expected ROI</p>
                    </div>
                  )}
                  {property.capRate !== undefined && (
                    <div className="text-center p-3 bg-blue-50 dark:bg-blue-950 rounded-lg">
                      <p className="text-lg font-semibold text-blue-600 dark:text-blue-400">
                        {property.capRate}%
                      </p>
                      <p className="text-xs text-muted-foreground">Cap Rate</p>
                    </div>
                  )}
                  {property.monthlyRent !== undefined && (
                    <div className="text-center p-3 bg-purple-50 dark:bg-purple-950 rounded-lg">
                      <p className="text-lg font-semibold text-purple-600 dark:text-purple-400">
                        ${property.monthlyRent.toLocaleString()}
                      </p>
                      <p className="text-xs text-muted-foreground">Monthly Rent</p>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Description */}
            {property.description && (
              <div>
                <h3 className="font-semibold mb-2">Description</h3>
                <p className="text-sm text-muted-foreground whitespace-pre-wrap">
                  {property.description}
                </p>
              </div>
            )}
          </div>
        ) : (
          <div className="flex-1 flex items-center justify-center">
            <p className="text-muted-foreground">Loading property details...</p>
          </div>
        )}

        {/* Footer actions */}
        <div className="flex gap-2 pt-4 border-t mt-4">
          <Button
            variant="outline"
            className="flex-1"
            onClick={toggleSave}
            disabled={isLoading}
          >
            {isSaved ? "Saved" : "Save Property"}
          </Button>
          <Button asChild className="flex-1">
            <Link href={`/properties/${propertyId}`} onClick={() => onOpenChange(false)}>
              View Full Details
            </Link>
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

Key features:
- Modal uses `"skip"` pattern for conditional query (only loads when open)
- Full property details with investment metrics
- Save button in footer
- Link to full property page
- Scrollable content area
- Loading state handling
  </action>
  <verify>
Run `npx tsc --noEmit` - no TypeScript errors.
Check all three files export properly.
  </verify>
  <done>
PropertyDetailModal shows full property details, SaveAllButton saves all with toast, usePropertySave hook wraps favorite toggle.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run dev` starts without errors
2. Sonner Toaster in root layout
3. PropertyRecommendationCard, PropertyDetailModal, SaveAllButton all export from respective files
4. usePropertySave hook works with favorites.toggle mutation
5. No TypeScript errors
</verification>

<success_criteria>
- Sonner installed and Toaster in root layout
- PropertyRecommendationCard compact with image, price, beds, sqm, match badges
- PropertyDetailModal shows full details in dialog overlay
- SaveAllButton batch saves with toast notification
- usePropertySave hook provides isSaved, toggleSave, isLoading
</success_criteria>

<output>
After completion, create `.planning/phases/42-property-recommendations/42-02-SUMMARY.md`
</output>
