---
phase: 42-property-recommendations
plan: 03
type: execute
wave: 2
depends_on: [42-01, 42-02]
files_modified:
  - src/components/ai/ChatMessage.tsx
  - src/components/ai/hooks/useAIChat.ts
  - src/components/ai/index.ts
autonomous: false

must_haves:
  truths:
    - "Property cards appear inline in AI messages after tool execution"
    - "Save All button appears after property cards when 2+ properties shown"
    - "User can ask follow-up questions about recommended properties"
    - "AI never mentions properties that don't exist in database"
  artifacts:
    - path: "src/components/ai/ChatMessage.tsx"
      provides: "Message rendering with property cards"
      contains: "PropertyRecommendationCard"
    - path: "src/components/ai/hooks/useAIChat.ts"
      provides: "Hook returning tool results"
      contains: "toolResults"
    - path: "src/components/ai/index.ts"
      provides: "Updated exports including property components"
      exports: ["PropertyRecommendationCard", "PropertyDetailModal", "SaveAllButton"]
  key_links:
    - from: "src/components/ai/ChatMessage.tsx"
      to: "src/components/ai/PropertyRecommendationCard.tsx"
      via: "Renders cards from toolResults"
      pattern: "PropertyRecommendationCard"
    - from: "src/components/ai/ChatMessage.tsx"
      to: "src/components/ai/SaveAllButton.tsx"
      via: "Renders after property cards"
      pattern: "SaveAllButton"
---

<objective>
Wire property recommendation UI into the existing chat interface so property cards appear inline in AI messages.

Purpose: Complete the property recommendations feature by integrating tool results rendering into the chat flow.
Output: ChatMessage extended with property cards, useAIChat extended with tool results, human verification
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-property-recommendations/42-CONTEXT.md
@.planning/phases/42-property-recommendations/42-RESEARCH.md
@.planning/phases/42-property-recommendations/42-01-SUMMARY.md
@.planning/phases/42-property-recommendations/42-02-SUMMARY.md
@src/components/ai/ChatMessage.tsx
@src/components/ai/hooks/useAIChat.ts
@convex/ai/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useAIChat to include tool results</name>
  <files>src/components/ai/hooks/useAIChat.ts, convex/ai/messages.ts</files>
  <action>
First, check if the `listMessages` action in `convex/ai/messages.ts` returns tool call data. The @convex-dev/agent stores tool calls in message metadata. We need to ensure tool results are returned.

**If `convex/ai/messages.ts` doesn't include tool data:**
Update the `listMessages` action to return tool call information. The agent stores this in the message's internal format. Check the message structure and include any `toolCalls` or `toolInvocations` fields.

**Update `src/components/ai/hooks/useAIChat.ts`:**

1. Extend the Message interface to include tool results:
```typescript
interface ToolResult {
  toolName: string;
  result: any;
}

interface Message {
  _id: string;
  role: "user" | "assistant";
  content: string;
  _creationTime: number;
  toolResults?: ToolResult[];
}
```

2. The hook should already return messages with this structure if the backend returns it. No other changes needed to the hook itself.

The key is ensuring the backend `listMessages` action includes tool result data in the returned messages.

**Check `convex/ai/messages.ts`:**
- Look at how messages are fetched from the agent
- The `@convex-dev/agent` package stores tool calls in message format
- Include tool data in the returned message objects:

```typescript
// If the agent message has tool invocations, include them
const mappedMessages = messages.map(msg => ({
  _id: msg._id,
  role: msg.role,
  content: msg.content,
  _creationTime: msg._creationTime,
  // Include tool results if present
  toolResults: msg.toolInvocations?.filter(t => t.state === 'result').map(t => ({
    toolName: t.toolName,
    result: t.result,
  })) || [],
}));
```

Note: The exact field names depend on how @convex-dev/agent stores tool data. Inspect the actual message structure from the agent and adapt accordingly. The AI SDK uses `toolInvocations` array with `toolName`, `args`, `state`, and `result` fields.
  </action>
  <verify>
Run `npx convex dev` - no TypeScript errors.
Test by sending a message asking for property recommendations and check the console for tool results in messages.
  </verify>
  <done>
useAIChat returns messages with toolResults array containing tool execution results.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend ChatMessage to render property cards</name>
  <files>src/components/ai/ChatMessage.tsx</files>
  <action>
Update `src/components/ai/ChatMessage.tsx` to render property recommendation cards inline after the message text.

1. Add imports at the top:
```typescript
import { PropertyRecommendationCard } from "./PropertyRecommendationCard";
import { SaveAllButton } from "./SaveAllButton";
```

2. Extend the ChatMessageProps interface:
```typescript
interface ToolResult {
  toolName: string;
  result: any;
}

interface ChatMessageProps {
  role: "user" | "assistant";
  content: string;
  timestamp: number;
  isStreaming?: boolean;
  userImage?: string;
  userName?: string;
  toolResults?: ToolResult[];  // Add this
}
```

3. Inside the component, extract property results:
```typescript
// Extract property search results from tool calls
const propertyToolResult = toolResults?.find(
  (t) => t.toolName === "searchProperties"
);
const properties = propertyToolResult?.result?.properties || [];
const searchCriteria = propertyToolResult?.result?.searchCriteria;
```

4. After the ReactMarkdown block (inside the AI message bubble, after `{isStreaming && <StreamingCursor />}`), add:
```tsx
{/* Property recommendation cards */}
{!isStreaming && properties.length > 0 && (
  <div className="mt-4 space-y-3">
    {properties.map((property: any) => (
      <PropertyRecommendationCard
        key={property._id}
        property={property}
        searchCriteria={searchCriteria}
      />
    ))}
    {properties.length > 1 && (
      <SaveAllButton
        propertyIds={properties.map((p: any) => p._id)}
      />
    )}
  </div>
)}
```

Key points:
- Only render property cards for AI messages (not user messages)
- Don't render during streaming (wait for completion)
- Show SaveAllButton only when 2+ properties
- Pass searchCriteria for match badge computation
  </action>
  <verify>
Run `npx tsc --noEmit` - no TypeScript errors.
Check ChatMessage.tsx imports and renders PropertyRecommendationCard and SaveAllButton.
  </verify>
  <done>
ChatMessage renders property cards inline after AI text when toolResults contain searchProperties results.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update barrel exports and ChatMessageList</name>
  <files>src/components/ai/index.ts, src/components/ai/ChatMessageList.tsx</files>
  <action>
**1. Update `src/components/ai/index.ts` to export new components:**

Add these exports:
```typescript
// Property Recommendation Components
export { PropertyRecommendationCard } from "./PropertyRecommendationCard";
export { PropertyDetailModal } from "./PropertyDetailModal";
export { SaveAllButton } from "./SaveAllButton";

// Hooks
export { usePropertySave } from "./hooks/usePropertySave";
```

**2. Update `src/components/ai/ChatMessageList.tsx` to pass toolResults:**

Find where ChatMessage is rendered and ensure toolResults is passed through.

Check how messages are passed to ChatMessage. If the message object now includes toolResults, ensure it's passed:

```tsx
<ChatMessage
  key={message._id}
  role={message.role}
  content={message.content}
  timestamp={message._creationTime}
  isStreaming={isStreaming && index === messages.length - 1 && message.role === "assistant"}
  userImage={userImage}
  userName={userName}
  toolResults={message.toolResults}  // Add this
/>
```

Note: The exact prop passing depends on how ChatMessageList currently maps messages. Read the file first and adapt accordingly.
  </action>
  <verify>
Run `npx tsc --noEmit` - no TypeScript errors.
Verify exports in index.ts.
Verify ChatMessageList passes toolResults to ChatMessage.
  </verify>
  <done>
Barrel exports include all property recommendation components, ChatMessageList passes toolResults to ChatMessage.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete property recommendations feature:
- AI can search properties based on investor criteria
- Property cards appear inline in chat messages
- Each card shows photo, price, location, beds, sqm with match badges
- Clicking a card opens detail modal
- Save All button saves all recommended properties
- Toast notifications confirm saves
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Log in as an investor user
3. Open the AI chat panel
4. Send a message: "Show me properties in Tel Aviv under $500,000"
5. Verify:
   - AI shows "searching" or similar while tool executes
   - Property cards appear inline in the AI response
   - Cards show: thumbnail, title, price, beds/baths/sqm, match badges
   - Match badges reflect search criteria (e.g., "Tel Aviv", "Under $500K")
6. Click a property card:
   - Modal opens with full property details
   - Image, price, metrics, description visible
   - Save button and "View Full Details" link work
7. Close modal, click "Save All X Properties" button:
   - Toast shows "X properties saved"
   - Button changes to "Saved âœ“"
8. Send follow-up: "Tell me more about the first one"
   - AI should reference the property from context
9. Try: "What properties do you have in Jerusalem?"
   - Different results based on new criteria

If any issues found, describe what's broken.
  </how-to-verify>
  <resume-signal>Type "approved" to complete the phase, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run dev` runs without errors
2. Property cards appear in AI messages after tool execution
3. Cards are interactive (click -> modal, save -> toast)
4. Save All button appears for 2+ properties
5. Follow-up questions work with property context
6. All components exported from barrel file
</verification>

<success_criteria>
- AI recommends 3 properties based on investor criteria (REC-01)
- Each recommendation shows match factors via badges (REC-02, REC-03)
- "Quick save all" saves all properties with toast (REC-04)
- Property cards link to detail modal (REC-05)
- Tool execution indicated in AI flow (REC-06)
- All properties exist in database - no hallucinations (REC-07)
- AI answers questions about properties (CHAT-07)
</success_criteria>

<output>
After completion, create `.planning/phases/42-property-recommendations/42-03-SUMMARY.md`
</output>
