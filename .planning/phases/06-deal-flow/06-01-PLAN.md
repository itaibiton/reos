---
phase: 06-deal-flow
plan: 01
type: execute
---

<objective>
Create deals table schema and basic CRUD operations for tracking investor-property deals through stages.

Purpose: Establish the core data model for deal flow - connecting investors to properties and tracking progress through defined stages.
Output: Deals schema with stages, mutations for creating/updating deals, queries for listing deals.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior context:
@convex/schema.ts
@convex/properties.ts
@convex/users.ts

**Tech stack available:** Convex, Next.js, Shadcn/ui
**Established patterns:**
- Convex schema with defineTable, indexes
- User roles: investor, broker, mortgage_advisor, lawyer, admin
- Property references via v.id("properties")
- Timestamps: createdAt, updatedAt as v.number()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deals table to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add a new `deals` table with the following structure:

```typescript
// Deal stages - investor progresses through these
const dealStage = v.union(
  v.literal("interest"),        // Investor expressed interest
  v.literal("broker_assigned"), // Broker is working with investor
  v.literal("mortgage"),        // With mortgage advisor
  v.literal("legal"),           // With lawyer
  v.literal("closing"),         // In final closing process
  v.literal("completed"),       // Deal closed
  v.literal("cancelled")        // Deal cancelled at any stage
);

deals: defineTable({
  // Core references
  propertyId: v.id("properties"),
  investorId: v.id("users"),

  // Current stage
  stage: dealStage,

  // Service provider assignments (added as deal progresses)
  brokerId: v.optional(v.id("users")),
  mortgageAdvisorId: v.optional(v.id("users")),
  lawyerId: v.optional(v.id("users")),

  // Deal info
  offerPrice: v.optional(v.number()), // USD
  notes: v.optional(v.string()),

  // Stage history tracking
  stageHistory: v.array(v.object({
    stage: dealStage,
    timestamp: v.number(),
    notes: v.optional(v.string()),
  })),

  // Timestamps
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_investor", ["investorId"])
  .index("by_property", ["propertyId"])
  .index("by_stage", ["stage"])
  .index("by_broker", ["brokerId"])
  .index("by_mortgage_advisor", ["mortgageAdvisorId"])
  .index("by_lawyer", ["lawyerId"])
```

Export `dealStage` type for reuse.
  </action>
  <verify>npx convex dev runs without schema errors</verify>
  <done>deals table defined with all fields and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create deals.ts with basic queries and mutations</name>
  <files>convex/deals.ts</files>
  <action>
Create convex/deals.ts with:

**Queries:**

1. `list` - Get deals for the authenticated user (based on their role):
   - If investor: deals where investorId matches
   - If broker: deals where brokerId matches
   - If mortgage_advisor: deals where mortgageAdvisorId matches
   - If lawyer: deals where lawyerId matches
   - If admin: all deals (optional limit)

2. `get` - Get a single deal by ID (with access check - user must be participant or admin)

3. `getByProperty` - Get all deals for a property (for property detail page)

**Mutations:**

1. `create` - Create a new deal:
   - Args: propertyId, notes (optional)
   - Sets investorId from auth, stage to "interest"
   - Initializes stageHistory with first entry
   - Only investors can create deals

2. `updateStage` - Update deal stage:
   - Args: dealId, newStage, notes (optional)
   - Validates stage transition is valid
   - Adds entry to stageHistory
   - Updates updatedAt

3. `cancel` - Cancel a deal:
   - Sets stage to "cancelled"
   - Adds to stageHistory with reason

Use `ctx.auth.getUserIdentity()` for auth. Query users table to get role.
Validate access before any operation.
  </action>
  <verify>`npx convex dev` shows no errors, API endpoints generated</verify>
  <done>deals.ts exports list, get, getByProperty queries and create, updateStage, cancel mutations</done>
</task>

<task type="auto">
  <name>Task 3: Add seed data for sample deals</name>
  <files>convex/seedData.ts, convex/seed.ts</files>
  <action>
Add sample deals to seed data for testing:

1. In seedData.ts, add a `sampleDeals` array with 3-5 deals:
   - Vary stages (interest, broker_assigned, mortgage, completed)
   - Use different properties from existing seed data
   - Reference placeholder user IDs (will be replaced at seed time)

2. In seed.ts, modify the seed function to:
   - Skip deal seeding if no admin user exists yet
   - Create deals using the first admin user as the investor (for testing)
   - Or add a comment explaining deals require real users

Note: Since deals require real user IDs, the seed might just set up the structure. Document this limitation.
  </action>
  <verify>`npx convex run seed:seed` runs without error (may skip deals if no users)</verify>
  <done>Seed data structure for deals prepared, documented any limitations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev` runs without schema errors
- [ ] deals table created with proper indexes
- [ ] All queries and mutations export correctly
- [ ] `npm run build` passes
</verification>

<success_criteria>
- deals schema with 7 stages and proper relationships
- Basic CRUD operations functional
- Access control based on user role
- Stage history tracking implemented
</success_criteria>

<output>
After completion, create `.planning/phases/06-deal-flow/06-01-SUMMARY.md` with:

# Phase 6 Plan 01: Deals Schema & CRUD Summary

**[One-liner describing what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [File list]

## Decisions Made
- [Key decisions]

## Issues Encountered
- [Problems and resolutions]

## Next Step
Ready for 06-02-PLAN.md (Service provider request flow)
</output>
