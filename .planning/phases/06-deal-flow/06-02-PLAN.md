---
phase: 06-deal-flow
plan: 02
type: execute
---

<objective>
Implement service provider request flow - investors request providers, providers see potential clients.

Purpose: Enable the connection between investors and service providers through a request/accept workflow.
Output: Service requests table, request mutations, provider leads list functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/06-deal-flow/06-01-SUMMARY.md

# Key source files:
@convex/schema.ts
@convex/deals.ts
@convex/users.ts
@convex/serviceProviderProfiles.ts

**Tech stack available:** Convex, Next.js, Shadcn/ui
**Established patterns:**
- deals table with stage history
- Service provider profiles with providerType, serviceAreas
- Access control via getUserIdentity + users table lookup
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add serviceRequests table to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add a new `serviceRequests` table for tracking provider requests:

```typescript
// Request status
const requestStatus = v.union(
  v.literal("pending"),   // Request sent, awaiting provider response
  v.literal("accepted"),  // Provider accepted
  v.literal("declined"),  // Provider declined
  v.literal("cancelled")  // Investor cancelled request
);

serviceRequests: defineTable({
  // References
  dealId: v.id("deals"),
  investorId: v.id("users"),
  providerId: v.id("users"),

  // What type of provider (broker, mortgage_advisor, lawyer)
  providerType: providerType,

  // Status
  status: requestStatus,

  // Messages
  investorMessage: v.optional(v.string()), // Initial request message
  providerResponse: v.optional(v.string()), // Response when accept/decline

  // Timestamps
  createdAt: v.number(),
  respondedAt: v.optional(v.number()),
})
  .index("by_deal", ["dealId"])
  .index("by_investor", ["investorId"])
  .index("by_provider", ["providerId"])
  .index("by_provider_and_status", ["providerId", "status"])
```
  </action>
  <verify>npx convex dev runs without schema errors</verify>
  <done>serviceRequests table defined with proper indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create serviceRequests.ts with request workflow</name>
  <files>convex/serviceRequests.ts</files>
  <action>
Create convex/serviceRequests.ts with:

**Queries:**

1. `listForProvider` - Get requests for a provider:
   - Args: status (optional filter)
   - Returns requests where providerId matches auth user
   - Include deal and investor info via joins

2. `listForDeal` - Get all requests for a deal:
   - Args: dealId
   - Access check: user is deal participant
   - Returns all requests with provider info

3. `getRecommendedProviders` - Get providers matching deal criteria:
   - Args: dealId, providerType
   - Match property city to provider serviceAreas
   - Exclude providers already requested for this deal
   - Return provider profiles sorted by relevance

**Mutations:**

1. `create` - Request a service provider:
   - Args: dealId, providerId, message (optional)
   - Validate: requester is deal investor
   - Validate: provider has matching role
   - Check: no existing pending request for same provider/deal
   - Create request with "pending" status

2. `respond` - Provider responds to request:
   - Args: requestId, accept (boolean), response (optional message)
   - Validate: responder is the providerId
   - If accepted:
     - Update request status to "accepted"
     - Update deal to assign this provider (brokerId/mortgageAdvisorId/lawyerId)
     - If broker accepted: advance deal stage to "broker_assigned"
   - If declined: update status to "declined"

3. `cancel` - Investor cancels request:
   - Args: requestId
   - Validate: canceller is the investorId
   - Only allowed if status is "pending"
  </action>
  <verify>`npx convex dev` shows no errors</verify>
  <done>Request workflow complete with create, respond, cancel mutations</done>
</task>

<task type="auto">
  <name>Task 3: Add provider search query</name>
  <files>convex/serviceProviderProfiles.ts</files>
  <action>
Add/update queries in serviceProviderProfiles.ts:

1. `listByType` - Get providers by type with optional area filter:
   - Args: providerType, city (optional)
   - If city provided: filter by serviceAreas containing city
   - Return profiles with user info (name, imageUrl)
   - Sort by yearsExperience (descending)

2. `getWithUser` - Get profile with user details:
   - Args: userId
   - Join to get user name, email, imageUrl
   - Return combined profile + user info

These queries power the "Find a Provider" UI.
  </action>
  <verify>`npx convex dev` shows no errors, queries return expected structure</verify>
  <done>Provider search queries functional</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] serviceRequests table created
- [ ] Request create/respond/cancel workflow works
- [ ] Provider assignment updates deal correctly
- [ ] `npm run build` passes
</verification>

<success_criteria>
- Investors can request service providers
- Providers can accept/decline requests
- Accepting a request assigns provider to deal
- Deal stage advances appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/06-deal-flow/06-02-SUMMARY.md` with:

# Phase 6 Plan 02: Service Provider Request Flow Summary

**[One-liner describing what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [File list]

## Decisions Made
- [Key decisions]

## Issues Encountered
- [Problems and resolutions]

## Next Step
Ready for 06-03-PLAN.md (File storage per deal)
</output>
