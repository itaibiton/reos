---
phase: 06-deal-flow
plan: 03
type: execute
---

<objective>
Implement file storage per deal using Convex file storage.

Purpose: Enable document sharing between investors and service providers on a deal (contracts, ID docs, etc.)
Output: Deal files table, file upload/download mutations, file list queries.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/06-deal-flow/06-01-SUMMARY.md
@.planning/phases/06-deal-flow/06-02-SUMMARY.md

# Key source files:
@convex/schema.ts
@convex/deals.ts

**Convex file storage:**
- Use `ctx.storage.generateUploadUrl()` for client uploads
- Store file ID as `v.id("_storage")` in database
- Use `ctx.storage.getUrl(storageId)` to get download URL
- Files are stored in Convex's managed storage

**Established patterns:**
- Access control via deal participants check
- Timestamps pattern: createdAt as v.number()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dealFiles table to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add a new `dealFiles` table:

```typescript
dealFiles: defineTable({
  // References
  dealId: v.id("deals"),
  uploadedBy: v.id("users"),

  // File info
  storageId: v.id("_storage"), // Convex file storage ID
  fileName: v.string(),        // Original filename
  fileType: v.string(),        // MIME type
  fileSize: v.number(),        // Bytes

  // Categorization
  category: v.union(
    v.literal("contract"),
    v.literal("id_document"),
    v.literal("financial"),
    v.literal("legal"),
    v.literal("other")
  ),

  // Optional description
  description: v.optional(v.string()),

  // Visibility: who can see this file
  // "all" = all deal participants, "providers" = only service providers
  visibility: v.union(
    v.literal("all"),
    v.literal("providers_only")
  ),

  // Timestamps
  createdAt: v.number(),
})
  .index("by_deal", ["dealId"])
  .index("by_uploader", ["uploadedBy"])
```
  </action>
  <verify>npx convex dev runs without schema errors</verify>
  <done>dealFiles table defined with proper indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create dealFiles.ts with storage operations</name>
  <files>convex/dealFiles.ts</files>
  <action>
Create convex/dealFiles.ts with:

**Mutations:**

1. `generateUploadUrl` - Get upload URL for client:
   - Returns: `ctx.storage.generateUploadUrl()`
   - Used by frontend before upload

2. `saveFile` - Save file metadata after upload:
   - Args: dealId, storageId, fileName, fileType, fileSize, category, description, visibility
   - Access check: user is deal participant
   - Creates dealFiles record

3. `deleteFile` - Delete a file:
   - Args: fileId
   - Access check: user is uploader OR admin
   - Deletes from storage: `ctx.storage.delete(storageId)`
   - Deletes record

**Queries:**

1. `listForDeal` - Get files for a deal:
   - Args: dealId
   - Access check: user is deal participant
   - If investor: exclude visibility="providers_only"
   - Returns files with getUrl for download

2. `getDownloadUrl` - Get download URL for a file:
   - Args: fileId
   - Access check: user can view file (participant + visibility)
   - Returns: `ctx.storage.getUrl(storageId)`

**Helper function:**
- `isDealParticipant(ctx, dealId, userId)` - checks if user is investor or assigned provider on deal
  </action>
  <verify>`npx convex dev` shows no errors</verify>
  <done>File storage operations complete</done>
</task>

<task type="auto">
  <name>Task 3: Create FileUpload component</name>
  <files>src/components/deals/FileUpload.tsx</files>
  <action>
Create a reusable file upload component for deals:

```typescript
interface FileUploadProps {
  dealId: Id<"deals">;
  onUploadComplete?: () => void;
}
```

Component features:
1. Drag-and-drop zone using Shadcn styling
2. File type validation (common document types: pdf, docx, jpg, png)
3. Max file size check (10MB)
4. Category selector (dropdown with dealFiles categories)
5. Description input (optional)
6. Visibility toggle (all participants vs providers only)
7. Upload progress indicator
8. Uses useMutation for generateUploadUrl and saveFile

Upload flow:
1. User drops/selects file
2. Call generateUploadUrl mutation
3. POST file to returned URL
4. Call saveFile mutation with storageId and metadata
5. Show success/error toast

Use Shadcn components: Card, Button, Input, Select, Label, Progress
Use Hugeicons for upload icon.
  </action>
  <verify>Component renders without errors</verify>
  <done>FileUpload component with drag-drop, validation, and upload flow</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] dealFiles table created
- [ ] Upload URL generation works
- [ ] File save/delete works with access control
- [ ] FileUpload component renders
- [ ] `npm run build` passes
</verification>

<success_criteria>
- Files can be uploaded to deals
- Access control respects deal participants
- Visibility settings work (all vs providers_only)
- Files can be downloaded and deleted
</success_criteria>

<output>
After completion, create `.planning/phases/06-deal-flow/06-03-SUMMARY.md` with:

# Phase 6 Plan 03: File Storage Per Deal Summary

**[One-liner describing what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [File list]

## Decisions Made
- [Key decisions]

## Issues Encountered
- [Problems and resolutions]

## Next Step
Ready for 06-04-PLAN.md (Deal transitions & handoffs)
</output>
