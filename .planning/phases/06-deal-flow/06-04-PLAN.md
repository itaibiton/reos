---
phase: 06-deal-flow
plan: 04
type: execute
---

<objective>
Implement deal stage transitions and provider handoffs with validation.

Purpose: Ensure deals progress through stages correctly and providers can hand off to next in chain.
Output: Stage transition validation, handoff mutations, deal activity log.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/06-deal-flow/06-01-SUMMARY.md
@.planning/phases/06-deal-flow/06-02-SUMMARY.md
@.planning/phases/06-deal-flow/06-03-SUMMARY.md

# Key source files:
@convex/schema.ts
@convex/deals.ts
@convex/serviceRequests.ts

**Deal stages flow:**
interest → broker_assigned → mortgage → legal → closing → completed
(cancelled can happen from any stage)

**Handoff pattern:**
- Broker hands off to mortgage advisor
- Mortgage advisor hands off to lawyer
- Lawyer completes deal
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deal activity log table</name>
  <files>convex/schema.ts</files>
  <action>
Add a `dealActivity` table for tracking all deal events:

```typescript
const activityType = v.union(
  v.literal("stage_change"),
  v.literal("provider_assigned"),
  v.literal("provider_removed"),
  v.literal("file_uploaded"),
  v.literal("file_deleted"),
  v.literal("note_added"),
  v.literal("handoff_initiated"),
  v.literal("handoff_completed")
);

dealActivity: defineTable({
  dealId: v.id("deals"),
  actorId: v.id("users"),      // Who performed the action
  activityType: activityType,

  // Details based on activity type
  details: v.object({
    fromStage: v.optional(v.string()),
    toStage: v.optional(v.string()),
    providerId: v.optional(v.id("users")),
    providerType: v.optional(v.string()),
    fileId: v.optional(v.id("dealFiles")),
    fileName: v.optional(v.string()),
    note: v.optional(v.string()),
  }),

  createdAt: v.number(),
})
  .index("by_deal", ["dealId"])
  .index("by_deal_and_time", ["dealId", "createdAt"])
```
  </action>
  <verify>npx convex dev runs without schema errors</verify>
  <done>dealActivity table defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement stage transition validation and handoffs</name>
  <files>convex/deals.ts</files>
  <action>
Update convex/deals.ts with:

**Add helper function for valid transitions:**

```typescript
const validTransitions: Record<string, string[]> = {
  interest: ["broker_assigned", "cancelled"],
  broker_assigned: ["mortgage", "cancelled"],
  mortgage: ["legal", "cancelled"],
  legal: ["closing", "cancelled"],
  closing: ["completed", "cancelled"],
  completed: [], // Terminal state
  cancelled: [], // Terminal state
};

function isValidTransition(from: string, to: string): boolean {
  return validTransitions[from]?.includes(to) ?? false;
}
```

**Update `updateStage` mutation:**
- Validate transition is allowed
- Check user has permission (investor, assigned provider, or admin)
- Log activity to dealActivity table
- Return error if transition invalid

**Add `handoffToNextProvider` mutation:**
- Args: dealId, nextProviderId, message (optional)
- Current provider initiates handoff to next stage
- Validates:
  - Caller is current stage's provider
  - nextProviderId has correct role for next stage
  - Transition is valid
- Creates service request for next provider
- Logs handoff_initiated activity

**Add `acceptHandoff` mutation:**
- Args: requestId
- Accept the handoff request
- Assign provider to deal
- Advance deal stage
- Log handoff_completed activity

**Add queries:**

`getActivityLog` - Get activity for a deal:
- Args: dealId, limit (optional, default 20)
- Access check: user is participant
- Returns activities with actor info
- Sorted by createdAt descending
  </action>
  <verify>`npx convex dev` shows no errors, transitions validate correctly</verify>
  <done>Stage transitions validated, handoffs implemented, activity logged</done>
</task>

<task type="auto">
  <name>Task 3: Update dealFiles to log activity</name>
  <files>convex/dealFiles.ts</files>
  <action>
Update dealFiles.ts to log file activity:

1. In `saveFile` mutation:
   - After saving file, insert dealActivity record
   - activityType: "file_uploaded"
   - details: { fileId, fileName }

2. In `deleteFile` mutation:
   - Before deleting, insert dealActivity record
   - activityType: "file_deleted"
   - details: { fileId, fileName }

Import the insert function pattern from deals.ts.
  </action>
  <verify>File upload/delete creates activity records</verify>
  <done>File operations logged to deal activity</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Stage transitions validate correctly
- [ ] Invalid transitions are rejected
- [ ] Handoff flow creates requests and advances stages
- [ ] Activity log captures all events
- [ ] `npm run build` passes
</verification>

<success_criteria>
- Deals can only transition through valid stages
- Providers can hand off to next provider type
- All deal activity is logged for audit trail
- Permissions enforced on all operations
</success_criteria>

<output>
After completion, create `.planning/phases/06-deal-flow/06-04-SUMMARY.md` with:

# Phase 6 Plan 04: Deal Transitions & Handoffs Summary

**[One-liner describing what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [File list]

## Decisions Made
- [Key decisions]

## Issues Encountered
- [Problems and resolutions]

## Next Step
Ready for 06-05-PLAN.md (Deals UI)
</output>
