---
phase: 26-user-profiles-revamp
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/users.ts
  - src/app/(app)/profile/[id]/page.tsx
  - src/components/profile/ProfileHeader.tsx
  - src/components/profile/UserPostsFeed.tsx
  - src/components/profile/index.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to /profile/[id] and see a profile page"
    - "Profile page displays user name, avatar, role badge"
    - "Profile page shows follower/following counts"
    - "User can follow/unfollow from profile page"
    - "Profile page shows user's posts in paginated feed"
  artifacts:
    - path: "convex/users.ts"
      provides: "getUserProfile query"
      exports: ["getUserProfile"]
    - path: "src/app/(app)/profile/[id]/page.tsx"
      provides: "Profile page route"
      min_lines: 80
    - path: "src/components/profile/ProfileHeader.tsx"
      provides: "Profile header with avatar, name, role, follow"
      min_lines: 50
    - path: "src/components/profile/UserPostsFeed.tsx"
      provides: "Paginated user posts feed"
      min_lines: 40
  key_links:
    - from: "src/app/(app)/profile/[id]/page.tsx"
      to: "convex/users.ts"
      via: "useQuery(api.users.getUserProfile)"
      pattern: "useQuery.*getUserProfile"
    - from: "src/app/(app)/profile/[id]/page.tsx"
      to: "convex/posts.ts"
      via: "usePaginatedQuery(api.posts.userFeed)"
      pattern: "usePaginatedQuery.*userFeed"
    - from: "src/components/profile/ProfileHeader.tsx"
      to: "src/components/feed/FollowButton.tsx"
      via: "FollowButton component"
      pattern: "FollowButton"
---

<objective>
Create user profile page with backend query and core UI components

Purpose: Enable users to view any user's public profile with their info, follow stats, and posts feed
Output: Working /profile/[id] route displaying user profile with follow functionality and posts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-user-profiles-revamp/26-RESEARCH.md

# Existing patterns to follow
@src/app/(app)/providers/[id]/page.tsx
@src/components/feed/FollowStats.tsx
@src/components/feed/FollowButton.tsx
@src/components/feed/PostCard.tsx
@convex/posts.ts
@convex/users.ts
@convex/serviceProviderProfiles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getUserProfile query to convex/users.ts</name>
  <files>convex/users.ts</files>
  <action>
Add a new `getUserProfile` query to convex/users.ts that aggregates all profile data in a single call.

The query should:
1. Accept `userId: v.id("users")` argument
2. Require authentication (return null if not authenticated)
3. Fetch the target user by ID
4. Determine if current user follows this user (using userFollows table with by_follower_and_following index)
5. Determine if this is the current user's own profile (isOwnProfile boolean)
6. For service providers (broker, mortgage_advisor, lawyer):
   - Fetch serviceProviderProfiles by userId
   - Calculate stats (completedDeals count, averageRating, totalReviews, yearsExperience)
   - Fetch portfolio (last 5 completed deals with property info) - same pattern as getPublicProfile
7. Return unified object with:
   - _id, name, email, imageUrl, role
   - isFollowing, isOwnProfile
   - providerProfile (null for investors, object with companyName, bio, etc for providers)
   - stats (null for investors, object for providers)
   - portfolio (null for investors, array for providers)

Follow the exact pattern from getPublicProfile in serviceProviderProfiles.ts for provider stats/portfolio.
Use Math.round((sum/count) * 10) / 10 for averageRating to get 1 decimal place.
  </action>
  <verify>
Run `npx convex dev` - no type errors. The query should be exported and available as api.users.getUserProfile.
  </verify>
  <done>
getUserProfile query exists in convex/users.ts, accepts userId, returns profile with isFollowing, isOwnProfile, and provider-specific data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create profile components and page</name>
  <files>
    src/components/profile/ProfileHeader.tsx
    src/components/profile/UserPostsFeed.tsx
    src/components/profile/index.ts
    src/app/(app)/profile/[id]/page.tsx
  </files>
  <action>
Create profile components following the provider profile page pattern:

**ProfileHeader.tsx:**
- "use client" directive
- Props: `profile` object (from getUserProfile query)
- Display: Avatar (h-20 w-20), name (text-2xl font-bold), role Badge
- If providerProfile?.companyName exists, show with Briefcase icon
- If providerProfile?.bio exists, show truncated (line-clamp-2)
- Include FollowStats component passing profile._id
- Include FollowButton component passing profile._id and profile.isOwnProfile
- Layout: flex with avatar on left, info in middle, follow button on right (responsive)

Helper function for role labels:
```typescript
const ROLE_LABELS: Record<string, string> = {
  investor: "Investor",
  broker: "Broker",
  mortgage_advisor: "Mortgage Advisor",
  lawyer: "Lawyer",
  admin: "Admin",
};
```

Helper for initials:
```typescript
function getInitials(name: string): string {
  return name.split(" ").map((n) => n[0]).join("").toUpperCase().slice(0, 2);
}
```

**UserPostsFeed.tsx:**
- "use client" directive
- Props: `userId: Id<"users">`
- Use usePaginatedQuery with api.posts.userFeed, { userId }, { initialNumItems: 10 }
- Loading state: 3x PostCardSkeleton
- Empty state: "No posts yet." centered text
- Map results to PostCard components
- Load more button when status === "CanLoadMore"
- Loading indicator when status === "LoadingMore"

**index.ts (barrel export):**
```typescript
export { ProfileHeader } from "./ProfileHeader";
export { UserPostsFeed } from "./UserPostsFeed";
```

**Profile page (src/app/(app)/profile/[id]/page.tsx):**
- "use client" directive
- Get userId from params using `useParams()`
- Use useQuery(api.users.getUserProfile, { userId })
- Loading state: ProfilePageSkeleton (copy pattern from ProviderProfileSkeleton)
- Not found state: "User Not Found" with back button
- Layout: p-6 space-y-6 max-w-4xl mx-auto
- Back button (Button variant="ghost" with ArrowLeft01Icon)
- ProfileHeader component
- Tabs component with "Posts" tab (always shown)
- TabsContent with UserPostsFeed

Do NOT include Portfolio tab yet (that's Plan 02).
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Navigate to /profile/[some-user-id] (use a real user ID from the database)
3. Verify: Profile header shows with avatar, name, role badge
4. Verify: Follow stats display (followers/following counts)
5. Verify: Follow/Unfollow button works (if not own profile)
6. Verify: Posts tab shows user's posts
7. Verify: Back button navigates back
  </verify>
  <done>
Profile page at /profile/[id] displays user info, follow stats, follow button, and paginated posts feed.
  </done>
</task>

</tasks>

<verification>
- [ ] `npx convex dev` runs without errors
- [ ] `npm run dev` starts without errors
- [ ] /profile/[id] route accessible and displays profile
- [ ] ProfileHeader shows avatar, name, role badge
- [ ] FollowStats shows follower/following counts
- [ ] FollowButton works (follow/unfollow toggles)
- [ ] UserPostsFeed shows user's posts with pagination
- [ ] Empty state shown when user has no posts
- [ ] Back button navigates back
</verification>

<success_criteria>
- getUserProfile query aggregates all profile data in single call
- Profile page renders without errors for any user ID
- Follow functionality works from profile page
- User's posts are displayed with proper pagination
- Loading and empty states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/26-user-profiles-revamp/26-01-SUMMARY.md`
</output>
