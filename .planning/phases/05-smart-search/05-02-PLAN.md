---
phase: 05-smart-search
plan: 02
type: execute
---

<objective>
Extend property query to support full filter criteria from parsed search.

Purpose: The existing properties.list query only supports status, city, and propertyType. Smart search needs additional filters: price range, bedrooms, bathrooms, square meters.
Output: Enhanced properties.list (or new search query) supporting all filterable fields.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-smart-search/05-01-SUMMARY.md

**Existing code:**
@convex/properties.ts — Current list query with limited filters
@convex/schema.ts — Property schema with all fields
@convex/search.ts — parseSearchQuery action (from 05-01)

**Current filters in properties.list:**
- status (defaults to "available")
- city
- propertyType
- limit

**Needed filters:**
- priceMin, priceMax (priceUsd range)
- bedroomsMin (minimum bedrooms)
- bathroomsMin (minimum bathrooms)
- squareMetersMin, squareMetersMax (size range)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend properties.list with full filter support</name>
  <files>convex/properties.ts</files>
  <action>
  Add new optional filter arguments to the properties.list query:

  ```typescript
  args: {
    // Existing
    status: v.optional(propertyStatusValidator),
    city: v.optional(v.string()),
    propertyType: v.optional(propertyTypeValidator),
    limit: v.optional(v.number()),
    // New
    priceMin: v.optional(v.number()),
    priceMax: v.optional(v.number()),
    bedroomsMin: v.optional(v.number()),
    bathroomsMin: v.optional(v.number()),
    squareMetersMin: v.optional(v.number()),
    squareMetersMax: v.optional(v.number()),
  }
  ```

  In the handler, after the existing filters, add:
  - priceMin: filter properties where priceUsd >= priceMin
  - priceMax: filter properties where priceUsd <= priceMax
  - bedroomsMin: filter where bedrooms >= bedroomsMin (handle undefined bedrooms gracefully)
  - bathroomsMin: filter where bathrooms >= bathroomsMin
  - squareMetersMin/Max: filter by squareMeters range

  Since Convex doesn't support multiple index filters, continue using in-memory filtering after the initial index query (by_status).
  </action>
  <verify>npx convex dev runs without TypeScript errors</verify>
  <done>properties.list accepts all filter args, filters are applied correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create search query combining parse + filter</name>
  <files>convex/search.ts</files>
  <action>
  Create a new query `search` that:

  1. Takes a natural language search string
  2. Calls the parseSearchQuery action to get structured filters
  3. Passes those filters to properties.list logic (inline, not calling the query)
  4. Returns filtered properties

  Wait - queries can't call actions. Instead, create a convenience function pattern:

  Option A: Create a shared filter function used by both list and search
  Option B: Have the frontend call parseSearchQuery action, then call list query with results

  Choose Option B (simpler, cleaner separation):
  - parseSearchQuery action: string → filter object (already done in 05-01)
  - properties.list query: filter object → properties (enhanced in task 1)
  - Frontend orchestrates: call action, then call query

  So for Task 2: Export filter type from search.ts so frontend can pass parsed filters to properties.list correctly. Add JSDoc comments explaining the flow.

  ```typescript
  // Export the filter type for frontend use
  export type PropertyFilters = {
    status?: "available" | "pending" | "sold";
    city?: string;
    propertyType?: "residential" | "commercial" | "mixed_use" | "land";
    priceMin?: number;
    priceMax?: number;
    bedroomsMin?: number;
    bathroomsMin?: number;
    squareMetersMin?: number;
    squareMetersMax?: number;
    limit?: number;
  };
  ```
  </action>
  <verify>TypeScript compiles, types are exported correctly</verify>
  <done>PropertyFilters type exported, search flow documented in comments</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev` runs without errors
- [ ] properties.list accepts priceMin, priceMax, bedroomsMin, bathroomsMin, squareMetersMin, squareMetersMax
- [ ] PropertyFilters type is exported from convex/search.ts
- [ ] Filter logic handles undefined property values gracefully
</verification>

<success_criteria>
- properties.list query supports full filter set
- Filter type exported for frontend consumption
- Existing marketplace page still works (no breaking changes)
</success_criteria>

<output>
After completion, create `.planning/phases/05-smart-search/05-02-SUMMARY.md`
</output>
