---
phase: 05-smart-search
plan: 01
type: execute
---

<objective>
Set up Claude AI integration for natural language search parsing.

Purpose: Enable "AI-powered" search by parsing natural language queries like "apartments in Tel Aviv under $500k" into structured property filters.
Output: Convex action that takes natural language input and returns structured filter JSON.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior work:**
@.planning/phases/04-property-marketplace/04-02-SUMMARY.md

**Existing code:**
@convex/properties.ts — Current properties.list query with basic filters
@src/lib/constants.ts — Valid values for propertyType, cities, etc.

**Key constraints:**
- PROJECT.md: "NLP → filters for MVP search (Faster to ship, semantic search adds complexity)"
- Property schema supports: city, propertyType, status, priceUsd, bedrooms, bathrooms, squareMeters
- Constants define valid values: PROPERTY_TYPES, ISRAELI_LOCATIONS
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Anthropic SDK and configure environment</name>
  <files>package.json, .env.local</files>
  <action>
  1. Install the Anthropic SDK: `npm install @anthropic-ai/sdk`
  2. Add ANTHROPIC_API_KEY to .env.local (prompt user to add their key)
  3. Create convex/.env.local if needed and add ANTHROPIC_API_KEY there too (Convex actions need env vars in convex/ directory OR use Convex dashboard)

  Note: For Convex actions to access env vars, they must be set in the Convex dashboard under "Environment Variables" for production, or in convex/.env.local for local dev.
  </action>
  <verify>npm list @anthropic-ai/sdk shows installed package</verify>
  <done>Anthropic SDK installed, environment variable placeholders created</done>
</task>

<task type="auto">
  <name>Task 2: Create parseSearchQuery Convex action</name>
  <files>convex/search.ts</files>
  <action>
  Create a Convex action (not query - actions can make HTTP calls) that:

  1. Takes a natural language search string as input
  2. Calls Claude API with a structured prompt containing:
     - The user's search query
     - Valid property types: residential, commercial, mixed_use, land
     - Valid cities: from ISRAELI_LOCATIONS constant
     - Valid filter fields: priceMin, priceMax, bedrooms, bathrooms, squareMetersMin, squareMetersMax
  3. Uses Claude's structured output to return a typed filter object
  4. Returns the parsed filters as JSON matching properties.list args

  Prompt structure should be:
  - System: "You are a search query parser for a real estate platform. Extract structured filters from natural language."
  - Include valid values for each field
  - Request JSON output matching the filter schema
  - Handle gracefully when no valid filters are found (return empty object)

  Use claude-3-haiku for speed/cost efficiency (this is a simple parsing task).

  Handle errors gracefully - if Claude API fails, return empty filters (allow fallback to showing all properties).
  </action>
  <verify>npx convex dev runs without errors, action is registered</verify>
  <done>parseSearchQuery action created, accepts string, returns structured filter object</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Add Anthropic API key to Convex environment</action>
  <instructions>
  I've created the action that needs the Anthropic API key. You need to:

  1. Get your Anthropic API key from https://console.anthropic.com/settings/keys
  2. Add it to Convex:
     - For local dev: Create `convex/.env.local` and add `ANTHROPIC_API_KEY=sk-ant-...`
     - For production: Run `npx convex env set ANTHROPIC_API_KEY sk-ant-...`
  </instructions>
  <verification>The parseSearchQuery action can successfully call Claude API</verification>
  <resume-signal>Type "done" when API key is configured</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm list @anthropic-ai/sdk` shows package installed
- [ ] `npx convex dev` runs without errors
- [ ] convex/search.ts exports parseSearchQuery action
- [ ] Action accepts search string and returns filter object type
</verification>

<success_criteria>
- Anthropic SDK installed
- parseSearchQuery Convex action created
- Action compiles and is registered with Convex
- User has been prompted to add API key
</success_criteria>

<output>
After completion, create `.planning/phases/05-smart-search/05-01-SUMMARY.md`
</output>
