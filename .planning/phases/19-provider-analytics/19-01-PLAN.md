# Phase 19 Plan 01: Provider Analytics Backend & Dashboard

## Objective

Create analytics queries for providers to track their performance metrics including completed deals, conversion rates, earnings estimates, response times, and client satisfaction ratings. Then build a frontend analytics dashboard displaying these metrics.

## Execution Context

- **Phase**: 19 (Provider Analytics)
- **Plan**: 01 of 01
- **Subsystem**: backend + frontend
- **Dependencies**: Phase 18 complete (provider reviews/ratings)

## Context

### Data Sources Available

From `deals` table:
- Stage tracking with timestamps (stageHistory)
- Provider assignments (brokerId, mortgageAdvisorId, lawyerId)
- Offer price for commission estimates
- Deal creation and completion dates

From `serviceRequests` table:
- Request status (pending/accepted/declined/cancelled)
- Created/responded timestamps for response time

From `providerReviews` table:
- Ratings (1-5 stars)
- Already have aggregation via getProviderStats

From `properties` table:
- Property prices for deal value calculations

### Metrics to Implement

1. **Completed Deals**: Count of deals in "completed" stage
2. **Active Deals**: Count of deals in non-terminal stages
3. **Conversion Rate**: Accepted requests / Total requests
4. **Average Response Time**: Time from request to response
5. **Average Rating**: From providerReviews (already exists)
6. **Total Deal Value**: Sum of deal offer prices
7. **Monthly Trends**: Deals and requests over time

## Tasks

### Task 1: Create Analytics Query (Auto)

Create `convex/providerAnalytics.ts` with:

```typescript
// getProviderAnalytics(providerId) - returns all analytics for a provider
{
  // Deal metrics
  completedDeals: number,
  activeDeals: number,
  totalDealValue: number, // USD
  avgDealValue: number,

  // Request metrics
  totalRequests: number,
  acceptedRequests: number,
  declinedRequests: number,
  conversionRate: number, // percentage
  avgResponseTimeHours: number,

  // Rating (from existing getProviderStats)
  avgRating: number,
  totalReviews: number,

  // Monthly trends (last 6 months)
  monthlyTrends: Array<{
    month: string, // "2026-01"
    deals: number,
    requests: number,
  }>
}
```

Implementation:
1. Query deals by provider role (brokerId/mortgageAdvisorId/lawyerId)
2. Query serviceRequests by providerId
3. Calculate metrics from raw data
4. Build monthly trends from timestamps

Files: `convex/providerAnalytics.ts`

### Task 2: Create Analytics Dashboard Page (Auto)

Create `/analytics` page for providers showing:

**Top Stats Row** (4 cards):
- Completed Deals (with delta from last month)
- Active Deals
- Conversion Rate (percentage)
- Average Rating (stars)

**Revenue Section**:
- Total Deal Value card with monthly chart
- Note: Actual earnings depend on commission agreements

**Performance Section**:
- Response Time metric
- Requests breakdown (accepted/declined/pending)

**Monthly Trends Chart**:
- Line/bar chart showing deals and requests over last 6 months
- Use Recharts (already in project dependencies)

**Layout**:
- Full-width dashboard at `/dashboard/analytics` or `/analytics`
- Add "Analytics" to provider navigation

Files:
- `src/app/(app)/analytics/page.tsx`
- `src/lib/navigation.ts` (add Analytics link)

### Task 3: Human Verification (Verify)

Verify the analytics dashboard:
1. Navigate to /analytics as a provider
2. Confirm stats cards display correctly
3. Check charts render with appropriate data
4. Verify empty states when no data
5. Test with provider that has deals vs one without

## Verification

- [ ] Analytics query returns all required metrics
- [ ] Dashboard displays all metric cards
- [ ] Charts render correctly (or show empty state)
- [ ] Navigation updated for all provider roles
- [ ] Page is responsive on mobile

## Success Criteria

- Providers can view their performance metrics on /analytics
- All metrics calculate correctly from available data
- Dashboard provides meaningful insights at a glance
- Charts show historical trends

## Output

- `convex/providerAnalytics.ts` - Analytics query
- `src/app/(app)/analytics/page.tsx` - Analytics dashboard
- `src/lib/navigation.ts` - Navigation update
