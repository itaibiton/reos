---
phase: 25-user-following
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/feed/FollowButton.tsx
  - src/components/feed/index.ts
  - src/components/feed/PostCard.tsx
  - src/components/feed/PropertyPostCard.tsx
  - src/components/feed/ServiceRequestPostCard.tsx
  - src/components/feed/DiscussionPostCard.tsx
  - src/app/(app)/feed/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can follow another user from their post"
    - "User can unfollow a user they follow"
    - "Following tab shows posts only from followed users"
    - "Follow button shows correct state (Following/Follow)"
  artifacts:
    - path: "src/components/feed/FollowButton.tsx"
      provides: "Follow/unfollow toggle button with optimistic UI"
      min_lines: 50
    - path: "src/app/(app)/feed/page.tsx"
      provides: "Feed page with Following tab"
      contains: "followingFeed"
  key_links:
    - from: "src/components/feed/FollowButton.tsx"
      to: "convex/userFollows.ts"
      via: "useMutation/useQuery"
      pattern: "api\\.userFollows\\.(followUser|unfollowUser|isFollowing)"
    - from: "src/app/(app)/feed/page.tsx"
      to: "convex/posts.ts"
      via: "usePaginatedQuery"
      pattern: "api\\.posts\\.followingFeed"
---

<objective>
Create FollowButton component and add Following feed tab to enable users to follow other users and see posts from followed users.

Purpose: Enable social following - the core of personalized feeds
Output: FollowButton component + Following tab on feed page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@convex/userFollows.ts (followUser, unfollowUser, isFollowing mutations/queries)
@convex/posts.ts (followingFeed query exists)
@src/components/feed/EngagementFooter.tsx (optimistic UI pattern to follow)
@src/app/(app)/feed/page.tsx (current feed page to add Following tab)
@src/components/feed/PostCard.tsx (EnrichedPost type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FollowButton component</name>
  <files>src/components/feed/FollowButton.tsx, src/components/feed/index.ts</files>
  <action>
Create FollowButton component following EngagementFooter's optimistic UI pattern:

1. Create `src/components/feed/FollowButton.tsx`:
   - Props: `userId: Id<"users">` (the user to follow/unfollow)
   - Use `useQuery(api.userFollows.isFollowing, { userId })` for initial state
   - Use `useMutation(api.userFollows.followUser)` and `useMutation(api.userFollows.unfollowUser)`
   - Local state for optimistic UI: `isFollowing`, `isPending`
   - Sync with server via useEffect (like EngagementFooter)
   - On click: toggle state optimistically, call mutation, revert on error
   - Button styling:
     - Following state: `variant="secondary"` with "Following" text
     - Not following state: `variant="default"` with "Follow" text
   - Disable during pending state
   - Don't render if user is viewing their own post (need currentUserId check)

2. Add query for current user ID. The component needs to know if the post author is the current user. Options:
   - Pass `isOwnPost` prop from parent (cleaner)
   - Query current user in component (extra query but self-contained)

   Use prop approach: `isOwnPost?: boolean` - if true, don't render button.

3. Export from `src/components/feed/index.ts`

Component structure:
```tsx
interface FollowButtonProps {
  userId: Id<"users">;
  isOwnPost?: boolean;
}

export function FollowButton({ userId, isOwnPost }: FollowButtonProps) {
  // Don't show follow button for own posts
  if (isOwnPost) return null;

  // Query server state
  const serverIsFollowing = useQuery(api.userFollows.isFollowing, { userId });

  // Mutations
  const follow = useMutation(api.userFollows.followUser);
  const unfollow = useMutation(api.userFollows.unfollowUser);

  // Local optimistic state
  const [isFollowing, setIsFollowing] = useState(false);
  const [isPending, setIsPending] = useState(false);

  // Sync with server
  useEffect(() => {
    if (serverIsFollowing !== undefined) {
      setIsFollowing(serverIsFollowing);
    }
  }, [serverIsFollowing]);

  // Handle toggle
  const handleToggle = async () => {
    if (isPending) return;
    setIsPending(true);

    const newIsFollowing = !isFollowing;
    setIsFollowing(newIsFollowing); // Optimistic

    try {
      if (newIsFollowing) {
        await follow({ userId });
      } else {
        await unfollow({ userId });
      }
    } catch {
      setIsFollowing(!newIsFollowing); // Revert
    } finally {
      setIsPending(false);
    }
  };

  // Don't render until we know the state
  if (serverIsFollowing === undefined) return null;

  return (
    <Button
      variant={isFollowing ? "secondary" : "default"}
      size="sm"
      onClick={handleToggle}
      disabled={isPending}
    >
      {isFollowing ? "Following" : "Follow"}
    </Button>
  );
}
```
  </action>
  <verify>
    - File exists: `ls src/components/feed/FollowButton.tsx`
    - Exported: `grep -q "FollowButton" src/components/feed/index.ts`
    - Uses optimistic pattern: `grep -q "setIsFollowing" src/components/feed/FollowButton.tsx`
  </verify>
  <done>FollowButton component with optimistic UI for follow/unfollow toggle</done>
</task>

<task type="auto">
  <name>Task 2: Add FollowButton to post cards and pass authorId</name>
  <files>src/components/feed/PostCard.tsx, src/components/feed/PropertyPostCard.tsx, src/components/feed/ServiceRequestPostCard.tsx, src/components/feed/DiscussionPostCard.tsx</files>
  <action>
Update post cards to include FollowButton in the author header area:

1. Update `EnrichedPost` type in PostCard.tsx to include `authorId`:
   - The authorId already exists in the base post document (from `Doc<"posts">`)
   - Just verify it's accessible via spread: `...post` includes `authorId`

2. Update PropertyPostCard.tsx:
   - Import FollowButton
   - In the author header section (after name and role badge), add FollowButton
   - Pass `userId={post.authorId}`
   - Determine if own post by querying current user OR pass from feed page

   For simplicity, add a currentUser query in each card to check ownership:
   ```tsx
   const currentUser = useQuery(api.users.getCurrentUser);
   const isOwnPost = currentUser?._id === post.authorId;
   ```

   Place FollowButton in the header row, right-aligned:
   ```tsx
   <div className="flex items-center gap-3">
     <Avatar>...</Avatar>
     <div className="flex-1 min-w-0">
       <div className="flex items-center gap-2">
         <span className="font-medium text-sm truncate">{post.authorName}</span>
         {roleLabel && <Badge>...</Badge>}
       </div>
       <span className="text-xs text-muted-foreground">...</span>
     </div>
     <FollowButton userId={post.authorId} isOwnPost={isOwnPost} />
   </div>
   ```

3. Apply same pattern to ServiceRequestPostCard.tsx and DiscussionPostCard.tsx

Note: Each card already has "use client" directive, so hooks are available.
  </action>
  <verify>
    - PropertyPostCard has FollowButton: `grep -q "FollowButton" src/components/feed/PropertyPostCard.tsx`
    - ServiceRequestPostCard has FollowButton: `grep -q "FollowButton" src/components/feed/ServiceRequestPostCard.tsx`
    - DiscussionPostCard has FollowButton: `grep -q "FollowButton" src/components/feed/DiscussionPostCard.tsx`
    - All cards query current user: `grep -q "getCurrentUser" src/components/feed/PropertyPostCard.tsx`
  </verify>
  <done>All post card types show FollowButton in author header, hidden for own posts</done>
</task>

<task type="auto">
  <name>Task 3: Add Following tab to feed page</name>
  <files>src/app/(app)/feed/page.tsx</files>
  <action>
Add a "Following" tab to the feed page that shows posts from followed users:

1. Update the feed page to support two feed modes: "global" and "following"

2. Add a second Tabs component OR use the source parameter approach:
   - Option A: Separate tabs for source (Global/Following) + type filter tabs
   - Option B: Add "Following" as a special filter that uses different query

   Use Option A for clarity - two tab rows:
   - Row 1: Feed source (Global | Following)
   - Row 2: Post type filter (All | Properties | Services | Discussions)

3. Implementation:
   ```tsx
   type FeedSource = "global" | "following";

   // Read from URL: /feed?source=following&type=property_listing
   const sourceParam = searchParams.get("source") as FeedSource | null;
   const feedSource: FeedSource = sourceParam ?? "global";

   // Conditionally use different query
   const globalFeedResults = usePaginatedQuery(
     api.posts.globalFeed,
     feedSource === "global" ? { postType: queryPostType } : "skip",
     { initialNumItems: 10 }
   );

   const followingFeedResults = usePaginatedQuery(
     api.posts.followingFeed,
     feedSource === "following" ? {} : "skip",
     { initialNumItems: 10 }
   );

   // Active results based on source
   const { results, status, loadMore } = feedSource === "global"
     ? globalFeedResults
     : followingFeedResults;
   ```

4. Add source tabs above type filter:
   ```tsx
   {/* Feed Source Tabs */}
   <Tabs value={feedSource} onValueChange={handleSourceChange}>
     <TabsList>
       <TabsTrigger value="global">Global</TabsTrigger>
       <TabsTrigger value="following">Following</TabsTrigger>
     </TabsList>
   </Tabs>

   {/* Filter Tabs (only for global feed) */}
   {feedSource === "global" && (
     <Tabs value={filterType} onValueChange={handleFilterChange}>
       <TabsList className="grid w-full grid-cols-4">
         ...
       </TabsList>
     </Tabs>
   )}
   ```

5. Handle source change:
   ```tsx
   const handleSourceChange = (value: string) => {
     if (value === "global") {
       router.push("/feed");
     } else {
       router.push("/feed?source=following");
     }
   };
   ```

6. Update empty state for Following tab:
   - If following feed is empty, show: "No posts from people you follow yet. Follow users to see their posts here."
  </action>
  <verify>
    - Following tab exists: `grep -q "Following" src/app/(app)/feed/page.tsx`
    - Uses followingFeed query: `grep -q "followingFeed" src/app/(app)/feed/page.tsx`
    - App compiles: `cd /Users/Kohelet/Code/REOS && npm run build 2>&1 | head -20`
  </verify>
  <done>Feed page has Global/Following tabs, Following shows posts from followed users</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. FollowButton renders on posts from other users
3. Clicking Follow changes to Following (optimistic)
4. Following tab shows only posts from followed users
5. Own posts don't show Follow button
</verification>

<success_criteria>
- FollowButton component exists with optimistic UI pattern
- All three post card types include FollowButton in author header
- Feed page has Global/Following source tabs
- Following feed uses followingFeed query from Phase 21
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/25-user-following/25-01-SUMMARY.md`
</output>
