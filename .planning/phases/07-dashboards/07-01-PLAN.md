---
phase: 07-dashboards
plan: 01
type: execute
---

<objective>
Create backend queries for role-specific dashboard stats and property recommendations.

Purpose: Provide data foundation for investor and provider dashboards with personalized metrics.
Output: Convex queries for dashboard stats per role and property recommendations based on investor profile.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior context (from frontmatter):
@.planning/phases/06-deal-flow/06-05-SUMMARY.md

# Relevant source files:
@convex/schema.ts
@convex/deals.ts
@convex/properties.ts
@convex/serviceRequests.ts
@src/hooks/useCurrentUser.ts

**Tech stack available:** Next.js 16, Convex, Clerk auth, Shadcn/ui
**Established patterns:**
- Convex queries with auth check via ctx.auth.getUserIdentity()
- effectiveRole = viewingAsRole ?? role for admin impersonation
- Index-based queries with in-memory filtering
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard stats query</name>
  <files>convex/dashboard.ts</files>
  <action>
Create new convex/dashboard.ts file with a `getStats` query that returns role-specific statistics.

For investors:
- activeDeals: count of deals not completed/cancelled
- completedDeals: count of completed deals
- savedProperties: count from favorites table
- pendingRequests: count of pending service requests they created

For service providers (broker, mortgage_advisor, lawyer):
- pendingRequests: count of pending requests for this provider
- activeClients: count of accepted requests (active deals)
- totalClients: count of all accepted requests historically
- recentActivity: count of deal activity in last 7 days where they're assigned

For admin (without viewingAsRole):
- totalDeals: all deals count
- activeDeals: non-terminal deals
- totalUsers: user count
- totalProperties: property count

Use effectiveRole pattern from useCurrentUser hook. Query relevant tables with indexes where available. Return stats as object with numeric values.
  </action>
  <verify>npx convex dev runs without type errors, query function exports correctly</verify>
  <done>getStats query returns role-appropriate statistics object</done>
</task>

<task type="auto">
  <name>Task 2: Create property recommendations query</name>
  <files>convex/dashboard.ts</files>
  <action>
Add `getRecommendedProperties` query to convex/dashboard.ts for investors.

Logic:
1. Get current user and their investor profile
2. Query available properties
3. Score and filter based on profile match:
   - preferredPropertyTypes match (if set)
   - budgetMax >= property price (if set)
   - preferredLocations includes property city (if set)
4. Exclude properties user has already saved (favorites)
5. Return top 6 properties with match score

If no investor profile exists, return random 6 available properties as fallback.

Return array of property objects with additional `matchScore` field (0-100).

Pattern: Follow properties.list query structure for property data shape.
  </action>
  <verify>npx convex dev runs, query returns array of properties with matchScore</verify>
  <done>getRecommendedProperties returns personalized property list for investors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev` runs without errors
- [ ] Both queries export from convex/dashboard.ts
- [ ] Stats query returns different data based on user role
- [ ] Recommendations query returns properties with match scores
</verification>

<success_criteria>

- convex/dashboard.ts exists with getStats and getRecommendedProperties queries
- Both queries handle auth and role checking
- Queries use existing indexes for efficient data access
- No TypeScript errors in Convex functions
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboards/07-01-SUMMARY.md`
</output>
