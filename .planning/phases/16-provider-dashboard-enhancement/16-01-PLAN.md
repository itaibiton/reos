---
phase: 16-provider-dashboard-enhancement
plan: 01
type: execute
---

<objective>
Enhance the provider dashboard with active deals summary and improved client overview.

Purpose: Transform the provider dashboard from showing just counts to displaying actual deal cards, giving providers immediate visibility into their active work without navigating to other pages.
Output: Enhanced ProviderDashboard component with "My Active Deals" section showing deal cards with property, investor, and stage information.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior work (Phase 7 dashboards):**
@.planning/phases/07-dashboards/07-03-SUMMARY.md

**Key files:**
@convex/dashboard.ts
@src/components/dashboard/ProviderDashboard.tsx

**Established patterns:**
- effectiveRole pattern for admin impersonation in queries
- Dashboard component pattern: Stats grid + sections + quick actions
- Activity description generation from activityType and details
- Card component with Avatar, Badge for status display

**Tech stack available:**
- Convex queries with ctx.db access
- Shadcn Card, Avatar, Badge, Button, Skeleton components
- Hugeicons for icons
- formatRelativeTime, formatUSD, formatDate utilities already in ProviderDashboard
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getProviderActiveDeals query</name>
  <files>convex/dashboard.ts</files>
  <action>
Add a new query `getProviderActiveDeals` to dashboard.ts that:
1. Gets current user and validates they're a service provider (broker/mortgage_advisor/lawyer)
2. Queries deals where user is assigned (using existing by_broker/by_mortgage_advisor/by_lawyer indexes)
3. Filters to active deals only (stage !== "completed" && stage !== "cancelled")
4. Enriches each deal with:
   - property: { _id, title, city, priceUsd, images } from properties table
   - investor: { _id, name, imageUrl } from users table
5. Returns array sorted by createdAt descending, limited to 5 deals
6. Returns empty array if not a provider

Follow the pattern from getRecentActivity for user authentication and role checking.
Use effectiveRole pattern to support admin impersonation.
  </action>
  <verify>Run `npx convex dev` and check no TypeScript errors. Check convex dashboard for new function.</verify>
  <done>getProviderActiveDeals query exists, returns deals with property and investor info for providers</done>
</task>

<task type="auto">
  <name>Task 2: Add Active Deals section to ProviderDashboard</name>
  <files>src/components/dashboard/ProviderDashboard.tsx</files>
  <action>
Update ProviderDashboard.tsx to add "My Active Deals" section:

1. Add query: `const activeDeals = useQuery(api.dashboard.getProviderActiveDeals);`

2. Create ActiveDealCard inline component (inside ProviderDashboard.tsx):
   - Shows property image (first from images array, or placeholder)
   - Property title and city
   - Price in USD
   - Investor avatar + name
   - Stage badge (color-coded: broker_assigned=blue, mortgage=purple, legal=orange, closing=green)
   - Clickable - onClick navigates to /deals/[dealId]
   - Use existing formatUSD, formatDate utilities

3. Add "My Active Deals" section AFTER the stats grid, BEFORE pending requests:
   - Card with CardHeader "My Active Deals" + "View all" link to /deals
   - CardContent with grid of deal cards (grid-cols-1 on mobile, grid-cols-2 on lg)
   - Loading skeleton while activeDeals === undefined
   - Empty state when no active deals: icon + "No active deals" message

4. Stage badge colors:
   - broker_assigned: bg-blue-100 text-blue-800
   - mortgage: bg-purple-100 text-purple-800
   - legal: bg-orange-100 text-orange-800
   - closing: bg-green-100 text-green-800

Keep the existing sections (stats, pending requests, activity, quick actions) unchanged.
  </action>
  <verify>Run `npm run dev`, navigate to dashboard as a provider role, verify Active Deals section appears with deal cards</verify>
  <done>ProviderDashboard shows "My Active Deals" section with deal cards displaying property, investor, and stage</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced provider dashboard with Active Deals section</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Login as a service provider (broker/mortgage_advisor/lawyer) with active deals
    3. Navigate to /dashboard
    4. Verify:
       - Stats grid still shows (Pending Requests, Active Clients, Total Clients, Activity 7d)
       - NEW "My Active Deals" section appears after stats
       - Deal cards show: property image/placeholder, title, city, price, investor avatar/name, stage badge
       - Stage badges are color-coded correctly
       - Clicking a deal card navigates to /deals/[id]
       - "View all" link navigates to /deals
       - Empty state shows if no active deals
    5. Check mobile view (resize to <768px) - cards should stack single column
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx convex dev` runs without errors
- [ ] `npm run build` succeeds without errors
- [ ] Provider dashboard shows Active Deals section with deal cards
- [ ] Deal cards display property, investor, and stage information
- [ ] Cards are clickable and navigate to deal detail page
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Provider dashboard enhanced with actual deal content (not just counts)
- Phase 16 complete
</success_criteria>

<output>
After completion, create `.planning/phases/16-provider-dashboard-enhancement/16-01-SUMMARY.md`
</output>
