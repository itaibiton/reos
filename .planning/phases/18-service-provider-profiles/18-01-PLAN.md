---
phase: 18-service-provider-profiles
plan: 01
type: execute
---

<objective>
Create reviews/ratings schema and backend queries for service provider public profiles.

Purpose: Enable investors to leave reviews for providers and display aggregated ratings and portfolio statistics on provider profiles.
Output: Convex schema extension with providerReviews table, review mutations, and provider stats queries.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@convex/schema.ts
@convex/serviceProviderProfiles.ts

**Prior context:**
- Phase 17 completed client management UI
- serviceProviderProfiles table exists with profile data
- listByType, getWithUser queries exist for providers
- deals table tracks completed deals with provider assignments
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add providerReviews table to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add providerReviews table with fields:
- providerId: v.id("users") - the provider being reviewed
- reviewerId: v.id("users") - the investor leaving review
- dealId: v.id("deals") - the deal this review relates to
- rating: v.number() - 1-5 star rating
- reviewText: v.optional(v.string()) - optional review text
- createdAt: v.number()

Add indexes: by_provider, by_reviewer, by_deal.

Add constraint comment: One review per deal per reviewer (enforced in mutation).
  </action>
  <verify>npx convex dev --once runs without schema errors</verify>
  <done>providerReviews table exists in schema with proper indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create providerReviews.ts with queries and mutations</name>
  <files>convex/providerReviews.ts</files>
  <action>
Create new Convex file with:

1. `addReview` mutation:
   - Args: providerId, dealId, rating (1-5), reviewText (optional)
   - Validate: caller is authenticated, caller was investor on this deal, deal is completed, no existing review for this deal+reviewer combo
   - Insert review, return review ID

2. `getByProvider` query:
   - Args: providerId
   - Returns all reviews for provider with reviewer name/imageUrl, sorted by createdAt desc
   - Include deal property title for context

3. `getProviderStats` query:
   - Args: providerId
   - Returns: averageRating, totalReviews, completedDeals count, yearsActive (from serviceProviderProfile)
   - Calculate averageRating from reviews, count completed deals where provider was assigned

Note: Use existing patterns from serviceProviderProfiles.ts for query structure.
  </action>
  <verify>npx convex dev --once compiles without errors, queries appear in Convex dashboard</verify>
  <done>addReview mutation validates and inserts, getByProvider returns reviews with user info, getProviderStats returns aggregated stats</done>
</task>

<task type="auto">
  <name>Task 3: Add getPublicProfile query to serviceProviderProfiles</name>
  <files>convex/serviceProviderProfiles.ts</files>
  <action>
Add `getPublicProfile` query that combines:
- Provider profile data (from serviceProviderProfiles)
- User data (name, imageUrl from users)
- Stats (from getProviderStats - inline or call internal)
- Recent reviews (last 5)
- Portfolio highlights (last 5 completed deals with property info)

Args: providerId: v.id("users")
Returns: Combined object for public profile page rendering

This is a single query that powers the entire public profile page to minimize client roundtrips.
  </action>
  <verify>npx convex dev --once compiles, query returns combined profile data</verify>
  <done>getPublicProfile query returns profile, user info, stats, reviews, and portfolio in one call</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` runs without errors
- [ ] providerReviews table appears in Convex dashboard
- [ ] addReview mutation enforces one-review-per-deal constraint
- [ ] getPublicProfile returns combined data structure
</verification>

<success_criteria>
- All tasks completed
- Schema deployed to Convex
- Review functionality ready for frontend
- Public profile data query available
</success_criteria>

<output>
After completion, create `.planning/phases/18-service-provider-profiles/18-01-SUMMARY.md`
</output>
