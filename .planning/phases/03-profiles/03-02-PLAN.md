---
phase: 03-profiles
plan: 02
type: execute
---

<objective>
Create investor profile schema and form for collecting investment preferences.

Purpose: Investors need to specify their investment criteria so the platform can match them with properties.
Output: Investor profiles table in Convex, CRUD functions, profile form page.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-profiles/03-01-SUMMARY.md

**Key files:**
@convex/schema.ts
@convex/users.ts
@src/hooks/useCurrentUser.ts

**Prior decisions:**
- Phase 2: Users table has role field
- Phase 3-01: Onboarding flow sets role

**Investor profile requirements (from PROJECT.md):**
- Investment preferences (property types, locations)
- Budget range (min/max in USD)
- Risk tolerance
- Target criteria (desired ROI, timeline)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add investorProfiles table to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add investorProfiles table with fields:

```typescript
investorProfiles: defineTable({
  // Reference to user
  userId: v.id("users"),

  // Investment preferences
  propertyTypes: v.array(v.union(
    v.literal("residential"),
    v.literal("commercial"),
    v.literal("mixed_use"),
    v.literal("land")
  )),

  // Target locations (Israeli cities/regions)
  targetLocations: v.array(v.string()),

  // Budget in USD
  budgetMin: v.number(),
  budgetMax: v.number(),

  // Risk tolerance
  riskTolerance: v.union(
    v.literal("conservative"),
    v.literal("moderate"),
    v.literal("aggressive")
  ),

  // Target metrics
  targetRoiMin: v.optional(v.number()), // Percentage
  investmentTimeline: v.optional(v.union(
    v.literal("short_term"),   // < 2 years
    v.literal("medium_term"),  // 2-5 years
    v.literal("long_term")     // 5+ years
  )),

  // Additional notes
  notes: v.optional(v.string()),

  // Timestamps
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_user", ["userId"])
```

One profile per investor (enforced by unique userId lookup in mutations).
  </action>
  <verify>npx convex dev shows schema updated without errors</verify>
  <done>investorProfiles table defined with all fields and index</done>
</task>

<task type="auto">
  <name>Task 2: Create investor profile mutations and queries</name>
  <files>convex/investorProfiles.ts</files>
  <action>
Create convex/investorProfiles.ts with:

1. `getMyProfile` query:
   - Get current user's investor profile
   - Returns null if no profile exists
   - Only works for authenticated investors

2. `upsertProfile` mutation:
   - Create or update investor profile
   - Args: all profile fields (except userId, timestamps)
   - Validates user is authenticated and has investor role
   - Uses getOrCreate pattern with by_user index

3. Helper: Define property types and locations as exportable constants for UI reuse

Validation:
- budgetMin must be < budgetMax
- At least one propertyType required
- At least one targetLocation required
  </action>
  <verify>npx convex dev shows functions registered</verify>
  <done>getMyProfile and upsertProfile functions working</done>
</task>

<task type="auto">
  <name>Task 3: Create investor profile form page</name>
  <files>src/app/(app)/profile/investor/page.tsx</files>
  <action>
Create investor profile form at /profile/investor:

1. Load existing profile with useQuery(api.investorProfiles.getMyProfile)
2. Form sections:
   - Property Types: Checkbox group (residential, commercial, mixed_use, land)
   - Target Locations: Multi-select or tag input (Tel Aviv, Jerusalem, Haifa, etc.)
   - Budget Range: Two number inputs (min/max USD) with formatting
   - Risk Tolerance: Radio group (Conservative, Moderate, Aggressive)
   - Investment Timeline: Radio group (Short, Medium, Long term)
   - Target ROI: Optional number input (percentage)
   - Notes: Textarea for additional preferences

3. Pre-fill form if profile exists
4. Submit calls upsertProfile mutation
5. Show success toast on save
6. Add validation with error messages

Use Shadcn components: Card, Form, Input, Checkbox, RadioGroup, Select, Textarea, Button, toast.

Style: Match the dashboard card style, max-w-2xl centered.
  </action>
  <verify>
- npm run build succeeds
- Page renders at /profile/investor
  </verify>
  <done>Investor profile form saves and loads data from Convex</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] investorProfiles table in schema
- [ ] getMyProfile query works
- [ ] upsertProfile mutation validates and saves
- [ ] Form loads existing profile data
- [ ] Form saves new/updated profile
- [ ] Validation errors shown for invalid data
- [ ] `npm run build` succeeds
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Investors can create and edit their investment profile
- Profile data persists in Convex
</success_criteria>

<output>
After completion, create `.planning/phases/03-profiles/03-02-SUMMARY.md`:

# Phase 3 Plan 2: Investor Profile Schema Summary

**[One-liner summarizing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-03-PLAN.md: Service Provider Profile Schema
</output>
