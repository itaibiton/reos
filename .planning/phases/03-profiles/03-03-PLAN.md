---
phase: 03-profiles
plan: 03
type: execute
---

<objective>
Create service provider profile schema and form for broker, mortgage advisor, and lawyer registration.

Purpose: Service providers need business profiles so investors can find and connect with them.
Output: Service provider profiles table in Convex, CRUD functions, profile form page.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-profiles/03-01-SUMMARY.md
@.planning/phases/03-profiles/03-02-SUMMARY.md

**Key files:**
@convex/schema.ts
@convex/users.ts
@convex/investorProfiles.ts

**Prior decisions:**
- Phase 2: Service provider roles: broker, mortgage_advisor, lawyer
- Phase 3-02: Pattern established for profile tables

**Service provider requirements (from PROJECT.md):**
- Business information (company name, license info)
- Specializations
- Service areas (locations they serve)
- Experience/credentials
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add serviceProviderProfiles table to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add serviceProviderProfiles table with fields:

```typescript
serviceProviderProfiles: defineTable({
  // Reference to user
  userId: v.id("users"),

  // Provider type (mirrors user role, but explicit for queries)
  providerType: v.union(
    v.literal("broker"),
    v.literal("mortgage_advisor"),
    v.literal("lawyer")
  ),

  // Business information
  companyName: v.optional(v.string()),
  licenseNumber: v.optional(v.string()),
  yearsExperience: v.optional(v.number()),

  // Specializations (depends on provider type)
  specializations: v.array(v.string()),

  // Service areas (Israeli cities/regions they cover)
  serviceAreas: v.array(v.string()),

  // Languages spoken
  languages: v.array(v.union(
    v.literal("english"),
    v.literal("hebrew"),
    v.literal("russian"),
    v.literal("french"),
    v.literal("spanish")
  )),

  // Bio/description
  bio: v.optional(v.string()),

  // Contact preferences
  phoneNumber: v.optional(v.string()),
  preferredContact: v.optional(v.union(
    v.literal("email"),
    v.literal("phone"),
    v.literal("whatsapp")
  )),

  // Timestamps
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_provider_type", ["providerType"])
  .index("by_service_area", ["serviceAreas"])
```

One profile per service provider.
  </action>
  <verify>npx convex dev shows schema updated without errors</verify>
  <done>serviceProviderProfiles table defined with fields and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create service provider profile mutations and queries</name>
  <files>convex/serviceProviderProfiles.ts</files>
  <action>
Create convex/serviceProviderProfiles.ts with:

1. `getMyProfile` query:
   - Get current user's service provider profile
   - Returns null if no profile exists
   - Only works for authenticated service providers (broker, mortgage_advisor, lawyer)

2. `upsertProfile` mutation:
   - Create or update service provider profile
   - Args: all profile fields (except userId, timestamps)
   - Validates user is authenticated and has service provider role
   - Sets providerType from user's role automatically

3. `getProvidersByType` query:
   - List service providers by type (for future marketplace)
   - Args: providerType, optional serviceArea filter
   - Returns basic info: name, company, serviceAreas, languages

4. Helper constants for specializations by provider type:
   - Broker: residential, commercial, luxury, new_construction, investment
   - Mortgage Advisor: first_time_buyers, refinancing, investment_properties, foreign_nationals
   - Lawyer: real_estate_transactions, contracts, due_diligence, tax_planning

Validation:
- At least one service area required
- At least one language required
  </action>
  <verify>npx convex dev shows functions registered</verify>
  <done>Service provider profile functions working</done>
</task>

<task type="auto">
  <name>Task 3: Create service provider profile form page</name>
  <files>src/app/(app)/profile/provider/page.tsx</files>
  <action>
Create service provider profile form at /profile/provider:

1. Load existing profile with useQuery(api.serviceProviderProfiles.getMyProfile)
2. Get user's role to show role-specific specializations
3. Form sections:
   - Company Name: Text input
   - License Number: Text input (optional)
   - Years of Experience: Number input
   - Specializations: Checkbox group (options based on provider type)
   - Service Areas: Multi-select (Tel Aviv, Jerusalem, Haifa, Netanya, etc.)
   - Languages: Checkbox group (English, Hebrew, Russian, French, Spanish)
   - Bio: Textarea for description
   - Phone Number: Text input
   - Preferred Contact: Radio group (Email, Phone, WhatsApp)

4. Pre-fill form if profile exists
5. Submit calls upsertProfile mutation
6. Show success toast on save
7. Validation with error messages

Use Shadcn components matching investor profile style.

Note: User's role determines which specializations are shown. Display role prominently at top (e.g., "Broker Profile").
  </action>
  <verify>
- npm run build succeeds
- Page renders at /profile/provider
  </verify>
  <done>Service provider profile form saves and loads data from Convex</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] serviceProviderProfiles table in schema
- [ ] getMyProfile query works for service providers
- [ ] upsertProfile mutation validates and saves
- [ ] getProvidersByType query works
- [ ] Form loads existing profile data
- [ ] Form shows role-specific specializations
- [ ] `npm run build` succeeds
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Service providers can create and edit their business profile
- Specializations are role-appropriate
- Profile data persists in Convex
</success_criteria>

<output>
After completion, create `.planning/phases/03-profiles/03-03-SUMMARY.md`:

# Phase 3 Plan 3: Service Provider Profile Schema Summary

**[One-liner summarizing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-04-PLAN.md: Profile Settings Page
</output>
