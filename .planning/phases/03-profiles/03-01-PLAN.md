---
phase: 03-profiles
plan: 01
type: execute
---

<objective>
Create onboarding flow that captures user role selection and redirects incomplete users.

Purpose: Users must select their role (investor or service provider type) before accessing the app.
Output: Onboarding page with role selection, automatic redirect for incomplete onboarding.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-02-SUMMARY.md
@.planning/phases/02-authentication/02-03-SUMMARY.md

**Key files:**
@convex/schema.ts
@convex/users.ts
@src/hooks/useCurrentUser.ts
@src/app/(app)/layout.tsx

**Prior decisions:**
- Phase 2: Role is optional until onboarding complete
- Phase 2: User auto-created with onboardingComplete: false
- Phase 2: setUserRole mutation marks onboardingComplete: true
- Phase 2: Route groups: (main) public, (auth) auth, (app) protected

**Tech available:**
- Convex mutations/queries
- useCurrentUser hook
- Shadcn components (Card, Button, RadioGroup)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding page with role selection</name>
  <files>src/app/(app)/onboarding/page.tsx</files>
  <action>
Create onboarding page at /onboarding that:
1. Shows welcome message and explains role selection
2. Uses RadioGroup to select role: Investor, Broker, Mortgage Advisor, Lawyer
3. On submit, calls setUserRole mutation
4. After success, redirects to /dashboard using router.push

UI structure:
- Centered card layout (like auth pages but within AppShell)
- Card with title "Complete Your Profile"
- Description explaining each role briefly
- RadioGroup with 4 options (use icons from Hugeicons if appropriate)
- Submit button "Continue"
- Loading state while submitting

Use useCurrentUser to check if already onboarded - if so, redirect to /dashboard immediately.
  </action>
  <verify>
- File exists at src/app/(app)/onboarding/page.tsx
- npm run build succeeds
  </verify>
  <done>Onboarding page renders role selection form</done>
</task>

<task type="auto">
  <name>Task 2: Redirect incomplete onboarding in app layout</name>
  <files>src/app/(app)/layout.tsx</files>
  <action>
Update the (app) layout to check onboarding status:

1. After auth is confirmed, check if user.onboardingComplete is false
2. If incomplete AND not already on /onboarding, redirect to /onboarding
3. Use usePathname() to check current route
4. Allow /onboarding to render without redirect loop

Flow:
- isLoading → show spinner
- !isAuthenticated → redirect to /sign-in (existing)
- isAuthenticated && !user → show spinner (user loading)
- isAuthenticated && user && !onboardingComplete && path !== '/onboarding' → redirect to /onboarding
- Otherwise → render AppShell with children

Important: Must wait for user data to load before checking onboardingComplete.
  </action>
  <verify>
- npm run build succeeds
- No redirect loop on /onboarding page
  </verify>
  <done>Incomplete onboarding users redirected to /onboarding from any protected route</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete onboarding flow with role selection</what-built>
  <how-to-verify>
    1. Run: npm run dev (and npx convex dev)
    2. Sign out if signed in
    3. Sign up with new account at /sign-up
    4. Verify: After sign-up, redirected to /onboarding (not dashboard)
    5. Select: "Investor" role
    6. Click: "Continue"
    7. Verify: Redirected to /dashboard
    8. Verify: Dashboard shows role as "investor"
    9. Visit: /onboarding directly
    10. Verify: Redirected to /dashboard (already onboarded)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Onboarding page exists and renders correctly
- [ ] Role selection works with all 4 options
- [ ] setUserRole mutation is called on submit
- [ ] Incomplete users redirected to /onboarding
- [ ] Completed users can access /dashboard
- [ ] No redirect loops
- [ ] `npm run build` succeeds
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- New users must complete onboarding before accessing app
- Role selection persists in Convex
</success_criteria>

<output>
After completion, create `.planning/phases/03-profiles/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Onboarding Flow Summary

**[One-liner summarizing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-02-PLAN.md: Investor Profile Schema
</output>
