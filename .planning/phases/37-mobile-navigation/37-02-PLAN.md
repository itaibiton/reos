---
phase: 37-mobile-navigation
plan: 02
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - src/components/layout/MobileBottomNav.tsx
autonomous: true

must_haves:
  truths:
    - "Tab bar shows 5 role-specific tabs"
    - "Active tab has visual indicator (filled icon, color highlight, top bar)"
    - "Chat tab shows badge when unread count > 0"
    - "Tab bar hidden on desktop (md:hidden)"
    - "Tab bar respects iOS safe area (content above home indicator)"
    - "Tab transitions animate smoothly"
  artifacts:
    - path: "src/components/layout/MobileBottomNav.tsx"
      provides: "Role-aware bottom tab navigation with animations and badges"
      min_lines: 80
  key_links:
    - from: "src/components/layout/MobileBottomNav.tsx"
      to: "getMobileTabsForRole"
      via: "import from navigation.ts"
      pattern: "import.*getMobileTabsForRole.*from.*navigation"
    - from: "src/components/layout/MobileBottomNav.tsx"
      to: "api.directMessages.getTotalUnreadCount"
      via: "useQuery for unread badge"
      pattern: "useQuery.*directMessages.*getTotalUnreadCount"
---

<objective>
Refactor MobileBottomNav to be role-aware with animations and badges

Purpose: Transform the hardcoded MobileBottomNav into a dynamic, role-based component with smooth animations (NAV-01 through NAV-07)
Output: Complete MobileBottomNav.tsx with role-based tabs, framer-motion animations, unread badges, and safe-area handling
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.5-ROADMAP.md
@.planning/phases/37-mobile-navigation/37-RESEARCH.md
@src/components/layout/MobileBottomNav.tsx
@src/lib/navigation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor MobileBottomNav with role-based navigation</name>
  <files>src/components/layout/MobileBottomNav.tsx</files>
  <action>
Replace the entire MobileBottomNav.tsx with a new implementation:

1. Update imports:
   - Remove hardcoded icon imports (Home01Icon, Building02Icon, FavouriteIcon, etc.)
   - Add: framer-motion (motion)
   - Add: getMobileTabsForRole, UserRole, MobileTabItem from "@/lib/navigation"
   - Add: useCurrentUser from "@/hooks/useCurrentUser"
   - Add: useTranslations from "next-intl"
   - Add: Badge from "@/components/ui/badge"
   - Add: useQuery from "convex/react"
   - Add: api from convex/_generated/api

2. Remove hardcoded navItems array

3. Inside component:
   - Get effectiveRole from useCurrentUser()
   - Get translations via useTranslations()
   - Fetch chat unread count: useQuery(api.directMessages.getTotalUnreadCount)
   - Get tabs: getMobileTabsForRole((effectiveRole as UserRole) ?? "investor")

4. Render structure:
```tsx
<nav className="fixed bottom-0 inset-x-0 z-50 border-t bg-background md:hidden safe-area-bottom">
  <div className="flex items-center justify-around py-2">
    {tabs.map((tab) => {
      const isActive = pathname === tab.href || pathname.startsWith(tab.href + "/");
      const unreadCount = tab.showBadge === "chat" ? chatUnread : 0;

      return (
        <Link
          key={tab.href}
          href={tab.href}
          className={cn(
            "relative flex flex-col items-center justify-center gap-0.5 px-3 py-1.5 min-w-[60px]",
            isActive ? "text-primary" : "text-muted-foreground"
          )}
        >
          {/* Active indicator bar */}
          {isActive && (
            <motion.div
              layoutId="activeTab"
              className="absolute -top-2 left-1/2 -translate-x-1/2 h-0.5 w-6 bg-primary rounded-full"
              transition={{ type: "spring", stiffness: 300, damping: 30 }}
            />
          )}

          <div className="relative">
            <HugeiconsIcon
              icon={tab.hugeIcon}
              size={22}
              strokeWidth={isActive ? 2 : 1.5}
            />
            {/* Unread badge */}
            {unreadCount > 0 && (
              <Badge
                variant="destructive"
                className="absolute -top-1.5 -end-2 h-4 min-w-4 px-1 text-[10px] flex items-center justify-center"
              >
                {unreadCount > 99 ? "99+" : unreadCount}
              </Badge>
            )}
          </div>

          <span className="text-[10px] font-medium">{t(tab.labelKey)}</span>
        </Link>
      );
    })}
  </div>
</nav>
```

Key changes from current implementation:
- `pb-safe` -> `safe-area-bottom` (fix research-identified bug)
- Add framer-motion layoutId for active indicator animation (NAV-07)
- Add Badge component for unread count (NAV-05)
- Use getMobileTabsForRole for role-based tabs (NAV-02, NAV-03)
- Add active indicator bar at top of icon (NAV-04)
- Use `inset-x-0` instead of `left-0 right-0` for brevity
  </action>
  <verify>
1. TypeScript compiles:
```bash
npx tsc --noEmit src/components/layout/MobileBottomNav.tsx
```

2. Verify component uses correct classes:
```bash
grep -q "safe-area-bottom" src/components/layout/MobileBottomNav.tsx && echo "OK: safe-area-bottom" || echo "FAIL: safe-area-bottom missing"
grep -q "md:hidden" src/components/layout/MobileBottomNav.tsx && echo "OK: md:hidden" || echo "FAIL: md:hidden missing"
grep -q "layoutId" src/components/layout/MobileBottomNav.tsx && echo "OK: layoutId" || echo "FAIL: layoutId missing"
```
  </verify>
  <done>
- MobileBottomNav uses getMobileTabsForRole for role-based navigation
- Active tab shows visual indicator (colored text, thicker icon stroke, animated top bar)
- Badge displays unread count on Chat tab when > 0
- Uses safe-area-bottom class (not pb-safe)
- Hidden on desktop via md:hidden
- Framer-motion layoutId animates active indicator between tabs
  </done>
</task>

</tasks>

<verification>
- [ ] Component imports getMobileTabsForRole from navigation.ts
- [ ] Component uses useCurrentUser for effectiveRole
- [ ] Component queries directMessages.getTotalUnreadCount
- [ ] Uses safe-area-bottom class (not pb-safe)
- [ ] Has md:hidden to hide on desktop
- [ ] Has motion.div with layoutId="activeTab" for animation
- [ ] Badge component used for unread count display
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
1. MobileBottomNav shows role-specific tabs (investor: 5 tabs, provider: 5 different tabs)
2. Active tab has visual indicator with animated transition
3. Chat tab shows unread badge when messages exist
4. Safe area respected (content not behind home indicator)
5. Tab bar hidden on desktop (md:hidden)
</success_criteria>

<output>
After completion, create `.planning/phases/37-mobile-navigation/37-02-SUMMARY.md`
</output>
