---
phase: 16.3-shadcn-sidebar-layout
plan: 01
type: execute
domain: next-js
---

<objective>
Replace custom Sidebar with Shadcn Sidebar component featuring role-based collapsible navigation groups.

Purpose: Standardize layout using Shadcn's sidebar primitives with proper mobile/desktop handling, collapsible groups, and keyboard shortcuts.
Output: Working Shadcn sidebar with all 8 role navigation structures.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@sidebar-routes.md
@src/components/ui/sidebar.tsx
@src/components/layout/Sidebar.tsx
@src/components/layout/AppShell.tsx
@src/hooks/useCurrentUser.ts

**Prior decisions:**
- Phase 16.1: Removed Dashboard from investor sidebar, investors redirect to /properties
- Phase 16.1: Provider sidebar spans full height with logo, header inline in main content
- Phase 5.2: effectiveRole = viewingAsRole ?? role pattern for role-aware UI
- Phase 1.1: Hugeicons for custom components, lucide-react for Shadcn internals

**Navigation Structure (from sidebar-routes.md):**

8 roles: investor, broker, mortgage_advisor, lawyer, accountant, notary, tax_consultant, appraiser

Each role has specific groups:
- Investor: Marketplace (3 items), Chat, Profile, Settings
- Broker: Dashboard, Marketplace (4 items), Property Management (3 items), Clients, Chat, Profile, Settings
- Mortgage Advisor: Dashboard, Marketplace (3 items), Mortgage Requests (3 items), Clients, Chat, Profile, Settings
- Lawyer: Dashboard, Marketplace (3 items), Legal Services (3 items), Clients, Chat, Profile, Settings
- Accountant: Dashboard, Marketplace (3 items), Accounting Services (3 items), Clients, Chat, Profile, Settings
- Notary: Dashboard, Marketplace (3 items), Notarization Services (3 items), Clients, Chat, Profile, Settings
- Tax Consultant: Dashboard, Marketplace (3 items), Tax Services (3 items), Clients, Chat, Profile, Settings
- Appraiser: Dashboard, Marketplace (3 items), Appraisal Services (3 items), Clients, Chat, Profile, Settings
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create navigation config with role-based route definitions</name>
  <files>src/lib/navigation.ts</files>
  <action>
Create navigation configuration with:

1. Define types:
```typescript
type NavItem = {
  label: string;
  href: string;
  icon: LucideIcon;
  items?: NavItem[]; // For sub-items in collapsible groups
};

type RoleNavigation = {
  groups: {
    label?: string; // Optional group label (e.g., "Marketplace", "Property Management")
    items: NavItem[];
  }[];
};

type NavigationConfig = Record<UserRole, RoleNavigation>;
```

2. Create navigation config for each role per sidebar-routes.md:

**Investor:**
- Group 1 (Marketplace): Browse Properties (/properties), Saved Properties (/properties?favorites=true), Deals (/deals)
- Single items: Chat (/chat), Profile (/profile/investor), Settings (/settings)

**Broker:**
- Single: Dashboard (/dashboard)
- Group (Marketplace): Browse Properties, Saved Properties, Your Listings (/properties/listings), Deals
- Group (Property Management): Listings (/properties/listings), Property Tours (/properties/tours), Lead Management (/leads)
- Single items: Clients (/clients), Chat, Profile (/profile/provider), Settings

**Mortgage Advisor:**
- Single: Dashboard
- Group (Marketplace): Browse Properties, Saved Properties, Deals
- Group (Mortgage Requests): New Applications (/mortgage/applications), Pre-approvals (/mortgage/pre-approvals), Financing Deals (/mortgage/deals)
- Single items: Clients, Chat, Profile, Settings

**Lawyer:**
- Single: Dashboard
- Group (Marketplace): Browse Properties, Saved Properties, Deals
- Group (Legal Services): Consultation Requests (/legal/consultations), Contract Reviews (/legal/contracts), Transaction Documents (/legal/documents)
- Single items: Clients, Chat, Profile, Settings

**Accountant:**
- Single: Dashboard
- Group (Marketplace): Browse Properties, Saved Properties, Deals
- Group (Accounting Services): Consultation Requests (/accounting/consultations), Financial Analysis (/accounting/analysis), Tax Planning (/accounting/tax-planning)
- Single items: Clients, Chat, Profile, Settings

**Notary:**
- Single: Dashboard
- Group (Marketplace): Browse Properties, Saved Properties, Deals
- Group (Notarization Services): Notarization Requests (/notary/requests), Document Signings (/notary/signings), Transaction Notarizations (/notary/transactions)
- Single items: Clients, Chat, Profile, Settings

**Tax Consultant:**
- Single: Dashboard
- Group (Marketplace): Browse Properties, Saved Properties, Deals
- Group (Tax Services): Consultation Requests (/tax/consultations), Tax Filing Requests (/tax/filings), Tax Planning (/tax/planning)
- Single items: Clients, Chat, Profile, Settings

**Appraiser:**
- Single: Dashboard
- Group (Marketplace): Browse Properties, Saved Properties, Deals
- Group (Appraisal Services): Appraisal Requests (/appraisal/requests), Property Valuations (/appraisal/valuations), Valuation Reports (/appraisal/reports)
- Single items: Clients, Chat, Profile, Settings

**Admin:** Same as broker plus any admin-only items.

Use lucide-react icons (Shadcn standard):
- Home for Dashboard
- Building2 for Marketplace/Properties
- Heart for Saved/Favorites
- Building for Your Listings
- Handshake for Deals
- CalendarDays for Tours
- Users for Lead Management/Clients
- FileText for documents/contracts
- Calculator for mortgage/financial
- Scale for legal
- Stamp for notary
- Receipt for tax
- ClipboardCheck for appraisal
- MessageSquare for Chat
- UserCircle for Profile
- Settings for Settings

Export: `getNavigationForRole(role: UserRole): RoleNavigation`
  </action>
  <verify>TypeScript compiles with no errors: npx tsc --noEmit</verify>
  <done>Navigation config exports getNavigationForRole function that returns correct structure for each role</done>
</task>

<task type="auto">
  <name>Task 2: Replace Sidebar.tsx with Shadcn sidebar implementation</name>
  <files>src/components/layout/Sidebar.tsx</files>
  <action>
Replace entire Sidebar component using Shadcn sidebar primitives:

1. Import from @/components/ui/sidebar:
- Sidebar, SidebarContent, SidebarHeader, SidebarFooter
- SidebarGroup, SidebarGroupLabel, SidebarGroupContent
- SidebarMenu, SidebarMenuItem, SidebarMenuButton
- SidebarMenuSub, SidebarMenuSubItem, SidebarMenuSubButton
- SidebarRail, useSidebar

2. Import from @/lib/navigation: getNavigationForRole

3. Component structure:
```tsx
export function AppSidebar() {
  const { effectiveRole, isLoading } = useCurrentUser();
  const pathname = usePathname();

  // Get navigation for current role
  const navigation = effectiveRole
    ? getNavigationForRole(effectiveRole)
    : getNavigationForRole("investor"); // Default for loading state

  return (
    <Sidebar collapsible="icon">
      <SidebarHeader>
        <SidebarMenu>
          <SidebarMenuItem>
            <SidebarMenuButton size="lg" asChild>
              <Link href="/">
                <div className="flex aspect-square size-8 items-center justify-center rounded-lg bg-sidebar-primary text-sidebar-primary-foreground">
                  <BlackHoleIcon className="size-4" />
                </div>
                <div className="grid flex-1 text-left text-sm leading-tight">
                  <span className="truncate font-semibold">REOS</span>
                  <span className="truncate text-xs">Real Estate OS</span>
                </div>
              </Link>
            </SidebarMenuButton>
          </SidebarMenuItem>
        </SidebarMenu>
      </SidebarHeader>

      <SidebarContent>
        {navigation.groups.map((group, i) => (
          <SidebarGroup key={i}>
            {group.label && <SidebarGroupLabel>{group.label}</SidebarGroupLabel>}
            <SidebarGroupContent>
              <SidebarMenu>
                {group.items.map((item) => (
                  <SidebarMenuItem key={item.href}>
                    {item.items ? (
                      // Collapsible menu item with sub-items
                      <Collapsible defaultOpen className="group/collapsible">
                        <CollapsibleTrigger asChild>
                          <SidebarMenuButton tooltip={item.label}>
                            <item.icon />
                            <span>{item.label}</span>
                            <ChevronRight className="ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90" />
                          </SidebarMenuButton>
                        </CollapsibleTrigger>
                        <CollapsibleContent>
                          <SidebarMenuSub>
                            {item.items.map((subItem) => (
                              <SidebarMenuSubItem key={subItem.href}>
                                <SidebarMenuSubButton asChild isActive={pathname === subItem.href}>
                                  <Link href={subItem.href}>
                                    <span>{subItem.label}</span>
                                  </Link>
                                </SidebarMenuSubButton>
                              </SidebarMenuSubItem>
                            ))}
                          </SidebarMenuSub>
                        </CollapsibleContent>
                      </Collapsible>
                    ) : (
                      // Simple menu item
                      <SidebarMenuButton asChild isActive={pathname === item.href} tooltip={item.label}>
                        <Link href={item.href}>
                          <item.icon />
                          <span>{item.label}</span>
                        </Link>
                      </SidebarMenuButton>
                    )}
                  </SidebarMenuItem>
                ))}
              </SidebarMenu>
            </SidebarGroupContent>
          </SidebarGroup>
        ))}
      </SidebarContent>

      <SidebarFooter>
        {/* User info + logout can go here */}
      </SidebarFooter>

      <SidebarRail />
    </Sidebar>
  );
}
```

4. Use Collapsible from @/components/ui/collapsible for groups with sub-items.

5. Handle loading state with SidebarMenuSkeleton.

6. isActive should check pathname === href OR pathname.startsWith(href + "/") for nested routes.

Keep the component focused on rendering the sidebar - state management moves to AppShell.
  </action>
  <verify>npx tsc --noEmit passes. Visual check: sidebar renders with groups.</verify>
  <done>AppSidebar component renders role-based navigation with collapsible groups</done>
</task>

<task type="auto">
  <name>Task 3: Update AppShell to use SidebarProvider</name>
  <files>src/components/layout/AppShell.tsx</files>
  <action>
Refactor AppShell to use Shadcn SidebarProvider:

1. Import from @/components/ui/sidebar: SidebarProvider, SidebarInset, SidebarTrigger

2. Remove old sidebar state management (isSidebarOpen, isSidebarCollapsed, localStorage).

3. Two layout modes:

**Investor layout (no sidebar):**
```tsx
if (isInvestorLayout) {
  return (
    <div className="h-screen flex flex-col bg-background">
      <Header showTopNav={true} />
      {/* ... rest of investor layout unchanged ... */}
    </div>
  );
}
```

**Provider layout (Shadcn sidebar):**
```tsx
return (
  <SidebarProvider>
    <AppSidebar />
    <SidebarInset>
      <header className="flex h-16 shrink-0 items-center gap-2 border-b px-4">
        <SidebarTrigger className="-ml-1" />
        <Separator orientation="vertical" className="mr-2 h-4" />
        {/* User menu, etc from Header */}
      </header>
      <main className={isFullBleedPage ? "" : "p-6"}>
        {children}
      </main>
    </SidebarInset>
  </SidebarProvider>
);
```

4. Move user dropdown from Header into the inline header section or keep Header simplified.

5. Keyboard shortcut Cmd+B to toggle sidebar is built into SidebarProvider.

6. Cookie persistence is automatic in SidebarProvider (sidebar_state cookie).

7. Mobile: Sidebar automatically uses Sheet component on mobile via Shadcn primitives.
  </action>
  <verify>npm run dev - check both investor and provider layouts work. Sidebar toggle works on desktop. Mobile shows sheet drawer.</verify>
  <done>AppShell uses SidebarProvider for providers, investor layout unchanged</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] Provider sidebar shows collapsible groups with role-specific items
- [ ] Investor layout shows top nav (no sidebar)
- [ ] Cmd+B toggles sidebar on desktop
- [ ] Mobile shows sidebar as sheet drawer
- [ ] Active state highlights current page
</verification>

<success_criteria>

- Navigation config covers all 8 roles
- Shadcn sidebar replaces custom sidebar
- AppShell properly wraps with SidebarProvider
- Collapsible groups work for menu sections
- Mobile responsive behavior works
</success_criteria>

<output>
After completion, create `.planning/phases/16.3-shadcn-sidebar-layout/16.3-01-SUMMARY.md`
</output>
