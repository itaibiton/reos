---
phase: 43-dream-team-builder
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ai/ProviderRecommendationCard.tsx
  - src/components/ai/ProviderDetailModal.tsx
  - src/components/ai/hooks/useProviderAdd.ts
  - convex/teamManagement.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Provider card shows photo, name, role, rating, availability"
    - "User can tap card to open full profile modal"
    - "User can click Add button to add provider to team"
    - "Card shows 'On Team' badge if provider already assigned"
    - "Toast confirms when provider added to team"
  artifacts:
    - path: "src/components/ai/ProviderRecommendationCard.tsx"
      provides: "Compact provider card with Add button"
      min_lines: 80
    - path: "src/components/ai/ProviderDetailModal.tsx"
      provides: "Full provider profile modal"
      min_lines: 50
    - path: "src/components/ai/hooks/useProviderAdd.ts"
      provides: "Hook for add provider mutation with toast"
      exports: ["useProviderAdd"]
    - path: "convex/teamManagement.ts"
      provides: "Mutations for adding/checking team members"
      exports: ["addProviderToTeam", "isProviderOnTeam"]
  key_links:
    - from: "src/components/ai/ProviderRecommendationCard.tsx"
      to: "src/components/ai/hooks/useProviderAdd.ts"
      via: "hook import"
      pattern: "useProviderAdd"
    - from: "src/components/ai/hooks/useProviderAdd.ts"
      to: "convex/teamManagement.ts"
      via: "useMutation"
      pattern: "api\\.teamManagement\\.addProviderToTeam"
---

<objective>
Create provider recommendation UI components and team management

Purpose: Build compact provider cards for chat display, detail modal for full profiles, and Add button with team management backend.
Output: ProviderRecommendationCard, ProviderDetailModal, useProviderAdd hook, teamManagement mutations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-dream-team-builder/43-CONTEXT.md
@.planning/phases/43-dream-team-builder/43-RESEARCH.md
@.planning/phases/42-property-recommendations/42-02-SUMMARY.md

Reference files:
@src/components/ai/PropertyRecommendationCard.tsx (pattern to follow)
@src/components/ai/PropertyDetailModal.tsx (pattern to follow)
@src/components/ai/hooks/usePropertySave.ts (pattern to follow)
@convex/deals.ts (existing deal queries to understand structure)
@convex/schema.ts (deals table with brokerId, mortgageAdvisorId, lawyerId)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create team management mutations</name>
  <files>convex/teamManagement.ts</files>
  <action>
Create new file for team management:

1. Import v from convex/values, mutation, query from ./_generated/server

2. Export `addProviderToTeam` mutation:
   - args:
     - providerId: v.id("users")
     - providerType: v.union(v.literal("broker"), v.literal("mortgage_advisor"), v.literal("lawyer"))
     - dealId: v.optional(v.id("deals"))
   - Get authenticated user, verify investor role
   - Find target deal:
     - If dealId provided, use that deal
     - Otherwise, find first active deal (not completed, not cancelled) for investor
     - If no active deal exists: throw Error("No active deal. Please save a property first to start building your team.")
   - Map providerType to field: broker -> brokerId, mortgage_advisor -> mortgageAdvisorId, lawyer -> lawyerId
   - Check if role already filled on deal, throw if so: "A {role} is already assigned to this deal"
   - Patch deal with provider assignment
   - Insert dealActivity record with full structure:
     ```typescript
     await ctx.db.insert("dealActivity", {
       dealId: deal._id,
       actorId: user._id,
       activityType: "provider_assigned",
       details: {
         providerId: args.providerId,
         providerType: args.providerType,
       },
       createdAt: Date.now(),
     });
     ```
   - Return { success: true, dealId }

3. Export `isProviderOnTeam` query:
   - args: providerId: v.id("users"), providerType: same union
   - Get authenticated user
   - Query all active deals for investor
   - Check if providerId matches the relevant field on any deal
   - Return boolean

4. Export `getActiveDealsWithProviders` query:
   - args: none
   - Get authenticated user (investor)
   - Return active deals with provider assignments for checking "On Team" status
  </action>
  <verify>npx convex dev --once shows "Convex functions ready" with no type errors</verify>
  <done>Team management mutations ready for provider assignment</done>
</task>

<task type="auto">
  <name>Task 2: Create useProviderAdd hook</name>
  <files>src/components/ai/hooks/useProviderAdd.ts</files>
  <action>
Create new file following usePropertySave.ts pattern:

1. "use client" directive at top
2. Import useState from react, useMutation, useQuery from convex/react
3. Import api from ../../../../convex/_generated/api
4. Import Id from ../../../../convex/_generated/dataModel
5. Import toast from sonner

6. Export function useProviderAdd(providerId: Id<"users">, providerType: "broker" | "mortgage_advisor" | "lawyer"):
   - const [isAdding, setIsAdding] = useState(false)
   - const addProvider = useMutation(api.teamManagement.addProviderToTeam)
   - const activeDeals = useQuery(api.teamManagement.getActiveDealsWithProviders)

   - Compute isOnTeam from activeDeals:
     ```typescript
     const isOnTeam = activeDeals?.some((deal) => {
       if (providerType === "broker") return deal.brokerId === providerId;
       if (providerType === "mortgage_advisor") return deal.mortgageAdvisorId === providerId;
       if (providerType === "lawyer") return deal.lawyerId === providerId;
       return false;
     }) ?? false;
     ```

   - async function addToTeam():
     - if (isOnTeam) return
     - setIsAdding(true)
     - try { await addProvider({ providerId, providerType }) }
     - toast.success("Added to your team", { description: "You can now contact this provider about your deal" })
     - catch (error): toast.error("Couldn't add provider", { description: error message })
     - finally: setIsAdding(false)

   - Return { isOnTeam, isAdding, addToTeam }
  </action>
  <verify>npx tsc --noEmit passes for this file</verify>
  <done>Hook returns isOnTeam state and addToTeam function with toast feedback</done>
</task>

<task type="auto">
  <name>Task 3: Create ProviderRecommendationCard component</name>
  <files>src/components/ai/ProviderRecommendationCard.tsx</files>
  <action>
Create new file following PropertyRecommendationCard pattern:

1. "use client" directive
2. Imports:
   - useState from react
   - HugeiconsIcon from @hugeicons/react
   - UserIcon, StarIcon, CheckmarkCircle02Icon from @hugeicons/core-free-icons
   - Card, CardContent from @/components/ui/card
   - Badge from @/components/ui/badge
   - Button from @/components/ui/button
   - Id from ../../../convex/_generated/dataModel
   - ProviderDetailModal (will create in Task 4)
   - useProviderAdd from ./hooks/useProviderAdd

3. Export interface ProviderData:
   ```typescript
   export interface ProviderData {
     _id: Id<"users">;
     name: string;
     imageUrl?: string;
     providerType: "broker" | "mortgage_advisor" | "lawyer";
     companyName?: string;
     yearsExperience: number;
     specializations: string[];
     serviceAreas: string[];
     languages: string[];
     avgRating: number;
     totalReviews: number;
     completedDeals: number;
     acceptingNewClients: boolean;
   }
   ```

4. Export interface SearchCriteria (for match context):
   ```typescript
   export interface ProviderSearchCriteria {
     roles?: string[];
     serviceAreas?: string[];
     languages?: string[];
   }
   ```

5. Export function ProviderRecommendationCard({ provider, searchCriteria }):
   - const [modalOpen, setModalOpen] = useState(false)
   - const { isOnTeam, isAdding, addToTeam } = useProviderAdd(provider._id, provider.providerType)

   - Format role display: providerType.split("_").map(w => capitalize).join(" ")
   - availabilityText: acceptingNewClients ? "Available now" : "Not accepting clients"

   - handleAddClick: stopPropagation, call addToTeam()

   - Return compact Card (onClick opens modal):
     - Left: 48x48 rounded-full photo or UserIcon placeholder
     - Center: name (truncate), company/role (truncate), rating + availability row, brief stats line
     - Right: "On Team" badge (if isOnTeam) OR "Add" Button (if not)

   - Include ProviderDetailModal with open/onOpenChange

Card layout should match Phase 43 context decisions:
- Compact: photo, name, role, 1-line match reason
- Star rating visible
- Availability status visible
- Tapping opens modal
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>Compact provider card with photo, rating, availability, and Add/On Team button</done>
</task>

<task type="auto">
  <name>Task 4: Create ProviderDetailModal component</name>
  <files>src/components/ai/ProviderDetailModal.tsx</files>
  <action>
Create new file following PropertyDetailModal pattern:

1. "use client" directive
2. Imports:
   - HugeiconsIcon from @hugeicons/react
   - UserIcon, StarIcon, Location01Icon, LanguageSkillIcon from @hugeicons/core-free-icons
   - Dialog, DialogContent, DialogHeader, DialogTitle from @/components/ui/dialog
   - Badge from @/components/ui/badge
   - Button from @/components/ui/button
   - useQuery from convex/react
   - api from ../../../convex/_generated/api
   - Id from ../../../convex/_generated/dataModel
   - useProviderAdd from ./hooks/useProviderAdd

3. Props:
   - providerId: Id<"users">
   - providerType: "broker" | "mortgage_advisor" | "lawyer"
   - open: boolean
   - onOpenChange: (open: boolean) => void

4. Component:
   - Query provider profile: useQuery(api.serviceProviderProfiles.getByUserId, { userId: providerId })
   - Query user info: useQuery(api.users.getPublicProfile, { userId: providerId })
   - useProviderAdd hook for Add button

   - Return Dialog with:
     - Header: Photo (large), Name, Company, Role badge
     - Body sections:
       - Rating: Stars + count
       - Availability status
       - Service Areas: Badge list
       - Languages: Badge list
       - Specializations: Badge list
       - Experience: X years, Y completed deals
       - Bio (if exists)
     - Footer: Add to Team button (or "On Your Team" badge if already added)

Keep modal focused on provider info. Use existing Dialog component (already has responsive behavior).
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>Full provider profile modal with Add button</done>
</task>

</tasks>

<verification>
After all tasks:
1. npx convex dev --once passes
2. npx tsc --noEmit passes
3. All 4 files created with correct exports
4. teamManagement.ts has addProviderToTeam, getActiveDealsWithProviders
5. useProviderAdd returns { isOnTeam, isAdding, addToTeam }
6. ProviderRecommendationCard shows compact card with Add/On Team
7. ProviderDetailModal shows full profile in dialog
</verification>

<success_criteria>
- teamManagement mutations handle provider assignment with validation
- useProviderAdd hook integrates mutation with toast feedback
- ProviderRecommendationCard displays compact info with Add button
- Card shows "On Team" badge when provider already assigned
- ProviderDetailModal shows full provider profile
- All TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/43-dream-team-builder/43-02-SUMMARY.md`
</output>
