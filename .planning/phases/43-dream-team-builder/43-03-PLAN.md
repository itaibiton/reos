---
phase: 43-dream-team-builder
plan: 03
type: execute
wave: 2
depends_on: ["43-01", "43-02"]
files_modified:
  - src/components/ai/ProviderCardRenderer.tsx
  - src/components/ai/ChatMessage.tsx
  - src/components/ai/index.ts
autonomous: false
user_setup: []

must_haves:
  truths:
    - "AI can suggest providers grouped by role in chat"
    - "Provider cards render inline in chat messages"
    - "Accordion sections group providers by role (Brokers, Advisors, Lawyers)"
    - "All accordion sections start expanded"
    - "User can add providers directly from chat cards"
    - "Loading indicator shows during provider search"
  artifacts:
    - path: "src/components/ai/ProviderCardRenderer.tsx"
      provides: "Extracts and renders provider cards with accordion grouping"
      min_lines: 80
    - path: "src/components/ai/ChatMessage.tsx"
      provides: "Renders both property and provider tool results"
      contains: "ProviderCardRenderer"
    - path: "src/components/ai/index.ts"
      provides: "Barrel exports for provider components"
      contains: "ProviderCardRenderer"
  key_links:
    - from: "src/components/ai/ChatMessage.tsx"
      to: "src/components/ai/ProviderCardRenderer.tsx"
      via: "conditional render"
      pattern: "searchProviders.*ProviderCardRenderer"
    - from: "src/components/ai/ProviderCardRenderer.tsx"
      to: "src/components/ai/ProviderRecommendationCard.tsx"
      via: "import and render"
      pattern: "ProviderRecommendationCard"
---

<objective>
Wire provider tool results into chat UI with accordion grouping

Purpose: Connect the searchProviders tool (Plan 01) and ProviderRecommendationCard (Plan 02) to chat messages, displaying providers grouped by role in collapsible accordion sections.
Output: ProviderCardRenderer component, updated ChatMessage integration, barrel exports.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-dream-team-builder/43-CONTEXT.md
@.planning/phases/43-dream-team-builder/43-RESEARCH.md
@.planning/phases/42-property-recommendations/42-03-SUMMARY.md

Reference files:
@src/components/ai/PropertyCardRenderer.tsx (pattern to follow)
@src/components/ai/ChatMessage.tsx (extend for provider rendering)
@src/components/ai/index.ts (add exports)
@src/components/ui/accordion.tsx (confirm exists for grouping)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProviderCardRenderer component</name>
  <files>src/components/ai/ProviderCardRenderer.tsx</files>
  <action>
Create new file following PropertyCardRenderer pattern:

1. "use client" directive
2. Imports:
   - HugeiconsIcon from @hugeicons/react
   - Loading03Icon from @hugeicons/core-free-icons
   - Accordion, AccordionContent, AccordionItem, AccordionTrigger from @/components/ui/accordion
   - ProviderRecommendationCard, ProviderData, ProviderSearchCriteria from ./ProviderRecommendationCard

3. Define ToolCall interface (same as PropertyCardRenderer):
   ```typescript
   interface ToolCall {
     toolCallId: string;
     toolName: string;
     args: any;
     result?: any;
   }
   ```

4. Props interface:
   ```typescript
   interface ProviderCardRendererProps {
     toolCalls?: ToolCall[];
     isExecuting?: boolean;
   }
   ```

5. Export function ProviderCardRenderer({ toolCalls, isExecuting }):
   - If isExecuting && (no result yet): show loading indicator "Searching providers..."
   - If no toolCalls or empty: return null
   - Find searchProviders tool call
   - If no result: return null

   - Extract from result:
     - providersByRole: Record<string, ProviderData[]>
     - totalCount: number
     - searchCriteria: ProviderSearchCriteria

   - If totalCount === 0: return null

   - roleLabels map:
     ```typescript
     const roleLabels: Record<string, string> = {
       broker: "Brokers",
       mortgage_advisor: "Mortgage Advisors",
       lawyer: "Lawyers",
     };
     ```

   - Get roles with providers for defaultValue
   - Build summary string: "Found X providers: Y brokers, Z advisors, W lawyers"

   - Return JSX:
     ```tsx
     <div className="flex flex-col gap-2 mt-2">
       {/* Summary count */}
       <p className="text-sm text-muted-foreground">
         Found {totalCount} providers: {summary}
       </p>

       {/* Accordion - all sections start expanded */}
       <Accordion
         type="multiple"
         defaultValue={rolesWithProviders}
         className="w-full"
       >
         {Object.entries(providersByRole).map(([role, providers]) => {
           if (providers.length === 0) return null;

           return (
             <AccordionItem key={role} value={role}>
               <AccordionTrigger className="text-base font-semibold">
                 {roleLabels[role] || role} ({providers.length})
               </AccordionTrigger>
               <AccordionContent>
                 <div className="space-y-2">
                   {providers.map((provider) => (
                     <ProviderRecommendationCard
                       key={provider._id}
                       provider={provider}
                       searchCriteria={searchCriteria}
                     />
                   ))}
                 </div>
               </AccordionContent>
             </AccordionItem>
           );
         })}
       </Accordion>
     </div>
     ```
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>ProviderCardRenderer extracts tool results and renders accordion-grouped provider cards</done>
</task>

<task type="auto">
  <name>Task 2: Update ChatMessage for provider rendering</name>
  <files>src/components/ai/ChatMessage.tsx</files>
  <action>
Update existing ChatMessage component to render provider cards:

1. Add import at top:
   ```typescript
   import { ProviderCardRenderer } from "./ProviderCardRenderer";
   ```

2. Find where PropertyCardRenderer is rendered (should be inside assistant message branch)

3. Add ProviderCardRenderer below PropertyCardRenderer:
   ```tsx
   {/* Property recommendations */}
   {role === "assistant" && toolCalls && toolCalls.length > 0 && (
     <>
       <PropertyCardRenderer
         toolCalls={toolCalls}
         isExecuting={isStreaming && !toolCalls.some(t => t.toolName === "searchProperties" && t.result)}
       />
       <ProviderCardRenderer
         toolCalls={toolCalls}
         isExecuting={isStreaming && !toolCalls.some(t => t.toolName === "searchProviders" && t.result)}
       />
     </>
   )}
   ```

   Note: Each renderer checks for its specific tool (searchProperties vs searchProviders), so both can be present but only the relevant one renders.

4. Verify isStreaming logic works for both tools - show loading when streaming and no result yet
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>ChatMessage renders both property and provider cards from tool results</done>
</task>

<task type="auto">
  <name>Task 3: Update barrel exports</name>
  <files>src/components/ai/index.ts</files>
  <action>
Add exports for new provider components:

1. Read current index.ts content
2. Add exports for Plan 02 and 03 components:
   ```typescript
   export { ProviderRecommendationCard } from "./ProviderRecommendationCard";
   export type { ProviderData, ProviderSearchCriteria } from "./ProviderRecommendationCard";
   export { ProviderDetailModal } from "./ProviderDetailModal";
   export { ProviderCardRenderer } from "./ProviderCardRenderer";
   export { useProviderAdd } from "./hooks/useProviderAdd";
   ```

Keep existing exports intact. Add provider exports after property exports for organization.
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>All provider components exported from barrel file</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Provider recommendations feature end-to-end:
- AI searchProviders tool searches database for matching providers
- ProviderCardRenderer displays results in accordion sections by role
- Compact provider cards show photo, name, rating, availability
- Add button assigns provider to investor's team
- Toast confirms team assignment
- Modal shows full provider profile on card click
  </what-built>
  <how-to-verify>
1. Open browser to the AI chat interface (http://localhost:3000/investor/chat or wherever AIChatPanel is mounted)
2. As an investor with an active deal (has saved a property), ask: "Help me build my dream team"
3. Verify:
   - Loading indicator shows "Searching providers..." briefly
   - Providers appear grouped by role (Brokers, Mortgage Advisors, Lawyers sections)
   - All sections start expanded
   - Each card shows: photo (or placeholder), name, company, rating stars, availability
   - Clicking a card opens modal with full profile
4. Click "Add" on a provider card:
   - Toast appears: "Added to your team"
   - Button changes to "On Team" badge
5. Ask AI about a specific provider by name - verify it references actual database data
6. Requirements satisfied:
   - TEAM-01: AI suggests 2-3 brokers (check count)
   - TEAM-02: AI suggests 2-3 mortgage advisors (check count)
   - TEAM-03: AI suggests 2-3 lawyers (check count)
   - TEAM-04: AI explains match reasons in text
   - TEAM-05: User can add providers to team
   - CHAT-08: AI answers questions about providers
  </how-to-verify>
  <resume-signal>Type "approved" if all features work, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. npx convex dev shows Convex functions ready
2. npx tsc --noEmit passes
3. ProviderCardRenderer.tsx created with accordion layout
4. ChatMessage renders both PropertyCardRenderer and ProviderCardRenderer
5. Barrel exports updated
6. Human verification confirms end-to-end flow
</verification>

<success_criteria>
- Provider cards render inline in chat messages
- Accordion groups providers by role with all sections expanded
- Loading indicator shows during provider search
- Add button works with toast feedback
- Modal opens on card click
- AI answers questions about providers (CHAT-08)
- All TEAM requirements (01-05) verified
</success_criteria>

<output>
After completion, create `.planning/phases/43-dream-team-builder/43-03-SUMMARY.md`
</output>
