---
phase: 43-dream-team-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/ai/tools/providerQueries.ts
  - convex/ai/tools/providerSearch.ts
  - convex/ai/agent.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "AI can search providers by role (broker, mortgage_advisor, lawyer)"
    - "AI can filter providers by service areas matching investor locations"
    - "AI can filter providers by languages matching investor preferences"
    - "AI receives provider data including ratings and availability"
  artifacts:
    - path: "convex/ai/tools/providerQueries.ts"
      provides: "Multi-criteria provider search with profile enrichment"
      exports: ["searchProviders"]
    - path: "convex/ai/tools/providerSearch.ts"
      provides: "AI tool definition for provider search"
      exports: ["searchProvidersTool"]
    - path: "convex/ai/agent.ts"
      provides: "Agent with searchProviders tool registered"
      contains: "searchProviders: searchProvidersTool"
  key_links:
    - from: "convex/ai/tools/providerSearch.ts"
      to: "convex/ai/tools/providerQueries.ts"
      via: "ctx.runQuery"
      pattern: "api\\.ai\\.tools\\.providerQueries\\.searchProviders"
    - from: "convex/ai/agent.ts"
      to: "convex/ai/tools/providerSearch.ts"
      via: "import and register"
      pattern: "searchProviders: searchProvidersTool"
---

<objective>
Create provider search tool and query for AI agent

Purpose: Enable AI to search for service providers (brokers, mortgage advisors, lawyers) based on investor criteria, following the Phase 42 property search pattern.
Output: Provider search query with multi-criteria filtering, AI tool definition, agent registration with updated instructions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-dream-team-builder/43-CONTEXT.md
@.planning/phases/43-dream-team-builder/43-RESEARCH.md
@.planning/phases/42-property-recommendations/42-01-SUMMARY.md

Reference files:
@convex/ai/tools/propertyQueries.ts (pattern to follow)
@convex/ai/tools/propertySearch.ts (pattern to follow)
@convex/ai/agent.ts (extend with new tool)
@convex/schema.ts (serviceProviderProfiles table structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider search query</name>
  <files>convex/ai/tools/providerQueries.ts</files>
  <action>
Create new file following propertyQueries.ts pattern:

1. Export `searchProviders` query with args:
   - providerType: v.union(v.literal("broker"), v.literal("mortgage_advisor"), v.literal("lawyer"))
   - serviceAreas: v.optional(v.array(v.string()))
   - languages: v.optional(v.array(v.string()))
   - limit: v.number()

2. Query implementation:
   - Get profiles from serviceProviderProfiles using by_provider_type index
   - Filter by serviceAreas (case-insensitive match, any overlap)
   - Filter by languages (any overlap)
   - Enrich with user data: name, imageUrl from users table
   - Calculate avgRating from providerReviews using by_provider index
   - Count completedDeals from deals table (where brokerId/mortgageAdvisorId/lawyerId matches)
   - Get acceptingNewClients from profile (default true if undefined)

3. Return enriched profiles:
   ```typescript
   {
     _id: profile.userId,  // Use userId as identifier (for team management)
     name: user?.name ?? "Unknown",
     imageUrl: user?.imageUrl,
     providerType: profile.providerType,
     companyName: profile.companyName,
     yearsExperience: profile.yearsExperience ?? 0,
     specializations: profile.specializations,
     serviceAreas: profile.serviceAreas,
     languages: profile.languages,
     bio: profile.bio,
     avgRating: calculated,
     totalReviews: reviews.length,
     completedDeals: count,
     acceptingNewClients: profile.acceptingNewClients ?? true,
   }
   ```

4. Sort by: avgRating desc, yearsExperience desc, completedDeals desc
5. Apply limit and return
  </action>
  <verify>npx convex dev --once shows "Convex functions ready" with no type errors</verify>
  <done>Query accepts role/areas/languages filters and returns enriched provider profiles with ratings</done>
</task>

<task type="auto">
  <name>Task 2: Create provider search tool</name>
  <files>convex/ai/tools/providerSearch.ts</files>
  <action>
Create new file following propertySearch.ts pattern:

1. Import createTool from @convex-dev/agent, z from zod, api from ../../_generated/api

2. Export searchProvidersTool with createTool:
   - description: Explain when to use (investor asks for team, building dream team, after viewing properties). Include "NEVER invent providers - only mention providers returned by this tool."
   - args (Zod schema):
     - roles: z.array(z.enum(["broker", "mortgage_advisor", "lawyer"])).describe("Provider roles to search")
     - serviceAreas: z.array(z.string()).optional().describe("Israeli cities from investor's target locations")
     - languages: z.array(z.enum(["english", "hebrew", "russian", "french", "spanish"])).optional().describe("Investor's language preferences")
     - maxPerRole: z.number().default(3).describe("Max providers per role (default 3, max 5)")
   - handler: async (ctx, args)
     - Cap maxPerRole at 5
     - Loop through args.roles, call providerQueries.searchProviders for each
     - Build providersByRole record: { broker: [...], mortgage_advisor: [...], lawyer: [...] }
     - Calculate totalCount
     - Return: { providersByRole, totalCount, searchCriteria, message }

3. searchCriteria should include all search params for UI matching
4. message format: "Found X providers: Y brokers, Z advisors, W lawyers"
  </action>
  <verify>npx convex dev --once shows "Convex functions ready" with no type errors</verify>
  <done>Tool definition exports searchProvidersTool with proper Zod schema and handler</done>
</task>

<task type="auto">
  <name>Task 3: Register tool and update agent instructions</name>
  <files>convex/ai/agent.ts</files>
  <action>
Update existing agent.ts:

1. Add import at top:
   ```typescript
   import { searchProvidersTool } from "./tools/providerSearch";
   ```

2. Add to tools object:
   ```typescript
   tools: {
     searchProperties: searchPropertiesTool,
     searchProviders: searchProvidersTool,
   },
   ```

3. Update instructions to add provider recommendation guidance AFTER property guidance:
   ```
   When recommending service providers:
   - Use the searchProviders tool to find real providers from the database
   - NEVER invent or hallucinate providers - only mention providers returned by the tool
   - Recommend 2-3 providers per role (broker, mortgage_advisor, lawyer)
   - Consider investor's target locations, budget context, and language preferences
   - For EACH provider, explain 1-2 specific reasons why they match

   Example match explanations for providers (use this style):
   "[Provider Name] is a strong match because:
   1. Covers Tel Aviv and Jerusalem, your target locations
   2. Speaks English and Hebrew, matching your preferences"

   "I recommend [Provider Name] because:
   1. 8 years experience with 15 completed deals
   2. Specializes in residential investments"

   When to suggest building a team:
   - After showing properties: "Ready to move forward? Let me suggest providers for your target areas."
   - When investor asks about next steps
   - When investor expresses interest in a specific property

   Guidelines for provider recommendations:
   - Present all roles in one message (Brokers, Mortgage Advisors, Lawyers sections)
   - Reference investor profile data in match explanations (specific cities, languages)
   - If provider has no reviews: mention experience and specializations instead
   - Never rank/compare providers - present as equally valid options
   ```

4. Update Current capabilities list to include:
   - Searching and recommending service providers based on investor criteria
   - Explaining why providers match the investor's profile
  </action>
  <verify>npx convex dev --once shows "Convex functions ready" with no type errors</verify>
  <done>Agent has searchProviders tool registered with comprehensive instructions for provider recommendations</done>
</task>

</tasks>

<verification>
After all tasks:
1. npx convex dev --once completes without errors
2. File structure: convex/ai/tools/providerQueries.ts and convex/ai/tools/providerSearch.ts exist
3. agent.ts imports and registers searchProvidersTool
4. Instructions include explicit examples for provider match explanations
</verification>

<success_criteria>
- Provider search query filters by role, service areas, and languages
- Query enriches profiles with user info, ratings, and completed deals
- Tool definition uses createTool with proper Zod schema
- Tool returns providersByRole grouped structure with searchCriteria
- Agent registered with tool and has provider-specific instructions
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/43-dream-team-builder/43-01-SUMMARY.md`
</output>
