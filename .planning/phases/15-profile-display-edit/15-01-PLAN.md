---
phase: 15-profile-display-edit
plan: 01
type: execute
---

<objective>
Enable service providers to view investor questionnaire profiles when working on deals.

Purpose: Providers need context about investor preferences, budget, timeline, and goals to serve them effectively.
Output: Backend query + InvestorQuestionnaireCard component integrated into deal detail page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/14-ai-preferences-service-selection/14-01-SUMMARY.md

**Key files:**
@convex/investorQuestionnaires.ts
@convex/schema.ts
@src/app/(app)/deals/[id]/page.tsx
@src/components/questionnaire/steps/index.ts

**Established patterns:**
- Questionnaire data in investorQuestionnaires table with 17 fields
- Deal detail page uses tabbed interface (Overview, Providers, Files, Activity)
- Card components with CardHeader/CardContent pattern
- Provider access via deal assignment (brokerId, mortgageAdvisorId, lawyerId)

**Constraining decisions:**
- Phase 14: 17-step questionnaire complete with all schema fields
- Phase 6: Service providers access deal data via their assignment
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getByInvestorId query for providers</name>
  <files>convex/investorQuestionnaires.ts</files>
  <action>
Add a new query `getByInvestorId` that allows service providers to view an investor's questionnaire.

Auth logic:
1. Get authenticated user
2. If user is the investor (userId matches), allow access
3. If user is a provider (broker, mortgage_advisor, lawyer), check if they share a deal with the investor:
   - Query deals table for deals where investorId matches AND (brokerId OR mortgageAdvisorId OR lawyerId) matches current user
   - If any such deal exists, allow access
4. Return null if no access

Query structure:
```typescript
export const getByInvestorId = query({
  args: { investorId: v.id("users") },
  handler: async (ctx, args) => {
    // Auth check
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return null;

    const currentUser = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .unique();
    if (!currentUser) return null;

    // Self-access check
    if (currentUser._id === args.investorId) {
      return await ctx.db
        .query("investorQuestionnaires")
        .withIndex("by_user", (q) => q.eq("userId", args.investorId))
        .unique();
    }

    // Provider access check - must share a deal
    const sharedDeals = await ctx.db
      .query("deals")
      .filter((q) =>
        q.and(
          q.eq(q.field("investorId"), args.investorId),
          q.or(
            q.eq(q.field("brokerId"), currentUser._id),
            q.eq(q.field("mortgageAdvisorId"), currentUser._id),
            q.eq(q.field("lawyerId"), currentUser._id)
          )
        )
      )
      .first();

    if (!sharedDeals) return null;

    return await ctx.db
      .query("investorQuestionnaires")
      .withIndex("by_user", (q) => q.eq("userId", args.investorId))
      .unique();
  },
});
```
  </action>
  <verify>TypeScript compiles: `npx convex dev --once` succeeds</verify>
  <done>Query exists and enforces proper access control</done>
</task>

<task type="auto">
  <name>Task 2: Create InvestorQuestionnaireCard component</name>
  <files>src/components/deals/InvestorQuestionnaireCard.tsx</files>
  <action>
Create a display-only card component that shows investor questionnaire data in a readable format.

Props:
```typescript
interface InvestorQuestionnaireCardProps {
  investorId: Id<"users">;
}
```

Structure:
- Use Card with CardHeader (title "Investor Profile") and CardContent
- Fetch questionnaire using `api.investorQuestionnaires.getByInvestorId`
- Show loading skeleton while fetching
- Show "No profile available" if null
- Display sections for each category of questionnaire data:

**Background section:**
- Citizenship: Display readable label (Israeli Citizen / Non-Israeli)
- Residency: Display readable label
- Experience: Display readable label
- Owns property in Israel: Yes/No

**Investment Preferences section:**
- Investment type: Residential / Investment
- Budget range: Format as currency USD
- Investment horizon: Display readable label
- Goals: List as comma-separated
- Yield preference: Display readable label
- Financing: Display readable label

**Property Preferences section:**
- Property types: List
- Locations: List
- Size: bedrooms range, area range (sqm)
- Amenities: List

**Timeline & Services section:**
- Purchase timeline: Display readable label
- Services needed: List
- Additional preferences: Display if present

Use label mappings (create QUESTIONNAIRE_LABELS constant in file or import from constants) to convert values like "non_israeli" to "Non-Israeli Citizen".

Styling: Use grid layout for two-column display on larger screens, single column on mobile. Use text-muted-foreground for labels, font-medium for values.
  </action>
  <verify>Component renders without TypeScript errors</verify>
  <done>InvestorQuestionnaireCard displays all 17 questionnaire fields in readable format</done>
</task>

<task type="auto">
  <name>Task 3: Integrate InvestorQuestionnaireCard into deal detail page</name>
  <files>src/app/(app)/deals/[id]/page.tsx</files>
  <action>
Add the InvestorQuestionnaireCard to the deal detail page so providers can see investor preferences.

1. Import InvestorQuestionnaireCard:
```typescript
import { InvestorQuestionnaireCard } from "@/components/deals/InvestorQuestionnaireCard";
```

2. Add to Overview tab, after the existing "Team" card:
```tsx
{/* Investor Profile - show to providers only */}
{!isInvestor && deal.investorId && (
  <InvestorQuestionnaireCard investorId={deal.investorId} />
)}
```

This shows the card only to service providers (not to the investor themselves viewing their own deal), and only when investorId is available.

The card handles its own loading state and access control (the query returns null if unauthorized).
  </action>
  <verify>Run dev server, navigate to a deal as a provider, see Investor Profile card in Overview tab</verify>
  <done>Provider deal view shows investor questionnaire profile</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` succeeds (Convex types generate)
- [ ] `npm run build` succeeds without errors
- [ ] Provider viewing a deal sees InvestorQuestionnaireCard in Overview tab
- [ ] Investor viewing their own deal does NOT see the card (they know their own profile)
- [ ] Unauthorized users (not on deal) cannot fetch questionnaire data
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Provider can see investor preferences when viewing shared deals
- Access control properly enforced
</success_criteria>

<output>
After completion, create `.planning/phases/15-profile-display-edit/15-01-SUMMARY.md`
</output>
