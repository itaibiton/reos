---
phase: 15-profile-display-edit
plan: 02
type: execute
---

<objective>
Enable investors to edit their questionnaire answers after onboarding and show profile completeness.

Purpose: Investors should be able to update preferences over time, and see how complete their profile is.
Output: Edit questionnaire page accessible from dashboard/profile + completeness indicator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior plan context:**
@.planning/phases/15-profile-display-edit/15-01-SUMMARY.md

**Key files:**
@convex/investorQuestionnaires.ts
@src/app/(app)/onboarding/questionnaire/page.tsx
@src/app/(app)/profile/investor/page.tsx
@src/components/profile/InvestorProfileForm.tsx
@src/app/(app)/dashboard/page.tsx

**Established patterns:**
- Questionnaire page uses QuestionnaireWizard with step state
- Profile pages at /profile/investor and /profile/provider
- Dashboard shows role-based content
- Sidebar navigation varies by role

**Constraining decisions:**
- Phase 10: QuestionnaireWizard with steps array, currentStep, onStepChange callbacks
- Phase 9: Questionnaire has draft/complete status
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create questionnaire edit page for investors</name>
  <files>src/app/(app)/profile/investor/questionnaire/page.tsx</files>
  <action>
Create a page that reuses the questionnaire wizard for editing existing answers.

Structure:
1. Create new page at `/profile/investor/questionnaire/page.tsx`
2. Copy the core logic from `/onboarding/questionnaire/page.tsx` but with edit-mode differences:
   - No redirect for already-onboarded users (this IS the edit page)
   - No redirect for role selection (user already has role)
   - No "skip" button (user already completed onboarding)
   - No `completeOnboarding` call on finish (already completed)
   - Show "Save Changes" instead of "Complete" on final step
   - Show toast on save success
   - Add back link to profile page

Key differences from onboarding page:
```typescript
// No redirect for onboarded users - this is for editing
// No skip button
// On complete, just save and show toast (no redirect to dashboard)

const handleComplete = async () => {
  setIsSubmitting(true);
  try {
    await saveProgress();
    toast.success("Profile updated successfully!");
    setIsSubmitting(false);
  } catch (error) {
    console.error("Failed to save profile:", error);
    toast.error("Failed to save profile. Please try again.");
    setIsSubmitting(false);
  }
};
```

Add a header with back link:
```tsx
<div className="mb-6">
  <Link href="/profile/investor" className="text-sm text-muted-foreground hover:text-foreground inline-flex items-center gap-1">
    <HugeiconsIcon icon={ArrowLeft01Icon} size={16} />
    Back to Profile
  </Link>
  <h1 className="text-2xl font-bold mt-2">Edit Investment Profile</h1>
</div>
```

Remove skip functionality since users have already completed onboarding.
  </action>
  <verify>Navigate to /profile/investor/questionnaire, wizard loads with existing data, can edit and save</verify>
  <done>Edit questionnaire page works for onboarded investors</done>
</task>

<task type="auto">
  <name>Task 2: Add ProfileCompletenessCard component</name>
  <files>src/components/profile/ProfileCompletenessCard.tsx</files>
  <action>
Create a card component that shows questionnaire completeness with a link to edit.

Props:
```typescript
interface ProfileCompletenessCardProps {
  className?: string;
}
```

Logic:
1. Fetch questionnaire using `api.investorQuestionnaires.getByUser`
2. Calculate completeness as percentage of filled fields
3. Show progress bar and percentage
4. List which sections are incomplete
5. Link to edit page

Completeness calculation:
```typescript
function calculateCompleteness(q: Questionnaire | null): { percent: number; missing: string[] } {
  if (!q) return { percent: 0, missing: ["Not started"] };

  const fields = [
    { key: "citizenship", label: "Citizenship" },
    { key: "residencyStatus", label: "Residency Status" },
    { key: "experienceLevel", label: "Experience Level" },
    { key: "ownsPropertyInIsrael", label: "Property Ownership" },
    { key: "investmentType", label: "Investment Type" },
    { key: "budgetMin", label: "Budget" },
    { key: "budgetMax", label: "Budget" },
    { key: "investmentHorizon", label: "Investment Horizon" },
    { key: "investmentGoals", label: "Investment Goals" },
    { key: "yieldPreference", label: "Yield Preference" },
    { key: "financingApproach", label: "Financing Approach" },
    { key: "preferredPropertyTypes", label: "Property Types" },
    { key: "preferredLocations", label: "Preferred Locations" },
    { key: "purchaseTimeline", label: "Purchase Timeline" },
    { key: "servicesNeeded", label: "Services Needed" },
  ];

  const missing: string[] = [];
  let filled = 0;

  for (const { key, label } of fields) {
    const value = q[key as keyof typeof q];
    const isFilled = value !== undefined && value !== null &&
      (Array.isArray(value) ? value.length > 0 : true);
    if (isFilled) {
      filled++;
    } else if (!missing.includes(label)) {
      missing.push(label);
    }
  }

  return { percent: Math.round((filled / fields.length) * 100), missing };
}
```

Note: Optional fields like minBedrooms, maxBedrooms, minArea, maxArea, preferredAmenities, additionalPreferences are excluded from completeness calculation since they're optional.

UI:
- Card with title "Profile Completeness"
- Progress component showing percentage
- "{X}% complete" text
- If < 100%: "Missing: {list}" in muted text
- "Edit Profile" button linking to /profile/investor/questionnaire
  </action>
  <verify>Component renders with correct percentage and missing fields list</verify>
  <done>ProfileCompletenessCard shows accurate completeness with edit link</done>
</task>

<task type="auto">
  <name>Task 3: Update investor profile page with completeness and edit link</name>
  <files>src/app/(app)/profile/investor/page.tsx</files>
  <action>
Update the investor profile page to show questionnaire completeness and link to edit.

1. Import ProfileCompletenessCard:
```typescript
import { ProfileCompletenessCard } from "@/components/profile/ProfileCompletenessCard";
```

2. Update the page layout to show both the existing InvestorProfileForm and the new ProfileCompletenessCard:
```tsx
export default function InvestorProfilePage() {
  return (
    <div className="p-6 space-y-6">
      <h1 className="text-2xl font-bold">Investor Profile</h1>

      {/* Profile Completeness Card */}
      <ProfileCompletenessCard />

      {/* Investment Preferences Form (existing) */}
      <div className="max-w-2xl">
        <h2 className="text-lg font-semibold mb-4">Investment Preferences</h2>
        <InvestorProfileForm />
      </div>
    </div>
  );
}
```

This gives investors a clear view of their questionnaire completeness alongside the existing profile form. The completeness card links to the questionnaire edit page for detailed edits.

Note: The existing InvestorProfileForm uses a separate investorProfiles table for basic preferences. The questionnaire edit page uses investorQuestionnaires for detailed onboarding answers. Both are valid and serve different purposes - the form is a quick edit, the questionnaire is comprehensive.
  </action>
  <verify>Navigate to /profile/investor, see completeness card with edit link above the form</verify>
  <done>Profile page shows completeness indicator with edit functionality</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Investor can navigate to /profile/investor/questionnaire and edit answers
- [ ] Changes save successfully with toast confirmation
- [ ] Profile completeness shows correct percentage
- [ ] Missing fields are listed when profile is incomplete
- [ ] Edit link navigates to questionnaire edit page
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Investors can edit questionnaire answers after onboarding
- Completeness indicator accurately reflects filled fields
- Phase 15 complete
</success_criteria>

<output>
After completion, create `.planning/phases/15-profile-display-edit/15-02-SUMMARY.md` with:
- Summary of edit page and completeness feature
- Files created/modified
- Note that Phase 15 and v1.1 milestone are complete
</output>
