# Phase 20 Plan 02: Settings UI with Availability & Notifications

## Objective

Build the settings UI for providers to manage their availability calendar and notification preferences. Refactor the Settings page to use a tabbed interface with Profile, Availability, and Notifications sections.

## Execution Context

- **Phase**: 20 (Provider Settings & Availability)
- **Plan**: 02 of 02
- **Subsystem**: frontend
- **Dependencies**: Phase 20 Plan 01 complete (backend)

## Context

### From Plan 01

Backend now provides:
- `providerAvailability.getMyAvailability()` - Returns acceptingNewClients + unavailable dates
- `providerAvailability.setAcceptingNewClients()` - Toggle availability
- `providerAvailability.addUnavailableDate()` / `removeUnavailableDate()` - Manage blocked dates
- `notificationPreferences.getMyNotificationPreferences()` - Get notification settings
- `notificationPreferences.updateNotificationPreferences()` - Update settings

### Existing UI Patterns

From prior phases:
- Settings page uses role-based forms (InvestorProfileForm, ProviderProfileForm)
- Tabs component from Shadcn available
- Switch component from Shadcn for toggles
- Calendar component from Shadcn for date picking
- Two-column layouts common (lg:grid-cols-2)

### Design

**Settings Page Structure:**
- Tabs: Profile | Availability | Notifications
- Investors see only Profile tab
- Providers see all three tabs
- Admin (viewing as role) follows that role's tabs

**Availability Tab:**
- "Accepting New Clients" toggle at top (prominent)
- Calendar showing blocked dates (highlighted)
- Click date to toggle blocked status
- List of blocked dates with remove button

**Notifications Tab:**
- Master toggles: Email / In-App
- Individual toggles per notification type
- Grouped logically (Messages, Deals, Requests)

## Tasks

### Task 1: Refactor Settings Page with Tabs (Auto)

Update `src/app/(app)/settings/page.tsx`:

1. Import Tabs components from Shadcn
2. Wrap content in Tabs with tab triggers:
   - "Profile" (always visible)
   - "Availability" (providers only)
   - "Notifications" (providers only)
3. Profile tab contains existing form logic
4. Availability tab renders `<AvailabilitySettings />` (created in Task 2)
5. Notifications tab renders `<NotificationSettings />` (created in Task 3)
6. Investors only see Profile (no tabs shown, direct render)
7. Keep admin "viewing as" badge

Files: `src/app/(app)/settings/page.tsx`

### Task 2: Create AvailabilitySettings Component (Auto)

Create `src/components/settings/AvailabilitySettings.tsx`:

**Layout:**
```
┌─────────────────────────────────────────────┐
│ Accepting New Clients          [Toggle ON]  │
│ Visible to investors on your profile        │
├─────────────────────────────────────────────┤
│ Blocked Dates                               │
│ Mark dates when you're unavailable          │
│                                             │
│ ┌─────────────┐  ┌────────────────────────┐ │
│ │  Calendar   │  │ Blocked Dates List     │ │
│ │             │  │ - Jan 20, 2026 [x]     │ │
│ │             │  │ - Jan 25, 2026 [x]     │ │
│ └─────────────┘  └────────────────────────┘ │
└─────────────────────────────────────────────┘
```

**Implementation:**
1. Use `useQuery(api.providerAvailability.getMyAvailability)`
2. "Accepting New Clients" toggle using Switch component
3. Calendar component with mode="multiple" for selecting dates
4. Highlight blocked dates with different styling
5. Click date to add/remove from blocked list
6. Side list showing blocked dates with delete buttons
7. Format dates using date-fns or native toLocaleDateString

Files: `src/components/settings/AvailabilitySettings.tsx`

### Task 3: Create NotificationSettings Component (Auto)

Create `src/components/settings/NotificationSettings.tsx`:

**Layout:**
```
┌─────────────────────────────────────────────┐
│ Notification Channels                       │
│ ┌─────────────────────────────────────────┐ │
│ │ Email Notifications          [Toggle]   │ │
│ │ In-App Notifications         [Toggle]   │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ Notification Types                          │
│ ┌─────────────────────────────────────────┐ │
│ │ Messages                                │ │
│ │   New messages              [Toggle]    │ │
│ │                                         │ │
│ │ Deals                                   │ │
│ │   Deal stage changes        [Toggle]    │ │
│ │   Files uploaded            [Toggle]    │ │
│ │                                         │ │
│ │ Service Requests                        │ │
│ │   New requests received     [Toggle]    │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

**Implementation:**
1. Use `useQuery(api.notificationPreferences.getMyNotificationPreferences)`
2. Use `useMutation(api.notificationPreferences.updateNotificationPreferences)`
3. Group toggles by category (Channels, Messages, Deals, Requests)
4. Each toggle updates immediately (no submit button - live updates)
5. Show loading state while saving
6. Toast on error

Files: `src/components/settings/NotificationSettings.tsx`

### Task 4: Human Verification (Verify)

Verify the settings UI:
1. Log in as a provider (broker, mortgage advisor, or lawyer)
2. Navigate to /settings
3. Confirm three tabs visible: Profile, Availability, Notifications
4. Test Availability tab:
   - Toggle "Accepting New Clients"
   - Click dates on calendar to block/unblock
   - Verify blocked dates appear in list
   - Delete a blocked date from list
5. Test Notifications tab:
   - Toggle email/in-app master switches
   - Toggle individual notification types
   - Verify changes persist after page refresh
6. Log in as investor - confirm only Profile visible (no tabs)

## Verification

- [ ] Settings page has tabs for providers
- [ ] Availability toggle works and persists
- [ ] Calendar allows blocking/unblocking dates
- [ ] Notification toggles update immediately
- [ ] Investor settings show only profile form
- [ ] No TypeScript errors

## Success Criteria

- Providers can manage availability from Settings
- Providers can customize notification preferences
- UI is intuitive and matches existing design patterns
- All changes persist in Convex backend
- Phase 20 complete, v1.2 milestone complete

## Output

After completion, create `.planning/phases/20-provider-settings-availability/20-02-SUMMARY.md`
