# Phase 20 Plan 01: Provider Settings Backend

## Objective

Create backend schema and queries for provider availability management and notification preferences. This enables providers to control when they're available for new clients and which notifications they receive.

## Execution Context

- **Phase**: 20 (Provider Settings & Availability)
- **Plan**: 01 of 02
- **Subsystem**: backend
- **Dependencies**: Phase 19 complete (provider analytics)

## Context

### Existing Infrastructure

From `convex/schema.ts`:
- `serviceProviderProfiles` table has serviceAreas (already exists)
- `notifications` table has notification types defined
- `notificationType` union: new_message, deal_stage_change, file_uploaded, request_received, request_accepted, request_declined

From `src/lib/constants.ts`:
- SERVICE_AREAS constant for location options
- CONTACT_PREFERENCE_OPTIONS for contact methods

### Design Decisions

**Availability Model (MVP approach):**
- `acceptingNewClients` boolean on provider profile (simple toggle)
- `unavailableDates` table for specific blocked dates
- No complex time slots for MVP - just date-level availability

**Notification Preferences Model:**
- Add to `serviceProviderProfiles` table (not separate table)
- Object field `notificationPreferences` with boolean flags per type
- Email notifications toggle (future: actual email integration)
- In-app notifications already exist via notifications table

## Tasks

### Task 1: Update Schema with Availability & Notification Fields (Auto)

Update `convex/schema.ts` to add:

1. Add `acceptingNewClients` boolean field to `serviceProviderProfiles`
2. Add `notificationPreferences` object field to `serviceProviderProfiles` with:
   - `emailNotifications`: boolean (master toggle)
   - `inAppNotifications`: boolean (master toggle)
   - `newMessageNotify`: boolean
   - `dealStageNotify`: boolean
   - `fileUploadedNotify`: boolean
   - `requestReceivedNotify`: boolean

3. Create new `providerUnavailableDates` table:
   - `providerId`: v.id("users")
   - `date`: v.number() (timestamp for start of day)
   - `reason`: v.optional(v.string()) - optional note
   - `createdAt`: v.number()
   - Index: `by_provider` on providerId
   - Index: `by_provider_and_date` on [providerId, date]

Files: `convex/schema.ts`

### Task 2: Create Availability Queries & Mutations (Auto)

Create `convex/providerAvailability.ts` with:

**Queries:**
- `getMyAvailability()` - Returns current user's acceptingNewClients status and unavailable dates
- `getUnavailableDates({ providerId })` - Get blocked dates for a provider (for public profile display)

**Mutations:**
- `setAcceptingNewClients({ accepting: boolean })` - Toggle availability status
- `addUnavailableDate({ date: number, reason?: string })` - Block a specific date
- `removeUnavailableDate({ dateId: Id<"providerUnavailableDates"> })` - Unblock a date
- `bulkAddUnavailableDates({ dates: number[] })` - Block multiple dates at once

Implementation notes:
- All mutations require authenticated provider
- Dates stored as start-of-day timestamps (midnight UTC)
- Prevent duplicate dates for same provider

Files: `convex/providerAvailability.ts`

### Task 3: Create Notification Preferences Queries & Mutations (Auto)

Create `convex/notificationPreferences.ts` with:

**Queries:**
- `getMyNotificationPreferences()` - Returns current user's notification settings
  - If no preferences set, return defaults (all enabled)

**Mutations:**
- `updateNotificationPreferences({ preferences: object })` - Update notification settings
  - Accepts partial updates (only fields being changed)
  - Merges with existing preferences

Also update `convex/serviceProviderProfiles.ts`:
- Modify `upsertProfile` to initialize default notification preferences if not set

Files:
- `convex/notificationPreferences.ts`
- `convex/serviceProviderProfiles.ts`

## Verification

- [ ] `npx convex dev --once` deploys without errors
- [ ] Schema validates with new fields
- [ ] Availability queries return data for providers
- [ ] Notification preferences queries return defaults when not set
- [ ] Mutations properly validate provider role

## Success Criteria

- Schema extended with availability and notification fields
- providerUnavailableDates table created with proper indexes
- All queries and mutations work for authenticated providers
- Default notification preferences applied when not set

## Output

After completion, create `.planning/phases/20-provider-settings-availability/20-01-SUMMARY.md`
