---
phase: 61-panel-shell-streaming-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/providers/AIAssistantProvider.tsx
  - src/components/ai/AIAssistantPanel.tsx
  - src/components/ai/AIToggleButton.tsx
  - src/components/layout/AppShell.tsx
  - src/components/layout/MobileBottomNav.tsx
autonomous: true

must_haves:
  truths:
    - "A toggle button in the header opens a right-side Sheet panel on desktop without pushing page content"
    - "On mobile, a FAB above the bottom tab bar opens a full-screen Drawer"
    - "The panel remains open when navigating between pages (state persists in sessionStorage)"
    - "When the mobile AI panel is open, the MobileBottomNav is hidden"
    - "Cmd/Ctrl+J toggles the panel open/closed"
  artifacts:
    - path: "src/providers/AIAssistantProvider.tsx"
      provides: "React Context for AI panel open/closed state with sessionStorage persistence"
      exports: ["AIAssistantProvider", "useAIAssistant"]
    - path: "src/components/ai/AIAssistantPanel.tsx"
      provides: "Responsive container: Sheet on desktop, Drawer on mobile"
    - path: "src/components/ai/AIToggleButton.tsx"
      provides: "Desktop header button and mobile FAB"
    - path: "src/components/layout/AppShell.tsx"
      provides: "Integration point: provider wrapping, toggle in header, panel rendered"
  key_links:
    - from: "src/components/ai/AIToggleButton.tsx"
      to: "src/providers/AIAssistantProvider.tsx"
      via: "useAIAssistant().toggle"
      pattern: "useAIAssistant.*toggle"
    - from: "src/components/ai/AIAssistantPanel.tsx"
      to: "src/providers/AIAssistantProvider.tsx"
      via: "useAIAssistant().isOpen and close"
      pattern: "useAIAssistant.*isOpen"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/providers/AIAssistantProvider.tsx"
      via: "AIAssistantProvider wraps SidebarProvider children"
      pattern: "AIAssistantProvider"
    - from: "src/components/layout/MobileBottomNav.tsx"
      to: "src/providers/AIAssistantProvider.tsx"
      via: "useAIAssistant().isOpen hides nav"
      pattern: "useAIAssistant.*isOpen"
---

<objective>
Build the responsive AI assistant panel shell -- the container UI that houses the chat experience. Desktop users get a right-side Sheet overlay, mobile users get a full-screen Drawer with FAB trigger.

Purpose: This creates the physical panel that users interact with on every authenticated page. It is the visual foundation for the entire v1.10 assistant experience.

Output: `AIAssistantProvider.tsx` (state management), `AIAssistantPanel.tsx` (responsive container), `AIToggleButton.tsx` (triggers), updated `AppShell.tsx` (integration), updated `MobileBottomNav.tsx` (hide when panel open).
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@src/components/layout/AppShell.tsx
@src/components/layout/MobileBottomNav.tsx
@src/components/ui/sheet.tsx
@src/components/ui/drawer.tsx
@src/components/ai/AIChatPanel.tsx
@src/hooks/use-mobile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AIAssistantProvider + AIToggleButton</name>
  <files>
    src/providers/AIAssistantProvider.tsx
    src/components/ai/AIToggleButton.tsx
  </files>
  <action>
**1. Create `src/providers/AIAssistantProvider.tsx`:**

This is a React Context provider managing the AI panel open/closed state. Use split context pattern (state + dispatch) to avoid unnecessary re-renders.

```typescript
"use client";

import React, { createContext, useContext, useCallback, useEffect, useState } from "react";

// State context
interface AIAssistantState {
  isOpen: boolean;
}

// Dispatch context
interface AIAssistantDispatch {
  open: () => void;
  close: () => void;
  toggle: () => void;
}

const AIAssistantStateContext = createContext<AIAssistantState | null>(null);
const AIAssistantDispatchContext = createContext<AIAssistantDispatch | null>(null);

const STORAGE_KEY = "reos-ai-panel-open";

export function AIAssistantProvider({ children }: { children: React.ReactNode }) {
  // Initialize from sessionStorage (persists across navigation, not across tabs/sessions)
  const [isOpen, setIsOpen] = useState(() => {
    if (typeof window === "undefined") return false;
    try {
      return sessionStorage.getItem(STORAGE_KEY) === "true";
    } catch {
      return false;
    }
  });

  // Sync to sessionStorage on change
  useEffect(() => {
    try {
      sessionStorage.setItem(STORAGE_KEY, String(isOpen));
    } catch {
      // sessionStorage unavailable (SSR, private browsing edge cases)
    }
  }, [isOpen]);

  // Keyboard shortcut: Cmd/Ctrl+J
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "j") {
        e.preventDefault();
        setIsOpen(prev => !prev);
      }
    };
    document.addEventListener("keydown", handleKeyDown);
    return () => document.removeEventListener("keydown", handleKeyDown);
  }, []);

  const open = useCallback(() => setIsOpen(true), []);
  const close = useCallback(() => setIsOpen(false), []);
  const toggle = useCallback(() => setIsOpen(prev => !prev), []);

  return (
    <AIAssistantStateContext.Provider value={{ isOpen }}>
      <AIAssistantDispatchContext.Provider value={{ open, close, toggle }}>
        {children}
      </AIAssistantDispatchContext.Provider>
    </AIAssistantStateContext.Provider>
  );
}

/**
 * Hook to access AI assistant panel state and controls.
 * Must be used within AIAssistantProvider.
 */
export function useAIAssistant() {
  const state = useContext(AIAssistantStateContext);
  const dispatch = useContext(AIAssistantDispatchContext);
  if (!state || !dispatch) {
    throw new Error("useAIAssistant must be used within AIAssistantProvider");
  }
  return { ...state, ...dispatch };
}
```

Note: The `src/providers/` directory does not exist yet. Create it. This follows the pattern of co-locating providers separate from components.

**2. Create `src/components/ai/AIToggleButton.tsx`:**

Two variants: desktop (inline button for header) and mobile (FAB).

```typescript
"use client";

import { useAIAssistant } from "@/providers/AIAssistantProvider";
import { useIsMobile } from "@/hooks/use-mobile";
import { Button } from "@/components/ui/button";
import { HugeiconsIcon } from "@hugeicons/react";
import { AiChat02Icon } from "@hugeicons/core-free-icons";
import { useTranslations } from "next-intl";
import { cn } from "@/lib/utils";
```

The component renders conditionally based on `useIsMobile()`:

**Desktop variant (rendered in header):**
- `<Button variant="ghost" size="icon" onClick={toggle} className="h-9 w-9" aria-label={t("aiAssistant.toggle")} title={t("aiAssistant.toggleTooltip")}>`
- Inside: `<HugeiconsIcon icon={AiChat02Icon} size={20} />`
- When `isOpen`, add a visual indicator: `className={cn("h-9 w-9", isOpen && "bg-accent")}` on the button

**Mobile variant (FAB -- rendered separately outside header):**
- Only renders when `isMobile && !isOpen` (FAB hides when panel is open since Drawer covers screen)
- `<button onClick={toggle} className="fixed bottom-24 end-4 z-40 h-14 w-14 rounded-full bg-primary text-primary-foreground shadow-lg flex items-center justify-center active:scale-95 transition-transform" aria-label={t("aiAssistant.toggle")}>`
- Inside: `<HugeiconsIcon icon={AiChat02Icon} size={24} />`
- The `bottom-24` positions it above MobileBottomNav (which is ~80px/5rem from bottom, so 6rem = bottom-24 = 96px gives good clearance)
- Use `end-4` (not `right-4`) for RTL support

**Icon choice:** Use `AiChat02Icon` from `@hugeicons/core-free-icons`. If that specific icon is not available, fall back to `AiChat01Icon` or `SparklesIcon`. Check the import works; if the icon name is wrong, use a sparkle/chat icon that IS available in the Hugeicons free set. Grep the node_modules or try the import. A safe fallback is to use any chat-bubble icon from Hugeicons.

Export a single component `AIToggleButton` that renders the appropriate variant. Also export `AIToggleFAB` as a separate component for the mobile FAB (since it renders in a different position in the tree than the header button).

```typescript
// Desktop toggle for header
export function AIToggleButton() { /* ... renders Button */ }

// Mobile FAB (rendered at AppShell level, not in header)
export function AIToggleFAB() { /* ... renders fixed FAB, only on mobile, only when !isOpen */ }
```
  </action>
  <verify>
1. `npx tsc --noEmit` -- no TypeScript errors
2. Verify the Hugeicons icon import works: check that `AiChat02Icon` (or fallback) is importable from `@hugeicons/core-free-icons`
3. The provider file compiles and exports `AIAssistantProvider` and `useAIAssistant`
4. The toggle files compile and export `AIToggleButton` and `AIToggleFAB`
  </verify>
  <done>
- `AIAssistantProvider` exists with split state/dispatch contexts, sessionStorage persistence, and Cmd/Ctrl+J keyboard shortcut
- `AIToggleButton` renders a ghost icon button for the header (desktop)
- `AIToggleFAB` renders a fixed FAB positioned above MobileBottomNav (mobile only, hidden when panel is open)
- All use `useTranslations` for i18n keys (actual strings added in Plan 61-03)
  </done>
</task>

<task type="auto">
  <name>Task 2: AIAssistantPanel + AppShell integration + MobileBottomNav hide</name>
  <files>
    src/components/ai/AIAssistantPanel.tsx
    src/components/layout/AppShell.tsx
    src/components/layout/MobileBottomNav.tsx
  </files>
  <action>
**1. Create `src/components/ai/AIAssistantPanel.tsx`:**

This is the responsive panel container. It uses Sheet on desktop and Drawer on mobile. The CHAT CONTENT inside it is a placeholder for now (Plan 61-03 will wire the real streaming chat). For this task, render the existing `AIChatPanel` component inside.

```typescript
"use client";

import { useAIAssistant } from "@/providers/AIAssistantProvider";
import { useIsMobile } from "@/hooks/use-mobile";
import { useTranslations } from "next-intl";
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetDescription,
} from "@/components/ui/sheet";
import {
  Drawer,
  DrawerContent,
  DrawerHeader,
  DrawerTitle,
  DrawerDescription,
} from "@/components/ui/drawer";
import { AIChatPanel } from "./AIChatPanel";
import { VisuallyHidden } from "@radix-ui/react-visually-hidden";
```

Component logic:
- Read `isOpen` and `close` from `useAIAssistant()`
- Read `isMobile` from `useIsMobile()`
- `t` from `useTranslations("aiAssistant")`

**Desktop (Sheet):**
```jsx
<Sheet open={isOpen} onOpenChange={(open) => { if (!open) close(); }}>
  <SheetContent
    side="right"
    className="w-[440px] sm:max-w-[440px] p-0 flex flex-col [&>button]:hidden"
  >
    <VisuallyHidden>
      <SheetHeader>
        <SheetTitle>{t("panelTitle")}</SheetTitle>
        <SheetDescription>{t("panelDescription")}</SheetDescription>
      </SheetHeader>
    </VisuallyHidden>
    <AIChatPanel className="h-full" />
  </SheetContent>
</Sheet>
```

Key details:
- `w-[440px] sm:max-w-[440px]` overrides the default `sm:max-w-sm` (384px) to give a wider panel
- `p-0` removes default padding since AIChatPanel manages its own padding
- `[&>button]:hidden` hides the default SheetClose X button (AIChatPanel has its own header)
- `side="right"` -- the Sheet component already uses `end-0` / `start-0` in its styling, so RTL is handled (Sheet slides from the correct side based on CSS logical properties). Verify this: looking at sheet.tsx, it uses `end-0` for right side. Good -- this means on RTL locales the panel slides from the left (which is the "end" side in RTL). This is correct behavior.
- The `<VisuallyHidden>` wrapper around SheetHeader satisfies Radix's accessibility requirement for title/description without showing them (since AIChatPanel has its own visual header)

**Mobile (Drawer):**
```jsx
<Drawer open={isOpen} onOpenChange={(open) => { if (!open) close(); }}>
  <DrawerContent className="h-[100dvh] max-h-[100dvh] p-0 rounded-none">
    <VisuallyHidden>
      <DrawerHeader>
        <DrawerTitle>{t("panelTitle")}</DrawerTitle>
        <DrawerDescription>{t("panelDescription")}</DrawerDescription>
      </DrawerHeader>
    </VisuallyHidden>
    <AIChatPanel className="h-full" />
  </DrawerContent>
</Drawer>
```

Key details:
- `h-[100dvh] max-h-[100dvh]` makes it full screen (overrides default `max-h-[80vh]`)
- `rounded-none` removes the top border radius for full-screen feel
- `p-0` removes default padding
- The Vaul Drawer drag-handle is automatically rendered by DrawerContent (the `bg-muted mx-auto mt-4 hidden h-2 w-[100px]` div visible when direction is bottom). For full-screen, we may want to hide this. Add `[&>[data-slot=drawer-content]>.bg-muted]:hidden` or simply set the `handleOnly` Drawer prop. Actually, for a full-screen drawer, the drag handle adds nice UX (swipe down to dismiss). Keep it visible but make it smaller: the default is fine.

The component conditionally renders Sheet or Drawer:
```jsx
export function AIAssistantPanel() {
  const isMobile = useIsMobile();
  // ... state from useAIAssistant

  if (isMobile) {
    return <MobileDrawerPanel />;  // Drawer variant
  }
  return <DesktopSheetPanel />;    // Sheet variant
}
```

Or use a single component with conditional JSX. Either approach works.

**2. Update `src/components/layout/AppShell.tsx`:**

Add imports at the top:
```typescript
import { AIAssistantProvider } from "@/providers/AIAssistantProvider";
import { AIAssistantPanel } from "@/components/ai/AIAssistantPanel";
import { AIToggleButton, AIToggleFAB } from "@/components/ai/AIToggleButton";
```

Modifications to the JSX:

a) Wrap the entire return in `AIAssistantProvider`. Place it OUTSIDE `SidebarProvider`:
```jsx
return (
  <AIAssistantProvider>
    <SidebarProvider>
      {/* ... existing content ... */}
    </SidebarProvider>
  </AIAssistantProvider>
);
```

b) Add `AIToggleButton` in the header's right section, inside the `<Authenticated>` block, BEFORE `<ProviderHeaderContent />`:
```jsx
<Authenticated>
  <div className="flex items-center gap-2 flex-1 justify-end px-4">
    {/* ... existing search ... */}
  </div>
</Authenticated>

{/* Right: Auth section */}
<div className="flex items-center gap-2">
  <AuthLoading>
    <Skeleton className="h-8 w-8 rounded-full" />
  </AuthLoading>

  <Authenticated>
    <AIToggleButton />
    <ProviderHeaderContent />
  </Authenticated>

  <Unauthenticated>
    <Button asChild variant="outline" size="sm">
      <Link href="/sign-in">{t("header.signIn")}</Link>
    </Button>
  </Unauthenticated>
</div>
```

Note: Add `gap-2` to the right div if not already present (currently has no gap class). The AIToggleButton is a small ghost icon button that sits next to the role switcher and avatar dropdown.

c) Add `AIAssistantPanel` and `AIToggleFAB` AFTER `<MobileBottomNav />`, still inside `SidebarProvider` but after all content:
```jsx
    <MobileBottomNav />
    <Authenticated>
      <AIAssistantPanel />
      <AIToggleFAB />
    </Authenticated>
  </SidebarProvider>
</AIAssistantProvider>
```

The `AIAssistantPanel` renders a Sheet/Drawer portal, so its position in the tree mainly matters for context access. The `AIToggleFAB` renders a fixed-position button, so it also doesn't matter for layout.

Both are wrapped in `<Authenticated>` to only appear for logged-in users.

**3. Update `src/components/layout/MobileBottomNav.tsx`:**

Add import:
```typescript
import { useAIAssistant } from "@/providers/AIAssistantProvider";
```

Inside the component, get the AI panel state:
```typescript
const { isOpen: isAIPanelOpen } = useAIAssistant();
```

Conditionally hide the nav when AI panel is open. The cleanest approach: return null early.
```typescript
// Hide bottom nav when AI panel is open (full-screen drawer covers it)
if (isAIPanelOpen) return null;
```

Place this check after the existing hooks but before the JSX return. This completely removes the nav from the DOM when the AI panel is open, preventing any z-index conflicts with the full-screen Drawer.
  </action>
  <verify>
1. `npx tsc --noEmit` -- no TypeScript errors
2. `npm run build` or `next build` -- compiles without errors
3. Open the app in browser:
   - Desktop: Click the AI toggle in the header -> Sheet slides in from right, ~440px wide, overlays content
   - Click toggle again -> Sheet closes
   - Press Cmd+J -> Sheet toggles
   - Navigate to a different page -> Sheet remains open (sessionStorage persists)
   - On RTL locale: Sheet slides from left (the "end" side)
4. Mobile viewport:
   - FAB visible in bottom-right corner above tab bar
   - Tap FAB -> full-screen Drawer opens from bottom
   - MobileBottomNav disappears when Drawer is open
   - Swipe down or close -> Drawer closes, tab bar reappears, FAB reappears
5. The existing AIChatPanel content renders inside both Sheet and Drawer
  </verify>
  <done>
- Desktop: Right-side Sheet overlay (440px) opens/closes via header button or Cmd/Ctrl+J
- Mobile: Full-screen Drawer opens via FAB positioned above bottom tab bar
- MobileBottomNav hides when AI panel is open
- Panel state persists across page navigation via sessionStorage
- RTL: Panel slides from correct side (end), FAB uses `end-4` positioning
- AIChatPanel renders inside both containers (existing functionality preserved)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero errors
2. Desktop: Toggle button visible in header for authenticated users. Sheet opens right, overlays content, 440px wide.
3. Mobile: FAB visible above tab bar. Drawer opens full-screen. Tab bar hidden during.
4. Navigation persistence: Open panel, click sidebar link, panel remains open.
5. Keyboard shortcut: Cmd/Ctrl+J toggles panel on desktop.
6. RTL locale: Panel slides from left side (logical end), FAB at `end-4`.
7. Unauthenticated: No toggle button, no FAB, no panel.
</verification>

<success_criteria>
- AI assistant panel is accessible from every authenticated page via toggle button (desktop) or FAB (mobile)
- Desktop panel is an overlay Sheet that does NOT push content
- Mobile panel is a full-screen Drawer that hides the bottom tab bar
- Panel open/closed state survives page navigation within the same session
- Cmd/Ctrl+J keyboard shortcut works
- RTL layout works correctly
- Existing AIChatPanel renders inside the new containers
</success_criteria>

<output>
After completion, create `.planning/phases/61-panel-shell-streaming-infrastructure/61-02-SUMMARY.md`
</output>
