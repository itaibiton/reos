---
phase: 61-panel-shell-streaming-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/ai/agent.ts
  - convex/ai/streaming.ts
  - convex/ai/threads.ts
  - convex/ai/chat.ts
  - convex/schema.ts
autonomous: true

must_haves:
  truths:
    - "platformAssistant agent exists and is functional with the same tools as investorAssistant"
    - "A streaming query returns real-time UIMessages with syncStreams for token-by-token streaming"
    - "Session-based threads are created per user -- a new thread starts after 24h inactivity while preserving the old session summary"
    - "sendMessage accepts an optional role parameter and injects it into the system prompt"
  artifacts:
    - path: "convex/ai/agent.ts"
      provides: "platformAssistant agent definition with role-aware system prompt"
      exports: ["platformAssistant", "CONTEXT_OPTIONS"]
    - path: "convex/ai/streaming.ts"
      provides: "Real-time streaming query wrapping listUIMessages + syncStreams"
      exports: ["listMessages"]
    - path: "convex/ai/threads.ts"
      provides: "Session-based thread management with 24h inactivity threshold"
      exports: ["getOrCreateThread", "getThreadForUser", "clearMemory"]
    - path: "convex/schema.ts"
      provides: "Extended aiThreads table with sessionId and lastRole fields"
      contains: "sessionId"
  key_links:
    - from: "convex/ai/streaming.ts"
      to: "convex/ai/agent.ts"
      via: "components.agent passed to listUIMessages and syncStreams"
      pattern: "listUIMessages.*components\\.agent"
    - from: "convex/ai/chat.ts"
      to: "convex/ai/agent.ts"
      via: "platformAssistant.createThread and continueThread"
      pattern: "platformAssistant\\.(createThread|continueThread)"
    - from: "convex/ai/threads.ts"
      to: "convex/schema.ts"
      via: "aiThreads table queries with session logic"
      pattern: "aiThreads"
---

<objective>
Upgrade the AI backend from investor-only to platform-ready: rename the agent, add a real-time streaming query, and implement session-based thread management.

Purpose: This is the backend foundation for the platform-wide AI assistant. Without this, the frontend panel has nothing to stream from and no way to manage per-session conversations.

Output: Updated `convex/ai/agent.ts` (platformAssistant), new `convex/ai/streaming.ts` (real-time query), updated `convex/ai/threads.ts` (session logic), updated `convex/schema.ts` (new fields), updated `convex/ai/chat.ts` (role parameter).
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@convex/ai/agent.ts
@convex/ai/chat.ts
@convex/ai/threads.ts
@convex/ai/messages.ts
@convex/ai/context.ts
@convex/ai/summarization.ts
@convex/schema.ts
@convex/convex.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema extension + Agent rename + Streaming query</name>
  <files>
    convex/schema.ts
    convex/ai/agent.ts
    convex/ai/streaming.ts
  </files>
  <action>
**1. Extend `aiThreads` schema in `convex/schema.ts`:**

Add two new optional fields to the `aiThreads` table definition:
```
sessionId: v.optional(v.string()),
lastRole: v.optional(v.string()),
```
Add them after `summarizedMessageCount` and before `lastActivityAt`. Keep all existing fields and indexes unchanged. Add a new index:
```
.index("by_user_and_session", ["userId", "sessionId"])
```

**2. Rename agent in `convex/ai/agent.ts`:**

- Rename `investorAssistant` to `platformAssistant`
- Change `name:` from `"Investor Assistant"` to `"REOS Assistant"`
- Replace the long investor-specific `instructions` string with a generalized base instruction that works for all roles. The base instruction should cover:
  - You are the REOS AI assistant helping users with real estate investing in Israel
  - You help investors find properties, service providers manage clients, and everyone navigate the platform
  - NEVER invent or hallucinate data -- only use data from tool results
  - When recommending properties: use searchProperties tool, recommend 3 by default, explain 2-3 match reasons per property
  - When recommending providers: use searchProviders tool, 2-3 per role, explain 1-2 match reasons
  - Be conversational but professional
  - Memory behavior section (same as current -- summary awareness, compression acknowledgment)
  - After tool results, suggest next steps
- Keep `tools` object unchanged: `{ searchProperties: searchPropertiesTool, searchProviders: searchProvidersTool }`
- Keep `maxSteps: 5`, `contextOptions: CONTEXT_OPTIONS`
- Update the type export: `export type PlatformAssistant = typeof platformAssistant;`
- Keep the `CONTEXT_OPTIONS` export

**3. Create `convex/ai/streaming.ts`:**

This file exposes a Convex **query** that wraps `listUIMessages` and `syncStreams` from `@convex-dev/agent` for real-time subscriptions.

```typescript
import { listUIMessages, syncStreams } from "@convex-dev/agent";
import { query } from "../_generated/server";
import { components } from "../_generated/api";
import { paginationOptsValidator } from "convex/server";
import { v } from "convex/values";

/**
 * Real-time streaming messages query.
 * Used by useUIMessages on the client for token-by-token streaming.
 * Auth-gated: returns empty if not authenticated.
 */
export const listMessages = query({
  args: {
    threadId: v.string(),
    paginationOpts: paginationOptsValidator,
  },
  returns: v.any(),
  handler: async (ctx, args) => {
    // Auth check
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      return { page: [], isDone: true, continueCursor: "" };
    }

    // Get UIMessages with pagination
    const messages = await listUIMessages(ctx, components.agent, {
      threadId: args.threadId,
      paginationOpts: args.paginationOpts,
    });

    // Sync active streams for real-time token display
    const streams = await syncStreams(ctx, components.agent, {
      threadId: args.threadId,
    });

    return { ...messages, ...streams };
  },
});
```

IMPORTANT: The `listUIMessages` and `syncStreams` functions are imported from `@convex-dev/agent` (NOT from `@convex-dev/agent/react`). They are backend query helpers. The `components` object is imported from `../_generated/api` (already used in agent.ts). The `paginationOptsValidator` is from `convex/server`.

Note on args: The `syncStreams` function may accept different args than shown. Check the function signature. If it needs `streamArgs` instead, adjust accordingly. The key pattern is: this query combines message listing + stream syncing so the client `useUIMessages` hook gets both historical messages and live stream deltas through a single reactive query.
  </action>
  <verify>
Run `npx convex dev --once` (or check that `npx convex dev` running in background shows no errors). Verify:
1. Schema pushes without errors (new fields are optional, non-breaking)
2. `convex/ai/streaming.ts` compiles -- no import errors for `listUIMessages`, `syncStreams`, `components`
3. `convex/ai/agent.ts` compiles -- `platformAssistant` exports correctly
4. No TypeScript errors: `npx tsc --noEmit` in the convex directory
  </verify>
  <done>
- `platformAssistant` agent exists in `convex/ai/agent.ts` with generalized instructions, same tools, and the same maxSteps/contextOptions
- `convex/ai/streaming.ts` exists with an auth-gated `listMessages` query that combines `listUIMessages` + `syncStreams`
- `aiThreads` table has `sessionId` and `lastRole` fields plus `by_user_and_session` index
- All files compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Session-based threads + Chat action role support</name>
  <files>
    convex/ai/threads.ts
    convex/ai/chat.ts
  </files>
  <action>
**1. Update `convex/ai/threads.ts` for session-based threads:**

Add a constant at the top:
```typescript
/** Sessions expire after 24 hours of inactivity */
const SESSION_TIMEOUT_MS = 24 * 60 * 60 * 1000; // 24 hours
```

Modify `getOrCreateThread` mutation to implement session logic:

The current logic finds the user's single thread and returns it. Change to:
1. Query ALL threads for the user (not `.unique()`, use `.collect()`) ordered by `lastActivityAt` descending
2. Find the most recent thread
3. If the most recent thread exists AND `(Date.now() - thread.lastActivityAt) < SESSION_TIMEOUT_MS`:
   - Update `lastActivityAt` and `updatedAt` on that thread
   - Return `{ threadId: thread._id, agentThreadId: thread.agentThreadId, isNew: false }`
4. If the most recent thread is stale (>24h) OR no thread exists:
   - Generate a `sessionId` using `crypto.randomUUID()` (available in Convex runtime)
   - Grab the `summary` from the stale thread (if it exists) to carry over context
   - Create a new thread with: `{ userId, sessionId, summary: previousSummary, lastActivityAt: now, createdAt: now, updatedAt: now }`
   - Return `{ threadId: newThread._id, agentThreadId: undefined, isNew: true, previousSummary }`

Update the return type to include `previousSummary?: string`.

Modify `getThreadForUser` query:
- Instead of `.unique()`, collect all threads for the user and return the most recent one (by `lastActivityAt`). This is because there are now multiple threads per user (one per session).

Modify `clearMemory` mutation:
- Delete ALL threads for the user (not just one). Use `.collect()` and loop over all, deleting each.

Keep `linkAgentThread` and `updateSummary` unchanged.

**2. Update `convex/ai/chat.ts` for role support and platformAssistant:**

Change import from `investorAssistant` to `platformAssistant`:
```typescript
import { platformAssistant } from "./agent";
```

Add `role` to the args:
```typescript
args: {
  message: v.string(),
  role: v.optional(v.string()), // "investor" | "broker" | "mortgage_advisor" | "lawyer" | "admin"
},
```

In the handler:
- After loading profile context, build a role-specific system prompt prefix. For now, only handle `investor` (default) with a brief role header:
  ```
  ## Your Role
  You are assisting an investor looking to invest in Israeli real estate.
  Focus on: property discovery, investment analysis, provider recommendations, and deal guidance.
  ```
  For other roles (broker, mortgage_advisor, lawyer, admin), add a simple placeholder:
  ```
  ## Your Role
  You are assisting a {role} on the REOS platform.
  Help them with their specific needs and tasks.
  ```
  This keeps backward compatibility. Phase 63 will add proper role-specific prompts.

- Replace ALL occurrences of `investorAssistant` with `platformAssistant` (in createThread, continueThread, listMessages calls)

- When creating a new agent thread (the `if (isNew || !currentThreadId)` block), if `threadResult.previousSummary` exists, prepend it to `systemContext`:
  ```
  if (threadResult.previousSummary) {
    systemContext += `## Previous Session Summary\n\n${threadResult.previousSummary}\n\n---\nThis summarizes our conversation from a previous session.\n\n`;
  }
  ```

- Update the thread's `lastRole` field after successful send by calling a patch mutation (or inline it). Add an internal mutation `updateThreadRole` to threads.ts:
  ```typescript
  export const updateThreadRole = internalMutation({
    args: { threadId: v.id("aiThreads"), role: v.string() },
    handler: async (ctx, { threadId, role }) => {
      await ctx.db.patch(threadId, { lastRole: role, updatedAt: Date.now() });
    },
  });
  ```
  Call it at the end of sendMessage (non-blocking): `void ctx.runMutation(internal.ai.threads.updateThreadRole, { threadId, role: role ?? "investor" })`
  </action>
  <verify>
1. `npx convex dev --once` succeeds -- schema pushes, all functions compile
2. `npx tsc --noEmit` -- no TypeScript errors
3. Manual test: Call `sendMessage` with `{ message: "Hello", role: "investor" }` -- should work exactly as before
4. Manual test: Call `getOrCreateThread` twice within seconds -- returns same thread. Wait... (can't test 24h timeout, but verify the logic path by checking the code)
5. Verify `clearMemory` deletes all threads (not just first)
  </verify>
  <done>
- `getOrCreateThread` creates new threads after 24h inactivity, carrying forward the previous session's summary
- `getThreadForUser` returns the most recent thread (not `.unique()`)
- `clearMemory` deletes ALL user threads
- `sendMessage` accepts optional `role` param, defaults to investor behavior
- All `investorAssistant` references in `chat.ts` replaced with `platformAssistant`
- `updateThreadRole` internal mutation exists and is called after each send
- Everything compiles and deploys
  </done>
</task>

</tasks>

<verification>
1. Run `npx convex dev --once` -- full deployment succeeds with no errors
2. Run `npx tsc --noEmit` -- no TypeScript errors across the project
3. The existing investor AI chat on the summary page still works (backward compatible since `sendMessage` defaults to investor role)
4. Grep for `investorAssistant` in `convex/ai/chat.ts` -- should return 0 results (all replaced with `platformAssistant`)
5. `convex/ai/streaming.ts` exists and exports `listMessages` query
6. `convex/schema.ts` `aiThreads` table includes `sessionId` and `lastRole` fields
</verification>

<success_criteria>
- platformAssistant is the single agent definition used by chat.ts
- streaming.ts provides a reactive query combining listUIMessages + syncStreams
- Threads are session-based with 24h inactivity threshold
- Previous session summaries carry forward to new sessions
- sendMessage accepts role parameter (defaults to "investor")
- Zero regressions: existing investor AI chat works unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/61-panel-shell-streaming-infrastructure/61-01-SUMMARY.md`
</output>
