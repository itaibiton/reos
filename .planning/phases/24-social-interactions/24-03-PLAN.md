---
phase: 24-social-interactions
plan: 03
type: execute
wave: 2
depends_on: ["24-01", "24-02"]
files_modified:
  - src/components/feed/CommentSection.tsx
  - src/components/feed/EngagementFooter.tsx
  - src/components/feed/index.ts
autonomous: true

must_haves:
  truths:
    - "User can click comment icon to expand comment section"
    - "User can type a comment and submit it"
    - "Comments appear in a list below the post content"
    - "Comment count updates after adding a comment"
  artifacts:
    - path: "src/components/feed/CommentSection.tsx"
      provides: "Expandable comment section with input and list"
      exports: ["CommentSection"]
  key_links:
    - from: "CommentSection.tsx"
      to: "api.posts.addComment"
      via: "useMutation"
      pattern: "useMutation.*addComment"
    - from: "CommentSection.tsx"
      to: "api.posts.getComments"
      via: "usePaginatedQuery"
      pattern: "usePaginatedQuery.*getComments"
---

<objective>
Create comment UI components for viewing and adding comments on posts

Purpose: Enable users to view and add comments directly on post cards
Output: CommentSection component with input and list, integrated into EngagementFooter
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@convex/posts.ts (addComment, getComments)
@src/components/feed/EngagementFooter.tsx (from 24-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommentSection component</name>
  <files>src/components/feed/CommentSection.tsx</files>
  <action>
Create CommentSection component with comment input and list:

```typescript
"use client";

import { useState } from "react";
import { useMutation } from "convex/react";
import { usePaginatedQuery } from "convex/react";
import { api } from "../../../convex/_generated/api";
import { Id } from "../../../convex/_generated/dataModel";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { formatDistanceToNow } from "date-fns";
import { Loader2 } from "lucide-react";
import { toast } from "sonner";

interface CommentSectionProps {
  postId: Id<"posts">;
}

// Get initials from name
function getInitials(name: string): string {
  return name
    .split(" ")
    .map((n) => n[0])
    .join("")
    .toUpperCase()
    .slice(0, 2);
}

export function CommentSection({ postId }: CommentSectionProps) {
  const [commentText, setCommentText] = useState("");
  const [isSubmitting, setIsSubmitting] = useState(false);

  const addComment = useMutation(api.posts.addComment);

  // Paginated comments, newest first
  const { results: comments, status, loadMore } = usePaginatedQuery(
    api.posts.getComments,
    { postId },
    { initialNumItems: 5 }
  );

  const handleSubmit = async () => {
    if (!commentText.trim()) return;

    setIsSubmitting(true);
    try {
      await addComment({ postId, content: commentText });
      setCommentText("");
      toast.success("Comment added");
    } catch (error) {
      toast.error("Failed to add comment");
    } finally {
      setIsSubmitting(false);
    }
  };

  // Handle Enter to submit, Shift+Enter for newline
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSubmit();
    }
  };

  return (
    <div className="pt-3 space-y-4">
      {/* Comment Input */}
      <div className="flex gap-3">
        <Textarea
          value={commentText}
          onChange={(e) => setCommentText(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder="Write a comment..."
          className="min-h-[80px] resize-none"
          maxLength={1000}
        />
        <Button
          onClick={handleSubmit}
          disabled={!commentText.trim() || isSubmitting}
          className="self-end"
        >
          {isSubmitting ? (
            <Loader2 className="h-4 w-4 animate-spin" />
          ) : (
            "Post"
          )}
        </Button>
      </div>

      {/* Comments List */}
      {status === "LoadingFirstPage" && (
        <div className="flex justify-center py-4">
          <Loader2 className="h-5 w-5 animate-spin text-muted-foreground" />
        </div>
      )}

      {comments.length > 0 && (
        <div className="space-y-3">
          {comments.map((comment) => (
            <div key={comment._id} className="flex gap-3">
              <Avatar className="h-8 w-8 flex-shrink-0">
                <AvatarImage src={comment.authorImageUrl} alt={comment.authorName} />
                <AvatarFallback className="text-xs">
                  {getInitials(comment.authorName)}
                </AvatarFallback>
              </Avatar>
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                  <span className="font-medium text-sm">{comment.authorName}</span>
                  <span className="text-xs text-muted-foreground">
                    {formatDistanceToNow(comment.createdAt, { addSuffix: true })}
                  </span>
                </div>
                <p className="text-sm mt-1">{comment.content}</p>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Load more */}
      {status === "CanLoadMore" && (
        <Button
          variant="ghost"
          size="sm"
          className="w-full text-muted-foreground"
          onClick={() => loadMore(5)}
        >
          Load more comments
        </Button>
      )}

      {status === "LoadingMore" && (
        <div className="flex justify-center py-2">
          <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
        </div>
      )}

      {/* Empty state */}
      {status !== "LoadingFirstPage" && comments.length === 0 && (
        <p className="text-sm text-muted-foreground text-center py-2">
          No comments yet. Be the first to comment!
        </p>
      )}
    </div>
  );
}
```

Key features:
- Textarea with 1000 char limit matching backend
- Enter to submit, Shift+Enter for newline
- Paginated comments with load more
- Author avatar and name with relative timestamp
- Loading states and empty state
- Toast feedback on submit
  </action>
  <verify>Component compiles without errors</verify>
  <done>CommentSection component created with input, list, pagination, and loading states</done>
</task>

<task type="auto">
  <name>Task 2: Integrate CommentSection into EngagementFooter</name>
  <files>
    src/components/feed/EngagementFooter.tsx
    src/components/feed/index.ts
  </files>
  <action>
1. Update EngagementFooter to include expandable comment section:

Add to EngagementFooter:
- Add state: `const [showComments, setShowComments] = useState(false);`
- Make the comment button clickable: wrap in button that toggles `showComments`
- Conditionally render CommentSection below the footer when `showComments` is true:

```tsx
// Inside the footer component, after the footer div:
{showComments && (
  <CommentSection postId={postId} />
)}
```

- Make the comment button a `button` element with onClick to toggle:
```tsx
<button
  onClick={() => setShowComments(!showComments)}
  className="flex items-center gap-1 hover:text-foreground transition-colors"
>
  <HugeiconsIcon icon={Comment01Icon} size={16} strokeWidth={1.5} />
  <span>{commentCount}</span>
</button>
```

2. Update the component to wrap footer + comments in a div so they're connected:
```tsx
return (
  <div>
    <div className="flex items-center gap-4 text-sm text-muted-foreground pt-3 border-t">
      {/* like, comment, save buttons */}
    </div>
    {showComments && <CommentSection postId={postId} />}
  </div>
);
```

3. Update barrel export in index.ts:
- Add `export { CommentSection } from "./CommentSection";`
  </action>
  <verify>`npm run build` passes, clicking comment icon on feed page expands comment section</verify>
  <done>Comment section integrated into EngagementFooter, expands on click</done>
</task>

</tasks>

<verification>
1. Navigate to /feed page
2. Click comment icon on any post - section should expand
3. Type a comment and press Enter or click Post
4. Comment should appear in list, count should increment
5. Click comment icon again - section should collapse
6. Refresh page - comment should persist
7. Click "Load more comments" if available
</verification>

<success_criteria>
- Comment icon click toggles comment section visibility
- Comment input with Enter to submit, 1000 char limit
- Comments display with author avatar, name, time
- Comment count updates after adding
- Paginated with "Load more comments" button
- Toast feedback on submit
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-social-interactions/24-03-SUMMARY.md`
</output>
