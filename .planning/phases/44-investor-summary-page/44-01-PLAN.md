---
phase: 44-investor-summary-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/profile/ProfileCompletenessBar.tsx
  - src/components/profile/InlineFieldEditor.tsx
  - src/components/profile/ProfileSection.tsx
  - src/components/profile/ProfileSummaryPanel.tsx
  - src/components/profile/index.ts
autonomous: true

must_haves:
  truths:
    - "Profile sections display questionnaire data in collapsible accordion format"
    - "First incomplete section is expanded by default"
    - "Completeness percentage updates reactively after field edit"
    - "Clicking completeness bar jumps to first incomplete section"
    - "User can edit any field via popover without leaving context"
  artifacts:
    - path: "src/components/profile/ProfileCompletenessBar.tsx"
      provides: "Progress bar with percentage, click-to-jump, sticky positioning"
      exports: ["ProfileCompletenessBar"]
    - path: "src/components/profile/InlineFieldEditor.tsx"
      provides: "Popover editor with save/cancel, generic renderInput prop"
      exports: ["InlineFieldEditor"]
    - path: "src/components/profile/ProfileSection.tsx"
      provides: "Single accordion section with inline editors per field"
      exports: ["ProfileSection"]
    - path: "src/components/profile/ProfileSummaryPanel.tsx"
      provides: "Full left panel: completeness bar + accordion sections"
      exports: ["ProfileSummaryPanel"]
  key_links:
    - from: "ProfileCompletenessBar"
      to: "ProfileSummaryPanel"
      via: "onJumpToIncomplete callback controlling accordion state"
      pattern: "setActiveSection.*firstIncomplete"
    - from: "InlineFieldEditor"
      to: "investorQuestionnaires.saveAnswers"
      via: "onSave prop calling mutation"
      pattern: "await onSave"
    - from: "ProfileSection"
      to: "InlineFieldEditor"
      via: "renders InlineFieldEditor for each field"
      pattern: "<InlineFieldEditor"
---

<objective>
Create the profile summary panel components for the left side of the investor summary page.

Purpose: Build the accordion-based profile display with inline editing and completeness tracking. This is the core profile management interface that lets investors view and edit their questionnaire data without navigating away.

Output: Four components - ProfileCompletenessBar (sticky progress with click-to-jump), InlineFieldEditor (generic popover editor), ProfileSection (accordion section with inline editors), and ProfileSummaryPanel (assembled panel).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-investor-summary-page/44-CONTEXT.md
@.planning/phases/44-investor-summary-page/44-RESEARCH.md

# Existing components to reference
@src/components/profile/ProfileCompletenessCard.tsx
@convex/investorQuestionnaires.ts
@src/app/[locale]/(app)/onboarding/questionnaire/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProfileCompletenessBar and InlineFieldEditor components</name>
  <files>
    src/components/profile/ProfileCompletenessBar.tsx
    src/components/profile/InlineFieldEditor.tsx
  </files>
  <action>
**ProfileCompletenessBar.tsx:**
Extract completeness calculation logic from ProfileCompletenessCard. Create a sticky progress bar component:

```typescript
interface ProfileCompletenessBarProps {
  questionnaire: QuestionnaireData | null;
  onJumpToIncomplete?: (sectionId: string) => void;
}
```

- Use same COMPLETENESS_FIELDS array and calculateCompleteness function from ProfileCompletenessCard
- Sticky positioning: `sticky top-0 bg-background z-10 p-4 border-b`
- Show Progress component with percentage
- Show missing fields (first 3 + "+N more" pattern)
- When complete, show checkmark badge: "Profile complete"
- Clickable when incomplete: calls onJumpToIncomplete with first incomplete section ID
- Use cursor-pointer and hover state when incomplete

Map fields to section IDs:
- citizenship, residencyStatus, experienceLevel, ownsPropertyInIsrael, investmentType -> "basics"
- budgetMin, budgetMax, investmentHorizon, investmentGoals, yieldPreference, financingApproach -> "financial"
- preferredPropertyTypes, preferredLocations -> "preferences"
- purchaseTimeline, servicesNeeded -> "timeline"

**InlineFieldEditor.tsx:**
Generic popover editor component:

```typescript
interface InlineFieldEditorProps {
  label: string;
  value: string | number | string[] | boolean | undefined;
  onSave: (value: any) => Promise<void>;
  renderInput: (value: any, onChange: (val: any) => void) => ReactNode;
  formatValue?: (value: any) => string; // For display
}
```

- Controlled Popover from shadcn/ui
- Trigger shows formatted value or "Not set"
- Content shows label, renderInput, Save/Cancel buttons
- Save button disabled during save, shows loading
- Await onSave before closing popover (prevent close-before-save bug)
- Cancel resets editValue to original and closes
- Keyboard: Enter saves, Escape cancels
- Toast error on save failure (use sonner)
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
ProfileCompletenessBar shows progress with click-to-jump capability.
InlineFieldEditor provides generic popover editing pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ProfileSection and ProfileSummaryPanel components</name>
  <files>
    src/components/profile/ProfileSection.tsx
    src/components/profile/ProfileSummaryPanel.tsx
  </files>
  <action>
**ProfileSection.tsx:**
Single accordion section component:

```typescript
interface ProfileSectionProps {
  section: {
    id: string;
    titleKey: string; // translation key
    fields: { key: string; labelKey: string; type: "text" | "select" | "multiselect" | "number" | "boolean" }[];
  };
  questionnaire: QuestionnaireData;
  onFieldSave: (fieldName: string, value: any) => Promise<void>;
}
```

- Use AccordionItem, AccordionTrigger, AccordionContent from shadcn
- Trigger shows section title (via useTranslations) + incomplete Badge if any field missing
- Content shows InlineFieldEditor for each field
- renderInput varies by field type:
  - text: Input component
  - select: Select component with options (from translation keys)
  - multiselect: Multi-checkbox or multi-select (depends on options count)
  - number: Input type="number"
  - boolean: Switch or Yes/No select
- Format array values as comma-separated for display

Define QUESTIONNAIRE_SECTIONS constant:
```typescript
const QUESTIONNAIRE_SECTIONS = [
  {
    id: "basics",
    titleKey: "sections.basics",
    fields: [
      { key: "citizenship", labelKey: "fields.citizenship", type: "select" },
      { key: "residencyStatus", labelKey: "fields.residencyStatus", type: "select" },
      { key: "experienceLevel", labelKey: "fields.experienceLevel", type: "select" },
      { key: "ownsPropertyInIsrael", labelKey: "fields.propertyOwnership", type: "boolean" },
      { key: "investmentType", labelKey: "fields.investmentType", type: "select" },
    ],
  },
  {
    id: "financial",
    titleKey: "sections.financial",
    fields: [
      { key: "budgetMin", labelKey: "fields.budgetMin", type: "number" },
      { key: "budgetMax", labelKey: "fields.budgetMax", type: "number" },
      { key: "investmentHorizon", labelKey: "fields.investmentHorizon", type: "select" },
      { key: "investmentGoals", labelKey: "fields.investmentGoals", type: "multiselect" },
      { key: "yieldPreference", labelKey: "fields.yieldPreference", type: "select" },
      { key: "financingApproach", labelKey: "fields.financingApproach", type: "select" },
    ],
  },
  {
    id: "preferences",
    titleKey: "sections.preferences",
    fields: [
      { key: "preferredPropertyTypes", labelKey: "fields.propertyTypes", type: "multiselect" },
      { key: "preferredLocations", labelKey: "fields.preferredLocations", type: "multiselect" },
    ],
  },
  {
    id: "timeline",
    titleKey: "sections.timeline",
    fields: [
      { key: "purchaseTimeline", labelKey: "fields.purchaseTimeline", type: "select" },
      { key: "servicesNeeded", labelKey: "fields.servicesNeeded", type: "multiselect" },
    ],
  },
];
```

**ProfileSummaryPanel.tsx:**
Assembles completeness bar and accordion:

```typescript
interface ProfileSummaryPanelProps {
  className?: string;
}
```

- Fetch questionnaire via `useQuery(api.investorQuestionnaires.getByUser)`
- Show Skeleton while loading
- Controlled Accordion with `value` and `onValueChange` state
- Default value: first incomplete section ID, or "basics" if all complete
- ProfileCompletenessBar at top with onJumpToIncomplete setting accordion value
- Map QUESTIONNAIRE_SECTIONS to ProfileSection components
- Use `useMutation(api.investorQuestionnaires.saveAnswers)` for field saves
- Toast success on save, error on failure
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
ProfileSection renders accordion section with inline editors.
ProfileSummaryPanel assembles full left panel with controlled accordion and completeness tracking.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add barrel export and verify component integration</name>
  <files>
    src/components/profile/index.ts
  </files>
  <action>
Create or update barrel export at `src/components/profile/index.ts`:

```typescript
// Profile components
export { ProfileHeader } from "./ProfileHeader";
export { StatsRow } from "./StatsRow";
export { PortfolioSection } from "./PortfolioSection";
export { UserPostsFeed } from "./UserPostsFeed";
export { UserRepostsFeed } from "./UserRepostsFeed";
export { ProviderProfileForm } from "./ProviderProfileForm";
export { ProfileCompletenessCard } from "./ProfileCompletenessCard";
export { InvestorProfileForm } from "./InvestorProfileForm";

// New Phase 44 components
export { ProfileCompletenessBar } from "./ProfileCompletenessBar";
export { InlineFieldEditor } from "./InlineFieldEditor";
export { ProfileSection, QUESTIONNAIRE_SECTIONS } from "./ProfileSection";
export { ProfileSummaryPanel } from "./ProfileSummaryPanel";
```

Export QUESTIONNAIRE_SECTIONS constant for reuse (completeness bar needs it for section ID mapping).

Run lint and type check to ensure clean integration.
  </action>
  <verify>
`npx tsc --noEmit` passes.
`npm run lint` passes.
Import works: `import { ProfileSummaryPanel } from "@/components/profile"` compiles.
  </verify>
  <done>
All profile summary components exported and importable.
Ready for integration in summary page (Plan 03).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Lint passes
3. ProfileCompletenessBar renders with progress percentage
4. InlineFieldEditor opens popover, saves field, closes after save
5. ProfileSection renders accordion with inline editors for each field
6. ProfileSummaryPanel shows controlled accordion with completeness bar
7. Clicking completeness bar expands the incomplete section
</verification>

<success_criteria>
- ProfileCompletenessBar shows percentage and responds to clicks
- InlineFieldEditor saves to Convex via mutation
- Accordion sections expand/collapse with proper animation
- First incomplete section expanded by default
- Field edits trigger reactive completeness recalculation
- All components exported from barrel
</success_criteria>

<output>
After completion, create `.planning/phases/44-investor-summary-page/44-01-SUMMARY.md`
</output>
